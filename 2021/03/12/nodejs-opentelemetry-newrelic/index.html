<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Getting NodeJS OpenTelemetry data into NewRelic | Andy Dote</title><meta name=keywords content="observability,opentelemetry,nodejs,zipkin"><meta name=description content="I had the need to get some OpenTelemetry data out of a NodeJS application, and into NewRelic&rsquo;s distributed tracing service, but found that there is no way to do it directly, and in this use case, adding a separate collector is more hassle than it&rsquo;s worth.
Luckily, there is an NodeJS OpenTelemetry library which can report to Zipkin, and NewRelic can also ingest Zipkin format data.
To use it was relatively straight forward:"><meta name=author content><link rel=canonical href=https://andydote.co.uk/2021/03/12/nodejs-opentelemetry-newrelic/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Getting NodeJS OpenTelemetry data into NewRelic"><meta property="og:description" content="I had the need to get some OpenTelemetry data out of a NodeJS application, and into NewRelic&rsquo;s distributed tracing service, but found that there is no way to do it directly, and in this use case, adding a separate collector is more hassle than it&rsquo;s worth.
Luckily, there is an NodeJS OpenTelemetry library which can report to Zipkin, and NewRelic can also ingest Zipkin format data.
To use it was relatively straight forward:"><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2021/03/12/nodejs-opentelemetry-newrelic/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-03-12T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-12T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Getting NodeJS OpenTelemetry data into NewRelic"><meta name=twitter:description content="I had the need to get some OpenTelemetry data out of a NodeJS application, and into NewRelic&rsquo;s distributed tracing service, but found that there is no way to do it directly, and in this use case, adding a separate collector is more hassle than it&rsquo;s worth.
Luckily, there is an NodeJS OpenTelemetry library which can report to Zipkin, and NewRelic can also ingest Zipkin format data.
To use it was relatively straight forward:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Getting NodeJS OpenTelemetry data into NewRelic","item":"https://andydote.co.uk/2021/03/12/nodejs-opentelemetry-newrelic/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Getting NodeJS OpenTelemetry data into NewRelic","name":"Getting NodeJS OpenTelemetry data into NewRelic","description":"I had the need to get some OpenTelemetry data out of a NodeJS application, and into NewRelic\u0026rsquo;s distributed tracing service, but found that there is no way to do it directly, and in this use case, adding a separate collector is more hassle than it\u0026rsquo;s worth.\nLuckily, there is an NodeJS OpenTelemetry library which can report to Zipkin, and NewRelic can also ingest Zipkin format data.\nTo use it was relatively straight forward:","keywords":["observability","opentelemetry","nodejs","zipkin"],"articleBody":"I had the need to get some OpenTelemetry data out of a NodeJS application, and into NewRelic’s distributed tracing service, but found that there is no way to do it directly, and in this use case, adding a separate collector is more hassle than it’s worth.\nLuckily, there is an NodeJS OpenTelemetry library which can report to Zipkin, and NewRelic can also ingest Zipkin format data.\nTo use it was relatively straight forward:\nimport { context, setSpan, Span, trace } from \"@opentelemetry/api\"; import { BasicTracerProvider, BatchSpanProcessor } from \"@opentelemetry/tracing\"; import { ZipkinExporter } from \"@opentelemetry/exporter-zipkin\"; const exporter = new ZipkinExporter({ url: \"https://trace-api.newrelic.com/trace/v1\", serviceName: \"interesting-service\", headers: { \"Api-Key\": process.env.NEWRELIC_APIKEY, \"Data-Format\": \"zipkin\", \"Data-Format-Version\": \"2\", }, }); const provider = new BasicTracerProvider(); provider.addSpanProcessor(new BatchSpanProcessor(exporter)); provider.register(); export const tracer = trace.getTracer(\"default\"); const rootSpan = tracer.startSpan(\"main\"); // do something fantastically interesting rootSpan.end(); provider.shutdown(); This has the added benefit of being able to test with Zipkin locally, using the openzipkin/zipkin-slim docker container, by just removing the URL property from the ZipkinExporter:\ndocker run --rm -d -p 9411:9411 openzipkin/zipkin-slim Child Spans Figuring out how to create child spans was actually harder in the end, in part because the OpenTelemetry docs don’t quite match the actual function signatures.\nIn the end, I wrote this little helper function:\nimport { context, setSpan, Span } from \"@opentelemetry/api\"; function startSpan(parent: Span, name: string): Span { return tracer.startSpan(name, undefined, setSpan(context.active(), parent)); } Which I can use like this:\nasync function DoInterestingThings(span: Span) { span = startSpan(span, \"do-interesting-things\"); // interesting things happen here span.end(); } Doing both of these means I can now see what my misbehaving cron jobs are actually doing, rather than trying to guess what their problems are.\n","wordCount":"278","inLanguage":"en","datePublished":"2021-03-12T00:00:00Z","dateModified":"2021-03-12T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2021/03/12/nodejs-opentelemetry-newrelic/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Getting NodeJS OpenTelemetry data into NewRelic</h1><div class=post-meta><span title='2021-03-12 00:00:00 +0000 UTC'>March 12, 2021</span>&nbsp;·&nbsp;2 min</div></header><div class=post-content><p>I had the need to get some OpenTelemetry data out of a NodeJS application, and into NewRelic&rsquo;s distributed tracing service, but found that there is no way to do it directly, and in this use case, adding a separate collector is more hassle than it&rsquo;s worth.</p><p>Luckily, there is an NodeJS <a href=https://www.npmjs.com/package/@opentelemetry/exporter-zipkin>OpenTelemetry library which can report to Zipkin</a>, and NewRelic can also <a href=https://docs.newrelic.com/docs/understand-dependencies/distributed-tracing/trace-api/report-zipkin-format-traces-trace-api/>ingest Zipkin format data</a>.</p><p>To use it was relatively straight forward:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>context</span>, <span style=color:#a6e22e>setSpan</span>, <span style=color:#a6e22e>Span</span>, <span style=color:#a6e22e>trace</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@opentelemetry/api&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>BasicTracerProvider</span>, <span style=color:#a6e22e>BatchSpanProcessor</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@opentelemetry/tracing&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ZipkinExporter</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@opentelemetry/exporter-zipkin&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>exporter</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ZipkinExporter</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;https://trace-api.newrelic.com/trace/v1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>serviceName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;interesting-service&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Api-Key&#34;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>NEWRELIC_APIKEY</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Data-Format&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;zipkin&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;Data-Format-Version&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;2&#34;</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>provider</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BasicTracerProvider</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>addSpanProcessor</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BatchSpanProcessor</span>(<span style=color:#a6e22e>exporter</span>));
</span></span><span style=display:flex><span><span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>register</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tracer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>getTracer</span>(<span style=color:#e6db74>&#34;default&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rootSpan</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tracer</span>.<span style=color:#a6e22e>startSpan</span>(<span style=color:#e6db74>&#34;main&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// do something fantastically interesting
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rootSpan</span>.<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>shutdown</span>();
</span></span></code></pre></div><p>This has the added benefit of being able to test with Zipkin locally, using the <code>openzipkin/zipkin-slim</code> docker container, by just removing the URL property from the <code>ZipkinExporter</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --rm -d -p 9411:9411 openzipkin/zipkin-slim
</span></span></code></pre></div><h2 id=child-spans>Child Spans<a hidden class=anchor aria-hidden=true href=#child-spans>#</a></h2><p>Figuring out how to create child spans was actually harder in the end, in part because the OpenTelemetry docs don&rsquo;t quite match the actual function signatures.</p><p>In the end, I wrote this little helper function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>context</span>, <span style=color:#a6e22e>setSpan</span>, <span style=color:#a6e22e>Span</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;@opentelemetry/api&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>startSpan</span>(<span style=color:#a6e22e>parent</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Span</span>, <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Span</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>tracer</span>.<span style=color:#a6e22e>startSpan</span>(<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>undefined</span>, <span style=color:#a6e22e>setSpan</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>active</span>(), <span style=color:#a6e22e>parent</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Which I can use like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>DoInterestingThings</span>(<span style=color:#a6e22e>span</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Span</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>span</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>startSpan</span>(<span style=color:#a6e22e>span</span>, <span style=color:#e6db74>&#34;do-interesting-things&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// interesting things happen here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Doing both of these means I can now see what my misbehaving cron jobs are actually doing, rather than trying to guess what their problems are.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/observability/>observability</a></li><li><a href=https://andydote.co.uk/tags/opentelemetry/>opentelemetry</a></li><li><a href=https://andydote.co.uk/tags/nodejs/>nodejs</a></li><li><a href=https://andydote.co.uk/tags/zipkin/>zipkin</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2021/05/27/vault-observe/><span class=title>« Prev Page</span><br><span>Adding Observability to Vault</span></a>
<a class=next href=https://andydote.co.uk/2021/03/01/observability-with-infrastructure-as-code/><span class=title>Next Page »</span><br><span>Observability with Infrastructure as Code</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>