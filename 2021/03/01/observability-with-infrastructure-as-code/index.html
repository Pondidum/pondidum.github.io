<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Observability with Infrastructure as Code | Andy Dote</title>
<meta name=keywords content="observability,honeycomb,pulumi,infrastructure,aws"><meta name=description content="This article was originally published on the Pulumi blog.
When using the Pulumi Automation API to create applications which can provision infrastructure, it is very handy to be able to use observability techniques to ensure the application functions correctly and to help see where performance bottlenecks are.
One of the applications I work on creates a VPC and Bastion host and then stores the credentials into a Vault instance. The problem is that the “create infrastructure” part is an opaque blob, in that I can see it takes 129 seconds to create, but I can’t see what it’s doing, or why it takes this amount of time."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2021/03/01/observability-with-infrastructure-as-code/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.c6a36963ab47314b3d95fe85a9385337e1ef8eb1c2194eecb86f178d492ab666.js integrity="sha256-xqNpY6tHMUs9lf6FqThTN+HvjrHCGU7suG8XjUkqtmY="></script><script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script><link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Observability with Infrastructure as Code"><meta property="og:description" content="This article was originally published on the Pulumi blog.
When using the Pulumi Automation API to create applications which can provision infrastructure, it is very handy to be able to use observability techniques to ensure the application functions correctly and to help see where performance bottlenecks are.
One of the applications I work on creates a VPC and Bastion host and then stores the credentials into a Vault instance. The problem is that the “create infrastructure” part is an opaque blob, in that I can see it takes 129 seconds to create, but I can’t see what it’s doing, or why it takes this amount of time."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2021/03/01/observability-with-infrastructure-as-code/"><meta property="article:section" content="post"><meta property="article:published_time" content="2021-03-01T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-01T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Observability with Infrastructure as Code"><meta name=twitter:description content="This article was originally published on the Pulumi blog.
When using the Pulumi Automation API to create applications which can provision infrastructure, it is very handy to be able to use observability techniques to ensure the application functions correctly and to help see where performance bottlenecks are.
One of the applications I work on creates a VPC and Bastion host and then stores the credentials into a Vault instance. The problem is that the “create infrastructure” part is an opaque blob, in that I can see it takes 129 seconds to create, but I can’t see what it’s doing, or why it takes this amount of time."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Observability with Infrastructure as Code","item":"https://andydote.co.uk/2021/03/01/observability-with-infrastructure-as-code/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Observability with Infrastructure as Code","name":"Observability with Infrastructure as Code","description":"This article was originally published on the Pulumi blog.\nWhen using the Pulumi Automation API to create applications which can provision infrastructure, it is very handy to be able to use observability techniques to ensure the application functions correctly and to help see where performance bottlenecks are.\nOne of the applications I work on creates a VPC and Bastion host and then stores the credentials into a Vault instance. The problem is that the “create infrastructure” part is an opaque blob, in that I can see it takes 129 seconds to create, but I can’t see what it’s doing, or why it takes this amount of time.","keywords":["observability","honeycomb","pulumi","infrastructure","aws"],"articleBody":" This article was originally published on the Pulumi blog.\nWhen using the Pulumi Automation API to create applications which can provision infrastructure, it is very handy to be able to use observability techniques to ensure the application functions correctly and to help see where performance bottlenecks are.\nOne of the applications I work on creates a VPC and Bastion host and then stores the credentials into a Vault instance. The problem is that the “create infrastructure” part is an opaque blob, in that I can see it takes 129 seconds to create, but I can’t see what it’s doing, or why it takes this amount of time.\nSo can I do better?\nThe Initial Application In this example I use Honeycomb’s Go Beeline to capture all the data I care about; durations, errors, any context which is “interesting”:\nfunc main() { beeline.Init(beeline.Config{ WriteKey: os.Getenv(\"HONEYCOMB_API_KEY\"), Dataset: \"pulumi-demo\", }) defer beeline.Close() ctx, span := beeline.StartSpan(context.Background(), \"basic-vpc\") defer span.Send() name := auto.FullyQualifiedStackName(os.Getenv(\"PULUMI_USERNAME\"), \"basic-vpc\", \"dev\") stack, err := auto.UpsertStackInlineSource(ctx, name, \"basic-vpc\", func(pc *pulumi.Context) error { azs, err := getAvailabilityZones(ctx) if err != nil { beeline.AddField(ctx, \"err\", err) return err } v, err := vpc.NewVpc(ctx, pc, \"dev\", \u0026vpc.VpcArgs{ Description: \"dev\", BaseCidr: \"192.168.0.0/16\", AvailabilityZoneNames: azs, S3Endpoint: true, DynamoEndpoint: true, }) if err != nil { beeline.AddField(ctx, \"err\", err) return err } }) if err != nil { beeline.AddField(ctx, \"err\", err) os.Exit(1) } if err := stack.SetConfig(ctx, \"aws:region\", auto.ConfigValue{Value: os.Getenv(\"PULUMI_REGION\")}); err != nil { beeline.AddField(ctx, \"err\", err) os.Exit(1) } ws := stack.Workspace() if err := ws.InstallPlugin(ctx, \"aws\", \"v3.23.0\"); err != nil { beeline.AddField(ctx, \"err\", err) os.Exit(1) } if _, err := stack.Refresh(ctx); err != nil { beeline.AddField(ctx, \"err\", err) os.Exit(1) } stream := optup.ProgressStreams(os.Stdout) if _, err := stack.Up(ctx, stream); err != nil { beeline.AddField(ctx, \"err\", err) os.Exit(1) } //vault code } Adding Infrastructure Observability To get a handle on what is happening when stack.Up() runs, I have mplemented a custom io.Writer, which will be passed into the ProgressStream constructor.\nThe custom progress stream’s Write method is called once for each line emitted, which allows us to start new spans when a resource starts being constructed, and send them when construction completes. Currently, this is achieved by parsing the console output text, but I gather in the future, it will be possible to get streamed json blobs which can be unmarshaled into go structs.\ntype pulumiBeeline struct { ctx context.Context contexts map[string]func() } func NewPulumiBeeline(ctx context.Context) *pulumiBeeline { return \u0026pulumiBeeline{ ctx: ctx, contexts: map[string]func(){}, } } func (cw *pulumiBeeline) Write(p []byte) (n int, err error) { // todo: make more robust, support modifications, deletions etc. line := strings.TrimSpace(string(p)) parts := strings.Split(line, \" \") if len(parts) \u003c 5 { return len(p), nil } //+ aws-vpc dev creating //+ resourceType := parts[2] resourceName := parts[3] resourceAction := parts[4] if resourceAction == \"creating\" { c, s := beeline.StartSpan(cw.ctx, resourceName) beeline.AddField(c, \"type\", resourceType) // add other things here cw.contexts[resourceName] = s.Send } if resourceAction == \"created\" { cw.contexts[resourceName]() } return len(p), nil } Modifying the optup.ProgressStreams is the only change needed to the original application:\nstream := optup.ProgressStreams(os.Stdout, NewPulumiBeeline(ctx)) if _, err := stack.Up(ctx, stream); err != nil { beeline.AddField(ctx, \"err\", err) os.Exit(1) } Now when I run this program again, I can see a lot more information in my Honeycomb traces, which not only shows me that Pulumi is highly parallelised, but also gives me a better idea of where the time is taken when creating infrastructure; in this example, it’s the NAT Gateways:\nIn the future, I want to expand this to cover far more details, such as including the reasons resources were created/modified/destroyed and including as much information as possible about what caused a resource to fail.\nWrapping Up In the end, this turned out to be much easier to achieve than I had hoped. Being able to use Pulumi progmatically, rather than running os.Exec directly myself was a huge productivity boost.\nI am looking forward to all the new kinds of tooling I can build to solve my user’s problems continuing to utilise Honeycomb for my observability and Pulumi for my infrastructure.\n","wordCount":"678","inLanguage":"en","datePublished":"2021-03-01T00:00:00Z","dateModified":"2021-03-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2021/03/01/observability-with-infrastructure-as-code/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Observability with Infrastructure as Code</h1><div class=post-meta>&lt;span title='2021-03-01 00:00:00 +0000 UTC'>March 1, 2021&lt;/span>&amp;nbsp;·&amp;nbsp;4 min</div></header><div class=post-content><blockquote><p>This article was originally published on the <a href=https://www.pulumi.com/blog/observability-with-infrastructure-as-code/>Pulumi blog</a>.</p></blockquote><p>When using the <a href=https://www.pulumi.com/blog/tag/automation-api/>Pulumi Automation API</a> to create applications which can provision infrastructure, it is very handy to be able to use observability techniques to ensure the application functions correctly and to help see where performance bottlenecks are.</p><p>One of the applications I work on creates a VPC and Bastion host and then stores the credentials into a Vault instance. The problem is that the “create infrastructure” part is an opaque blob, in that I can see it takes 129 seconds to create, but I can’t see what it’s doing, or why it takes this amount of time.</p><p><img loading=lazy src=pulumi-observability-before.png alt="honeycomb traces of one pulumi stack resource"></p><p>So can I do better?</p><h2 id=the-initial-application>The Initial Application<a hidden class=anchor aria-hidden=true href=#the-initial-application>#</a></h2><p>In this example I use <a href=https://honeycomb.io/>Honeycomb&rsquo;s</a> <a href=https://github.com/honeycombio/beeline-go/>Go Beeline</a> to capture all the data I care about; durations, errors, any context which is “interesting”:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>Init</span>(<span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>WriteKey</span>: <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;HONEYCOMB_API_KEY&#34;</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Dataset</span>:  <span style=color:#e6db74>&#34;pulumi-demo&#34;</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>span</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>StartSpan</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;basic-vpc&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>Send</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>name</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>auto</span>.<span style=color:#a6e22e>FullyQualifiedStackName</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;PULUMI_USERNAME&#34;</span>), <span style=color:#e6db74>&#34;basic-vpc&#34;</span>, <span style=color:#e6db74>&#34;dev&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stack</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>auto</span>.<span style=color:#a6e22e>UpsertStackInlineSource</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>name</span>, <span style=color:#e6db74>&#34;basic-vpc&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>pc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pulumi</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>azs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getAvailabilityZones</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>AddField</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>vpc</span>.<span style=color:#a6e22e>NewVpc</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>pc</span>, <span style=color:#e6db74>&#34;dev&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>vpc</span>.<span style=color:#a6e22e>VpcArgs</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Description</span>:           <span style=color:#e6db74>&#34;dev&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>BaseCidr</span>:              <span style=color:#e6db74>&#34;192.168.0.0/16&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>AvailabilityZoneNames</span>: <span style=color:#a6e22e>azs</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>S3Endpoint</span>:            <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>DynamoEndpoint</span>:        <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>AddField</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>AddField</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>SetConfig</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;aws:region&#34;</span>, <span style=color:#a6e22e>auto</span>.<span style=color:#a6e22e>ConfigValue</span>{<span style=color:#a6e22e>Value</span>: <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;PULUMI_REGION&#34;</span>)}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>AddField</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ws</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>Workspace</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>InstallPlugin</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;aws&#34;</span>, <span style=color:#e6db74>&#34;v3.23.0&#34;</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>AddField</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>Refresh</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>AddField</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stream</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>optup</span>.<span style=color:#a6e22e>ProgressStreams</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>Up</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>stream</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>AddField</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//vault code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=adding-infrastructure-observability>Adding Infrastructure Observability<a hidden class=anchor aria-hidden=true href=#adding-infrastructure-observability>#</a></h2><p>To get a handle on what is happening when <code>stack.Up()</code> runs, I have mplemented a custom <code>io.Writer</code>, which will be passed into the <code>ProgressStream</code> constructor.</p><p>The custom progress stream&rsquo;s <code>Write</code> method is called once for each line emitted, which allows us to start new spans when a resource starts being constructed, and send them when construction completes. Currently, this is achieved by parsing the console output text, but I gather in the future, it will be possible to get streamed json blobs which can be unmarshaled into go structs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>pulumiBeeline</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span>      <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>contexts</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>func</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewPulumiBeeline</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>pulumiBeeline</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pulumiBeeline</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>:  	<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>contexts</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>func</span>(){},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>cw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pulumiBeeline</span>) <span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>p</span> []<span style=color:#66d9ef>byte</span>) (<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// todo: make more robust, support modifications, deletions etc.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>line</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>TrimSpace</span>(string(<span style=color:#a6e22e>p</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>parts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Split</span>(<span style=color:#a6e22e>line</span>, <span style=color:#e6db74>&#34; &#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>parts</span>) &lt; <span style=color:#ae81ff>5</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>p</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//+  aws-vpc dev creating
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//+  &lt;type&gt; &lt;name&gt; &lt;action&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>resourceType</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parts</span>[<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resourceName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parts</span>[<span style=color:#ae81ff>3</span>]
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>resourceAction</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parts</span>[<span style=color:#ae81ff>4</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>resourceAction</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;creating&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>StartSpan</span>(<span style=color:#a6e22e>cw</span>.<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>resourceName</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>AddField</span>(<span style=color:#a6e22e>c</span>, <span style=color:#e6db74>&#34;type&#34;</span>, <span style=color:#a6e22e>resourceType</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// add other things here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cw</span>.<span style=color:#a6e22e>contexts</span>[<span style=color:#a6e22e>resourceName</span>] = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Send</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>resourceAction</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;created&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>cw</span>.<span style=color:#a6e22e>contexts</span>[<span style=color:#a6e22e>resourceName</span>]()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>p</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Modifying the <code>optup.ProgressStreams</code> is the only change needed to the original application:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>stream</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>optup</span>.<span style=color:#a6e22e>ProgressStreams</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>, <span style=color:#a6e22e>NewPulumiBeeline</span>(<span style=color:#a6e22e>ctx</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>Up</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>stream</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>beeline</span>.<span style=color:#a6e22e>AddField</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;err&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now when I run this program again, I can see a lot more information in my Honeycomb traces, which not only shows me that Pulumi is <em>highly</em> parallelised, but also gives me a better idea of where the time is taken when creating infrastructure; in this example, it’s the NAT Gateways:</p><p><img loading=lazy src=pulumi-observability-after.png alt="honeycomb traces of all infrastructure resources in the pulumi stack"></p><p>In the future, I want to expand this to cover far more details, such as including the reasons resources were created/modified/destroyed and including as much information as possible about what caused a resource to fail.</p><h2 id=wrapping-up>Wrapping Up<a hidden class=anchor aria-hidden=true href=#wrapping-up>#</a></h2><p>In the end, this turned out to be much easier to achieve than I had hoped. Being able to use Pulumi progmatically, rather than running <code>os.Exec</code> directly myself was a huge productivity boost.</p><p>I am looking forward to all the new kinds of tooling I can build to solve my user&rsquo;s problems continuing to utilise Honeycomb for my observability and Pulumi for my infrastructure.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/observability/>observability</a></li><li><a href=https://andydote.co.uk/tags/honeycomb/>honeycomb</a></li><li><a href=https://andydote.co.uk/tags/pulumi/>pulumi</a></li><li><a href=https://andydote.co.uk/tags/infrastructure/>infrastructure</a></li><li><a href=https://andydote.co.uk/tags/aws/>aws</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2021/03/12/nodejs-opentelemetry-newrelic/><span class=title>« Prev Page</span><br><span>Getting NodeJS OpenTelemetry data into NewRelic</span>
</a><a class=next href=https://andydote.co.uk/2020/11/03/docker-multi-output/><span class=title>Next Page »</span><br><span>Forking Multi Container Docker Builds</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>