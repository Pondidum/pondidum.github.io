<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Expression Rules, Version 2 | Andy Dote</title><meta name=keywords content="design,c#"><meta name=description content="Recently I have written a rules engine for a very large menu system in an application I work on. Many of the rules apply many items, so I didn&rsquo;t wish to have to express the same rule many times. To avoid this, the rule engine DSL was born:
Concerns.When(item => /* rule of some sort */) .AppliesToAll() .Except(MenuItems.ToggleHidden, MenuItems.Refresh) And rules are rolled together, so a specific menu item must have all of its rules evaluating to true to be displayed."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2011/02/09/expression-rules-version-2/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Expression Rules, Version 2"><meta property="og:description" content="Recently I have written a rules engine for a very large menu system in an application I work on. Many of the rules apply many items, so I didn&rsquo;t wish to have to express the same rule many times. To avoid this, the rule engine DSL was born:
Concerns.When(item => /* rule of some sort */) .AppliesToAll() .Except(MenuItems.ToggleHidden, MenuItems.Refresh) And rules are rolled together, so a specific menu item must have all of its rules evaluating to true to be displayed."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2011/02/09/expression-rules-version-2/"><meta property="article:section" content="post"><meta property="article:published_time" content="2011-02-09T00:00:00+00:00"><meta property="article:modified_time" content="2011-02-09T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Expression Rules, Version 2"><meta name=twitter:description content="Recently I have written a rules engine for a very large menu system in an application I work on. Many of the rules apply many items, so I didn&rsquo;t wish to have to express the same rule many times. To avoid this, the rule engine DSL was born:
Concerns.When(item => /* rule of some sort */) .AppliesToAll() .Except(MenuItems.ToggleHidden, MenuItems.Refresh) And rules are rolled together, so a specific menu item must have all of its rules evaluating to true to be displayed."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Expression Rules, Version 2","item":"https://andydote.co.uk/2011/02/09/expression-rules-version-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Expression Rules, Version 2","name":"Expression Rules, Version 2","description":"Recently I have written a rules engine for a very large menu system in an application I work on. Many of the rules apply many items, so I didn\u0026rsquo;t wish to have to express the same rule many times. To avoid this, the rule engine DSL was born:\nConcerns.When(item =\u0026gt; /* rule of some sort */) .AppliesToAll() .Except(MenuItems.ToggleHidden, MenuItems.Refresh) And rules are rolled together, so a specific menu item must have all of its rules evaluating to true to be displayed.","keywords":["design","c#"],"articleBody":"Recently I have written a rules engine for a very large menu system in an application I work on. Many of the rules apply many items, so I didn’t wish to have to express the same rule many times. To avoid this, the rule engine DSL was born:\nConcerns.When(item =\u003e /* rule of some sort */) .AppliesToAll() .Except(MenuItems.ToggleHidden, MenuItems.Refresh) And rules are rolled together, so a specific menu item must have all of its rules evaluating to true to be displayed.\nThe problem arose when an item was displaying when it shouldn’t (or vice versa). Debugging with rules specified like this was a pain, and when I saw the article about ExpressionRules by Daniel Wertheim, I thought it would help solve my problem. He replaces Lambda conditions with a class and implicit operator, allowing code to be changed from something like this:\nvar bonusCustomers = _customers.Where(c =\u003e (c.NumOfYearsAsMember == 0 \u0026\u0026 c.CashSpent \u003e= 3000) || (c.NumOfYearsAsMember \u003e 0 \u0026\u0026 (c.CashSpent / c.NumOfYearsAsMember) \u003e= 5000)); To something like this:\nvar bonusCustomers = _customers.Where(new IsBonusCustomer()); He does this using a base class and then inheriting from it to create the rule:\npublic class IsBonusCustomer : ExpressionRule, IIsBonusCustomer { public IsBonusCustomer() : base(c =\u003e (c.NumOfYearsAsMember == 0 \u0026\u0026 c.CashSpent \u003e= 3000) || (c.NumOfYearsAsMember \u003e 0 \u0026\u0026 (c.CashSpent / c.NumOfYearsAsMember) \u003e= 5000)) { } } I took his base class and modified it to this:\npublic abstract class ExpressionRule where T : class { protected abstract bool Rule(T item); public static implicit operator Func","wordCount":"330","inLanguage":"en","datePublished":"2011-02-09T00:00:00Z","dateModified":"2011-02-09T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2011/02/09/expression-rules-version-2/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Expression Rules, Version 2</h1><div class=post-meta><span title='2011-02-09 00:00:00 +0000 UTC'>February 9, 2011</span>&nbsp;·&nbsp;2 min</div></header><div class=post-content><p>Recently I have written a rules engine for a very large menu system in an application I work on. Many of the rules apply many items, so I didn&rsquo;t wish to have to express the same rule many times. To avoid this, the rule engine DSL was born:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>Concerns.When(item =&gt; <span style=color:#75715e>/* rule of some sort */</span>)
</span></span><span style=display:flex><span>		.AppliesToAll()
</span></span><span style=display:flex><span>		.Except(MenuItems.ToggleHidden, MenuItems.Refresh)
</span></span></code></pre></div><p>And rules are rolled together, so a specific menu item must have all of its rules evaluating to true to be displayed.</p><p>The problem arose when an item was displaying when it shouldn&rsquo;t (or vice versa). Debugging with rules specified like this was a pain, and when I saw the article about <a href=http://daniel.wertheim.se/2011/02/07/c-clean-up-your-linq-queries-and-lambda-expressions/>ExpressionRules</a> by <a href=http://daniel.wertheim.se/>Daniel Wertheim</a>, I thought it would help solve my problem. He replaces Lambda conditions with a class and implicit operator, allowing code to be changed from something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> bonusCustomers = _customers.Where(c =&gt;
</span></span><span style=display:flex><span>		(c.NumOfYearsAsMember == <span style=color:#ae81ff>0</span> &amp;&amp; c.CashSpent &gt;= <span style=color:#ae81ff>3000</span>) ||
</span></span><span style=display:flex><span>		(c.NumOfYearsAsMember &gt; <span style=color:#ae81ff>0</span> &amp;&amp; (c.CashSpent / c.NumOfYearsAsMember) &gt;= <span style=color:#ae81ff>5000</span>));
</span></span></code></pre></div><p>To something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> bonusCustomers = _customers.Where(<span style=color:#66d9ef>new</span> IsBonusCustomer());
</span></span></code></pre></div><p>He does this using a base class and then inheriting from it to create the rule:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IsBonusCustomer</span> : ExpressionRule&lt;Customer&gt;, IIsBonusCustomer
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> IsBonusCustomer()
</span></span><span style=display:flex><span>		: <span style=color:#66d9ef>base</span>(c =&gt;
</span></span><span style=display:flex><span>				(c.NumOfYearsAsMember == <span style=color:#ae81ff>0</span> &amp;&amp; c.CashSpent &gt;= <span style=color:#ae81ff>3000</span>) ||
</span></span><span style=display:flex><span>				(c.NumOfYearsAsMember &gt; <span style=color:#ae81ff>0</span> &amp;&amp; (c.CashSpent / c.NumOfYearsAsMember) &gt;= <span style=color:#ae81ff>5000</span>))
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I took his base class and modified it to this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExpressionRule</span>&lt;T&gt; <span style=color:#66d9ef>where</span> T : <span style=color:#66d9ef>class</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>bool</span> Rule(T item);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>operator</span> Func&lt;T, <span style=color:#66d9ef>bool</span>&gt;(ExpressionRule&lt;T&gt; item)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> item.Rule;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> Evaluate(T item)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> Rule(item);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This means the IsBonusCustomer now becomes this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IsBonusCustomer</span> : ExpressionRule&lt;Customer&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>bool</span> Rule(Customer customer)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> (c.NumOfYearsAsMember == <span style=color:#ae81ff>0</span> &amp;&amp; c.CashSpent &gt;= <span style=color:#ae81ff>3000</span>) ||
</span></span><span style=display:flex><span>			   (c.NumOfYearsAsMember &gt; <span style=color:#ae81ff>0</span> &amp;&amp; (c.CashSpent / c.NumOfYearsAsMember) &gt;= <span style=color:#ae81ff>5000</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Not only do we still have the readability of the first version, but a full function that can have logging added to it, and easier debugging.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/design/>design</a></li><li><a href=https://andydote.co.uk/tags/c#/>c#</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2011/03/17/missuse-of-narrowing-implicit-operators/><span class=title>« Prev Page</span><br><span>(Miss)Use of Narrowing-Implicit Operators</span></a>
<a class=next href=https://andydote.co.uk/2010/11/13/adding-mspec-to-your-git-bash/><span class=title>Next Page »</span><br><span>Adding MSpec to your Git Bash</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>