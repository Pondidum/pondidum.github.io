<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Explicit vs Implicit code | Andy Dote</title><meta name=keywords content="golang,debugging,typescript"><meta name=description content="A system I am working on at the moment started giving errors occasionally, say 5 times out of 10,000 messages or so. The error was pretty straightforward:
json: cannot unmarshal array into Go struct field Thing.Parts of type Parts The data structure it is referring to looks like this:
type Thing struct { Parts Parts } type Parts struct { Part []Part } Which represents the (slightly weird) json structure we receive in a message:"><meta name=author content><link rel=canonical href=https://andydote.co.uk/2025/01/19/explicit-vs-implicit-code/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Explicit vs Implicit code"><meta property="og:description" content="A system I am working on at the moment started giving errors occasionally, say 5 times out of 10,000 messages or so. The error was pretty straightforward:
json: cannot unmarshal array into Go struct field Thing.Parts of type Parts The data structure it is referring to looks like this:
type Thing struct { Parts Parts } type Parts struct { Part []Part } Which represents the (slightly weird) json structure we receive in a message:"><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2025/01/19/explicit-vs-implicit-code/"><meta property="article:section" content="post"><meta name=twitter:card content="summary"><meta name=twitter:title content="Explicit vs Implicit code"><meta name=twitter:description content="A system I am working on at the moment started giving errors occasionally, say 5 times out of 10,000 messages or so. The error was pretty straightforward:
json: cannot unmarshal array into Go struct field Thing.Parts of type Parts The data structure it is referring to looks like this:
type Thing struct { Parts Parts } type Parts struct { Part []Part } Which represents the (slightly weird) json structure we receive in a message:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Explicit vs Implicit code","item":"https://andydote.co.uk/2025/01/19/explicit-vs-implicit-code/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Explicit vs Implicit code","name":"Explicit vs Implicit code","description":"A system I am working on at the moment started giving errors occasionally, say 5 times out of 10,000 messages or so. The error was pretty straightforward:\njson: cannot unmarshal array into Go struct field Thing.Parts of type Parts The data structure it is referring to looks like this:\ntype Thing struct { Parts Parts } type Parts struct { Part []Part } Which represents the (slightly weird) json structure we receive in a message:","keywords":["golang","debugging","typescript"],"articleBody":"A system I am working on at the moment started giving errors occasionally, say 5 times out of 10,000 messages or so. The error was pretty straightforward:\njson: cannot unmarshal array into Go struct field Thing.Parts of type Parts The data structure it is referring to looks like this:\ntype Thing struct { Parts Parts } type Parts struct { Part []Part } Which represents the (slightly weird) json structure we receive in a message:\n{ \"thing\": { \"parts\": { \"part\": [ { \"name\": \"one\" }, { \"name\": \"two\" } ] } } } However, rarely, we receive a json document which looks like this instead, where the parts struct has instead become an array, with one object containing the part array:\n{ \"thing\": { \"parts\": [\t{ \"part\": [ { \"name\": \"one\" }, { \"name\": \"two\" } ] } ] } } In the interest of keeping the software running while digging through for the root cause of this, I added an implementation of the json.Unmarshaler interface to the Parts struct to allow it to handle both forms of json:\n// duplicate of the Parts type, to prevent recursive calls to the UnmarshalJSON method type dto struct { Part []Part } func (i *Parts) UnmarshalJSON(b []byte) error { // this is the standard format that json arrives in. normal := dto{} err := json.Unmarshal(b, \u0026normal) if err == nil { t.Part = normal.Part return nil } // sometimes, we get json with an extra array, so if we get an error about that, // try the alternative structure if jsonErr, ok := err.(*json.UnmarshalTypeError); ok \u0026\u0026 jsonErr.Value == \"array\" { weird := []dto{} if err := json.Unmarshal(b, \u0026weird); err != nil { return err } if len(weird) \u003e 0 { t.Part = weird[0].Part } return nil } return err } When I opened a pullrequest about this, one of my colleagues approved it, but also noted:\nfor once typescript would solve something more cleanly in my opinion\nAnd I agree, after deserialising, doing something like this is much less code, and basically has the same result.\nconst thing = JSON.parse(message); if (Array.isArray(thing.parts)) { thing.parts = thing.parts[0] } Down the Rabbit Hole Tracing back through the system to figure out where the message came from lead me back to a system which parses an XML document and, after doing some work on the result, emits the json message we handle. The XML itself has a pretty reasonable structure (and far larger than I am showing here, with tens, if not hundreds of nodes):\n","wordCount":"761","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2025/01/19/explicit-vs-implicit-code/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Explicit vs Implicit code</h1><div class=post-meta><span title='2025-01-19 00:00:00 +0000 UTC'>January 19, 2025</span>&nbsp;·&nbsp;4 min</div></header><div class=post-content><p>A system I am working on at the moment started giving errors occasionally, say 5 times out of 10,000 messages or so. The error was pretty straightforward:</p><pre tabindex=0><code>json: cannot unmarshal array into Go struct field Thing.Parts of type Parts
</code></pre><p>The data structure it is referring to looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Thing</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Parts</span> <span style=color:#a6e22e>Parts</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Parts</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Part</span> []<span style=color:#a6e22e>Part</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Which represents the (slightly weird) json structure we receive in a message:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#f92672>&#34;thing&#34;</span>: {
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;parts&#34;</span>: {
</span></span><span style=display:flex><span>			<span style=color:#f92672>&#34;part&#34;</span>: [
</span></span><span style=display:flex><span>				{ <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;one&#34;</span> },
</span></span><span style=display:flex><span>				{ <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;two&#34;</span> }
</span></span><span style=display:flex><span>			]
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>However, rarely, we receive a json document which looks like this instead, where the <code>parts</code> struct has instead become an array, with one object containing the <code>part</code> array:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#f92672>&#34;thing&#34;</span>: {
</span></span><span style=display:flex><span>		<span style=color:#f92672>&#34;parts&#34;</span>: [	
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#f92672>&#34;part&#34;</span>: [
</span></span><span style=display:flex><span>					{ <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;one&#34;</span> },
</span></span><span style=display:flex><span>					{ <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;two&#34;</span> }
</span></span><span style=display:flex><span>				]
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		]
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In the interest of keeping the software running while digging through for the root cause of this, I added an implementation of the <code>json.Unmarshaler</code> interface to the <code>Parts</code> struct to allow it to handle both forms of json:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// duplicate of the Parts type, to prevent recursive calls to the UnmarshalJSON method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>dto</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Part</span> []<span style=color:#a6e22e>Part</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>i</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Parts</span>) <span style=color:#a6e22e>UnmarshalJSON</span>(<span style=color:#a6e22e>b</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// this is the standard format that json arrives in.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>normal</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dto</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>b</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>normal</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Part</span> = <span style=color:#a6e22e>normal</span>.<span style=color:#a6e22e>Part</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// sometimes, we get json with an extra array, so if we get an error about that,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// try the alternative structure
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>jsonErr</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>err</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>UnmarshalTypeError</span>); <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>jsonErr</span>.<span style=color:#a6e22e>Value</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;array&#34;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>weird</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>dto</span>{}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>b</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>weird</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>weird</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Part</span> = <span style=color:#a6e22e>weird</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Part</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When I opened a pullrequest about this, one of my colleagues approved it, but also noted:</p><blockquote><p>for once typescript would solve something more cleanly in my opinion</p></blockquote><p>And I agree, after deserialising, doing something like this is much less code, and basically has the same result.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>thing</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (Array.<span style=color:#a6e22e>isArray</span>(<span style=color:#a6e22e>thing</span>.<span style=color:#a6e22e>parts</span>)) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>thing</span>.<span style=color:#a6e22e>parts</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>thing</span>.<span style=color:#a6e22e>parts</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=down-the-rabbit-hole>Down the Rabbit Hole<a hidden class=anchor aria-hidden=true href=#down-the-rabbit-hole>#</a></h2><p>Tracing back through the system to figure out where the message came from lead me back to a system which parses an XML document and, after doing some work on the result, emits the json message we handle. The XML itself has a pretty reasonable structure (and far larger than I am showing here, with tens, if not hundreds of nodes):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;Thing&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;Parts&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;Part</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;one&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;Part</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;two&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;/Parts&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/Thing&gt;</span>
</span></span></code></pre></div><p>Which it mangles into that weird json structure. It does, however, do some sanitisation to the <code>Thing</code> before writing it out, and I found one for dealing with the <code>Parts</code> property:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// if there is only one part, the parser doesn&#39;t emit an array, so force an array.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>Array.<span style=color:#a6e22e>isArray</span>(<span style=color:#a6e22e>thing</span>.<span style=color:#a6e22e>parts</span>.<span style=color:#a6e22e>part</span>)) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>thing</span>.<span style=color:#a6e22e>parts</span>.<span style=color:#a6e22e>part</span> <span style=color:#f92672>=</span> [ <span style=color:#a6e22e>part</span> ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Interesting! but this is a different bug to the one we&rsquo;ve just seen; in our case the <code>Parts</code> became an array&mldr;</p><p>Checking the original XML file which was processed, it looked entirely normal until I noticed that it has two <code>Parts</code> nodes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;Thing&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;Parts&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;Part</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;one&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;Part</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;two&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;/Parts&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>&lt;!-- many nodes later --&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;Parts&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;Part</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;three&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;Part</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;four&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;/Parts&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/Thing&gt;</span>
</span></span></code></pre></div><p>So the fix is to add another sanitisation to our parser:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>if</span> (Array.<span style=color:#a6e22e>isArray</span>(<span style=color:#a6e22e>thing</span>.<span style=color:#a6e22e>parts</span>)) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>thing</span>.<span style=color:#a6e22e>parts</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>part</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>flatMap</span>(<span style=color:#a6e22e>thing</span>.<span style=color:#a6e22e>parts</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This fixes the data as soon as it appears in our system; however, searching our codebase revealed that, up until this fix, many places had been missing data, or incorrectly handling the data.</p><p>While the TypeScript types written for the <code>Thing</code> are correct, that doesn&rsquo;t help when the data is supplied at runtime and apparently can have varying shapes.</p><h2 id=the-tradeoff>The Tradeoff<a hidden class=anchor aria-hidden=true href=#the-tradeoff>#</a></h2><p>The tradeoff between typescript/javascript and Go feels like this to me:</p><p>Go causes me to notice when something isn&rsquo;t working, as errors start being returned about data not matching the shape it was expected to be in. Fixing the issues in general, require more code than the same fix in typescript would.</p><p>Typescript has short code, but as its only a compile-time type checking system, when weird data starts arriving, you don&rsquo;t get any errors (directly, things later on can break however.)</p><p>For me, I would rather have slightly longer code which is more explicit, and tells me when something goes wrong, rather than silently continuing. The likelihood of a silent error in serialisation leading to data loss or corruption is just too high.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/golang/>golang</a></li><li><a href=https://andydote.co.uk/tags/debugging/>debugging</a></li><li><a href=https://andydote.co.uk/tags/typescript/>typescript</a></li></ul><nav class=paginav><a class=next href=https://andydote.co.uk/2025/01/11/debugging-gdi-handles/><span class=title>Next Page »</span><br><span>Debugging GDI Handle Leaks</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>