<!doctype html><html lang=en dir=auto><head><meta name=generator content="Hugo 0.118.2"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Andy Dote</title><meta name=description content><meta name=author content><link rel=canonical href=https://andydote.co.uk/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://andydote.co.uk/rss.xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Andy Dote"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://andydote.co.uk/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Andy Dote"><meta name=twitter:description content><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"Andy Dote","url":"https://andydote.co.uk","description":"","thumbnailUrl":"https://andydote.co.uk/favicon.ico","sameAs":[]}</script></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-entry><header class=entry-header><h2>Pulumi Conditional Infrastructure for Speed</h2></header><div class=entry-content><p>One of the reasons I prefer Pulumi over Terraform is the additional control I have over my processes due to the fact that it’s a programming language.
For example, I have a CLI, that creates a cluster of machines for a user; the machines use IAM Authentication with Vault so that they can request certificates on boot. The trouble with this application is that it is slow; it takes 175 seconds on average to provision the machines, write the IAM information to Vault, and then re-run the cloud-init script on all the machines in the cluster (as when they first booted, the configuration hadn’t been written to Vault yet....</p></div><footer class=entry-footer><span title='2022-07-17 00:00:00 +0000 UTC'>July 17, 2022</span>&nbsp;·&nbsp;3 min</footer><a class=entry-link aria-label="post link to Pulumi Conditional Infrastructure for Speed" href=https://andydote.co.uk/2022/07/17/pulumi-faster-processes/></a></article><article class=post-entry><header class=entry-header><h2>An NGINX and DNS based outage</h2></header><div class=entry-content><p>I recently encountered a behaviour in Nginx that I didn’t expect and caused a production outage in the process. While I would love to blame DNS for this, as it’s usually the cause of most network-related issues, in this case, the fault lies with Nginx.
I was running a very simple Nginx proxy, relaying an internal service to the outside world. The internal service is behind an AWS ALB, and the Nginx configuration was proxying to the ALB’s FQDN:...</p></div><footer class=entry-footer><span title='2022-04-23 00:00:00 +0000 UTC'>April 23, 2022</span>&nbsp;·&nbsp;3 min</footer><a class=entry-link aria-label="post link to An NGINX and DNS based outage" href=https://andydote.co.uk/2022/04/23/nginx-dns/></a></article><article class=post-entry><header class=entry-header><h2>The Operator Pattern in Nomad</h2></header><div class=entry-content><p>The Operator Pattern from Kubernetes is an excellent way of handling tasks in a cluster in an automated way, for example, provisioning applications, running backups, requesting certificates, and injecting chaos testing.
As a Nomad user, I wanted to do something similar for my clusters, so I set about seeing how it would be possible. It turns out; it is much easier than I expected! While Nomad doesn’t support the idea of Custom Resource Definitions, we can achieve an operator by utilising a regular Nomad job and the nomad HTTP API....</p></div><footer class=entry-footer><span title='2021-11-22 00:00:00 +0000 UTC'>November 22, 2021</span>&nbsp;·&nbsp;9 min</footer><a class=entry-link aria-label="post link to The Operator Pattern in Nomad" href=https://andydote.co.uk/2021/11/22/nomad-operator-pattern/></a></article><article class=post-entry><header class=entry-header><h2>How do you tag docker images?</h2></header><div class=entry-content><p>An interesting question came up at work today: how do you tag your Docker images? In previous projects, I’ve always used a short git sha, or sometimes a semver, but with no great consistency.
As luck would have it, I had pushed for a change in tagging format at a client not so long ago as the method we were using didn’t make a lot of sense and, worst of all, it was a manual process....</p></div><footer class=entry-footer><span title='2021-11-10 00:00:00 +0000 UTC'>November 10, 2021</span>&nbsp;·&nbsp;6 min</footer><a class=entry-link aria-label="post link to How do you tag docker images?" href=https://andydote.co.uk/2021/11/10/docker-tagging/></a></article><article class=post-entry><header class=entry-header><h2>The Problem with CPUs and Kubernetes</h2></header><div class=entry-content><p>Key Takeaway: os .cpus() returns the number of cores on a Kubernetes host, not the number of cores assigned to a pod.
Investigating excessive memory usage Recently, when I was looking through a cluster health dashboard for a Kubernetes cluster, I noticed that one of the applications deployed was using a considerable amount of RAM - way more than I thought could be reasonable. Each instance (pod) of the application used approximately 8 GB of RAM, which was definitely excessive for a reasonably simple NodeJS webserver....</p></div><footer class=entry-footer><span title='2021-06-02 00:00:00 +0000 UTC'>June 2, 2021</span>&nbsp;·&nbsp;2 min</footer><a class=entry-link aria-label="post link to The Problem with CPUs and Kubernetes" href=https://andydote.co.uk/2021/06/02/os-cpus-and-kubernetes/></a></article><article class=post-entry><header class=entry-header><h2>Adding Observability to Vault</h2></header><div class=entry-content><p>One of the things I like to do when setting up a Vault cluster is to visualise all the operations Vault is performing, which helps see usage patterns changing, whether there are lots of failed requests coming in, and what endpoints are receiving the most traffic.
While Vault has a lot of data available in Prometheus telemetry, the kind of information I am after is best taken from the Audit backend....</p></div><footer class=entry-footer><span title='2021-05-27 00:00:00 +0000 UTC'>May 27, 2021</span>&nbsp;·&nbsp;7 min</footer><a class=entry-link aria-label="post link to Adding Observability to Vault" href=https://andydote.co.uk/2021/05/27/vault-observe/></a></article><article class=post-entry><header class=entry-header><h2>Getting NodeJS OpenTelemetry data into NewRelic</h2></header><div class=entry-content><p>I had the need to get some OpenTelemetry data out of a NodeJS application, and into NewRelic’s distributed tracing service, but found that there is no way to do it directly, and in this use case, adding a separate collector is more hassle than it’s worth.
Luckily, there is an NodeJS OpenTelemetry library which can report to Zipkin, and NewRelic can also ingest Zipkin format data.
To use it was relatively straight forward:...</p></div><footer class=entry-footer><span title='2021-03-12 00:00:00 +0000 UTC'>March 12, 2021</span>&nbsp;·&nbsp;2 min</footer><a class=entry-link aria-label="post link to Getting NodeJS OpenTelemetry data into NewRelic" href=https://andydote.co.uk/2021/03/12/nodejs-opentelemetry-newrelic/></a></article><article class=post-entry><header class=entry-header><h2>Observability with Infrastructure as Code</h2></header><div class=entry-content><p>This article was originally published on the Pulumi blog.
When using the Pulumi Automation API to create applications which can provision infrastructure, it is very handy to be able to use observability techniques to ensure the application functions correctly and to help see where performance bottlenecks are.
One of the applications I work on creates a VPC and Bastion host and then stores the credentials into a Vault instance. The problem is that the “create infrastructure” part is an opaque blob, in that I can see it takes 129 seconds to create, but I can’t see what it’s doing, or why it takes this amount of time....</p></div><footer class=entry-footer><span title='2021-03-01 00:00:00 +0000 UTC'>March 1, 2021</span>&nbsp;·&nbsp;4 min</footer><a class=entry-link aria-label="post link to Observability with Infrastructure as Code" href=https://andydote.co.uk/2021/03/01/observability-with-infrastructure-as-code/></a></article><article class=post-entry><header class=entry-header><h2>Forking Multi Container Docker Builds</h2></header><div class=entry-content><p>Following on from my last post on Isolated Multistage Docker Builds, I thought it would be useful to cover another advantage to splitting your dockerfiles: building different output containers from a common base.
The Problem When I have an application which when built, needs to have all assets in one container, and a subset of assets in a second container.
For example, writing a node webapp, where you want the compiled/bundled static assets available in the container as a fallback, and also stored in an nginx container for serving....</p></div><footer class=entry-footer><span title='2020-11-03 00:00:00 +0000 UTC'>November 3, 2020</span>&nbsp;·&nbsp;3 min</footer><a class=entry-link aria-label="post link to Forking Multi Container Docker Builds" href=https://andydote.co.uk/2020/11/03/docker-multi-output/></a></article><article class=post-entry><header class=entry-header><h2>Isolated Docker Multistage Images</h2></header><div class=entry-content><p>Often when building applications, I will use a multistage docker build for output container size and efficiency, but will run the build in two halves, to make use of the extra assets in the builder container, something like this:
docker build \ --target builder \ -t builder:$GIT_COMMIT \ . docker run --rm \ -v "$PWD/artefacts/tests:/artefacts/tests" \ builder:$GIT_COMMIT \ yarn ci:test docker run --rm \ -v "$PWD/artefacts/lint:/artefacts/lint" \ builder:$GIT_COMMIT \ yarn ci:lint docker build \ --cache-from builder:$GIT_COMMIT \ --target output \ -t app:$GIT_COMMIT \ ....</p></div><footer class=entry-footer><span title='2020-11-01 00:00:00 +0000 UTC'>November 1, 2020</span>&nbsp;·&nbsp;3 min</footer><a class=entry-link aria-label="post link to Isolated Docker Multistage Images" href=https://andydote.co.uk/2020/11/01/docker-multistage-containers/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://andydote.co.uk/page/2/>« Prev Page</a>
<a class=next href=https://andydote.co.uk/page/4/>Next Page »</a></nav></footer></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>