<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using a Micro ORM to decouple your DB Access | Andy Dote</title><meta name=keywords content="design,c#,automapper,sql,memento"><meta name=description content="One of the databases I use on a regular bases has a rather interesting column naming scheme; all columns have a prefix, based on the table name. For example, the table containing people would have the prefix PEO_, so you would have this:
Select * from People PEO_PersonID, PEO_FirstName, PEO_LastName, PEO_DoB ----------------------------------------------------- 1 John Jones 1984-07-15 I believe the idea was so that when querying, you would not have any column name clashes."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2014/03/29/using-a-micro-orm-to-decouple-your-db-access/><link crossorigin=anonymous href=/assets/css/stylesheet.min.2b33c247bf6959372dd097f2cfdcd9f4d5019027cd9b1e28ae3d14c17c37ac00.css integrity="sha256-KzPCR79pWTct0Jfyz9zZ9NUBkCfNmx4orj0UwXw3rAA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Using a Micro ORM to decouple your DB Access"><meta property="og:description" content="One of the databases I use on a regular bases has a rather interesting column naming scheme; all columns have a prefix, based on the table name. For example, the table containing people would have the prefix PEO_, so you would have this:
Select * from People PEO_PersonID, PEO_FirstName, PEO_LastName, PEO_DoB ----------------------------------------------------- 1 John Jones 1984-07-15 I believe the idea was so that when querying, you would not have any column name clashes."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2014/03/29/using-a-micro-orm-to-decouple-your-db-access/"><meta property="article:section" content="post"><meta property="article:published_time" content="2014-03-29T00:00:00+00:00"><meta property="article:modified_time" content="2014-03-29T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using a Micro ORM to decouple your DB Access"><meta name=twitter:description content="One of the databases I use on a regular bases has a rather interesting column naming scheme; all columns have a prefix, based on the table name. For example, the table containing people would have the prefix PEO_, so you would have this:
Select * from People PEO_PersonID, PEO_FirstName, PEO_LastName, PEO_DoB ----------------------------------------------------- 1 John Jones 1984-07-15 I believe the idea was so that when querying, you would not have any column name clashes."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Using a Micro ORM to decouple your DB Access","item":"https://andydote.co.uk/2014/03/29/using-a-micro-orm-to-decouple-your-db-access/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using a Micro ORM to decouple your DB Access","name":"Using a Micro ORM to decouple your DB Access","description":"One of the databases I use on a regular bases has a rather interesting column naming scheme; all columns have a prefix, based on the table name. For example, the table containing people would have the prefix PEO_, so you would have this:\nSelect * from People PEO_PersonID, PEO_FirstName, PEO_LastName, PEO_DoB ----------------------------------------------------- 1 John Jones 1984-07-15 I believe the idea was so that when querying, you would not have any column name clashes.","keywords":["design","c#","automapper","sql","memento"],"articleBody":"One of the databases I use on a regular bases has a rather interesting column naming scheme; all columns have a prefix, based on the table name. For example, the table containing people would have the prefix PEO_, so you would have this:\nSelect * from People PEO_PersonID, PEO_FirstName, PEO_LastName, PEO_DoB ----------------------------------------------------- 1 John Jones 1984-07-15 I believe the idea was so that when querying, you would not have any column name clashes. This of course breaks down if you have to join on the same table twice.\nThis structure presents a problem when it comes to reading the tables into objects in code, as it removes the ability to use an orm - I have yet to see one which allows you to specify a prefix to be used on all columns in a table.\nThe existing entities are all manually read, and follow the same pattern:\npublic abstract class Entity { public void Load() { using (var reader = SqlHelper.ExecuteReader(\"connectionstring\", ReadProcedureName)) { if (reader.Read()) { Read(reader); } } } } public class Person : Entity { public int ID { get; set; } public string FirstName { get; set; } public string LastName { get; set; } public DateTime DoB { get; set; } protected override String ReadProcedureName { get { return \"p_getPerson\"; } } protected override void Read(IDataReader reader) { ID = reader.GetInt32(0); FirstName = reader.GetString(1); LastName = reader.GetString(2); DoB = reader.GetDateTime(3); } } Note how columns are read in order, which means two things: you cannot use select * as your query, and you cannot change column order etc.\nTo help split this so we can start using an ORM to do the mapping for us, we can utilise the Memento Pattern. First we create a new object, which will be used to read and write from the database:\npublic class PersonDto { public int PEO_ID { get; set; } public string PEO_FirstName { get; set; } public string PEO_LastName { get; set; } public DateTime PEO_DoB { get; set; } } Note the property names match the column names of the table in the db, our read method could then get changed to this:\npublic abstract class Entity { protected virtual string ReadProcedureName { get { return \"\"; } } public void Load() { var results = _connection.Query(ReadProcedureName).ToList(); if (results.Any()) { Read(results.First()); } } protected virtual void Read(TDto dto) { } } public class Person : Entity { public int ID { get; set; } public string FirstName { get; set; } public string LastName { get; set; } public DateTime DoB { get; set; } protected override void Read(PersonDto dto) { ID = dto.PEO_ID; FirstName = dto.PEO_FirstName; LastName = dto.PEO_LastName; DoB = dto.PEO_DoB; } } This gives us several benefits, in that we can change column naming and ordering freely without effecting the actual Person object, and we have made the class slightly more testable - we can pass it a faked PersonDto if we needed to load it with some data for a test.\nWe can however make another improvement to this - namely in the Read method, as this is a prime candidate for AutoMapper. To get this to work though, have two choices: the first is to manually specify the mappings of one object to the other, and the second is to write a profile which will do the work for us. Unsurprisingly, I went with the second option:\npublic class PrefixProfile : Profile { private readonly IDictionary _typeMap; public PrefixProfile(IDictionary typeMap ) { _typeMap = typeMap; } public override string ProfileName { get { return \"PrefixProfile\"; } } protected override void Configure() { foreach (var pair in _typeMap) { var prefix = GetPrefix(pair.Value.GetProperties()); RecognizeDestinationPrefixes(prefix); RecognizePrefixes(prefix); CreateMap(pair.Key, pair.Value); CreateMap(pair.Value, pair.Key); } } private string GetPrefix(IEnumerable properties) { return properties .Select(GetPrefixFromProperty) .FirstOrDefault(p =\u003e String.IsNullOrWhiteSpace(p) == false); } protected virtual string GetPrefixFromProperty(PropertyInfo property) { var name = property.Name; return name.IndexOf(\"_\", StringComparison.OrdinalIgnoreCase) \u003e= 0 ? name.Substring(0, name.IndexOf(\"_\", StringComparison.OrdinalIgnoreCase) + 1) : String.Empty; } } This class takes in a dictionary of types (in this case will be things like Person =\u003e PersonDto). It goes through each pair in the list and determines the prefix for the destination class (the dto). The GetPrefixFromProperty is virtual so that I can customise it for other uses later.\nTo use this we just need to initialise AutoMapper with the class once on start up:\nvar map = new Dictionary(); map.Add(typeof (Person), typeof (PersonDto)); Mapper.Initialize(config =\u003e config.AddProfile(new PrefixProfile(map))); This means our Person class becomes very small:\npublic class Person : Entity { public int ID { get; set; } public string FirstName { get; set; } public string LastName { get; set; } public DateTime DoB { get; set; } } And the Entity class can take care of the mapping for us, but utilising AutoMapperâ€™s Type based Map method:\npublic abstract class Entity { protected virtual string ReadProcedureName { get { return \"\"; } } public void Load() { var _connection = new SqlConnection(\"\"); var results = _connection.Query(ReadProcedureName).ToList(); if (results.Any()) { Read(results.First()); } } protected void Read(TDto dto) { Mapper.Map(dto, this, typeof(TDto), GetType()); } } While the design of having each entity responsible for saving and loading of itself is not the best design, it is what the existing system has in place (around 400 entities exist at last count). By taking these steps we can remove a lot of boilerplate code from our codebase, which means when we wish to change to a different architecture (such as session or transaction objects in a similar style to RavenDBâ€™s ISession), it will be an easier transition.\n","wordCount":"930","inLanguage":"en","datePublished":"2014-03-29T00:00:00Z","dateModified":"2014-03-29T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2014/03/29/using-a-micro-orm-to-decouple-your-db-access/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Using a Micro ORM to decouple your DB Access</h1><div class=post-meta><span title='2014-03-29 00:00:00 +0000 UTC'>March 29, 2014</span>&nbsp;Â·&nbsp;5 min</div></header><div class=post-content><p>One of the databases I use on a regular bases has a rather interesting column naming scheme; all columns have a prefix, based on the table name. For example, the table containing people would have the prefix <code>PEO_</code>, so you would have this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>Select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> People
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PEO_PersonID, PEO_FirstName, PEO_LastName, PEO_DoB
</span></span><span style=display:flex><span><span style=color:#75715e>-----------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>1</span>             John           Jones         <span style=color:#ae81ff>1984</span><span style=color:#f92672>-</span><span style=color:#ae81ff>07</span><span style=color:#f92672>-</span><span style=color:#ae81ff>15</span>
</span></span></code></pre></div><p>I believe the idea was so that when querying, you would not have any column name clashes. This of course breaks down if you have to join on the same table twice.</p><p>This structure presents a problem when it comes to reading the tables into objects in code, as it removes the ability to use an orm - I have yet to see one which allows you to specify a prefix to be used on all columns in a table.</p><p>The existing entities are all manually read, and follow the same pattern:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Entity</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Load()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>using</span> (<span style=color:#66d9ef>var</span> reader = SqlHelper.ExecuteReader(<span style=color:#e6db74>&#34;connectionstring&#34;</span>, ReadProcedureName))
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (reader.Read())
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				Read(reader);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Person</span> : Entity
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> ID { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> FirstName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> LastName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> DateTime DoB { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> String ReadProcedureName { <span style=color:#66d9ef>get</span> { <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;p_getPerson&#34;</span>; } }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> Read(IDataReader reader)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		ID = reader.GetInt32(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>		FirstName = reader.GetString(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>		LastName = reader.GetString(<span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>		DoB = reader.GetDateTime(<span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note how columns are read in order, which means two things: you cannot use <code>select *</code> as your query, and you cannot change column order etc.</p><p>To help split this so we can start using an ORM to do the mapping for us, we can utilise the <a href=http://www.dofactory.com/Patterns/PatternMemento.aspx>Memento Pattern</a>. First we create a new object, which will be used to read and write from the database:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PersonDto</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> PEO_ID { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> PEO_FirstName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> PEO_LastName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> DateTime PEO_DoB { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note the property names match the column names of the table in the db, our read method could then get changed to this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Entity</span>&lt;TDto&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>string</span> ReadProcedureName { <span style=color:#66d9ef>get</span> { <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>; } }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Load()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> results = _connection.Query&lt;TDto&gt;(ReadProcedureName).ToList();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (results.Any())
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			Read(results.First());
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> Read(TDto dto)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Person</span> : Entity&lt;PersonDto&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> ID { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> FirstName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> LastName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> DateTime DoB { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> Read(PersonDto dto)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		ID = dto.PEO_ID;
</span></span><span style=display:flex><span>		FirstName = dto.PEO_FirstName;
</span></span><span style=display:flex><span>		LastName = dto.PEO_LastName;
</span></span><span style=display:flex><span>		DoB = dto.PEO_DoB;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This gives us several benefits, in that we can change column naming and ordering freely without effecting the actual <code>Person</code> object, and we have made the class slightly more testable - we can pass it a faked <code>PersonDto</code> if we needed to load it with some data for a test.</p><p>We can however make another improvement to this - namely in the <code>Read</code> method, as this is a prime candidate for <a href=http://automapper.org/>AutoMapper</a>. To get this to work though, have two choices: the first is to manually specify the mappings of one object to the other, and the second is to write a profile which will do the work for us. Unsurprisingly, I went with the second option:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PrefixProfile</span> : Profile
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IDictionary&lt;Type, Type&gt; _typeMap;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> PrefixProfile(IDictionary&lt;Type, Type&gt; typeMap )
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		_typeMap = typeMap;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>string</span> ProfileName
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>get</span> { <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;PrefixProfile&#34;</span>; }
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> Configure()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>var</span> pair <span style=color:#66d9ef>in</span> _typeMap)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>var</span> prefix = GetPrefix(pair.Value.GetProperties());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			RecognizeDestinationPrefixes(prefix);
</span></span><span style=display:flex><span>			RecognizePrefixes(prefix);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			CreateMap(pair.Key, pair.Value);
</span></span><span style=display:flex><span>			CreateMap(pair.Value, pair.Key);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>string</span> GetPrefix(IEnumerable&lt;PropertyInfo&gt; properties)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> properties
</span></span><span style=display:flex><span>			.Select(GetPrefixFromProperty)
</span></span><span style=display:flex><span>			.FirstOrDefault(p =&gt; String.IsNullOrWhiteSpace(p) == <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>string</span> GetPrefixFromProperty(PropertyInfo property)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> name = property.Name;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> name.IndexOf(<span style=color:#e6db74>&#34;_&#34;</span>, StringComparison.OrdinalIgnoreCase) &gt;= <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>			? name.Substring(<span style=color:#ae81ff>0</span>, name.IndexOf(<span style=color:#e6db74>&#34;_&#34;</span>, StringComparison.OrdinalIgnoreCase) + <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>			: String.Empty;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This class takes in a dictionary of types (in this case will be things like <code>Person</code> => <code>PersonDto</code>). It goes through each pair in the list and determines the prefix for the destination class (the dto). The <code>GetPrefixFromProperty</code> is virtual so that I can customise it for other uses later.</p><p>To use this we just need to initialise AutoMapper with the class once on start up:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> map = <span style=color:#66d9ef>new</span> Dictionary&lt;Type, Type&gt;();
</span></span><span style=display:flex><span>map.Add(<span style=color:#66d9ef>typeof</span> (Person), <span style=color:#66d9ef>typeof</span> (PersonDto));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Mapper.Initialize(config =&gt; config.AddProfile(<span style=color:#66d9ef>new</span> PrefixProfile(map)));
</span></span></code></pre></div><p>This means our <code>Person</code> class becomes very small:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Person</span> : Entity&lt;PersonDto&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> ID { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> FirstName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> LastName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> DateTime DoB { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And the <code>Entity</code> class can take care of the mapping for us, but utilising AutoMapper&rsquo;s Type based Map method:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Entity</span>&lt;TDto&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>string</span> ReadProcedureName { <span style=color:#66d9ef>get</span> { <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>; } }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Load()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> _connection = <span style=color:#66d9ef>new</span> SqlConnection(<span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> results = _connection.Query&lt;TDto&gt;(ReadProcedureName).ToList();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (results.Any())
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			Read(results.First());
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> Read(TDto dto)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		Mapper.Map(dto, <span style=color:#66d9ef>this</span>, <span style=color:#66d9ef>typeof</span>(TDto), GetType());
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>While the design of having each entity responsible for saving and loading of itself is not the best design, it is what the existing system has in place (around 400 entities exist at last count). By taking these steps we can remove a lot of boilerplate code from our codebase, which means when we wish to change to a different architecture (such as session or transaction objects in a similar style to RavenDB&rsquo;s ISession), it will be an easier transition.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/design/>design</a></li><li><a href=https://andydote.co.uk/tags/c#/>c#</a></li><li><a href=https://andydote.co.uk/tags/automapper/>automapper</a></li><li><a href=https://andydote.co.uk/tags/sql/>sql</a></li><li><a href=https://andydote.co.uk/tags/memento/>memento</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2014/05/04/rich-domain-modeling/><span class=title>Â« Prev Page</span><br><span>Writing Rich Domain Models</span></a>
<a class=next href=https://andydote.co.uk/2014/03/15/solid-principles-dip/><span class=title>Next Page Â»</span><br><span>SOLID Principles - DIP</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>