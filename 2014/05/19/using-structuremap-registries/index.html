<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using StructureMap Registries for better separation | Andy Dote</title><meta name=keywords content="design,c#,structuremap,separation,testing"><meta name=description content="When it comes to configuring StructureMap, it supports the use of Registries. Registries support everything that the standard configure method does(new Container(c => { /* */});).
There are two main reasons that I use the registries rather then doing all my configuration in the Container&rsquo;s lambda: separation of concerns (one registry per area of code) and easier testing (which we will go into shortly).
The only down side I can see to using registries is that it can scatter your configuration across your codebase - but if you have ReSharper, doing a &lsquo;Find Implementations&rsquo; on Registry will find them all for you, so it really isn&rsquo;t much of a down side."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2014/05/19/using-structuremap-registries/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Using StructureMap Registries for better separation"><meta property="og:description" content="When it comes to configuring StructureMap, it supports the use of Registries. Registries support everything that the standard configure method does(new Container(c => { /* */});).
There are two main reasons that I use the registries rather then doing all my configuration in the Container&rsquo;s lambda: separation of concerns (one registry per area of code) and easier testing (which we will go into shortly).
The only down side I can see to using registries is that it can scatter your configuration across your codebase - but if you have ReSharper, doing a &lsquo;Find Implementations&rsquo; on Registry will find them all for you, so it really isn&rsquo;t much of a down side."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2014/05/19/using-structuremap-registries/"><meta property="article:section" content="post"><meta property="article:published_time" content="2014-05-19T00:00:00+00:00"><meta property="article:modified_time" content="2014-05-19T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using StructureMap Registries for better separation"><meta name=twitter:description content="When it comes to configuring StructureMap, it supports the use of Registries. Registries support everything that the standard configure method does(new Container(c => { /* */});).
There are two main reasons that I use the registries rather then doing all my configuration in the Container&rsquo;s lambda: separation of concerns (one registry per area of code) and easier testing (which we will go into shortly).
The only down side I can see to using registries is that it can scatter your configuration across your codebase - but if you have ReSharper, doing a &lsquo;Find Implementations&rsquo; on Registry will find them all for you, so it really isn&rsquo;t much of a down side."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Using StructureMap Registries for better separation","item":"https://andydote.co.uk/2014/05/19/using-structuremap-registries/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using StructureMap Registries for better separation","name":"Using StructureMap Registries for better separation","description":"When it comes to configuring StructureMap, it supports the use of Registries. Registries support everything that the standard configure method does(new Container(c =\u0026gt; { /* */});).\nThere are two main reasons that I use the registries rather then doing all my configuration in the Container\u0026rsquo;s lambda: separation of concerns (one registry per area of code) and easier testing (which we will go into shortly).\nThe only down side I can see to using registries is that it can scatter your configuration across your codebase - but if you have ReSharper, doing a \u0026lsquo;Find Implementations\u0026rsquo; on Registry will find them all for you, so it really isn\u0026rsquo;t much of a down side.","keywords":["design","c#","structuremap","separation","testing"],"articleBody":"When it comes to configuring StructureMap, it supports the use of Registries. Registries support everything that the standard configure method does(new Container(c =\u003e { /* */});).\nThere are two main reasons that I use the registries rather then doing all my configuration in the Container’s lambda: separation of concerns (one registry per area of code) and easier testing (which we will go into shortly).\nThe only down side I can see to using registries is that it can scatter your configuration across your codebase - but if you have ReSharper, doing a ‘Find Implementations’ on Registry will find them all for you, so it really isn’t much of a down side.\nSeparation of Concerns Taking NuCache as an example, in our app start we have ConfigureContainer.cs:\npublic static void Register(HttpConfiguration config) { var container = new Container(c =\u003e c.Scan(a =\u003e { a.TheCallingAssembly(); a.WithDefaultConventions(); a.LookForRegistries(); })); config.DependencyResolver = new StructureMapDependencyResolver(container); } This snippet of code gets called as part of the AppStart, and tells StructureMap to use the default conventions (eg: IFileSystem =\u003e FileSystem), and to process any registries it finds. The app then has multiple Registries with the actual configuration in (usually one per namespace, although not all namespaces have a registry).\nFor example, we have these two registries:\npublic class InfrastructureRegistry : Registry { public InfrastructureRegistry() { For() .Use() .OnCreation(c =\u003e c.Initialise()) .Singleton(); } } public class ProxyBehaviourRegistry : Registry { public ProxyBehaviourRegistry () { Scan(a =\u003e { a.TheCallingAssembly(); a.AddAllTypesOf(); }); } } The InfrastructureRegistry just specifies how to resolve an IPackageCache, as it has requires some extra initialisation and to be treated as a singleton.\nThe ProxyBehaviourRegistry tells StructureMap to add all implementations of IProxyBehaviour, so that when we construct as ProxyBehaviourSet, which has a constructor parameter of IEnumerable all the implementations are passed in for us.\nEasier Testing We can use the Registry feature of StructureMap to allow us to test parts of code as they would be in production. This mostly applies to acceptance style testing, for example when I am testing the XmlRewriter, I want it to behave exactly as it would in production, with the same IXElementTransforms passed in.\nTo do this, we can use the RewriterRegistry:\nvar container = new Container(new RewriterRegistry()); var rewriter = container.GetInstance(); Here we create a new container with the RewriterRegistry passed directly into the constructor. This gives us access to a container completely configured for using the XmlRewriter. We can then fake the inputs and outputs to the method under test, keeping the whole system in a known production-like state.\nusing (var inputStream = GetType().Assembly.GetManifestResourceStream(\"NuCache.Tests.Packages.xml\")) using (var outputStream = new MemoryStream()) { rewriter.Rewrite(targetUri, inputStream, outputStream); outputStream.Position = 0; _result = XDocument.Load(outputStream); _namespace = _result.Root.Name.Namespace; } Hopefully this shows how useful and powerful feature StructureMap’s Registries are.\n","wordCount":"458","inLanguage":"en","datePublished":"2014-05-19T00:00:00Z","dateModified":"2014-05-19T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2014/05/19/using-structuremap-registries/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Using StructureMap Registries for better separation</h1><div class=post-meta><span title='2014-05-19 00:00:00 +0000 UTC'>May 19, 2014</span>&nbsp;·&nbsp;3 min</div></header><div class=post-content><p>When it comes to configuring StructureMap, it supports the use of <a href=http://fubuworld.com/structuremap/registration/registry-dsl/>Registries</a>. Registries support everything that the standard configure method does(<code>new Container(c => { /* */});</code>).</p><p>There are two main reasons that I use the registries rather then doing all my configuration in the Container&rsquo;s lambda: separation of concerns (one registry per area of code) and easier testing (which we will go into shortly).</p><p>The only down side I can see to using registries is that it can scatter your configuration across your codebase - but if you have ReSharper, doing a &lsquo;Find Implementations&rsquo; on <code>Registry</code> will find them all for you, so it really isn&rsquo;t much of a down side.</p><h2 id=separation-of-concerns>Separation of Concerns<a hidden class=anchor aria-hidden=true href=#separation-of-concerns>#</a></h2><p>Taking <a href=https://github.com/Pondidum/NuCache>NuCache</a> as an example, in our app start we have <a href=https://github.com/Pondidum/NuCache/blob/master/NuCache/App_Start/ConfigureContainer.cs>ConfigureContainer.cs</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> Register(HttpConfiguration config)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> container = <span style=color:#66d9ef>new</span> Container(c =&gt; c.Scan(a =&gt;
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		a.TheCallingAssembly();
</span></span><span style=display:flex><span>		a.WithDefaultConventions();
</span></span><span style=display:flex><span>		a.LookForRegistries();
</span></span><span style=display:flex><span>	}));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	config.DependencyResolver = <span style=color:#66d9ef>new</span> StructureMapDependencyResolver(container);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This snippet of code gets called as part of the AppStart, and tells StructureMap to use the default conventions (eg: <code>IFileSystem => FileSystem</code>), and to process any registries it finds. The app then has multiple Registries with the actual configuration in (usually one per namespace, although not all namespaces have a registry).</p><p>For example, we have these two registries:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InfrastructureRegistry</span> : Registry
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> InfrastructureRegistry()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		For&lt;IPackageCache&gt;()
</span></span><span style=display:flex><span>			.Use&lt;FileSystemPackageCache&gt;()
</span></span><span style=display:flex><span>			.OnCreation(c =&gt; c.Initialise())
</span></span><span style=display:flex><span>			.Singleton();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProxyBehaviourRegistry</span> : Registry
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> ProxyBehaviourRegistry ()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		Scan(a =&gt;
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			a.TheCallingAssembly();
</span></span><span style=display:flex><span>			a.AddAllTypesOf&lt;IProxyBehaviour&gt;();
</span></span><span style=display:flex><span>		});
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <a href=https://github.com/Pondidum/NuCache/blob/master/NuCache/Infrastructure/InfrastructureRegistry.cs>InfrastructureRegistry</a> just specifies how to resolve an <code>IPackageCache</code>, as it has requires some extra initialisation and to be treated as a singleton.</p><p>The <a href=https://github.com/Pondidum/NuCache/blob/master/NuCache/ProxyBehaviour/ProxyBehaviourRegistry.cs>ProxyBehaviourRegistry</a> tells StructureMap to add all implementations of <code>IProxyBehaviour</code>, so that when we construct as <code>ProxyBehaviourSet</code>, which has a constructor parameter of <code>IEnumerable&lt;IProxyBehaviour></code> all the implementations are passed in for us.</p><h2 id=easier-testing>Easier Testing<a hidden class=anchor aria-hidden=true href=#easier-testing>#</a></h2><p>We can use the Registry feature of StructureMap to allow us to test parts of code as they would be in production. This mostly applies to acceptance style testing, for example when I am testing the XmlRewriter, I want it to behave exactly as it would in production, with the same <code>IXElementTransform</code>s passed in.</p><p>To do this, we can use the <code>RewriterRegistry</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> container = <span style=color:#66d9ef>new</span> Container(<span style=color:#66d9ef>new</span> RewriterRegistry());
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> rewriter = container.GetInstance&lt;XmlRewriter&gt;();
</span></span></code></pre></div><p>Here we create a new container with the <code>RewriterRegistry</code> passed directly into the constructor. This gives us access to a container completely configured for using the <code>XmlRewriter</code>. We can then fake the inputs and outputs to the method under test, keeping the whole system in a known production-like state.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> (<span style=color:#66d9ef>var</span> inputStream = GetType().Assembly.GetManifestResourceStream(<span style=color:#e6db74>&#34;NuCache.Tests.Packages.xml&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>using</span> (<span style=color:#66d9ef>var</span> outputStream = <span style=color:#66d9ef>new</span> MemoryStream())
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	rewriter.Rewrite(targetUri, inputStream, outputStream);
</span></span><span style=display:flex><span>	outputStream.Position = <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	_result = XDocument.Load(outputStream);
</span></span><span style=display:flex><span>	_namespace = _result.Root.Name.Namespace;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Hopefully this shows how useful and powerful feature StructureMap&rsquo;s Registries are.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/design/>design</a></li><li><a href=https://andydote.co.uk/tags/c#/>c#</a></li><li><a href=https://andydote.co.uk/tags/structuremap/>structuremap</a></li><li><a href=https://andydote.co.uk/tags/separation/>separation</a></li><li><a href=https://andydote.co.uk/tags/testing/>testing</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2014/06/08/specific-interfaces-smaller-abstractions/><span class=title>« Prev Page</span><br><span>Specific Interfaces</span></a>
<a class=next href=https://andydote.co.uk/2014/05/04/rich-domain-modeling/><span class=title>Next Page »</span><br><span>Writing Rich Domain Models</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>