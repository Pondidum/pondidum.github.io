<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Good Design in Warcraft Addons/Lua | Andy Dote</title><meta name=keywords content="design,lua,warcraft"><meta name=description content="Lack of Encapsulation in Addons I first noticed a lack of good design in addon code when I started trying to tweak existing addons to be slightly different.
One of the stand out examples was a Threat Meter (you know which one I mean). It works well, but I felt like writing my own, to make it really fit into my UI, with as little overhead as possible. Not knowing how to even begin writing a Threat Meter, I downloaded a copy, and opened its source directory&mldr; to discover that the entire addon is one 3500+ line file, and 16 Ace."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2014/11/23/good-design-in-warcraft-addons/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b4e19c453811e60acfec1f00c15ac2be1c53f6ab90187e684358ce7faaf48bab.css integrity="sha256-tOGcRTgR5grP7B8AwVrCvhxT9quQGH5oQ1jOf6r0i6s=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Good Design in Warcraft Addons/Lua"><meta property="og:description" content="Lack of Encapsulation in Addons I first noticed a lack of good design in addon code when I started trying to tweak existing addons to be slightly different.
One of the stand out examples was a Threat Meter (you know which one I mean). It works well, but I felt like writing my own, to make it really fit into my UI, with as little overhead as possible. Not knowing how to even begin writing a Threat Meter, I downloaded a copy, and opened its source directory&mldr; to discover that the entire addon is one 3500+ line file, and 16 Ace."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2014/11/23/good-design-in-warcraft-addons/"><meta property="article:section" content="post"><meta property="article:published_time" content="2014-11-23T00:00:00+00:00"><meta property="article:modified_time" content="2014-11-23T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Good Design in Warcraft Addons/Lua"><meta name=twitter:description content="Lack of Encapsulation in Addons I first noticed a lack of good design in addon code when I started trying to tweak existing addons to be slightly different.
One of the stand out examples was a Threat Meter (you know which one I mean). It works well, but I felt like writing my own, to make it really fit into my UI, with as little overhead as possible. Not knowing how to even begin writing a Threat Meter, I downloaded a copy, and opened its source directory&mldr; to discover that the entire addon is one 3500+ line file, and 16 Ace."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Good Design in Warcraft Addons/Lua","item":"https://andydote.co.uk/2014/11/23/good-design-in-warcraft-addons/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Good Design in Warcraft Addons/Lua","name":"Good Design in Warcraft Addons\/Lua","description":"Lack of Encapsulation in Addons I first noticed a lack of good design in addon code when I started trying to tweak existing addons to be slightly different.\nOne of the stand out examples was a Threat Meter (you know which one I mean). It works well, but I felt like writing my own, to make it really fit into my UI, with as little overhead as possible. Not knowing how to even begin writing a Threat Meter, I downloaded a copy, and opened its source directory\u0026hellip; to discover that the entire addon is one 3500+ line file, and 16 Ace.","keywords":["design","lua","warcraft"],"articleBody":"Lack of Encapsulation in Addons I first noticed a lack of good design in addon code when I started trying to tweak existing addons to be slightly different.\nOne of the stand out examples was a Threat Meter (you know which one I mean). It works well, but I felt like writing my own, to make it really fit into my UI, with as little overhead as possible. Not knowing how to even begin writing a Threat Meter, I downloaded a copy, and opened its source directory… to discover that the entire addon is one 3500+ line file, and 16 Ace.* dependencies.\nWhen I had finished my Threat Meter, I had two files (170 lines and 130 lines), and one dependency (Dark.Core, which all my addons use). I learnt a lot while reading the source for the original threat meter - it is very customisable, is externally skinable, and has some very good optimisations in it. But it also has a lot of unused variables (which are named very similarly to used ones), and so much of it’s code could be separated out, making it easier to modify by newer project members.\nThis set of observations goes on forever when concerning addons. The three main problems I see are:\nPollution of the global namespace All code in one file No separation of concerns All of this makes it harder for new developers to pick up and learn how to maintain and write addons. They are all fairly straight forward to solve problems, so lets address them!\nPollution of the Global Namespace A lot of addons you find declare many variables as global so they can access them anywhere within their addon. For example, this is pretty standard:\nMyAddonEvents = CreateFrame(\"Frame\", \"MyAddonEventFrame\") MyAddonEvents:RegisterEvent(\"PLAYER_ENTERING_WORLD\") MyAddonEvents:SetScript(\"OnEvent\", MyAddonEventHandler) MyAddonEventHandler = function(self, event, ...) if event == \"PLAYER_ENTERING_WORLD\" then --do something useful end end This is an example of poluting the global namespace, as now the entire UI has access to: MyAddonEvents, MyAddonEventFrame, MyAddonEventHandler. This is very trivial to rewrite to not expose anything to the global namespace:\nlocal events = CreateFrame(\"Frame\") local handler = function(self, event, ...) if event == \"PLAYER_ENTERING_WORLD\" then --do something useful end end events:RegisterEvent(\"PLAYER_ENTERING_WORLD\") events:SetScript(\"OnEvent\", handler) This version exposes nothing to the global namespace, and performs exactly the same function (you can even get rid of the handler variable and just pass the function directly into SetScript).\nHowever, by writing your code like this, you can’t access any of this from another file (either a lua file, or shudder a frameXml file), but using namespaces we can get around this limitation without polluting the global namespace.\nSplitting into Separate Files So, how to access local variables in other files? Well Warcraft addons come with a feature where all lua files are provided with two arguments: addon and ns. The first of these is a string of the addon name, and the second is an empty table. I almost never use the addon parameter, but the ns (or “namespace”) parameter is key to everything.\nYou can access these two variables by writing this as the first line of your lua file:\nlocal addon, ns = ... print(\"Hello from, \" .. addon) By using the ns, we can put our own variables into it to access from other files. For example, we have an event system in one file:\neventSystem.lua\nlocal addon, ns = ... local events = CreateFrame(\"Frame\") local handlers = {} events:SetScript(\"OnEvent\", function(self, event, ...) local eventHandlers = handlers[event] or {} for i, handler in ipairs(eventHandlers) do handler(event, ...) end end) ns.register = function(event, handler) handlers[event] = handlers[event] or {} table.insert(handlers[event], handler) events:RegisterEvent(event) end Note how the register function is defined on the ns. This means that any other file in our addon can do this to handle an event:\ngoldPrinter.lua\nlocal addon, ns = ... ns.register(\"PLAYER_MONEY\", function() local gold = floor(money / (COPPER_PER_SILVER * SILVER_PER_GOLD)) local silver = floor((money - (gold * COPPER_PER_SILVER * SILVER_PER_GOLD)) / COPPER_PER_SILVER) local copper = mod(money, COPPER_PER_SILVER) local moneyString = \"\" local separator = \"\" if ( gold \u003e 0 ) then moneyString = format(GOLD_AMOUNT_TEXTURE, gold, 0, 0) separator = \" \" end if ( silver \u003e 0 ) then moneyString = moneyString .. separator .. format(SILVER_AMOUNT_TEXTURE, silver, 0, 0) separator = \" \" end if ( copper \u003e 0 or moneyString == \"\" ) then moneyString = moneyString .. separator .. format(COPPER_AMOUNT_TEXTURE, copper, 0, 0) end print(\"You now have \" .. moneyString) end) A pretty trivial example, but we have managed to write a two file addon, without putting anything in the global namespace.\nWe have also managed to separate our concerns - the goldPrinter does not care what raises the events, and the eventSystem knows nothing about gold printing, just how to delegate events. There is also an efficiency here too - anything else in our addon that needs events uses the same eventSystem, meaning we only need to create one frame for the entire addon to receive events.\nStructure Now that we can separate things into individual files, we gain a slightly different problem - how to organise those files. I found over time that I end up with roughly the same structure each time, and others might benefit from it too.\nAll my addons start with four files:\nAddonName.toc initialise.lua config.lua run.lua The toc file, other than the usual header information is laid out in the order the files will run, for example this is the file segment of my bags addon’s toc file:\ninitialise.lua config.lua models\\classifier.lua models\\classifiers\\equipmentSet.lua models\\itemModel.lua models\\model.lua groups\\group.lua groups\\bagGroup.lua groups\\bagContainer.lua views\\item.lua views\\goldDisplay.lua views\\currencyDisplay.lua views\\bankBagBar.lua sets\\container.lua sets\\bag.lua sets\\bank.lua run.lua The initialise lua file is the first thing to run. All this tends to do is setup any sub-namespaces on ns, and copy in external dependencies to ns.lib:\nlocal addon, ns = ... ns.models = {} ns.groups = {} ns.views = {} ns.sets = {} local core = Dark.core ns.lib = { fonts = core.fonts, events = core.events, slash = core.slash, } By copying in the dependencies, we not only save a global lookup each time we need say the event system, but we also have an abstraction point. If we want to replace the event system, as long as the replacement has the right function names, we can just assign the new one to the lib: ns.lib.events = replacementEvents:new()\nThe sub namespaces correspond to folders on in the addon (much the same practice used by c# developers), so for example the classifier.lua file might have this in it:\nlocal addon, ns = ... local classifier = { new = function() end, update = function() end, classify = function(item) end, } ns.models.classifier = classifier The config file should be fairly simple, with not much more than a couple of tables in it:\nlocal addon, ns = ... ns.config = { buttonSize = 24, spacing = 4, screenPadding = 10, currencies = { 823, -- apexis 824, -- garrison resources } } And finally, the run.lua file is what makes your addon come to life:\nlocal addon, ns = ... local sets = ns.sets local pack = sets.bag:new() local bank = sets.bank:new() local ui = ns.controllers.uiIntegration.new(pack.frame, bank.frame) ui.hook() --expose DarkBags = { addClassifier = ns.classifiers.add } If you need to expose something to the entire UI or other addons, that’s fine. But make sure you only expose what you want to. In the example above the DarkBags global only has one method - addClassifier, because that is all I want other addons to be able to do.\nWrapping Up I hope this helps other people with their addons - I know I wish that I had gotten to this structure and style a lot sooner than I did.\nThere will be a few more posts incoming covering encapsulation, objects and inheritance in more detail, so stay tuned.\n","wordCount":"1297","inLanguage":"en","datePublished":"2014-11-23T00:00:00Z","dateModified":"2014-11-23T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2014/11/23/good-design-in-warcraft-addons/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Good Design in Warcraft Addons/Lua</h1><div class=post-meta><span title='2014-11-23 00:00:00 +0000 UTC'>November 23, 2014</span>&nbsp;·&nbsp;7 min</div></header><div class=post-content><h2 id=lack-of-encapsulation-in-addons>Lack of Encapsulation in Addons<a hidden class=anchor aria-hidden=true href=#lack-of-encapsulation-in-addons>#</a></h2><p>I first noticed a lack of good design in addon code when I started trying to tweak existing addons to be slightly different.</p><p>One of the stand out examples was a Threat Meter (you know which one I mean). It works well, but I felt like writing my own, to make it really fit into my UI, with as little overhead as possible. Not knowing how to even begin writing a Threat Meter, I downloaded a copy, and opened its source directory&mldr; to discover that the entire addon is one 3500+ line file, and 16 Ace.* dependencies.</p><p>When I had finished my Threat Meter, I had two files (170 lines and 130 lines), and one dependency (Dark.Core, which all my addons use). I learnt a lot while reading the source for the original threat meter - it is very customisable, is externally skinable, and has some very good optimisations in it. But it also has a lot of unused variables (which are named very similarly to used ones), and so much of it&rsquo;s code <em>could</em> be separated out, making it easier to modify by newer project members.</p><p>This set of observations goes on forever when concerning addons. The three main problems I see are:</p><ul><li>Pollution of the global namespace</li><li>All code in one file</li><li>No separation of concerns</li></ul><p>All of this makes it harder for new developers to pick up and learn how to maintain and write addons. They are all fairly straight forward to solve problems, so lets address them!</p><h2 id=pollution-of-the-global-namespace>Pollution of the Global Namespace<a hidden class=anchor aria-hidden=true href=#pollution-of-the-global-namespace>#</a></h2><p>A lot of addons you find declare many variables as global so they can access them anywhere within their addon. For example, this is pretty standard:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>MyAddonEvents <span style=color:#f92672>=</span> CreateFrame(<span style=color:#e6db74>&#34;Frame&#34;</span>, <span style=color:#e6db74>&#34;MyAddonEventFrame&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MyAddonEvents:RegisterEvent(<span style=color:#e6db74>&#34;PLAYER_ENTERING_WORLD&#34;</span>)
</span></span><span style=display:flex><span>MyAddonEvents:SetScript(<span style=color:#e6db74>&#34;OnEvent&#34;</span>, MyAddonEventHandler)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MyAddonEventHandler <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(self, event, ...)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> event <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;PLAYER_ENTERING_WORLD&#34;</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>--do something useful</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>This is an example of poluting the global namespace, as now the entire UI has access to: <code>MyAddonEvents</code>, <code>MyAddonEventFrame</code>, <code>MyAddonEventHandler</code>. This is very trivial to rewrite to not expose anything to the global namespace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> events <span style=color:#f92672>=</span> CreateFrame(<span style=color:#e6db74>&#34;Frame&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> handler <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(self, event, ...)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> event <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;PLAYER_ENTERING_WORLD&#34;</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>--do something useful</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>events:RegisterEvent(<span style=color:#e6db74>&#34;PLAYER_ENTERING_WORLD&#34;</span>)
</span></span><span style=display:flex><span>events:SetScript(<span style=color:#e6db74>&#34;OnEvent&#34;</span>, handler)
</span></span></code></pre></div><p>This version exposes nothing to the global namespace, and performs exactly the same function (you can even get rid of the <code>handler</code> variable and just pass the function directly into <code>SetScript</code>).</p><p>However, by writing your code like this, you can&rsquo;t access any of this from another file (either a lua file, or <em>shudder</em> a frameXml file), but using namespaces we can get around this limitation without polluting the global namespace.</p><h2 id=splitting-into-separate-files>Splitting into Separate Files<a hidden class=anchor aria-hidden=true href=#splitting-into-separate-files>#</a></h2><p>So, how to access local variables in other files? Well Warcraft addons come with a feature where all lua files are provided with two arguments: <code>addon</code> and <code>ns</code>. The first of these is a string of the addon name, and the second is an empty table. I almost never use the <code>addon</code> parameter, but the <code>ns</code> (or &ldquo;namespace&rdquo;) parameter is key to everything.</p><p>You can access these two variables by writing this as the first line of your lua file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> addon, ns <span style=color:#f92672>=</span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;Hello from, &#34;</span> <span style=color:#f92672>..</span> addon)
</span></span></code></pre></div><p>By using the <code>ns</code>, we can put our own variables into it to access from other files. For example, we have an event system in one file:</p><p><em>eventSystem.lua</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> addon, ns <span style=color:#f92672>=</span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> events <span style=color:#f92672>=</span> CreateFrame(<span style=color:#e6db74>&#34;Frame&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> handlers <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>events:SetScript(<span style=color:#e6db74>&#34;OnEvent&#34;</span>, <span style=color:#66d9ef>function</span>(self, event, ...)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>local</span> eventHandlers <span style=color:#f92672>=</span> handlers[event] <span style=color:#f92672>or</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> i, handler <span style=color:#66d9ef>in</span> ipairs(eventHandlers) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>		handler(event, ...)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ns.register <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(event, handler)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	handlers[event] <span style=color:#f92672>=</span> handlers[event] <span style=color:#f92672>or</span> {}
</span></span><span style=display:flex><span>	table.insert(handlers[event], handler)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	events:RegisterEvent(event)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>Note how the <code>register</code> function is defined on the <code>ns</code>. This means that any other file in our addon can do this to handle an event:</p><p><em>goldPrinter.lua</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> addon, ns <span style=color:#f92672>=</span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ns.register(<span style=color:#e6db74>&#34;PLAYER_MONEY&#34;</span>, <span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>local</span> gold <span style=color:#f92672>=</span> floor(money <span style=color:#f92672>/</span> (COPPER_PER_SILVER <span style=color:#f92672>*</span> SILVER_PER_GOLD))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>local</span> silver <span style=color:#f92672>=</span> floor((money <span style=color:#f92672>-</span> (gold <span style=color:#f92672>*</span> COPPER_PER_SILVER <span style=color:#f92672>*</span> SILVER_PER_GOLD)) <span style=color:#f92672>/</span> COPPER_PER_SILVER)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>local</span> copper <span style=color:#f92672>=</span> mod(money, COPPER_PER_SILVER)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>local</span> moneyString <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>local</span> separator <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> ( gold <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> ) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		moneyString <span style=color:#f92672>=</span> format(GOLD_AMOUNT_TEXTURE, gold, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		separator <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; &#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> ( silver <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> ) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		moneyString <span style=color:#f92672>=</span> moneyString <span style=color:#f92672>..</span> separator <span style=color:#f92672>..</span> format(SILVER_AMOUNT_TEXTURE, silver, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		separator <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; &#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> ( copper <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>or</span> moneyString <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> ) <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		moneyString <span style=color:#f92672>=</span> moneyString <span style=color:#f92672>..</span> separator <span style=color:#f92672>..</span> format(COPPER_AMOUNT_TEXTURE, copper, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	print(<span style=color:#e6db74>&#34;You now have &#34;</span> <span style=color:#f92672>..</span> moneyString)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>)
</span></span></code></pre></div><p>A pretty trivial example, but we have managed to write a two file addon, without putting <strong>anything</strong> in the global namespace.</p><p>We have also managed to separate our concerns - the <code>goldPrinter</code> does not care what raises the events, and the <code>eventSystem</code> knows nothing about gold printing, just how to delegate events. There is also an efficiency here too - anything else in our addon that needs events uses the same eventSystem, meaning we only need to create one frame for the entire addon to receive events.</p><h2 id=structure>Structure<a hidden class=anchor aria-hidden=true href=#structure>#</a></h2><p>Now that we can separate things into individual files, we gain a slightly different problem - how to organise those files. I found over time that I end up with roughly the same structure each time, and others might benefit from it too.</p><p>All my addons start with four files:</p><ul><li>AddonName.toc</li><li>initialise.lua</li><li>config.lua</li><li>run.lua</li></ul><p>The toc file, other than the usual header information is laid out in the order the files will run, for example this is the file segment of my bags addon&rsquo;s toc file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>initialise.lua
</span></span><span style=display:flex><span>config.lua
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>models\classifier.lua
</span></span><span style=display:flex><span>models\classifiers\equipmentSet.lua
</span></span><span style=display:flex><span>models\itemModel.lua
</span></span><span style=display:flex><span>models\model.lua
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>groups\group.lua
</span></span><span style=display:flex><span>groups\bagGroup.lua
</span></span><span style=display:flex><span>groups\bagContainer.lua
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>views\item.lua
</span></span><span style=display:flex><span>views\goldDisplay.lua
</span></span><span style=display:flex><span>views\currencyDisplay.lua
</span></span><span style=display:flex><span>views\bankBagBar.lua
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sets\container.lua
</span></span><span style=display:flex><span>sets\bag.lua
</span></span><span style=display:flex><span>sets\bank.lua
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>run.lua
</span></span></code></pre></div><p>The <code>initialise</code> lua file is the first thing to run. All this tends to do is setup any sub-namespaces on <code>ns</code>, and copy in external dependencies to <code>ns.lib</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> addon, ns <span style=color:#f92672>=</span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ns.models <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>ns.groups <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>ns.views <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>ns.sets <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> core <span style=color:#f92672>=</span> Dark.core
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ns.lib <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	fonts <span style=color:#f92672>=</span> core.fonts,
</span></span><span style=display:flex><span>	events <span style=color:#f92672>=</span> core.events,
</span></span><span style=display:flex><span>	slash <span style=color:#f92672>=</span> core.slash,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>By copying in the dependencies, we not only save a global lookup each time we need say the event system, but we also have an abstraction point. If we want to replace the event system, as long as the replacement has the right function names, we can just assign the new one to the lib: <code>ns.lib.events = replacementEvents:new()</code></p><p>The sub namespaces correspond to folders on in the addon (much the same practice used by c# developers), so for example the <code>classifier.lua</code> file might have this in it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> addon, ns <span style=color:#f92672>=</span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> classifier <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	new <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() <span style=color:#66d9ef>end</span>,
</span></span><span style=display:flex><span>	update <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() <span style=color:#66d9ef>end</span>,
</span></span><span style=display:flex><span>	classify <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(item) <span style=color:#66d9ef>end</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ns.models.classifier <span style=color:#f92672>=</span> classifier
</span></span></code></pre></div><p>The config file should be fairly simple, with not much more than a couple of tables in it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> addon, ns <span style=color:#f92672>=</span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ns.config <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	buttonSize <span style=color:#f92672>=</span> <span style=color:#ae81ff>24</span>,
</span></span><span style=display:flex><span>	spacing <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>	screenPadding <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>	currencies <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>823</span>, <span style=color:#75715e>-- apexis</span>
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>824</span>,  <span style=color:#75715e>-- garrison resources</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And finally, the <code>run.lua</code> file is what makes your addon come to life:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> addon, ns <span style=color:#f92672>=</span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> sets <span style=color:#f92672>=</span> ns.sets
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> pack <span style=color:#f92672>=</span> sets.bag:new()
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> bank <span style=color:#f92672>=</span> sets.bank:new()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> ui <span style=color:#f92672>=</span> ns.controllers.uiIntegration.new(pack.frame, bank.frame)
</span></span><span style=display:flex><span>ui.hook()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>--expose</span>
</span></span><span style=display:flex><span>DarkBags <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	addClassifier <span style=color:#f92672>=</span> ns.classifiers.add
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you need to expose something to the entire UI or other addons, that&rsquo;s fine. But make sure you only expose what you want to. In the example above the <code>DarkBags</code> global only has one method - <code>addClassifier</code>, because that is all I want other addons to be able to do.</p><h2 id=wrapping-up>Wrapping Up<a hidden class=anchor aria-hidden=true href=#wrapping-up>#</a></h2><p>I hope this helps other people with their addons - I know I wish that I had gotten to this structure and style a lot sooner than I did.</p><p>There will be a few more posts incoming covering encapsulation, objects and inheritance in more detail, so stay tuned.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/design/>design</a></li><li><a href=https://andydote.co.uk/tags/lua/>lua</a></li><li><a href=https://andydote.co.uk/tags/warcraft/>warcraft</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2014/11/28/encapsulation-in-warcraft-addons-closures/><span class=title>« Prev Page</span><br><span>Encapsulation in Warcraft Addons - Closures</span></a>
<a class=next href=https://andydote.co.uk/2014/08/04/edgejs-for-embedded-webuis/><span class=title>Next Page »</span><br><span>Edge.js for Embedded Webuis</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>