<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CQS with Mediatr | Andy Dote</title><meta name=keywords content="c#,cqs,cqrs,mediatr"><meta name=description content="This article is some extra thoughts I had on api structure after reading Derek Comartin.
Asides from the benefits that Derek mentions (no fat repositories, thin controllers), there are a number of other advantages that this style of architecture brings.
Ease of Testing By using Command and Queries, you end up with some very useful seams for writing tests.
For controllers With controllers, you typically use Dependency injection to provide an instance of IMediator:"><meta name=author content><link rel=canonical href=https://andydote.co.uk/2016/03/19/cqs-with-mediatr/><link crossorigin=anonymous href=/assets/css/stylesheet.min.4ac25d88867f6882d86478d9b478a3d3efa1ed9e18f0bc5e432812301516cb28.css integrity="sha256-SsJdiIZ/aILYZHjZtHij0++h7Z4Y8LxeQygSMBUWyyg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="CQS with Mediatr"><meta property="og:description" content="This article is some extra thoughts I had on api structure after reading Derek Comartin.
Asides from the benefits that Derek mentions (no fat repositories, thin controllers), there are a number of other advantages that this style of architecture brings.
Ease of Testing By using Command and Queries, you end up with some very useful seams for writing tests.
For controllers With controllers, you typically use Dependency injection to provide an instance of IMediator:"><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2016/03/19/cqs-with-mediatr/"><meta property="article:section" content="post"><meta property="article:published_time" content="2016-03-19T00:00:00+00:00"><meta property="article:modified_time" content="2016-03-19T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="CQS with Mediatr"><meta name=twitter:description content="This article is some extra thoughts I had on api structure after reading Derek Comartin.
Asides from the benefits that Derek mentions (no fat repositories, thin controllers), there are a number of other advantages that this style of architecture brings.
Ease of Testing By using Command and Queries, you end up with some very useful seams for writing tests.
For controllers With controllers, you typically use Dependency injection to provide an instance of IMediator:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"CQS with Mediatr","item":"https://andydote.co.uk/2016/03/19/cqs-with-mediatr/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CQS with Mediatr","name":"CQS with Mediatr","description":"This article is some extra thoughts I had on api structure after reading Derek Comartin.\nAsides from the benefits that Derek mentions (no fat repositories, thin controllers), there are a number of other advantages that this style of architecture brings.\nEase of Testing By using Command and Queries, you end up with some very useful seams for writing tests.\nFor controllers With controllers, you typically use Dependency injection to provide an instance of IMediator:","keywords":["c#","cqs","cqrs","mediatr"],"articleBody":"This article is some extra thoughts I had on api structure after reading Derek Comartin.\nAsides from the benefits that Derek mentions (no fat repositories, thin controllers), there are a number of other advantages that this style of architecture brings.\nEase of Testing By using Command and Queries, you end up with some very useful seams for writing tests.\nFor controllers With controllers, you typically use Dependency injection to provide an instance of IMediator:\npublic class AddressController : ApiController { private readonly IMediator _mediator; public AddressController(IMediator mediator) { _mediator = mediator; } public IEnumerable Get() { return _mediator.Send(new GetAllAddressesQuery(User)); } } You can now test the controller’s actions return as you expect:\n[Fact] public void When_requesting_all_addresses() { var mediator = Substitute.For(); var controller = new AddressController(mediator); controller.User = Substitute.For(); var result = controller.Get(); mediator .Received(1) .Send(Arg.Is(q =\u003e q.User == controller.User)); } This is also useful when doing integration tests, as you can use Microsoft.Owin.Testing.TestApp to test that all the serialization, content negotiation etc works correctly, and still use a substituted mediator so you have known values to test with:\n[Fact] public async void Addresses_get_should_return_an_empty_json_array() { var mediator = Substitute.For(); mediator.Send(Arg.Any()).Returns(Enumerable.Empty()); var server = TestServer.Create(app =\u003e { var api = new Startup(mediator); api.Configuration(app); }); var response = await _server .CreateRequest(\"/api/address\") .AddHeader(\"content-type\", \"application/json\") .GetAsync(); var json = await response.Content.ReadAsStringAsync(); json.ShouldBe(\"[]\"); } For Handlers Handler are now isolated from the front end of your application, which means testing is a simple matter of creating an instance, passing in a message, and checking the result. For example the GetAllAddressesQuery handler could be implemented like so:\npublic class GetAllAddressesQueryHandler : IRequestHandler","wordCount":"608","inLanguage":"en","datePublished":"2016-03-19T00:00:00Z","dateModified":"2016-03-19T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2016/03/19/cqs-with-mediatr/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>CQS with Mediatr</h1><div class=post-meta><span title='2016-03-19 00:00:00 +0000 UTC'>March 19, 2016</span>&nbsp;·&nbsp;3 min</div></header><div class=post-content><p>This article is some extra thoughts I had on api structure after reading <a href=http://codeopinion.com/thin-controllers-cqrs-mediatr/>Derek Comartin</a>.</p><p>Asides from the benefits that Derek mentions (no fat repositories, thin controllers), there are a number of other advantages that this style of architecture brings.</p><h2 id=ease-of-testing>Ease of Testing<a hidden class=anchor aria-hidden=true href=#ease-of-testing>#</a></h2><p>By using Command and Queries, you end up with some very useful seams for writing tests.</p><h3 id=for-controllers>For controllers<a hidden class=anchor aria-hidden=true href=#for-controllers>#</a></h3><p>With controllers, you typically use Dependency injection to provide an instance of <code>IMediator</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AddressController</span> : ApiController
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IMediator _mediator;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> AddressController(IMediator mediator)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _mediator = mediator;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IEnumerable&lt;Address&gt; Get()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _mediator.Send(<span style=color:#66d9ef>new</span> GetAllAddressesQuery(User));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can now test the controller&rsquo;s actions return as you expect:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[Fact]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> When_requesting_all_addresses()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> mediator = Substitute.For&lt;IMediator&gt;();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> controller = <span style=color:#66d9ef>new</span> AddressController(mediator);
</span></span><span style=display:flex><span>  controller.User = Substitute.For&lt;IPrincipal&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> result = controller.Get();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  mediator
</span></span><span style=display:flex><span>      .Received(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>      .Send(Arg.Is&lt;GetAllAddressesQuery&gt;(q =&gt; q.User == controller.User));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This is also useful when doing integration tests, as you can use <code>Microsoft.Owin.Testing.TestApp</code> to test that all the serialization, content negotiation etc works correctly, and still use a substituted mediator so you have known values to test with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>[Fact]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>void</span> Addresses_get_should_return_an_empty_json_array()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> mediator = Substitute.For&lt;IMediator&gt;();
</span></span><span style=display:flex><span>    mediator.Send(Arg.Any&lt;GetAllAddressesQuery&gt;()).Returns(Enumerable.Empty&lt;Address&gt;());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> server = TestServer.Create(app =&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> api = <span style=color:#66d9ef>new</span> Startup(mediator);
</span></span><span style=display:flex><span>        api.Configuration(app);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> response = <span style=color:#66d9ef>await</span> _server
</span></span><span style=display:flex><span>        .CreateRequest(<span style=color:#e6db74>&#34;/api/address&#34;</span>)
</span></span><span style=display:flex><span>        .AddHeader(<span style=color:#e6db74>&#34;content-type&#34;</span>, <span style=color:#e6db74>&#34;application/json&#34;</span>)
</span></span><span style=display:flex><span>        .GetAsync();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> json = <span style=color:#66d9ef>await</span> response.Content.ReadAsStringAsync();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    json.ShouldBe(<span style=color:#e6db74>&#34;[]&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=for-handlers>For Handlers<a hidden class=anchor aria-hidden=true href=#for-handlers>#</a></h3><p>Handler are now isolated from the front end of your application, which means testing is a simple matter of creating an instance, passing in a message, and checking the result. For example the <code>GetAllAddressesQuery</code> handler could be implemented like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GetAllAddressesQueryHandler</span> : IRequestHandler&lt;GetAllAddressesQuery, IEnumerable&lt;Address&gt;&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IEnumerable&lt;Address&gt; Handle(GetAllAddressesQuery message)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (message.User == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Enumerable.Empty&lt;Address&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> [] {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> Address { Line1 = <span style=color:#e6db74>&#34;34 Home Road&#34;</span>, PostCode = <span style=color:#e6db74>&#34;BY2 9AX&#34;</span> }
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And a test might look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>[Fact]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> When_no_user_is_specified()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> handler = <span style=color:#66d9ef>new</span> GetAllAddressesQueryHandler();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> result = handler.Handle(<span style=color:#66d9ef>new</span> GetAllAddressesQuery());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result.ShouldBeEmpty();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=multiple-front-ends>Multiple Front Ends<a hidden class=anchor aria-hidden=true href=#multiple-front-ends>#</a></h2><p>The next advantage of using Commmands and Queries is that you can support multiple frontends without code duplication. This ties in very nicely with a <a href=http://alistair.cockburn.us/Hexagonal+architecture>Hexagonal architecture</a>. For example, one of my current projects has a set of commands and queries, which are used by a WebApi, and WebSocket connector, and a RabbitMQ adaptor.</p><p>This sample also makes use of <a href=https://www.nuget.org/packages/rabbitharness>RabbitHarness</a>, which provides a small interface for easy sending, listening and querying of queues and exchanges.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> RabbitMqConnector(IMediator mediator, IRabbitConnector connector) {
</span></span><span style=display:flex><span>    _mediator = mediator;
</span></span><span style=display:flex><span>    _connector = connector;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    _connector.ListenTo(<span style=color:#66d9ef>new</span> QueueDefinition { Name = <span style=color:#e6db74>&#34;AddressQueries&#34;</span> }, OnMessage);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>bool</span> OnMessage(IBasicProperties props, GetAllAddressesQuery message)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>//in this case, the message sent to RabbitMQ matches the query structure</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> addresses = _mediator.Send(message);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    _connector.SendTo(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> QueueDefinition { Name = props.ReplyTo },
</span></span><span style=display:flex><span>        replyProps =&gt; replyProps.CorrelationID = props.CorrelationID,
</span></span><span style=display:flex><span>        addresses
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=vertical-slicing>Vertical Slicing<a hidden class=anchor aria-hidden=true href=#vertical-slicing>#</a></h2><p>This a soft-advantage of Commands and Queries I have found - you can have many more developers working in parallel on a project adding commands and queries etc, before you start treading on each others toes&mldr;and the only painful part is all the <code>*.csproj</code> merges you need to do! Your mileage may vary on this one!</p><h2 id=disadvantages>Disadvantages<a hidden class=anchor aria-hidden=true href=#disadvantages>#</a></h2><p>In a large project, you can end up with a lot of extra classes, which can be daunting at first - one of my current projects has around 60 <code>IRequest</code> and <code>IRequestHandler</code> implementations. As long as you follow a good naming convention, or sort them in to namespaces, it is not that much of a problem.</p><h2 id=overall>Overall<a hidden class=anchor aria-hidden=true href=#overall>#</a></h2><p>Overall I like this pattern a lot - especially as it makes transitioning towards EventSourcing and/or full CQRS much easier.</p><p>How about you? What are your thoughts and experiences on this?</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/c#/>c#</a></li><li><a href=https://andydote.co.uk/tags/cqs/>cqs</a></li><li><a href=https://andydote.co.uk/tags/cqrs/>cqrs</a></li><li><a href=https://andydote.co.uk/tags/mediatr/>mediatr</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2016/06/09/database-integrations-for-microservices/><span class=title>« Prev Page</span><br><span>Database Integrations for MicroServices</span></a>
<a class=next href=https://andydote.co.uk/2016/03/18/rabbitmq-xunit/><span class=title>Next Page »</span><br><span>RabbitMQ integration tests in XUnit</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>