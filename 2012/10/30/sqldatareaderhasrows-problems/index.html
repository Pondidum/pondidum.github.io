<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SqlDataReader.HasRows Problems | Andy Dote</title><meta name=keywords content="bug,sql"><meta name=description content="For the last 6 years or so at work, we have had an intermittent bug. In this case, intermittent means around once in 6 months or so. A little background to the problem first:
Our data access is done via what was originally Microsoft&rsquo;s SQLHelper class, passing in a stored procedure (and parameters), and our entities use the reader to load all their properties. Pretty straight forward stuff.
The problemis, on the live system, every few months a sproc will stop returning results, for no apparent reason."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2012/10/30/sqldatareaderhasrows-problems/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b4e19c453811e60acfec1f00c15ac2be1c53f6ab90187e684358ce7faaf48bab.css integrity="sha256-tOGcRTgR5grP7B8AwVrCvhxT9quQGH5oQ1jOf6r0i6s=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.e85ad0406048e8176e1c7661b25d5c69297ddfe41dc4124cf75ecb99a4f7b3d1.js integrity="sha256-6FrQQGBI6BduHHZhsl1caSl93+QdxBJM917LmaT3s9E=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="SqlDataReader.HasRows Problems"><meta property="og:description" content="For the last 6 years or so at work, we have had an intermittent bug. In this case, intermittent means around once in 6 months or so. A little background to the problem first:
Our data access is done via what was originally Microsoft&rsquo;s SQLHelper class, passing in a stored procedure (and parameters), and our entities use the reader to load all their properties. Pretty straight forward stuff.
The problemis, on the live system, every few months a sproc will stop returning results, for no apparent reason."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2012/10/30/sqldatareaderhasrows-problems/"><meta property="article:section" content="post"><meta property="article:published_time" content="2012-10-30T00:00:00+00:00"><meta property="article:modified_time" content="2012-10-30T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="SqlDataReader.HasRows Problems"><meta name=twitter:description content="For the last 6 years or so at work, we have had an intermittent bug. In this case, intermittent means around once in 6 months or so. A little background to the problem first:
Our data access is done via what was originally Microsoft&rsquo;s SQLHelper class, passing in a stored procedure (and parameters), and our entities use the reader to load all their properties. Pretty straight forward stuff.
The problemis, on the live system, every few months a sproc will stop returning results, for no apparent reason."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"SqlDataReader.HasRows Problems","item":"https://andydote.co.uk/2012/10/30/sqldatareaderhasrows-problems/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SqlDataReader.HasRows Problems","name":"SqlDataReader.HasRows Problems","description":"For the last 6 years or so at work, we have had an intermittent bug. In this case, intermittent means around once in 6 months or so. A little background to the problem first:\nOur data access is done via what was originally Microsoft\u0026rsquo;s SQLHelper class, passing in a stored procedure (and parameters), and our entities use the reader to load all their properties. Pretty straight forward stuff.\nThe problemis, on the live system, every few months a sproc will stop returning results, for no apparent reason.","keywords":["bug","sql"],"articleBody":"For the last 6 years or so at work, we have had an intermittent bug. In this case, intermittent means around once in 6 months or so. A little background to the problem first:\nOur data access is done via what was originally Microsoft’s SQLHelper class, passing in a stored procedure (and parameters), and our entities use the reader to load all their properties. Pretty straight forward stuff.\nThe problemis, on the live system, every few months a sproc will stop returning results, for no apparent reason. Calling the sproc from Sql Management Studio works fine. We have tried many different fixes: re-applying the sproc, calling the sproc from a different database login, re-pointing to the dev or test systems. None of it makes any difference, and then as suddenly as it stopped working, it starts working again.\nA few days ago, I was attempting to track down some inconsistent search results, this time based around an fts index. Now this index is pretty large (at least, in my books it is) at around 1.5 million rows, and the column itself being a good few thousand words on average.\nThe code used for this problem boils down to the following\nSproc “ftsSearch”:\nSelect\tid from\tftsTable where\tcontains(@query, searchColumn) Reader Class:\npublic class FtsSearch : List\u003cint\u003e { public void Search(String input) { Clear(); var param = new SqlParameter(\"@query\", SqlDbType.VarChar); param.Value = input; using (var reader = SqlHelper.ExecuteReader(DbConnection, \"ftsSearch\", param)) { if (reader.HasRows) { while (reader.Read()) { Add(reader.GetInt32(0)); } } } } } Calling this function while the error is occurring, yields the following results:\nQuery:\tResults: \"Project Management\"\t20,000 \"Project Manager\"\t15,000 \"Project Manage*\"\t0 The first two queries are fine, the last however I would expect to bring back between 20,000 and ~35,000 results, and when we ran the sql from Management Studio, it brought back 29,000 results.\nNow when debugging the function, we double checked everything was being called correctly - correct DB, correct sproc, correct login, correct (parsed) parameter.\nInspecting HasRows returns False. So we forced a call to Read() anyway, just to see what happened. An what do you know? Results, all there.\nThe reason that HasRows was returning false was that the sproc was triggering sql server to also send back a warning - in this case one about too many results (afraid I have lost the exact error code). Sadly this behaviour does not seem to be documented anywhere.\n","wordCount":"405","inLanguage":"en","datePublished":"2012-10-30T00:00:00Z","dateModified":"2012-10-30T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2012/10/30/sqldatareaderhasrows-problems/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>SqlDataReader.HasRows Problems</h1><div class=post-meta><span title='2012-10-30 00:00:00 +0000 UTC'>October 30, 2012</span>&nbsp;·&nbsp;2 min</div></header><div class=post-content><p>For the last 6 years or so at work, we have had an intermittent bug. In this case, intermittent means around once in 6 months or so. A little background to the problem first:</p><p>Our data access is done via what was originally Microsoft&rsquo;s SQLHelper class, passing in a stored procedure (and parameters), and our entities use the reader to load all their properties. Pretty straight forward stuff.</p><p>The problemis, on the live system, every few months a sproc will stop returning results, for no apparent reason. Calling the sproc from Sql Management Studio works fine. We have tried many different fixes: re-applying the sproc, calling the sproc from a different database login, re-pointing to the dev or test systems. None of it makes any difference, and then as suddenly as it stopped working, it starts working again.</p><p>A few days ago, I was attempting to track down some inconsistent search results, this time based around an fts index. Now this index is pretty large (at least, in my books it is) at around 1.5 million rows, and the column itself being a good few thousand words on average.</p><p>The code used for this problem boils down to the following</p><p>Sproc &ldquo;ftsSearch&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>	<span style=color:#66d9ef>Select</span>	id
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>from</span>	ftsTable
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>where</span>	<span style=color:#66d9ef>contains</span>(<span style=color:#f92672>@</span>query, searchColumn)
</span></span></code></pre></div><p>Reader Class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FtsSearch</span> : List&lt;<span style=color:#66d9ef>int</span>&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Search(String input)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		Clear();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> param = <span style=color:#66d9ef>new</span> SqlParameter(<span style=color:#e6db74>&#34;@query&#34;</span>, SqlDbType.VarChar);
</span></span><span style=display:flex><span>		param.Value = input;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>using</span> (<span style=color:#66d9ef>var</span> reader = SqlHelper.ExecuteReader(DbConnection, <span style=color:#e6db74>&#34;ftsSearch&#34;</span>, param))
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (reader.HasRows)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>while</span> (reader.Read())
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					Add(reader.GetInt32(<span style=color:#ae81ff>0</span>));
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Calling this function while the error is occurring, yields the following results:</p><pre><code>Query:						Results:
&quot;Project Management&quot;		20,000
&quot;Project Manager&quot;			15,000
&quot;Project Manage*&quot;			0
</code></pre><p>The first two queries are fine, the last however I would expect to bring back between 20,000 and ~35,000 results, and when we ran the sql from Management Studio, it brought back 29,000 results.</p><p>Now when debugging the function, we double checked everything was being called correctly - correct DB, correct sproc, correct login, correct (parsed) parameter.</p><p>Inspecting HasRows returns False. So we forced a call to Read() anyway, just to see what happened. An what do you know? Results, all there.</p><p>The reason that HasRows was returning false was that the sproc was triggering sql server to also send back a warning - in this case one about too many results (afraid I have lost the exact error code). Sadly this behaviour does not seem to be documented anywhere.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/bug/>bug</a></li><li><a href=https://andydote.co.uk/tags/sql/>sql</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2012/11/02/checking-a-type-for-an-attribute/><span class=title>« Prev Page</span><br><span>Checking a Type for an Attribute</span></a>
<a class=next href=https://andydote.co.uk/2012/10/29/winforms-design-time-support-exposing-sub-designers/><span class=title>Next Page »</span><br><span>Winforms Design Time support: exposing sub designers</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>