<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Validate Your Configuration | Andy Dote</title><meta name=keywords content="configuration,c#,strongtyping,stronk,validation"><meta name=description content="As I have written many times before, your application&rsquo;s configuration should be strongly typed and validated that it loads correctly at startup.
This means not only that the source values (typically all represented as strings) can be converted to the target types (int, Uri, TimeSpan etc) but that the values are semantically valid too.
For example, if you have a web.config file with the following AppSetting, and a configuration class to go with it:"><meta name=author content><link rel=canonical href=https://andydote.co.uk/2018/08/26/validate-configuration/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b4e19c453811e60acfec1f00c15ac2be1c53f6ab90187e684358ce7faaf48bab.css integrity="sha256-tOGcRTgR5grP7B8AwVrCvhxT9quQGH5oQ1jOf6r0i6s=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Validate Your Configuration"><meta property="og:description" content="As I have written many times before, your application&rsquo;s configuration should be strongly typed and validated that it loads correctly at startup.
This means not only that the source values (typically all represented as strings) can be converted to the target types (int, Uri, TimeSpan etc) but that the values are semantically valid too.
For example, if you have a web.config file with the following AppSetting, and a configuration class to go with it:"><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2018/08/26/validate-configuration/"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-08-26T00:00:00+00:00"><meta property="article:modified_time" content="2018-08-26T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Validate Your Configuration"><meta name=twitter:description content="As I have written many times before, your application&rsquo;s configuration should be strongly typed and validated that it loads correctly at startup.
This means not only that the source values (typically all represented as strings) can be converted to the target types (int, Uri, TimeSpan etc) but that the values are semantically valid too.
For example, if you have a web.config file with the following AppSetting, and a configuration class to go with it:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Validate Your Configuration","item":"https://andydote.co.uk/2018/08/26/validate-configuration/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Validate Your Configuration","name":"Validate Your Configuration","description":"As I have written many times before, your application\u0026rsquo;s configuration should be strongly typed and validated that it loads correctly at startup.\nThis means not only that the source values (typically all represented as strings) can be converted to the target types (int, Uri, TimeSpan etc) but that the values are semantically valid too.\nFor example, if you have a web.config file with the following AppSetting, and a configuration class to go with it:","keywords":["configuration","c#","strongtyping","stronk","validation"],"articleBody":"As I have written many times before, your application’s configuration should be strongly typed and validated that it loads correctly at startup.\nThis means not only that the source values (typically all represented as strings) can be converted to the target types (int, Uri, TimeSpan etc) but that the values are semantically valid too.\nFor example, if you have a web.config file with the following AppSetting, and a configuration class to go with it:\n     key=\"Timeout\" value=\"20\" /    public class Configuration {  public TimeSpan Timeout { get; private set; } } We can now load the configuration using Stronk (or Microsoft.Extensions.Configuration if you’re on dotnet core), and inspect the contents of the Timeout property:\nvar config = new StronkConfig().Build();  Console.WriteLine(config.Timeout); // 20 days, 0 hours, 0 minutes, 0 seconds Oops. A timeout of 20 days is probably a little on the high side! The reason this happened is that to parse the string value we use TimeSpan.Parse(value), which will interpret it as days if no other units are specified.\nHow to validate? There are several ways we could go about fixing this, from changing to use TimeSpan.ParseExact, but then we need to provide the format string from somewhere, or force people to use Stronk’s own decision on format strings.\nInstead, we can just write some validation logic ourselves. If it is a simple configuration, then writing a few statements inline is probably fine:\nvar config = new StronkConfig()  .Validate.Using(c =  {  if (c.Timeout 60) \u0026\u0026 c.Timeout  TimeSpan.Zero)  throw new ArgumentOutOfRangeException(nameof(c.Timeout), $\"Must be greater than 0, and less than 1 minute\");  });  .Build(); But we can make it much clearer by using a validation library such as FluentValidation, to do the validation:\nvar config = new StronkConfig()  .Validate.Using(c = new ConfigurationValidator().ValidateAndThrow(c))  .Build(); public class ConfigurationValidator : AbstractValidator {  private static readonly HashSetstring ValidHosts = new HashSetstring(  new[] { \"localhost\", \"internal\" },  StringComparer.OrdinalIgnoreCase);   public ConfigurationValidator()  {  RuleFor(x = x.Timeout)  .GreaterThan(TimeSpan.Zero)  .LessThan(TimeSpan.FromMinutes(2));   RuleFor(x = x.Callback)  .Must(url = url.Scheme == Uri.UriSchemeHttps)  .Must(url = ValidHosts.Contains(url.Host));  } } Here, not only are we checking the Timeout is in a valid range, but that our Callback is HTTPS and that it is going to a domain on an Allow-List.\nWhat should I validate? Everything? If you have properties controlling the number of threads an application uses, probably checking it’s a positive number, and less than x * Environment.ProcessorCount (for some value of x) is probably a good idea.\nIf you are specifying callback URLs in the config file, checking they are in the right domain/scheme would be a good idea (e.g. must be https, must be in a domain allow-list).\nHow do you check your configuration isn’t going to bite you when an assumption turns out to be wrong?\n","wordCount":"458","inLanguage":"en","datePublished":"2018-08-26T00:00:00Z","dateModified":"2018-08-26T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2018/08/26/validate-configuration/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Validate Your Configuration</h1><div class=post-meta><span title="2018-08-26 00:00:00 +0000 UTC">August 26, 2018</span>&nbsp;·&nbsp;3 min</div></header><div class=post-content><p>As I have <a href=/2016/12/06/strong-type-all-the-configurations/>written</a> many <a href=/2017/11/09/configuration-composition/>times</a> before, your application&rsquo;s configuration should be strongly typed and validated that it loads correctly at startup.</p><p>This means not only that the source values (typically all represented as strings) can be converted to the target types (<code>int</code>, <code>Uri</code>, <code>TimeSpan</code> etc) but that the values are <strong>semantically valid</strong> too.</p><p>For example, if you have a <code>web.config</code> file with the following <code>AppSetting</code>, and a configuration class to go with it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;appSettings&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;add</span> <span style=color:#a6e22e>key=</span><span style=color:#e6db74>&#34;Timeout&#34;</span> <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;20&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/appSettings&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Configuration</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> TimeSpan Timeout { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can now load the configuration using <a href=https://github.com/pondidum/stronk>Stronk</a> (or Microsoft.Extensions.Configuration if you&rsquo;re on dotnet core), and inspect the contents of the <code>Timeout</code> property:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> config = <span style=color:#66d9ef>new</span> StronkConfig().Build&lt;Configuration&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Console.WriteLine(config.Timeout); <span style=color:#75715e>// 20 days, 0 hours, 0 minutes, 0 seconds</span>
</span></span></code></pre></div><p>Oops. <strong>A timeout of 20 days is probably a <em>little</em> on the high side!</strong> The reason this happened is that to parse the string value we use <code>TimeSpan.Parse(value)</code>, which will interpret it as days if no other units are specified.</p><h2 id=how-to-validate>How to validate?<a hidden class=anchor aria-hidden=true href=#how-to-validate>#</a></h2><p>There are several ways we could go about fixing this, from changing to use <code>TimeSpan.ParseExact</code>, but then we need to provide the format string from somewhere, or force people to use Stronk&rsquo;s own decision on format strings.</p><p>Instead, we can just write some validation logic ourselves. If it is a simple configuration, then writing a few statements inline is probably fine:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> config = <span style=color:#66d9ef>new</span> StronkConfig()
</span></span><span style=display:flex><span>    .Validate.Using&lt;Configuration&gt;(c =&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (c.Timeout &lt; TimeSpan.FromSeconds(<span style=color:#ae81ff>60</span>) &amp;&amp; c.Timeout &gt; TimeSpan.Zero)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ArgumentOutOfRangeException(nameof(c.Timeout), <span style=color:#e6db74>$&#34;Must be greater than 0, and less than 1 minute&#34;</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    .Build&lt;Configuration&gt;();
</span></span></code></pre></div><p>But we can make it much clearer by using a validation library such as <a href=https://github.com/JeremySkinner/FluentValidation>FluentValidation</a>, to do the validation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> config = <span style=color:#66d9ef>new</span> StronkConfig()
</span></span><span style=display:flex><span>    .Validate.Using&lt;Configuration&gt;(c =&gt; <span style=color:#66d9ef>new</span> ConfigurationValidator().ValidateAndThrow(c))
</span></span><span style=display:flex><span>    .Build&lt;Configuration&gt;();
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ConfigurationValidator</span> : AbstractValidator&lt;Configuration&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>readonly</span> HashSet&lt;<span style=color:#66d9ef>string</span>&gt; ValidHosts = <span style=color:#66d9ef>new</span> HashSet&lt;<span style=color:#66d9ef>string</span>&gt;(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span>[] { <span style=color:#e6db74>&#34;localhost&#34;</span>, <span style=color:#e6db74>&#34;internal&#34;</span> },
</span></span><span style=display:flex><span>        StringComparer.OrdinalIgnoreCase);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ConfigurationValidator()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        RuleFor(x =&gt; x.Timeout)
</span></span><span style=display:flex><span>            .GreaterThan(TimeSpan.Zero)
</span></span><span style=display:flex><span>            .LessThan(TimeSpan.FromMinutes(<span style=color:#ae81ff>2</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        RuleFor(x =&gt; x.Callback)
</span></span><span style=display:flex><span>            .Must(url =&gt; url.Scheme == Uri.UriSchemeHttps)
</span></span><span style=display:flex><span>            .Must(url =&gt; ValidHosts.Contains(url.Host));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here, not only are we checking the <code>Timeout</code> is in a valid range, but that our <code>Callback</code> is HTTPS and that it is going to a domain on an Allow-List.</p><h2 id=what-should-i-validate>What should I validate?<a hidden class=anchor aria-hidden=true href=#what-should-i-validate>#</a></h2><p>Everything? If you have properties controlling the number of threads an application uses, probably checking it&rsquo;s a positive number, and less than <code>x * Environment.ProcessorCount</code> (for some value of x) is probably a good idea.</p><p>If you are specifying callback URLs in the config file, checking they are in the right domain/scheme would be a good idea (e.g. must be https, must be in a domain allow-list).</p><p>How do you check your configuration isn&rsquo;t going to bite you when an assumption turns out to be wrong?</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/configuration/>configuration</a></li><li><a href=https://andydote.co.uk/tags/c#/>c#</a></li><li><a href=https://andydote.co.uk/tags/strongtyping/>strongtyping</a></li><li><a href=https://andydote.co.uk/tags/stronk/>stronk</a></li><li><a href=https://andydote.co.uk/tags/validation/>validation</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2018/09/06/consul-feature-toggles/><span class=title>« Prev Page</span><br><span>Feature Toggles with Consul</span></a>
<a class=next href=https://andydote.co.uk/2018/08/10/red-builds/><span class=title>Next Page »</span><br><span>Branching and Red Builds</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>