<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Isolated Docker Multistage Images | Andy Dote</title><meta name=keywords content="docker"><meta name=description content="Often when building applications, I will use a multistage docker build for output container size and efficiency, but will run the build in two halves, to make use of the extra assets in the builder container, something like this:
docker build \ --target builder \ -t builder:$GIT_COMMIT \ . docker run --rm \ -v &#34;$PWD/artefacts/tests:/artefacts/tests&#34; \ builder:$GIT_COMMIT \ yarn ci:test docker run --rm \ -v &#34;$PWD/artefacts/lint:/artefacts/lint&#34; \ builder:$GIT_COMMIT \ yarn ci:lint docker build \ --cache-from builder:$GIT_COMMIT \ --target output \ -t app:$GIT_COMMIT \ ."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2020/11/01/docker-multistage-containers/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b4e19c453811e60acfec1f00c15ac2be1c53f6ab90187e684358ce7faaf48bab.css integrity="sha256-tOGcRTgR5grP7B8AwVrCvhxT9quQGH5oQ1jOf6r0i6s=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Isolated Docker Multistage Images"><meta property="og:description" content="Often when building applications, I will use a multistage docker build for output container size and efficiency, but will run the build in two halves, to make use of the extra assets in the builder container, something like this:
docker build \ --target builder \ -t builder:$GIT_COMMIT \ . docker run --rm \ -v &#34;$PWD/artefacts/tests:/artefacts/tests&#34; \ builder:$GIT_COMMIT \ yarn ci:test docker run --rm \ -v &#34;$PWD/artefacts/lint:/artefacts/lint&#34; \ builder:$GIT_COMMIT \ yarn ci:lint docker build \ --cache-from builder:$GIT_COMMIT \ --target output \ -t app:$GIT_COMMIT \ ."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2020/11/01/docker-multistage-containers/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-11-01T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-01T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Isolated Docker Multistage Images"><meta name=twitter:description content="Often when building applications, I will use a multistage docker build for output container size and efficiency, but will run the build in two halves, to make use of the extra assets in the builder container, something like this:
docker build \ --target builder \ -t builder:$GIT_COMMIT \ . docker run --rm \ -v &#34;$PWD/artefacts/tests:/artefacts/tests&#34; \ builder:$GIT_COMMIT \ yarn ci:test docker run --rm \ -v &#34;$PWD/artefacts/lint:/artefacts/lint&#34; \ builder:$GIT_COMMIT \ yarn ci:lint docker build \ --cache-from builder:$GIT_COMMIT \ --target output \ -t app:$GIT_COMMIT \ ."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Isolated Docker Multistage Images","item":"https://andydote.co.uk/2020/11/01/docker-multistage-containers/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Isolated Docker Multistage Images","name":"Isolated Docker Multistage Images","description":"Often when building applications, I will use a multistage docker build for output container size and efficiency, but will run the build in two halves, to make use of the extra assets in the builder container, something like this:\ndocker build \\ --target builder \\ -t builder:$GIT_COMMIT \\ . docker run --rm \\ -v \u0026#34;$PWD/artefacts/tests:/artefacts/tests\u0026#34; \\ builder:$GIT_COMMIT \\ yarn ci:test docker run --rm \\ -v \u0026#34;$PWD/artefacts/lint:/artefacts/lint\u0026#34; \\ builder:$GIT_COMMIT \\ yarn ci:lint docker build \\ --cache-from builder:$GIT_COMMIT \\ --target output \\ -t app:$GIT_COMMIT \\ .","keywords":["docker"],"articleBody":"Often when building applications, I will use a multistage docker build for output container size and efficiency, but will run the build in two halves, to make use of the extra assets in the builder container, something like this:\ndocker build \\ --target builder \\ -t builder:$GIT_COMMIT \\ . docker run --rm \\ -v \"$PWD/artefacts/tests:/artefacts/tests\" \\ builder:$GIT_COMMIT \\ yarn ci:test docker run --rm \\ -v \"$PWD/artefacts/lint:/artefacts/lint\" \\ builder:$GIT_COMMIT \\ yarn ci:lint docker build \\ --cache-from builder:$GIT_COMMIT \\ --target output \\ -t app:$GIT_COMMIT \\ . This usually works fine, but sometimes the .dockerignore file won’t have everything set correctly, and docker will decide that when it runs the last build command, that it needs to rebuild the builder container too, which is pretty irritating.\nThe first solution is to try and figure out what you need to add to your .dockerignore file, which depending on your repository structure and container usage, might be more hassle than it’s worth.\nThe second solution is to prevent docker invalidating the first layers at all, by splitting the build into separate files.\nSplitting the Dockerfile Let’s start with an example docker file, which is a generic yarn based application with multistage build configured:\nFROM node:15.0.1-alpine3.12 as builder WORKDIR /app COPY . ./ RUN yarn install --frozen-lockfile \u0026\u0026 yarn cache clean RUN yarn ci:build FROM node:15.0.1-alpine3.12 as output WORKDIR /app COPY package.json yarn.lock /app RUN yarn install --frozen-lockfile --production \u0026\u0026 yarn cache clean COPY --from builder /app/dist /app The first file will be our Docker.builder, which is a direct copy paste:\nFROM node:15.0.1-alpine3.12 as builder WORKDIR /app COPY . ./ RUN yarn install --frozen-lockfile \u0026\u0026 yarn cache clean RUN yarn ci:build The second file can also be a direct copy paste, saved as Dockerfile.output, but it has a problem:\nFROM node:15.0.1-alpine3.12 as output WORKDIR /app COPY package.json yarn.lock /app RUN yarn install --frozen-lockfile --production \u0026\u0026 yarn cache clean COPY --from builder /app/dist /app We want to copy from a different container, not a different stage, and while the COPY command does let you specify another container in the --from parameter, but we really want to specify which container it is at build time. The first attempt at solving this was using a buildarg:\nARG builder_image COPY --from ${builder_image} /app/dist /app But alas, this doesn’t work either, as the --from parameter doesn’t support variables. The solution turns out to be that FROM command does support parameterisation, so we can (ab)use that:\nARG builder_image FROM ${builder_image} as builder FROM node:15.0.1-alpine3.12 as output WORKDIR /app COPY package.json yarn.lock /app RUN yarn install --frozen-lockfile --production \u0026\u0026 yarn cache clean COPY --from builder /app/dist /app Now our build script can use the --build-arg parameter to force the right container:\ndocker build \\ - --target builder \\ + --file Dockerfile.builder \\ -t builder:$GIT_COMMIT \\ . docker run --rm \\ -v \"$PWD/artefacts/tests:/artefacts/tests\" \\ builder:$GIT_COMMIT \\ yarn ci:test docker run --rm \\ -v \"$PWD/artefacts/lint:/artefacts/lint\" \\ builder:$GIT_COMMIT \\ yarn ci:lint docker build \\ - --cache-from builder:$GIT_COMMIT \\ + --build-arg \"builder_image=builder:$GIT_COMMIT\" \\ + --file Dockerfile.output \\ -t app:$GIT_COMMIT \\ . We can now safely modfiy the working directory to our heart’s content without worring about invalidating the layer caches.\n","wordCount":"523","inLanguage":"en","datePublished":"2020-11-01T00:00:00Z","dateModified":"2020-11-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2020/11/01/docker-multistage-containers/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Isolated Docker Multistage Images</h1><div class=post-meta><span title='2020-11-01 00:00:00 +0000 UTC'>November 1, 2020</span>&nbsp;·&nbsp;3 min</div></header><div class=post-content><p>Often when building applications, I will use a multistage docker build for output container size and efficiency, but will run the build in two halves, to make use of the extra assets in the builder container, something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --target builder <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -t builder:$GIT_COMMIT <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run --rm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v <span style=color:#e6db74>&#34;</span>$PWD<span style=color:#e6db74>/artefacts/tests:/artefacts/tests&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  builder:$GIT_COMMIT <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  yarn ci:test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run --rm <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v <span style=color:#e6db74>&#34;</span>$PWD<span style=color:#e6db74>/artefacts/lint:/artefacts/lint&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  builder:$GIT_COMMIT <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  yarn ci:lint
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --cache-from builder:$GIT_COMMIT <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --target output <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -t app:$GIT_COMMIT <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  .
</span></span></code></pre></div><p>This usually works fine, but sometimes the <code>.dockerignore</code> file won&rsquo;t have everything set correctly, and docker will decide that when it runs the last <code>build</code> command, that it needs to rebuild the <code>builder</code> container too, which is pretty irritating.</p><p>The first solution is to try and figure out what you need to add to your <code>.dockerignore</code> file, which depending on your repository structure and container usage, might be more hassle than it&rsquo;s worth.</p><p>The second solution is to prevent docker invalidating the first layers at all, by splitting the build into separate files.</p><h2 id=splitting-the-dockerfile>Splitting the Dockerfile<a hidden class=anchor aria-hidden=true href=#splitting-the-dockerfile>#</a></h2><p>Let&rsquo;s start with an example docker file, which is a generic yarn based application with multistage build configured:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:15.0.1-alpine3.12 as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> yarn install --frozen-lockfile <span style=color:#f92672>&amp;&amp;</span> yarn cache clean<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> yarn ci:build<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:15.0.1-alpine3.12 as output</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package.json yarn.lock /app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> yarn install --frozen-lockfile --production <span style=color:#f92672>&amp;&amp;</span> yarn cache clean<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from builder /app/dist /app<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>The first file will be our <code>Docker.builder</code>, which is a direct copy paste:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:15.0.1-alpine3.12 as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> yarn install --frozen-lockfile <span style=color:#f92672>&amp;&amp;</span> yarn cache clean<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> yarn ci:build<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>The second file can also be a direct copy paste, saved as <code>Dockerfile.output</code>, but it has a problem:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:15.0.1-alpine3.12 as output</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package.json yarn.lock /app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> yarn install --frozen-lockfile --production <span style=color:#f92672>&amp;&amp;</span> yarn cache clean<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from builder /app/dist /app<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>We want to copy from a different container, not a different stage, and while the <code>COPY</code> command does let you specify another container in the <code>--from</code> parameter, but we really want to specify which container it is at build time. The first attempt at solving this was using a buildarg:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>ARG</span> builder_image<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from <span style=color:#e6db74>${</span>builder_image<span style=color:#e6db74>}</span> /app/dist /app<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>But alas, this doesn&rsquo;t work either, as the <code>--from</code> parameter doesn&rsquo;t support variables. The solution turns out to be that <code>FROM</code> command <em>does</em> support parameterisation, so we can (ab)use that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>ARG</span> builder_image<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> ${builder_image} as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> node:15.0.1-alpine3.12 as output</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package.json yarn.lock /app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> yarn install --frozen-lockfile --production <span style=color:#f92672>&amp;&amp;</span> yarn cache clean<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from builder /app/dist /app<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Now our build script can use the <code>--build-arg</code> parameter to force the right container:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>docker build \
</span></span><span style=display:flex><span><span style=color:#f92672>-  --target builder \
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+  --file Dockerfile.builder \
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>  -t builder:$GIT_COMMIT \
</span></span><span style=display:flex><span>  .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run --rm \
</span></span><span style=display:flex><span>  -v &#34;$PWD/artefacts/tests:/artefacts/tests&#34; \
</span></span><span style=display:flex><span>  builder:$GIT_COMMIT \
</span></span><span style=display:flex><span>  yarn ci:test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run --rm \
</span></span><span style=display:flex><span>  -v &#34;$PWD/artefacts/lint:/artefacts/lint&#34; \
</span></span><span style=display:flex><span>  builder:$GIT_COMMIT \
</span></span><span style=display:flex><span>  yarn ci:lint
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker build \
</span></span><span style=display:flex><span><span style=color:#f92672>-  --cache-from builder:$GIT_COMMIT \
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+  --build-arg &#34;builder_image=builder:$GIT_COMMIT&#34; \
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+  --file Dockerfile.output \
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>  -t app:$GIT_COMMIT \
</span></span><span style=display:flex><span>  .
</span></span></code></pre></div><p>We can now safely modfiy the working directory to our heart&rsquo;s content without worring about invalidating the layer caches.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/docker/>docker</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2020/11/03/docker-multi-output/><span class=title>« Prev Page</span><br><span>Forking Multi Container Docker Builds</span></a>
<a class=next href=https://andydote.co.uk/2020/08/28/better-bashing-through-technology/><span class=title>Next Page »</span><br><span>Better BASHing Through Technology</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>