<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Observability Driven CI | Andy Dote</title><meta name=keywords content="ci,feature flags,otel,tracing"><meta name=description content="Tracking where the time goes in your CI pipeline is an important step towards being able to make it go even faster. Up until somewhat recently, the only way of tracking how long tasks took in CI was either hoping people had wrapped all their commands in time ..., or by reading a timestamped build log and calculating the difference between numbers. Which isn&rsquo;t great or fun, if we&rsquo;re being honest."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2023/07/06/observability-driven-ci/><link crossorigin=anonymous href=/assets/css/stylesheet.min.4ac25d88867f6882d86478d9b478a3d3efa1ed9e18f0bc5e432812301516cb28.css integrity="sha256-SsJdiIZ/aILYZHjZtHij0++h7Z4Y8LxeQygSMBUWyyg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Observability Driven CI"><meta property="og:description" content="Tracking where the time goes in your CI pipeline is an important step towards being able to make it go even faster. Up until somewhat recently, the only way of tracking how long tasks took in CI was either hoping people had wrapped all their commands in time ..., or by reading a timestamped build log and calculating the difference between numbers. Which isn&rsquo;t great or fun, if we&rsquo;re being honest."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2023/07/06/observability-driven-ci/"><meta property="article:section" content="post"><meta name=twitter:card content="summary"><meta name=twitter:title content="Observability Driven CI"><meta name=twitter:description content="Tracking where the time goes in your CI pipeline is an important step towards being able to make it go even faster. Up until somewhat recently, the only way of tracking how long tasks took in CI was either hoping people had wrapped all their commands in time ..., or by reading a timestamped build log and calculating the difference between numbers. Which isn&rsquo;t great or fun, if we&rsquo;re being honest."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Observability Driven CI","item":"https://andydote.co.uk/2023/07/06/observability-driven-ci/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Observability Driven CI","name":"Observability Driven CI","description":"Tracking where the time goes in your CI pipeline is an important step towards being able to make it go even faster. Up until somewhat recently, the only way of tracking how long tasks took in CI was either hoping people had wrapped all their commands in time ..., or by reading a timestamped build log and calculating the difference between numbers. Which isn\u0026rsquo;t great or fun, if we\u0026rsquo;re being honest.","keywords":["ci","feature flags","otel","tracing"],"articleBody":"Tracking where the time goes in your CI pipeline is an important step towards being able to make it go even faster. Up until somewhat recently, the only way of tracking how long tasks took in CI was either hoping people had wrapped all their commands in time ..., or by reading a timestamped build log and calculating the difference between numbers. Which isn’t great or fun, if we’re being honest.\nWhat if we could create graphs of what parts of the build took time? Something like this?\nBeing someone who cares about build pipelines and speed, I decided to add OpenTelemetry to our builds, and see what information we could get. It turns out that there is far more useful information available than just timings. For example:\nnumber of main builds; are we merging often? is this speeding up or slowing down? number commits merged to main at once; is our batch size going up? why? deployments per day; are we still moving fast? Are people scared to deploy on Friday? why? pass and failure ratios; are failures becoming more often? why? runtime of failed builds; failing builds should be fast, so we re-ordered steps so that likely failures are hit first what fails most often?; a test suite testing too much? flaky tests? a dependency not being locally cached (and thus unavailable sometimes)? Terminology The OTEL website has details on what all the terminology means, but for a brief summary:\nspan: the basic units which make up a trace. They can be parented to other spans and can represent the entire build, a logical grouping of operations, or a single operation. trace: a collection of spans with one “root span” which has no parent. attributes: key-value pairs attached to spans to provide more context. [Otel Collector][otel-collector] - a service which accepts traces in a variety of formats and can forward them to other places. Generally, you run one of these locally and all applications send to it, and it is configured to batch, enrich, and forward to a tracing service, such as Honeycomb or Jaeger Tracing Builds The first step when tracing builds is to start with the overall picture: one span for the entire build. Once this is in place, you can move on to adding details, focusing your efforts on figuring out what is the most likely place to find speed improvements.\nTo do this, I use the trace tool, which is an opinionated CLI that creates OTEL traces for your build pipeline. If you need more flexibility or don’t like its opinions, you can either open a PR/Issue on Github, or there is the otel-cli which is much more low-level.\nThe trace command will send spans to localhost:4317 by default. By setting the OTEL_EXPORTER_OTLP_ENDPOINT environment variable, our traces will instead go to our local [OTEL Collector][otel-collector] instance, which is configured to send our traces elsewhere:\nInstall the trace tool:\nGithub Actions bash env: OTEL_EXPORTER_OTLP_ENDPOINT: https://otel.internal.xyz:443 jobs: build: runs-on: ubuntu-latest steps: - name: Setup Trace uses: pondidum/trace@main with: version: \"0.0.9\" export OTEL_EXPORTER_OTLP_ENDPOINT=https://otel.internal.xyz:443 version=\"0.0.9\" curl -sSL \"https://github.com/Pondidum/trace/releases/download/${version}/trace\" -o /usr/bin/trace chmod +x /usr/bin/trace Now we can start the trace; by default this will be marked as starting when the trace start command is run; we can change this with the --when flag, which is being fed the created_at field from Github so that our trace shows when the build was started.\nGithub Actions bash - name: Start Trace uses: pondidum/trace/start@main json=$(curl -sSL \\ --url \"${GITHUB_API_URL}/repos/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/attempts/${GITHUB_RUN_ATTEMPT}\" \\ -H \"Accept: application/vnd.github+json\" \\ -H \"Authorization: Bearer ${GITHUB_TOKEN}\" \\ -H \"X-GitHub-Api-Version: 2022-11-28\") created_at=$(echo \"$json\" | sed -n 's/.*\"created_at\".*\"\\(.*\\)\".*/\\1/p') trace_parent=$(trace start \"${GITHUB_REPOSITORY}/${GITHUB_WORKFLOW}\" --when \"${created_at}\") export \"TRACEPARENT=${trace_parent}\" So that we can capture the overhead of the build job starting and the first build command running, we also store the current time as an attribute:\ntrace attr \"first_command\" $(date +%s) At the end of the build, we finish the trace - this needs to happen no matter how the build finishes, pass or failure.\nGithub Actions bash - name: Finish Trace if: always() uses: pondidum/trace/finish@main By using if: always(), we make sure this step runs no matter if the workflow was failed, cancelled or success.\nThe action uses the {{ job.status }} context to add the --error flag and a message with the status in it, if the job doesn’t pass.\ntrap ' rc=$?; # store the exit code [ $rc = \"0\" ] \u0026\u0026 echo trace finish ${TRACEPARENT} [ $rc != \"0\" ] \u0026\u0026 echo trace finish --error=\"exit ${rc}\" trap - EXIT; exit ' EXIT INT HUP By using a trap, we can make sure the ./trace finish command always runs regardless of how the script was killed. This needs to be written near the top of the script however!\nTracing Build Steps Now that there is a trace for the entire build, we can start adding more details.\nFor example, we might want to pull a few docker containers so that we have warm caches, and want to keep track of how long this takes:\ngroup=$(trace group start \"docker_pull\") trace task -- docker pull app:builder || true trace task -- docker pull app:latest || true trace task -- docker pull alpine:3.18 || true trace group finish \"${group}\" Tracing and Feature Flags When you are using feature flags in your CI system, adding their state to the trace is important; it allows us to filter traces by what flags were active on a given run, letting us see if a particular flag has an impact on success rate or time taken.\n# flagon supports the `TRACEPARENT` environment variable, so you # also get spans for it querying your flag service too! vitest=$(flagon state \"ci-enable-vitest\" \"false\" \\ --user \"${email}\" \\ --attr \"branch=${branch}\" \\ --output \"template={{.Value}}\" || true) trace attr \"enable_vitest=${vitest}\" # later group=$(trace group start \"testing\") if [ \"${vitest}\" = \"true\" ]; then pnpm run vitest else pnpm run jest fi trace group finish \"${group}\" This will give us a trace with the enable-vitest flag state, and we can group by this to see if vitest is faster than jest and what effect it had on test count etc.\n","wordCount":"1014","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2023/07/06/observability-driven-ci/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Observability Driven CI</h1><div class=post-meta><span title='2023-07-06 00:00:00 +0000 UTC'>July 6, 2023</span>&nbsp;·&nbsp;5 min</div></header><div class=post-content><p>Tracking where the time goes in your CI pipeline is an important step towards being able to make it go even faster. Up until somewhat recently, the only way of tracking how long tasks took in CI was either hoping people had wrapped all their commands in <code>time ...</code>, or by reading a timestamped build log and calculating the difference between numbers. Which isn&rsquo;t great or fun, if we&rsquo;re being honest.</p><p>What if we could create graphs of what parts of the build took time? Something like this?</p><p><img loading=lazy src=/images/trace-build.png alt="a graph of a single build showing each task as a horizontal box denoting start and durations"></p><p>Being someone who cares about build pipelines and speed, I decided to add OpenTelemetry to our builds, and see what information we could get. It turns out that there is far more useful information available than just timings. For example:</p><ul><li><strong>number of main builds</strong>; are we merging often? is this speeding up or slowing down?</li><li><strong>number commits merged to <code>main</code> at once</strong>; is our batch size going up? why?</li><li><strong>deployments per day</strong>; are we still moving fast? Are people scared to <a href=/2022/11/02/deploy-doesnt-mean-release/>deploy</a> on Friday? why?</li><li><strong>pass and failure ratios</strong>; are failures becoming more often? why?</li><li><strong>runtime of failed builds</strong>; failing builds should be fast, so we re-ordered steps so that likely failures are hit first</li><li><strong>what fails most often?</strong>; a test suite testing too much? flaky tests? a dependency not being locally cached (and thus unavailable sometimes)?</li></ul><h2 id=terminology>Terminology<a hidden class=anchor aria-hidden=true href=#terminology>#</a></h2><p>The <a href=https://opentelemetry.io/docs/concepts/glossary/>OTEL</a> website has details on what all the terminology means, but for a brief summary:</p><ul><li>span: the basic units which make up a trace. They can be parented to other spans and can represent the entire build, a logical grouping of operations, or a single operation.</li><li>trace: a collection of spans with one &ldquo;root span&rdquo; which has no parent.</li><li>attributes: key-value pairs attached to spans to provide more context.</li><li>[Otel Collector][otel-collector] - a service which accepts traces in a variety of formats and can forward them to other places. Generally, you run one of these locally and all applications send to it, and it is configured to batch, enrich, and forward to a tracing service, such as <a href=https://honeycomb.io/>Honeycomb</a> or <a href=https://www.jaegertracing.io/>Jaeger</a></li></ul><h2 id=tracing-builds>Tracing Builds<a hidden class=anchor aria-hidden=true href=#tracing-builds>#</a></h2><p>The first step when tracing builds is to start with the overall picture: one span for the entire build. Once this is in place, you can move on to adding details, focusing your efforts on figuring out what is the most likely place to find speed improvements.</p><p>To do this, I use the <a href=https://github.com/Pondidum/Trace/>trace</a> tool, which is an opinionated CLI that creates OTEL traces for your build pipeline. If you need more flexibility or don&rsquo;t like its opinions, you can either open a PR/Issue on Github, or there is the <a href=https://github.com/equinix-labs/otel-cli>otel-cli</a> which is much more low-level.</p><p>The <code>trace</code> command will send spans to <code>localhost:4317</code> by default. By setting the <code>OTEL_EXPORTER_OTLP_ENDPOINT</code> environment variable, our traces will instead go to our local [OTEL Collector][otel-collector] instance, which is configured to send our traces elsewhere:</p><p>Install the <code>trace</code> tool:</p><div class=tab-panel><div class=tab-nav><button data-tab-item="Github Actions" data-tab-group=default class="tab-nav-button btn active" onclick='switchTab("default","Github Actions")'>Github Actions</button>
<button data-tab-item=bash data-tab-group=default class="tab-nav-button btn" onclick='switchTab("default","bash")'>bash</button></div><div class=tab-content><div data-tab-item="Github Actions" data-tab-group=default class="tab-item active"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>OTEL_EXPORTER_OTLP_ENDPOINT</span>: <span style=color:#ae81ff>https://otel.internal.xyz:443</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Setup Trace</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>pondidum/trace@main</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;0.0.9&#34;</span>
</span></span></code></pre></div></div><div data-tab-item=bash data-tab-group=default class=tab-item><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export OTEL_EXPORTER_OTLP_ENDPOINT<span style=color:#f92672>=</span>https://otel.internal.xyz:443
</span></span><span style=display:flex><span>version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.0.9&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -sSL <span style=color:#e6db74>&#34;https://github.com/Pondidum/trace/releases/download/</span><span style=color:#e6db74>${</span>version<span style=color:#e6db74>}</span><span style=color:#e6db74>/trace&#34;</span> -o /usr/bin/trace
</span></span><span style=display:flex><span>chmod +x /usr/bin/trace
</span></span></code></pre></div></div></div></div><p>Now we can start the trace; by default this will be marked as starting when the <code>trace start</code> command is run; we can change this with the <code>--when</code> flag, which is being fed the <code>created_at</code> field from Github so that our trace shows when the build was started.</p><div class=tab-panel><div class=tab-nav><button data-tab-item="Github Actions" data-tab-group=default class="tab-nav-button btn active" onclick='switchTab("default","Github Actions")'>Github Actions</button>
<button data-tab-item=bash data-tab-group=default class="tab-nav-button btn" onclick='switchTab("default","bash")'>bash</button></div><div class=tab-content><div data-tab-item="Github Actions" data-tab-group=default class="tab-item active"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Start Trace</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>pondidum/trace/start@main</span>
</span></span></code></pre></div></div><div data-tab-item=bash data-tab-group=default class=tab-item><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>json<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -sSL <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --url <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>GITHUB_API_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>/repos/</span><span style=color:#e6db74>${</span>GITHUB_REPOSITORY<span style=color:#e6db74>}</span><span style=color:#e6db74>/actions/runs/</span><span style=color:#e6db74>${</span>GITHUB_RUN_ID<span style=color:#e6db74>}</span><span style=color:#e6db74>/attempts/</span><span style=color:#e6db74>${</span>GITHUB_RUN_ATTEMPT<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Accept: application/vnd.github+json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;Authorization: Bearer </span><span style=color:#e6db74>${</span>GITHUB_TOKEN<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -H <span style=color:#e6db74>&#34;X-GitHub-Api-Version: 2022-11-28&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>created_at<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$json<span style=color:#e6db74>&#34;</span> | sed -n <span style=color:#e6db74>&#39;s/.*&#34;created_at&#34;.*&#34;\(.*\)&#34;.*/\1/p&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>trace_parent<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>trace start <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>GITHUB_REPOSITORY<span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span>GITHUB_WORKFLOW<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> --when <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>created_at<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>export <span style=color:#e6db74>&#34;TRACEPARENT=</span><span style=color:#e6db74>${</span>trace_parent<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div></div></div></div><p>So that we can capture the overhead of the build job starting and the first build command running, we also store the current time as an attribute:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>trace attr <span style=color:#e6db74>&#34;first_command&#34;</span> <span style=color:#66d9ef>$(</span>date +%s<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><p>At the end of the build, we finish the trace - this needs to happen no matter how the build finishes, pass or failure.</p><div class=tab-panel><div class=tab-nav><button data-tab-item="Github Actions" data-tab-group=default class="tab-nav-button btn active" onclick='switchTab("default","Github Actions")'>Github Actions</button>
<button data-tab-item=bash data-tab-group=default class="tab-nav-button btn" onclick='switchTab("default","bash")'>bash</button></div><div class=tab-content><div data-tab-item="Github Actions" data-tab-group=default class="tab-item active"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Finish Trace</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>if</span>: <span style=color:#ae81ff>always()</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>pondidum/trace/finish@main</span>
</span></span></code></pre></div><p>By using <code>if: always()</code>, we make sure this step runs no matter if the workflow was <code>failed</code>, <code>cancelled</code> or <code>success</code>.</p><p>The action uses the <code>{{ job.status }}</code> context to add the <code>--error</code> flag and a message with the status in it, if the job doesn&rsquo;t pass.</p></div><div data-tab-item=bash data-tab-group=default class=tab-item><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>trap <span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    rc=$?; # store the exit code
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    [ $rc = &#34;0&#34; ] &amp;&amp; echo trace finish ${TRACEPARENT}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    [ $rc != &#34;0&#34; ] &amp;&amp; echo trace finish --error=&#34;exit ${rc}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    trap - EXIT;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    exit
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  &#39;</span> EXIT INT HUP
</span></span></code></pre></div><p>By using a <code>trap</code>, we can make sure the <code>./trace finish</code> command always runs regardless of how the script was killed. This needs to be written near the top of the script however!</p></div></div></div><h2 id=tracing-build-steps>Tracing Build Steps<a hidden class=anchor aria-hidden=true href=#tracing-build-steps>#</a></h2><p>Now that there is a trace for the entire build, we can start adding more details.</p><p>For example, we might want to pull a few docker containers so that we have <a href=/2020/05/14/docker-layer-sharing/>warm caches</a>, and want to keep track of how long this takes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>group<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>trace group start <span style=color:#e6db74>&#34;docker_pull&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  trace task -- docker pull app:builder <span style=color:#f92672>||</span> true
</span></span><span style=display:flex><span>  trace task -- docker pull app:latest <span style=color:#f92672>||</span> true
</span></span><span style=display:flex><span>  trace task -- docker pull alpine:3.18 <span style=color:#f92672>||</span> true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>trace group finish <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>group<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><h2 id=tracing-and-feature-flags>Tracing and Feature Flags<a hidden class=anchor aria-hidden=true href=#tracing-and-feature-flags>#</a></h2><p>When you are using <a href=/2023/01/16/feature-flags-ci/>feature flags</a> in your CI system, adding their state to the trace is important; it allows us to filter traces by what flags were active on a given run, letting us see if a particular flag has an impact on success rate or time taken.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># flagon supports the `TRACEPARENT` environment variable, so you</span>
</span></span><span style=display:flex><span><span style=color:#75715e># also get spans for it querying your flag service too!</span>
</span></span><span style=display:flex><span>vitest<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>flagon state <span style=color:#e6db74>&#34;ci-enable-vitest&#34;</span> <span style=color:#e6db74>&#34;false&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --user <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>email<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --attr <span style=color:#e6db74>&#34;branch=</span><span style=color:#e6db74>${</span>branch<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --output <span style=color:#e6db74>&#34;template={{.Value}}&#34;</span> <span style=color:#f92672>||</span> true<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>trace attr <span style=color:#e6db74>&#34;enable_vitest=</span><span style=color:#e6db74>${</span>vitest<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># later</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>group<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>trace group start <span style=color:#e6db74>&#34;testing&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>vitest<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    pnpm run vitest
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    pnpm run jest
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>trace group finish <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>group<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>This will give us a trace with the <code>enable-vitest</code> flag state, and we can group by this to see if <code>vitest</code> is faster than <code>jest</code> and what effect it had on test count etc.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/ci/>ci</a></li><li><a href=https://andydote.co.uk/tags/feature-flags/>feature flags</a></li><li><a href=https://andydote.co.uk/tags/otel/>otel</a></li><li><a href=https://andydote.co.uk/tags/tracing/>tracing</a></li></ul><nav class=paginav><a class=next href=https://andydote.co.uk/2023/05/18/expand-contract/><span class=title>Next Page »</span><br><span>Expand Contract for Databases and Services</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>