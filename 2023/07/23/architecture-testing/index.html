<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Architecture Testing | Andy Dote</title><meta name=keywords content="architecture,adr,testing"><meta name=description content="One of the many reasons given for using microservices rather than a mono repository is that it enforces boundaries between services/modules. However, there are ways to achieve strong boundaries between modules/services in one repository, using tools which are already available: test runners.
Given a repository with the following structure:
. ├── libraries │ ├── core │ ├── events │ └── ui ├── services │ ├── catalogue │ ├── billing │ └── shipping └── tools └── admin-cli There are a few rules we should enforce:"><meta name=author content><link rel=canonical href=https://andydote.co.uk/2023/07/23/architecture-testing/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Architecture Testing"><meta property="og:description" content="One of the many reasons given for using microservices rather than a mono repository is that it enforces boundaries between services/modules. However, there are ways to achieve strong boundaries between modules/services in one repository, using tools which are already available: test runners.
Given a repository with the following structure:
. ├── libraries │ ├── core │ ├── events │ └── ui ├── services │ ├── catalogue │ ├── billing │ └── shipping └── tools └── admin-cli There are a few rules we should enforce:"><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2023/07/23/architecture-testing/"><meta property="article:section" content="post"><meta name=twitter:card content="summary"><meta name=twitter:title content="Architecture Testing"><meta name=twitter:description content="One of the many reasons given for using microservices rather than a mono repository is that it enforces boundaries between services/modules. However, there are ways to achieve strong boundaries between modules/services in one repository, using tools which are already available: test runners.
Given a repository with the following structure:
. ├── libraries │ ├── core │ ├── events │ └── ui ├── services │ ├── catalogue │ ├── billing │ └── shipping └── tools └── admin-cli There are a few rules we should enforce:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Architecture Testing","item":"https://andydote.co.uk/2023/07/23/architecture-testing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Architecture Testing","name":"Architecture Testing","description":"One of the many reasons given for using microservices rather than a mono repository is that it enforces boundaries between services/modules. However, there are ways to achieve strong boundaries between modules/services in one repository, using tools which are already available: test runners.\nGiven a repository with the following structure:\n. ├── libraries │ ├── core │ ├── events │ └── ui ├── services │ ├── catalogue │ ├── billing │ └── shipping └── tools └── admin-cli There are a few rules we should enforce:","keywords":["architecture","adr","testing"],"articleBody":"One of the many reasons given for using microservices rather than a mono repository is that it enforces boundaries between services/modules. However, there are ways to achieve strong boundaries between modules/services in one repository, using tools which are already available: test runners.\nGiven a repository with the following structure:\n. ├── libraries │ ├── core │ ├── events │ └── ui ├── services │ ├── catalogue │ ├── billing │ └── shipping └── tools └── admin-cli There are a few rules we should enforce:\nServices cannot reference each other tools cannot reference each other Services cannot reference tools Libraries can only reference other libraries Libraries cannot have circular dependencies There are also the conventions that we want to enforce:\nFeature folders should be used, not models, views and controllers Specific libraries should not be used all services should expose a /api/stats endpoint How to write these tests will vary greatly depending on what programming languages and tools you use, but I know for sure they can be written in Go, C#, and TypeScript. Not only that, but the tests can be written in a different language than the applications; in this example, our applications are written in a mix of NodeJS and Go, and the architectural tests are written in Go.\nTesting for a Convention The convention we will test for is that we strongly prefer folder-by-feature over folder-by-type.\nThe test itself uses a couple of helper methods: repositoryFolders returns a slice of every folder recursively in the project, with information such as all child folders and all child files, along with names, paths, etc., populated.\nThe hasLayers function itself is just checking if the direct children of a folder contain “models”, “views” and “controllers” or “models”, “views” and “presenters”.\nfunc TestFolderByFeature(t *testing.T) { folders := repositoryFolders() for _, folder := range folders { if hasLayers(folder) { assert.Failf(t, \"found type folders, not slices\", wrap80(` It looks like '%s' is using this folder structure, known as \"folder-by-type\", which is discouraged: %s Instead, you should use folders-by-feature: %s For more information, see this ADR: ./docs/arch/005-folder-layout.md If this test failure is a false positive, please let us know, or you can either improve the test or add your folder path to the '.architecture-ignore' file. Here is the fragment that can be added: %s `, folder.Path, layers(folder), slices(folder), folderByTypeArchitectureIgnore(folder))) } } } The error message in this kind of test is very important; it needs to cover:\nWhat was wrong Where the failure was (i.e. the path) Why this is considered wrong (with links to more information if needed) How to fix it How to add an exception to the rules (if desired) How to handle false positives For example, this is what the rendered output of the test above looks like, showing the folder that was detected to have folder-by-type, showing an example of how it should look, and linking to the adr, which documents why this was chosen.\nIt looks like 'services/catalogue/src' is using this folder structure, known as \"folder-by-type\", which is discouraged: services/catalogue/src ├── controllers ├── models └── views Instead, you should use folder-by-feature: services/catalogue/src ├── details │ ├── controller.ts │ ├── model.ts │ └── view.ts ├── indexing └── search For more information, see this ADR: ./docs/arch/005-folder-layout.md If this test failure is a false positive, please let us know, or you can either improve the test or add your folder path to the '.architecture-ignore' file. Here is the fragment that can be added: ```toml [[services]] [service.catalogue] allowFolderByType = true ```. There is also the text on how to skip a test if there is a good reason to or the test failure is a false negative. Adding to the .architecture-ignore file notifies the core team about an addition, but does not block the PR, as teams are all trusted; we just want to verify if something is happening a lot or if there is some case the tests are not handling.\nAn example of a good reason for ignoring this test is when a team is taking ownership of a service and adding it to the repository: they want to pull its source in and make as few changes as possible until it is under their control; refactoring can then happen later.\nTesting a Project Rule Now let’s look at how we verify that our services don’t reference other services. The test is similar to the previous one other than the repositoryServices() function returns a map of service names and Services. The Service struct is an abstraction which allows us to handle both NodeJS projects and Go projects with the same test.\nfunc TestServicesCannotReferenceOtherServices(t *testing.T) { allServices := repositoryServices() for _, service := range allServices { for _, reference := range service.References { if other, found := allServices[reference.Name]; found { assert.Failf(t, \"service references another service\", wrap80(` It looks like the '%s' service is referencing the '%s' service. 1. Service Boundary Needing data from another service is often an indication of non-optimal service boundary, which could mean we need to refactor our design a bit. 1. Distributed Ball of Mud Having many service to service dependencies make all our services more tightly coupled, making refactoring and deployment harder. Sometimes a service to service reference is fine however! You can add your service to service definition to the '.architecture-ignore' file if this is the case. Here is the fragment that can be added: %s `, service.Name, other.Name, serviceToServiceArchitectureIgnore(service, other))) } } } The error message when rendered looks like this, again adding as much detail as we can along with how to add the exception if needed:\nIt looks like the catalogue 'service' is referencing the 'offers' service. Service to Service references are discouraged for two main reasons: 1. Service Boundary Needing data from another service is often an indication of non-optimal service boundary, which could mean we need to refactor our design a bit. 2. Distributed Ball of Mud Having many service to service dependencies make all our services more tightly coupled, making refactoring and deployment harder. Sometimes a service to service reference is fine however! You can add your service to service definition to the '.architecture-ignore' file if this is the case. Here is the fragment that can be added: ```toml [[services]] [services.catalogue] references = [ \"offers\" ] ```. Further Work Using tests like this also allows you to build extra things on top of them; for migrating from one library to another, you can add tests that specify that the number of usages can only go down over time, never up.\nYou can also use codeowners (or equivalent) to keep an eye on what is being added to the .architecture-ignore file, allowing you to react to emerging patterns and either guide teams towards the pattern or away from it.\nThe key with this is that you trust your teams; this is all “trust but verify” with the ignore file. You should (almost) never be blocking a team from working.\n","wordCount":"1149","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2023/07/23/architecture-testing/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Architecture Testing</h1><div class=post-meta><span title='2023-07-23 00:00:00 +0000 UTC'>July 23, 2023</span>&nbsp;·&nbsp;6 min</div></header><div class=post-content><p>One of the many reasons given for using microservices rather than a mono repository is that it enforces boundaries between services/modules. However, there are ways to achieve strong boundaries between modules/services in one repository, using tools which are already available: test runners.</p><p>Given a repository with the following structure:</p><pre tabindex=0><code>.
├── libraries
│   ├── core
│   ├── events
│   └── ui
├── services
│   ├── catalogue
│   ├── billing
│   └── shipping
└── tools
    └── admin-cli
</code></pre><p>There are a few rules we should enforce:</p><ul><li>Services cannot reference each other</li><li>tools cannot reference each other</li><li>Services cannot reference tools</li><li>Libraries can only reference other libraries</li><li>Libraries cannot have circular dependencies</li></ul><p>There are also the conventions that we want to enforce:</p><ul><li>Feature folders should be used, not <code>models</code>, <code>views</code> and <code>controllers</code></li><li>Specific libraries should not be used</li><li>all services should expose a <code>/api/stats</code> endpoint</li></ul><p>How to write these tests will vary greatly depending on what programming languages and tools you use, but I know for sure they can be written in Go, C#, and TypeScript. Not only that, but the tests can be written in a different language than the applications; in this example, our applications are written in a mix of NodeJS and Go, and the architectural tests are written in Go.</p><h2 id=testing-for-a-convention>Testing for a Convention<a hidden class=anchor aria-hidden=true href=#testing-for-a-convention>#</a></h2><p>The convention we will test for is that we strongly prefer folder-by-feature over folder-by-type.</p><p>The test itself uses a couple of helper methods: <code>repositoryFolders</code> returns a slice of every folder recursively in the project, with information such as all child folders and all child files, along with names, paths, etc., populated.</p><p>The <code>hasLayers</code> function itself is just checking if the direct children of a folder contain &ldquo;models&rdquo;, &ldquo;views&rdquo; and &ldquo;controllers&rdquo; or &ldquo;models&rdquo;, &ldquo;views&rdquo; and &ldquo;presenters&rdquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestFolderByFeature</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>folders</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>repositoryFolders</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>folder</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>folders</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>hasLayers</span>(<span style=color:#a6e22e>folder</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Failf</span>(<span style=color:#a6e22e>t</span>, <span style=color:#e6db74>&#34;found type folders, not slices&#34;</span>, <span style=color:#a6e22e>wrap80</span>(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>It looks like &#39;%s&#39; is using this folder structure, known as &#34;folder-by-type&#34;, which is discouraged:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>%s
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Instead, you should use folders-by-feature:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>%s
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>For more information, see this ADR: ./docs/arch/005-folder-layout.md
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>If this test failure is a false positive, please let us know, or you can either improve the test or add your folder path to the &#39;.architecture-ignore&#39; file.  Here is the fragment that can be added:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>%s
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      `</span>, <span style=color:#a6e22e>folder</span>.<span style=color:#a6e22e>Path</span>, <span style=color:#a6e22e>layers</span>(<span style=color:#a6e22e>folder</span>), <span style=color:#a6e22e>slices</span>(<span style=color:#a6e22e>folder</span>), <span style=color:#a6e22e>folderByTypeArchitectureIgnore</span>(<span style=color:#a6e22e>folder</span>)))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The error message in this kind of test is very important; it needs to cover:</p><ul><li>What was wrong</li><li>Where the failure was (i.e. the path)</li><li>Why this is considered wrong (with links to more information if needed)</li><li>How to fix it</li><li>How to add an exception to the rules (if desired)</li><li>How to handle false positives</li></ul><p>For example, this is what the rendered output of the test above looks like, showing the folder that was detected to have folder-by-type, showing an example of how it should look, and linking to the <a href=/tags/adr/>adr</a>, which documents why this was chosen.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>It looks like &#39;services/catalogue/src&#39; is using this folder structure, known as
</span></span><span style=display:flex><span>&#34;folder-by-type&#34;, which is discouraged:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>services/catalogue/src
</span></span><span style=display:flex><span>├── controllers
</span></span><span style=display:flex><span>├── models
</span></span><span style=display:flex><span>└── views
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Instead, you should use folder-by-feature:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>services/catalogue/src
</span></span><span style=display:flex><span>├── details
</span></span><span style=display:flex><span>│   ├── controller.ts
</span></span><span style=display:flex><span>│   ├── model.ts
</span></span><span style=display:flex><span>│   └── view.ts
</span></span><span style=display:flex><span>├── indexing
</span></span><span style=display:flex><span>└── search
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>For more information, see this ADR: ./docs/arch/005-folder-layout.md
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If this test failure is a false positive, please let us know, or you can either
</span></span><span style=display:flex><span>improve the test or add your folder path to the &#39;.architecture-ignore&#39; file.
</span></span><span style=display:flex><span>Here is the fragment that can be added:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>```toml
</span></span><span style=display:flex><span>[[services]]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[service.catalogue]
</span></span><span style=display:flex><span>allowFolderByType = true
</span></span><span style=display:flex><span>```.
</span></span></code></pre></div><p>There is also the text on how to skip a test if there is a good reason to or the test failure is a false negative. Adding to the <code>.architecture-ignore</code> file notifies the core team about an addition, but <strong>does not block the PR</strong>, as teams are all trusted; we just want to verify if something is happening a lot or if there is some case the tests are not handling.</p><p>An example of a good reason for ignoring this test is when a team is taking ownership of a service and adding it to the repository: they want to pull its source in and make as few changes as possible until it is under their control; refactoring can then happen later.</p><h2 id=testing-a-project-rule>Testing a Project Rule<a hidden class=anchor aria-hidden=true href=#testing-a-project-rule>#</a></h2><p>Now let&rsquo;s look at how we verify that our services don&rsquo;t reference other services. The test is similar to the previous one other than the <code>repositoryServices()</code> function returns a map of service names and Services. The <code>Service</code> struct is an abstraction which allows us to handle both NodeJS projects and Go projects with the same test.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestServicesCannotReferenceOtherServices</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allServices</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>repositoryServices</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>service</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allServices</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>reference</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>References</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>other</span>, <span style=color:#a6e22e>found</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>allServices</span>[<span style=color:#a6e22e>reference</span>.<span style=color:#a6e22e>Name</span>]; <span style=color:#a6e22e>found</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>Failf</span>(<span style=color:#a6e22e>t</span>, <span style=color:#e6db74>&#34;service references another service&#34;</span>, <span style=color:#a6e22e>wrap80</span>(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>It looks like the &#39;%s&#39; service is referencing the &#39;%s&#39; service.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>1.  Service Boundary
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Needing data from another service is often an indication of non-optimal service boundary, which could mean we need to refactor our design a bit.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>1.  Distributed Ball of Mud
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Having many service to service dependencies make all our services more tightly coupled, making refactoring and deployment harder.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Sometimes a service to service reference is fine however!  You can add your service to service definition to the &#39;.architecture-ignore&#39; file if this is the case.  Here is the fragment that can be added:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>%s
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         `</span>, <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>other</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>serviceToServiceArchitectureIgnore</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>other</span>)))
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>The error message when rendered looks like this, again adding as much detail as we can along with how to add the exception if needed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-md data-lang=md><span style=display:flex><span>It looks like the catalogue &#39;service&#39; is referencing the &#39;offers&#39; service.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Service to Service references are discouraged for two main reasons:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>1.</span>  Service Boundary
</span></span><span style=display:flex><span>Needing data from another service is often an indication of non-optimal service
</span></span><span style=display:flex><span>boundary, which could mean we need to refactor our design a bit.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>2.</span>  Distributed Ball of Mud
</span></span><span style=display:flex><span>Having many service to service dependencies make all our services more tightly
</span></span><span style=display:flex><span>coupled, making refactoring and deployment harder.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sometimes a service to service reference is fine however!  You can add your
</span></span><span style=display:flex><span>service to service definition to the &#39;.architecture-ignore&#39; file if this is the
</span></span><span style=display:flex><span>case.  Here is the fragment that can be added:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>```toml
</span></span><span style=display:flex><span>[[services]]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[services.catalogue]
</span></span><span style=display:flex><span>references = [
</span></span><span style=display:flex><span>    &#34;offers&#34;
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>```.
</span></span></code></pre></div><h2 id=further-work>Further Work<a hidden class=anchor aria-hidden=true href=#further-work>#</a></h2><p>Using tests like this also allows you to build extra things on top of them; for migrating from one library to another, you can add tests that specify that the number of usages can only go down over time, never up.</p><p>You can also use <code>codeowners</code> (or equivalent) to keep an eye on what is being added to the <code>.architecture-ignore</code> file, allowing you to react to emerging patterns and either guide teams towards the pattern or away from it.</p><p>The key with this is that you trust your teams; this is all &ldquo;trust but verify&rdquo; with the ignore file. You should (almost) never be blocking a team from working.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/architecture/>architecture</a></li><li><a href=https://andydote.co.uk/tags/adr/>adr</a></li><li><a href=https://andydote.co.uk/tags/testing/>testing</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2023/09/19/tracing-is-better/><span class=title>« Prev Page</span><br><span>Tracing: structured logging, but better in every way</span></a>
<a class=next href=https://andydote.co.uk/2023/07/06/observability-driven-ci/><span class=title>Next Page »</span><br><span>Observability Driven CI</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>