<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Expand Contract for Databases and Services | Andy Dote</title><meta name=keywords content="database,feature flags,microservices,architecture"><meta name=description content="I haven&rsquo;t seen Expand-Contract written about in some years, and I think it is a great way of performing database schema migrations without the need for application downtime. I also realised that it also applies to microservices and service-to-service communication in general.
The Easy Example One of the two examples given is wanting to change how an address is stored in a database. The schema starts off looking like this:"><meta name=author content><link rel=canonical href=https://andydote.co.uk/2023/05/18/expand-contract/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ea821116adbd94ff8c04bf7745204429750a1079f16951db0415b837fc273249.css integrity="sha256-6oIRFq29lP+MBL93RSBEKXUKEHnxaVHbBBW4N/wnMkk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Expand Contract for Databases and Services"><meta property="og:description" content="I haven&rsquo;t seen Expand-Contract written about in some years, and I think it is a great way of performing database schema migrations without the need for application downtime. I also realised that it also applies to microservices and service-to-service communication in general.
The Easy Example One of the two examples given is wanting to change how an address is stored in a database. The schema starts off looking like this:"><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2023/05/18/expand-contract/"><meta property="article:section" content="post"><meta name=twitter:card content="summary"><meta name=twitter:title content="Expand Contract for Databases and Services"><meta name=twitter:description content="I haven&rsquo;t seen Expand-Contract written about in some years, and I think it is a great way of performing database schema migrations without the need for application downtime. I also realised that it also applies to microservices and service-to-service communication in general.
The Easy Example One of the two examples given is wanting to change how an address is stored in a database. The schema starts off looking like this:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Expand Contract for Databases and Services","item":"https://andydote.co.uk/2023/05/18/expand-contract/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Expand Contract for Databases and Services","name":"Expand Contract for Databases and Services","description":"I haven\u0026rsquo;t seen Expand-Contract written about in some years, and I think it is a great way of performing database schema migrations without the need for application downtime. I also realised that it also applies to microservices and service-to-service communication in general.\nThe Easy Example One of the two examples given is wanting to change how an address is stored in a database. The schema starts off looking like this:","keywords":["database","feature flags","microservices","architecture"],"articleBody":"I haven’t seen Expand-Contract written about in some years, and I think it is a great way of performing database schema migrations without the need for application downtime. I also realised that it also applies to microservices and service-to-service communication in general.\nThe Easy Example One of the two examples given is wanting to change how an address is stored in a database. The schema starts off looking like this:\nid name address 1 Juha Läntinen Rantakatu 15, 20100, Turku, Finland The requirement is that the schema is changed to look like this:\nid name street postcode town country 1 Juha Läntinen Rantakatu 15 20100 Turku Finland The way you would traditionally achieve this is with a migration:\nalter table buildings add column street text, add column postcode text, -- postcodes can start with a 0, so store them as text add column town text, add column country text update buildings set street = split_part(address, ',', 1), postcode = split_part(address, ',', 2), town = split_part(address, ',', 3), country = split_part(address, ',', 4) where address != \"\" alter table buildings drop column address The problem with doing this is that the software using this table needs to be stopped while the update is happening; if the old version is running, the app will suddenly be trying to query a non-existing column. If the new version is running, it will also be trying to query non-existing columns.\nThe process has to look like this:\nstop the old app run the migration start the new app Step 2 however can be long, especially if there is lots of data. And what happens if you cannot have downtime for your service?\nThe Expand Contract Way add a new column to the table (nullable) release new software for reads, read both old and new columns; prefer data in new columns if it exists for writes, write to new columns run a script to migrate any remaining data release new software only reads new columns only writes new columns drop the old column This is more steps than the original method, but it means there is no downtime in your system. Also, if you make step 2 write to both columns, the migration is easily reversible as no data is lost until the fourth step runs. .\nWhat about APIs? Services? Expand Contract doesn’t have to just be about services either. For example, you have two services and have decided that part of service A should be migrated into service B, which has a similar system. The process is broadly similar to the database example above but with service releases instead:\nService B’s data model is expanded Service A is released: for reads, read both it’s own datastore and Service B. Return result from B if available for writes, write to it’s own datastore and Service B Run a script/application to migrate the remaining data Release Service A: uses Service B for all operations Drop old data store tables As you can see, the process is broadly similar to when implementing a database change; the only difference is some coordination with the other service team. The coordination is only to make sure their data model is ready; no need to release anything at the same time, and no downtime in either service is required.\nDownsides This may sound like a silver bullet, but as with all techniques, it has drawbacks.\nThe primary drawback is the extra steps required. There are multiple releases, and data migrates lazily/on demand. Then there is the extra step of migrating the remaining data, which is an additional effort.\nThe other drawback is a symptom of the first drawback: time. It takes far longer to do expand-contract than to have a short downtime. Depending on your application, short downtime might be the better choice to make. For example, a queue processing service which doesn’t have a synchronous API would probably be better choosing the downtime, assuming it can catch up with any messages which queue up during the downtime!\n","wordCount":"667","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2023/05/18/expand-contract/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Expand Contract for Databases and Services</h1><div class=post-meta><span title='2023-05-18 00:00:00 +0000 UTC'>May 18, 2023</span>&nbsp;·&nbsp;4 min</div></header><div class=post-content><p>I haven&rsquo;t seen Expand-Contract written about in some years, and I think it is a great way of performing database schema migrations without the need for application downtime. I also realised that it also applies to microservices and service-to-service communication in general.</p><h2 id=the-easy-example>The Easy Example<a hidden class=anchor aria-hidden=true href=#the-easy-example>#</a></h2><p>One of the two examples given is wanting to change how an address is stored in a database. The schema starts off looking like this:</p><table><thead><tr><th>id</th><th>name</th><th>address</th></tr></thead><tbody><tr><td>1</td><td>Juha</td><td>Läntinen Rantakatu 15, 20100, Turku, Finland</td></tr></tbody></table><p>The requirement is that the schema is changed to look like this:</p><table><thead><tr><th>id</th><th>name</th><th>street</th><th>postcode</th><th>town</th><th>country</th></tr></thead><tbody><tr><td>1</td><td>Juha</td><td>Läntinen Rantakatu 15</td><td>20100</td><td>Turku</td><td>Finland</td></tr></tbody></table><p>The way you would traditionally achieve this is with a migration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> buildings
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>add</span> <span style=color:#66d9ef>column</span> street text,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>add</span> <span style=color:#66d9ef>column</span> postcode text, <span style=color:#75715e>-- postcodes can start with a 0, so store them as text
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>add</span> <span style=color:#66d9ef>column</span> town text,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>add</span> <span style=color:#66d9ef>column</span> country text
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>update</span> buildings <span style=color:#66d9ef>set</span>
</span></span><span style=display:flex><span>  street    <span style=color:#f92672>=</span> split_part(address, <span style=color:#e6db74>&#39;,&#39;</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>  postcode  <span style=color:#f92672>=</span> split_part(address, <span style=color:#e6db74>&#39;,&#39;</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>  town      <span style=color:#f92672>=</span> split_part(address, <span style=color:#e6db74>&#39;,&#39;</span>, <span style=color:#ae81ff>3</span>),
</span></span><span style=display:flex><span>  country   <span style=color:#f92672>=</span> split_part(address, <span style=color:#e6db74>&#39;,&#39;</span>, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>where</span>
</span></span><span style=display:flex><span>  address <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> buildings
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>drop</span> <span style=color:#66d9ef>column</span> address
</span></span></code></pre></div><p>The problem with doing this is that the software using this table needs to be stopped while the update is happening; if the old version is running, the app will suddenly be trying to query a non-existing column. If the new version is running, it will also be trying to query non-existing columns.</p><p>The process has to look like this:</p><ol><li>stop the old app</li><li>run the migration</li><li>start the new app</li></ol><p>Step 2 however can be long, especially if there is lots of data. And what happens if you cannot have downtime for your service?</p><h2 id=the-expand-contract-way>The Expand Contract Way<a hidden class=anchor aria-hidden=true href=#the-expand-contract-way>#</a></h2><ol><li>add a new column to the table (nullable)</li><li>release new software<ul><li>for reads, read both old and new columns; prefer data in new columns if it exists</li><li>for writes, write to new columns</li></ul></li><li>run a script to migrate any remaining data</li><li>release new software<ul><li>only reads new columns</li><li>only writes new columns</li></ul></li><li>drop the old column</li></ol><p>This is more steps than the original method, but it means there is no downtime in your system. Also, if you make step 2 write to both columns, the migration is easily reversible as no data is lost until the fourth step runs.
.</p><h2 id=what-about-apis--services>What about APIs? Services?<a hidden class=anchor aria-hidden=true href=#what-about-apis--services>#</a></h2><p>Expand Contract doesn&rsquo;t have to just be about services either. For example, you have two services and have decided that part of service A should be migrated into service B, which has a similar system. The process is broadly similar to the database example above but with service releases instead:</p><ol><li>Service B&rsquo;s data model is expanded</li><li>Service A is released:<ul><li>for reads, read both it&rsquo;s own datastore and Service B. Return result from B if available</li><li>for writes, write to it&rsquo;s own datastore and Service B</li></ul></li><li>Run a script/application to migrate the remaining data</li><li>Release Service A:<ul><li>uses Service B for all operations</li></ul></li><li>Drop old data store tables</li></ol><p>As you can see, the process is broadly similar to when implementing a database change; the only difference is some coordination with the other service team. The coordination is only to make sure their data model is ready; no need to release anything at the same time, and no downtime in either service is required.</p><h2 id=downsides>Downsides<a hidden class=anchor aria-hidden=true href=#downsides>#</a></h2><p>This may sound like a silver bullet, but as with all techniques, it has drawbacks.</p><p>The primary drawback is the extra steps required. There are multiple releases, and data migrates lazily/on demand. Then there is the extra step of migrating the remaining data, which is an additional effort.</p><p>The other drawback is a symptom of the first drawback: time. It takes far longer to do expand-contract than to have a short downtime. Depending on your application, short downtime might be the better choice to make. For example, a queue processing service which doesn&rsquo;t have a synchronous API would probably be better choosing the downtime, assuming it can catch up with any messages which queue up during the downtime!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/database/>database</a></li><li><a href=https://andydote.co.uk/tags/feature-flags/>feature flags</a></li><li><a href=https://andydote.co.uk/tags/microservices/>microservices</a></li><li><a href=https://andydote.co.uk/tags/architecture/>architecture</a></li></ul><nav class=paginav><a class=next href=https://andydote.co.uk/2023/01/16/feature-flags-ci/><span class=title>Next Page »</span><br><span>Feature Flags in a CI Pipeline</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>