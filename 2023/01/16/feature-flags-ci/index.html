<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Feature Flags in a CI Pipeline | Andy Dote</title><meta name=keywords content="cli,feature flags,ci"><meta name=description content="Feature flags are a great tool for helping software development; they provide controlled feature rollouts, facilitate A/B testing, and help decouple deployment from release. So when it comes to building our software, why do we treat the CI pipeline without the same level of engineering as the production code?
So, why not use feature flags in your CI pipeline?
TLDR Reduce the risk of breaking a CI pipeline for all of a project&rsquo;s developers by using the flagon CLI to query Feature Flags, opting developers into and out of new CI features and processes by targeting groups of developers or branch naming patterns."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2023/01/16/feature-flags-ci/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ea821116adbd94ff8c04bf7745204429750a1079f16951db0415b837fc273249.css integrity="sha256-6oIRFq29lP+MBL93RSBEKXUKEHnxaVHbBBW4N/wnMkk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Feature Flags in a CI Pipeline"><meta property="og:description" content="Feature flags are a great tool for helping software development; they provide controlled feature rollouts, facilitate A/B testing, and help decouple deployment from release. So when it comes to building our software, why do we treat the CI pipeline without the same level of engineering as the production code?
So, why not use feature flags in your CI pipeline?
TLDR Reduce the risk of breaking a CI pipeline for all of a project&rsquo;s developers by using the flagon CLI to query Feature Flags, opting developers into and out of new CI features and processes by targeting groups of developers or branch naming patterns."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2023/01/16/feature-flags-ci/"><meta property="article:section" content="post"><meta name=twitter:card content="summary"><meta name=twitter:title content="Feature Flags in a CI Pipeline"><meta name=twitter:description content="Feature flags are a great tool for helping software development; they provide controlled feature rollouts, facilitate A/B testing, and help decouple deployment from release. So when it comes to building our software, why do we treat the CI pipeline without the same level of engineering as the production code?
So, why not use feature flags in your CI pipeline?
TLDR Reduce the risk of breaking a CI pipeline for all of a project&rsquo;s developers by using the flagon CLI to query Feature Flags, opting developers into and out of new CI features and processes by targeting groups of developers or branch naming patterns."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Feature Flags in a CI Pipeline","item":"https://andydote.co.uk/2023/01/16/feature-flags-ci/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Feature Flags in a CI Pipeline","name":"Feature Flags in a CI Pipeline","description":"Feature flags are a great tool for helping software development; they provide controlled feature rollouts, facilitate A/B testing, and help decouple deployment from release. So when it comes to building our software, why do we treat the CI pipeline without the same level of engineering as the production code?\nSo, why not use feature flags in your CI pipeline?\nTLDR Reduce the risk of breaking a CI pipeline for all of a project\u0026rsquo;s developers by using the flagon CLI to query Feature Flags, opting developers into and out of new CI features and processes by targeting groups of developers or branch naming patterns.","keywords":["cli","feature flags","ci"],"articleBody":"Feature flags are a great tool for helping software development; they provide controlled feature rollouts, facilitate A/B testing, and help decouple deployment from release. So when it comes to building our software, why do we treat the CI pipeline without the same level of engineering as the production code?\nSo, why not use feature flags in your CI pipeline?\nTLDR Reduce the risk of breaking a CI pipeline for all of a project’s developers by using the flagon CLI to query Feature Flags, opting developers into and out of new CI features and processes by targeting groups of developers or branch naming patterns.\nWhat would we use them for? There are a few things that spring to mind that we could use feature flags for:\nMigrating CI system Job migration Replacing a step Trying a new step Why would using flags for this help? The answer is risk reduction. I don’t want to break parts of the build and deployment process for everyone in the project when I make a mistake in the pipelines, and a way to help mitigate that risk is feature flags.\nWith a feature flag, I can quickly opt people into or out of changes to the CI system, meaning that if something goes wrong, the impact is minimal. It also allows me to monitor the effects of new vs old by having the flag states stored in our OTEL traces. This lets me ask and answer questions like: is it faster? Is it more reliable? Does it work?\nOne of the most significant risks is migrating from one CI system to another, which is exactly what I have been doing recently. We are leaving Truly Awful CI and migrating to Github Actions. Let’s see how that goes.\nMigrating From Old to New CI The CI process, on a high level, looks like this. The three types of deployment are ephemeral, which are short-lived environments named after the branch which created them, development, which is the common development environment, and production, which is the live application. The production and development environments are deployed to whenever something is merged to main, and ephemeral is for any other branch.\ngraph LR clone --\u003e build --\u003e test --\u003e publish-container publish-container --\u003e |$BRANCH != 'main'| trigger-deploy-ephemeral publish-container --\u003e |$BRANCH == 'main'| trigger-deploy-development publish-container --\u003e |$BRANCH == 'main'| trigger-deploy-production To phase the changeover to GitHub Actions, I am using the flagon CLI to access our feature flags. The query uses both the user id (committer email) and branch name so that I can target rollouts based on a group of users or perhaps with a branch name pattern.\nFirst, I create a duplicate workflow in GitHub Actions. The docker container is published to a different tag, and all deployments have a feature flag condition added to them:\njobs: flags: outputs: enable_ephemeral: ${{ steps.query.outputs.enable_ephemeral }} steps: - name: Query Flags id: query run: | ephemeral=$(flagon state \"ci-enable-gha-deployment\" \"false\" \\ --user \"${email}\" \\ --attr \"branch=${branch}\" \\ --output \"template={{.Value}}\" || true) echo \"enable_ephemeral=${ephemeral}\" \u003e\u003e \"${GITHUB_OUTPUT}\" # build, test, etc. deploy_ephemeral: uses: ./.github/workflows/deploy.yaml needs: - flags - build if: ${{ github.ref_name != 'master' \u0026\u0026 needs.flags.outputs.enable_ephemeral == 'true' }} with: target_env: ephemeral Then update the old CI pipeline to wrap the deployment trigger with a flag query:\nif ! flagon \"ci-enable-gha-deploy\" \"true\" \\ --user \"${email}\" \\ --attr \"environment=ephemeral\" \\ --attr \"BRANCH=${branch}\"; then awful-ci trigger \"deploy - ephemeral\" \\ --sha \"${commit}\" \\ --branch \"${branch}\" fi Note that the two CI systems are both querying the same flag, but the old system defaults to active, and the new system defaults to inactive. This means that if the flagging service (LaunchDarkly in this case) cannot be reached, only one of the systems will be doing the deployment.\nRolling out The plan for starting the switchover was as follows:\nephemeral for just me ephemeral environment for a small group of developers ephemeral for everyone development for everyone production for everyone WAIT Remove old implementation, remove flags During the rollout, the flag was switched on and off for various stages as small bugs were found.\nFor example, I discovered that the deployments only looked like they were working in GitHub Actions due to some artefacts still being uploaded to CDN by the old CI system.\nTake Away Based on my experience of using flags in this migration, it is a technique that I will be using more in the future when updating our CI pipelines.\n","wordCount":"734","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2023/01/16/feature-flags-ci/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Feature Flags in a CI Pipeline</h1><div class=post-meta><span title='2023-01-16 00:00:00 +0000 UTC'>January 16, 2023</span>&nbsp;·&nbsp;4 min</div></header><div class=post-content><p>Feature flags are a great tool for helping software development; they provide controlled feature rollouts, facilitate A/B testing, and help decouple <a href=/2022/11/02/deploy-doesnt-mean-release/>deployment from release</a>. So when it comes to building our software, why do we treat the CI pipeline without the same level of engineering as the production code?</p><p>So, why not use feature flags in your CI pipeline?</p><h2 id=tldr>TLDR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>Reduce the risk of breaking a CI pipeline for all of a project&rsquo;s developers by using the <a href=https://github.com/pondidum/flagon>flagon</a> CLI to query Feature Flags, opting developers into and out of new CI features and processes by targeting groups of developers or branch naming patterns.</p><h2 id=what-would-we-use-them-for>What would we use them for?<a hidden class=anchor aria-hidden=true href=#what-would-we-use-them-for>#</a></h2><p>There are a few things that spring to mind that we could use feature flags for:</p><ul><li>Migrating CI system</li><li>Job migration</li><li>Replacing a step</li><li>Trying a new step</li></ul><h2 id=why-would-using-flags-for-this-help>Why would using flags for this help?<a hidden class=anchor aria-hidden=true href=#why-would-using-flags-for-this-help>#</a></h2><p>The answer is risk reduction. I don&rsquo;t want to break parts of the build and deployment process for everyone in the project when I make a mistake in the pipelines, and a way to help mitigate that risk is feature flags.</p><p>With a feature flag, I can quickly opt people into or out of changes to the CI system, meaning that if something goes wrong, the impact is minimal. It also allows me to monitor the effects of new vs old by having the flag states stored in our OTEL traces. This lets me ask and answer questions like: is it faster? Is it more reliable? Does it work?</p><p>One of the most significant risks is migrating from one CI system to another, which is exactly what I have been doing recently. We are leaving <code>Truly Awful CI</code> and migrating to <code>Github Actions</code>. Let&rsquo;s see how that goes.</p><h2 id=migrating-from-old-to-new-ci>Migrating From Old to New CI<a hidden class=anchor aria-hidden=true href=#migrating-from-old-to-new-ci>#</a></h2><p>The CI process, on a high level, looks like this. The three types of deployment are <code>ephemeral</code>, which are short-lived environments named after the branch which created them, <code>development</code>, which is the common development environment, and <code>production</code>, which is the live application. The <code>production</code> and <code>development</code> environments are deployed to whenever something is merged to <code>main</code>, and <code>ephemeral</code> is for any other branch.</p><div class=mermaid align=left>graph LR
clone --> build --> test --> publish-container
publish-container --> |$BRANCH != 'main'| trigger-deploy-ephemeral
publish-container --> |$BRANCH == 'main'| trigger-deploy-development
publish-container --> |$BRANCH == 'main'| trigger-deploy-production</div><p>To phase the changeover to GitHub Actions, I am using the <a href=https://github.com/pondidum/flagon>flagon</a> CLI to access our feature flags. The query uses both the user id (committer email) and branch name so that I can target rollouts based on a group of users or perhaps with a branch name pattern.</p><p>First, I create a duplicate workflow in GitHub Actions. The docker container is published to a different tag, and all deployments have a feature flag condition added to them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>flags</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>outputs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enable_ephemeral</span>: <span style=color:#ae81ff>${{ steps.query.outputs.enable_ephemeral }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Query Flags</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>id</span>: <span style=color:#ae81ff>query</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ephemeral=$(flagon state &#34;ci-enable-gha-deployment&#34; &#34;false&#34; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          --user &#34;${email}&#34; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          --attr &#34;branch=${branch}&#34; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          --output &#34;template={{.Value}}&#34; || true)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;enable_ephemeral=${ephemeral}&#34; &gt;&gt; &#34;${GITHUB_OUTPUT}&#34;</span>        
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># build, test, etc.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>deploy_ephemeral</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>./.github/workflows/deploy.yaml</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>needs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>flags</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span>: <span style=color:#ae81ff>${{ github.ref_name != &#39;master&#39; &amp;&amp; needs.flags.outputs.enable_ephemeral == &#39;true&#39; }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>target_env</span>: <span style=color:#ae81ff>ephemeral</span>
</span></span></code></pre></div><p>Then update the old CI pipeline to wrap the deployment trigger with a flag query:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#66d9ef>if</span> ! flagon <span style=color:#e6db74>&#34;ci-enable-gha-deploy&#34;</span> <span style=color:#e6db74>&#34;true&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --user <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>email<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --attr <span style=color:#e6db74>&#34;environment=ephemeral&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --attr <span style=color:#e6db74>&#34;BRANCH=</span><span style=color:#e6db74>${</span>branch<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  awful-ci trigger <span style=color:#e6db74>&#34;deploy - ephemeral&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --sha <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>commit<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --branch <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>branch<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><p>Note that the two CI systems are both querying the same flag, but the old system defaults to active, and the new system defaults to inactive. This means that if the flagging service (LaunchDarkly in this case) cannot be reached, only one of the systems will be doing the deployment.</p><h2 id=rolling-out>Rolling out<a hidden class=anchor aria-hidden=true href=#rolling-out>#</a></h2><p>The plan for starting the switchover was as follows:</p><ol><li><code>ephemeral</code> for just me</li><li><code>ephemeral</code> environment for a small group of developers</li><li><code>ephemeral</code> for everyone</li><li><code>development</code> for everyone</li><li><code>production</code> for everyone</li><li>WAIT</li><li>Remove old implementation, remove flags</li></ol><p>During the rollout, the flag was switched on and off for various stages as small bugs were found.</p><p>For example, I discovered that the deployments only looked like they were working in GitHub Actions due to some artefacts still being uploaded to CDN by the old CI system.</p><h2 id=take-away>Take Away<a hidden class=anchor aria-hidden=true href=#take-away>#</a></h2><p>Based on my experience of using flags in this migration, it is a technique that I will be using more in the future when updating our CI pipelines.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/cli/>cli</a></li><li><a href=https://andydote.co.uk/tags/feature-flags/>feature flags</a></li><li><a href=https://andydote.co.uk/tags/ci/>ci</a></li></ul><nav class=paginav><a class=next href=https://andydote.co.uk/2022/11/22/changelogs/><span class=title>Next Page »</span><br><span>Changelog Driven Versioning</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>