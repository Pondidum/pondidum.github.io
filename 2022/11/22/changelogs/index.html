<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Changelog Driven Versioning | Andy Dote</title>
<meta name=keywords content="cli,process,ci"><meta name=description content="Versioning is one of the many hard problems when it comes to writing software. There is no one correct way to do it, and all have various tradeoffs.
After reading keep a changelog, I was inspired to implement this into a couple of CLI tools that I am working on at the moment: Flagon (feature flags on the CLI, for CI usage), and Cas (Content Addressable Storage for Make), but I also wanted to solve my versioning and release process."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2022/11/22/changelogs/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.c6a36963ab47314b3d95fe85a9385337e1ef8eb1c2194eecb86f178d492ab666.js integrity="sha256-xqNpY6tHMUs9lf6FqThTN+HvjrHCGU7suG8XjUkqtmY="></script><script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script><link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Changelog Driven Versioning"><meta property="og:description" content="Versioning is one of the many hard problems when it comes to writing software. There is no one correct way to do it, and all have various tradeoffs.
After reading keep a changelog, I was inspired to implement this into a couple of CLI tools that I am working on at the moment: Flagon (feature flags on the CLI, for CI usage), and Cas (Content Addressable Storage for Make), but I also wanted to solve my versioning and release process."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2022/11/22/changelogs/"><meta property="article:section" content="post"><meta name=twitter:card content="summary"><meta name=twitter:title content="Changelog Driven Versioning"><meta name=twitter:description content="Versioning is one of the many hard problems when it comes to writing software. There is no one correct way to do it, and all have various tradeoffs.
After reading keep a changelog, I was inspired to implement this into a couple of CLI tools that I am working on at the moment: Flagon (feature flags on the CLI, for CI usage), and Cas (Content Addressable Storage for Make), but I also wanted to solve my versioning and release process."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Changelog Driven Versioning","item":"https://andydote.co.uk/2022/11/22/changelogs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Changelog Driven Versioning","name":"Changelog Driven Versioning","description":"Versioning is one of the many hard problems when it comes to writing software. There is no one correct way to do it, and all have various tradeoffs.\nAfter reading keep a changelog, I was inspired to implement this into a couple of CLI tools that I am working on at the moment: Flagon (feature flags on the CLI, for CI usage), and Cas (Content Addressable Storage for Make), but I also wanted to solve my versioning and release process.","keywords":["cli","process","ci"],"articleBody":"Versioning is one of the many hard problems when it comes to writing software. There is no one correct way to do it, and all have various tradeoffs.\nAfter reading keep a changelog, I was inspired to implement this into a couple of CLI tools that I am working on at the moment: Flagon (feature flags on the CLI, for CI usage), and Cas (Content Addressable Storage for Make), but I also wanted to solve my versioning and release process.\nRequirements Version number should be defined in only one place A changelog should be associated with the version number The binary should be able to print its version and changelog The release (Github Release in this case) should also have the changelog and version The commit released should be tagged with the version I came up with an idea: drive everything from the changelog.\nThe changelog can be the source of truth: it contains the version number, date of release, and the actual changes within that version. As the changelog is written in a standardised format it should be fairly easy to parse, and thus be handled by the binary itself.\nThe Format I decided to follow the format from keep a changelog as it is pretty minimal, in markdown, and easily parsable with a regex. As an example, here is one of the versions lifted from flagon’s changelog.\n# Changelog ## [0.0.1] - 2022-11-14 ### Added - Exit with code `0` if a flag is `true`, and `1` otherwise - Add `--silent` flag, to suppress console information ### Changed - Expand what information is written to traces Each version entry follows the same format, which is parsable by a regex:\nvar sectionRegex = regexp.MustCompile(`## \\[(?P.*)\\]\\s*-\\s*(?P.*)`) Source The parser itself is very short, and the result is an array of ChangelogEntry, giving the version, date, and text of the changes.\nUsing the changelog from the application The changelog is embedded in the binary using the go embed package, and can then be exposed as CLI commands. The application’s version command exposes this information with several flags:\nno flags: print the version number and git short sha\n--short: only print the version number\n./flagon version --short 0.0.1 --changelog: pretty print the current version’s changelog entry\n./flagon version --changelog --raw: causes --changelog to print the markdown as written in the changelog.md\n./flagon version --changelog 0.0.1 - local ### Added - Exit with code `0` if a flag is `true`, and `1` otherwise - Add `--silent` flag, to suppress console information ### Changed - Expand what information is written to traces Using the changelog for Releases In github actions when building the main branch, I use this to generate a version number, and write the current changelog entry to a temporary file:\n- name: Generate Release Notes if: github.ref_name == 'main' run: | echo \"FLAGON_VERSION=$(./flagon version --short)\" \u003e\u003e \"${GITHUB_ENV}\" ./flagon version --changelog --raw \u003e release-notes.md Which are then passed to the action-gh-release step:\n- name: Release if: github.ref_name == 'main' uses: softprops/action-gh-release@v1 with: name: ${{ env.FLAGON_VERSION }} tag_name: ${{ env.FLAGON_VERSION }} body_path: release-notes.md files: flagon Which makes my releases match the version number of the binary, and have the correct release notes.\nFurther Work This system isn’t perfect (yet), but it works well for my projects. I’ve considered extracting it into its own package, but so far with only two applications using it I haven’t hit the rule of 3 yet.\n","wordCount":"568","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2022/11/22/changelogs/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Changelog Driven Versioning</h1><div class=post-meta>&lt;span title='2022-11-22 00:00:00 +0000 UTC'>November 22, 2022&lt;/span>&amp;nbsp;·&amp;nbsp;3 min</div></header><div class=post-content><p>Versioning is one of the many hard problems when it comes to writing software. There is no one correct way to do it, and all have various tradeoffs.</p><p>After reading <a href=https://keepachangelog.com/en/1.0.0/>keep a changelog</a>, I was inspired to implement this into a couple of CLI tools that I am working on at the moment: <a href=https://github.com/pondidum/flagon>Flagon</a> (feature flags on the CLI, for CI usage), and <a href=https://github.com/pondidum/cas>Cas</a> (Content Addressable Storage for Make), but I also wanted to solve my versioning and release process.</p><h2 id=requirements>Requirements<a hidden class=anchor aria-hidden=true href=#requirements>#</a></h2><ul><li>Version number should be defined in only one place</li><li>A changelog should be associated with the version number</li><li>The binary should be able to print its version and changelog</li><li>The release (Github Release in this case) should also have the changelog and version</li><li>The commit released should be tagged with the version</li></ul><p>I came up with an idea: <strong>drive everything from the changelog.</strong></p><p>The changelog can be the source of truth: it contains the version number, date of release, and the actual changes within that version. As the changelog is written in a standardised format it should be fairly easy to parse, and thus be handled by the binary itself.</p><h2 id=the-format>The Format<a hidden class=anchor aria-hidden=true href=#the-format>#</a></h2><p>I decided to follow the format from <a href=https://keepachangelog.com/en/1.0.0/>keep a changelog</a> as it is pretty minimal, in markdown, and easily parsable with a regex. As an example, here is one of the versions lifted from <a href=https://github.com/Pondidum/Flagon/blob/main/changelog.md>flagon&rsquo;s changelog</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown><span style=display:flex><span># Changelog
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## [0.0.1] - 2022-11-14
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>### Added
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>-</span> Exit with code <span style=color:#e6db74>`0`</span> if a flag is <span style=color:#e6db74>`true`</span>, and <span style=color:#e6db74>`1`</span> otherwise
</span></span><span style=display:flex><span><span style=color:#66d9ef>-</span> Add <span style=color:#e6db74>`--silent`</span> flag, to suppress console information
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>### Changed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>-</span> Expand what information is written to traces
</span></span></code></pre></div><p>Each version entry follows the same format, which is parsable by a regex:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sectionRegex</span> = <span style=color:#a6e22e>regexp</span>.<span style=color:#a6e22e>MustCompile</span>(<span style=color:#e6db74>`## \[(?P&lt;version&gt;.*)\]\s*-\s*(?P&lt;date&gt;.*)`</span>)</span></span></code></pre></div><footer style="margin:10px auto"><small><a href=https://github.com/Pondidum/flagon/blob/master/version/changelog.go>Source</a></small></footer><p>The parser itself is very short, and the result is an array of <code>ChangelogEntry</code>, giving the <code>version</code>, <code>date</code>, and text of the changes.</p><h2 id=using-the-changelog-from-the-application>Using the changelog from the application<a hidden class=anchor aria-hidden=true href=#using-the-changelog-from-the-application>#</a></h2><p>The changelog is embedded in the binary using the go <code>embed</code> package, and can then be exposed as CLI commands. The application&rsquo;s <code>version</code> command exposes this information with several flags:</p><ul><li><p>no flags: print the version number and git short sha</p></li><li><p><code>--short</code>: only print the version number</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./flagon version --short
</span></span><span style=display:flex><span>0.0.1
</span></span></code></pre></div></li><li><p><code>--changelog</code>: pretty print the current version&rsquo;s changelog entry</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./flagon version --changelog
</span></span></code></pre></div><p><img loading=lazy src=flagon-changelog.png alt="flagon changelog as prettified markdown"></p></li><li><p><code>--raw</code>: causes <code>--changelog</code> to print the markdown as written in the <code>changelog.md</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./flagon version --changelog
</span></span><span style=display:flex><span>0.0.1 - local
</span></span><span style=display:flex><span><span style=color:#75715e>### Added</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- Exit with code <span style=color:#e6db74>`</span>0<span style=color:#e6db74>`</span> <span style=color:#66d9ef>if</span> a flag is <span style=color:#e6db74>`</span>true<span style=color:#e6db74>`</span>, and <span style=color:#e6db74>`</span>1<span style=color:#e6db74>`</span> otherwise
</span></span><span style=display:flex><span>- Add <span style=color:#e6db74>`</span>--silent<span style=color:#e6db74>`</span> flag, to suppress console information
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>### Changed</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- Expand what information is written to traces
</span></span></code></pre></div></li></ul><h2 id=using-the-changelog-for-releases>Using the changelog for Releases<a hidden class=anchor aria-hidden=true href=#using-the-changelog-for-releases>#</a></h2><p>In github actions when building the <code>main</code> branch, I use this to generate a version number, and write the current changelog entry to a temporary file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Generate Release Notes</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>if</span>: <span style=color:#ae81ff>github.ref_name == &#39;main&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;FLAGON_VERSION=$(./flagon version --short)&#34; &gt;&gt; &#34;${GITHUB_ENV}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ./flagon version --changelog --raw &gt; release-notes.md</span>    
</span></span></code></pre></div><p>Which are then passed to the <code>action-gh-release</code> step:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Release</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>if</span>: <span style=color:#ae81ff>github.ref_name == &#39;main&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>softprops/action-gh-release@v1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>${{ env.FLAGON_VERSION }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tag_name</span>: <span style=color:#ae81ff>${{ env.FLAGON_VERSION }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>body_path</span>: <span style=color:#ae81ff>release-notes.md</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>files</span>: <span style=color:#ae81ff>flagon</span>
</span></span></code></pre></div><p>Which makes my releases match the version number of the binary, and have the correct release notes.</p><h2 id=further-work>Further Work<a hidden class=anchor aria-hidden=true href=#further-work>#</a></h2><p>This system isn&rsquo;t perfect (yet), but it works well for my projects. I&rsquo;ve considered extracting it into its own package, but so far with only two applications using it I haven&rsquo;t hit the <a href=https://en.wikipedia.org/wiki/Rule_of_three_(computer_programming)>rule of 3 yet</a>.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/cli/>cli</a></li><li><a href=https://andydote.co.uk/tags/process/>process</a></li><li><a href=https://andydote.co.uk/tags/ci/>ci</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2023/01/16/feature-flags-ci/><span class=title>« Prev Page</span><br><span>Feature Flags in a CI Pipeline</span>
</a><a class=next href=https://andydote.co.uk/2022/11/10/qa-and-continuous-delivery/><span class=title>Next Page »</span><br><span>QA and Continuous Delivery</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>