<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Pulumi Conditional Infrastructure for Speed | Andy Dote</title><meta name=keywords content="aws,pulumi,honeycomb"><meta name=description content="One of the reasons I prefer Pulumi over Terraform is the additional control I have over my processes due to the fact that it&rsquo;s a programming language.
For example, I have a CLI, that creates a cluster of machines for a user; the machines use IAM Authentication with Vault so that they can request certificates on boot. The trouble with this application is that it is slow; it takes 175 seconds on average to provision the machines, write the IAM information to Vault, and then re-run the cloud-init script on all the machines in the cluster (as when they first booted, the configuration hadn&rsquo;t been written to Vault yet."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2022/07/17/pulumi-faster-processes/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Pulumi Conditional Infrastructure for Speed"><meta property="og:description" content="One of the reasons I prefer Pulumi over Terraform is the additional control I have over my processes due to the fact that it&rsquo;s a programming language.
For example, I have a CLI, that creates a cluster of machines for a user; the machines use IAM Authentication with Vault so that they can request certificates on boot. The trouble with this application is that it is slow; it takes 175 seconds on average to provision the machines, write the IAM information to Vault, and then re-run the cloud-init script on all the machines in the cluster (as when they first booted, the configuration hadn&rsquo;t been written to Vault yet."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2022/07/17/pulumi-faster-processes/"><meta property="article:section" content="post"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pulumi Conditional Infrastructure for Speed"><meta name=twitter:description content="One of the reasons I prefer Pulumi over Terraform is the additional control I have over my processes due to the fact that it&rsquo;s a programming language.
For example, I have a CLI, that creates a cluster of machines for a user; the machines use IAM Authentication with Vault so that they can request certificates on boot. The trouble with this application is that it is slow; it takes 175 seconds on average to provision the machines, write the IAM information to Vault, and then re-run the cloud-init script on all the machines in the cluster (as when they first booted, the configuration hadn&rsquo;t been written to Vault yet."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Pulumi Conditional Infrastructure for Speed","item":"https://andydote.co.uk/2022/07/17/pulumi-faster-processes/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Pulumi Conditional Infrastructure for Speed","name":"Pulumi Conditional Infrastructure for Speed","description":"One of the reasons I prefer Pulumi over Terraform is the additional control I have over my processes due to the fact that it\u0026rsquo;s a programming language.\nFor example, I have a CLI, that creates a cluster of machines for a user; the machines use IAM Authentication with Vault so that they can request certificates on boot. The trouble with this application is that it is slow; it takes 175 seconds on average to provision the machines, write the IAM information to Vault, and then re-run the cloud-init script on all the machines in the cluster (as when they first booted, the configuration hadn\u0026rsquo;t been written to Vault yet.","keywords":["aws","pulumi","honeycomb"],"articleBody":"One of the reasons I prefer Pulumi over Terraform is the additional control I have over my processes due to the fact that it’s a programming language.\nFor example, I have a CLI, that creates a cluster of machines for a user; the machines use IAM Authentication with Vault so that they can request certificates on boot. The trouble with this application is that it is slow; it takes 175 seconds on average to provision the machines, write the IAM information to Vault, and then re-run the cloud-init script on all the machines in the cluster (as when they first booted, the configuration hadn’t been written to Vault yet.) so that they can request a certificate. The process is roughly this:\nCreate infrastructure Write configuration to Vault Wait for the machines to be ready Wait for SSH Re-run cloud-init The CLI can’t write the configuration to Vault before the machines boot, as the configuration values are from the same infrastructure stack as the machines themselves. You can see the process in the Honeycomb trace UI (with more details about what infra is created thanks to my pulumi-honeycomb stream adaptor):\nI don’t want to make two separate stacks for this, one containing IAM Roles and other configuration data, the other containing all the other infrastructure (load balancers, auto-scale groups, etc.) But what if I could dynamically change what the stack does?\nBy adding an IsInit property to the configuration of the stack, we can change the pulumi program to return early when the value of IsInit is true, meaning we only create the minimal amount of infrastructure for the configuration call to succeed:\nfunc DefineInfrastructure(ctx *pulumi.Context, cfg *ClusterConfiguration) error { role, err := iam.NewRole(ctx, Name+\"-iam-role\", \u0026iam.RoleArgs{ NamePrefix: pulumi.String(Name), AssumeRolePolicy: allowEc2Json, }) _, err = iam.NewRolePolicy(ctx, Name+\"-iam-policy-cluster\", \u0026iam.RolePolicyArgs{ NamePrefix: pulumi.String(Name), Role: role.ID(), Policy: findMachinesJson, }) ctx.Export(\"role-arn\", role.Arn) if cfg.IsInit { return nil } asg, err := autoscaling.NewGroup(ctx, Name+\"-asg\", \u0026autoscaling.GroupArgs{ LaunchConfiguration: createLaunchConfiguration(ctx, cfg, role), VpcZoneIdentifiers: cfg.ZoneIdentifiers, DesiredCapacity: cfg.ClusterSize, MinSize: cfg.ClusterSize, MaxSize: cfg.ClusterSize, }) ctx.Export(\"asg-name\", asg.Name) return nil } Now that the stack can be run to create only partial infrastructure, the process changes to this:\nCreate minimal infrastructure Write configuration to Vault Create remaining infrastructure But is the new process faster? I had hoped it would be a little faster, as waiting for cloud-init and SSH can take a while, and thankfully, it is significantly faster. It takes on average 98 seconds, so around 77 seconds faster.\nComparing the before and after traces, I can see that the additional pulumi call adds 20 seconds to the processes, but the consul_configure span drops from 100 seconds to 3.5, which is quite the speed increase.\nWhat about Terraform? This is still possible to do with a terraform stack, but not in a pleasant way; in pulumi I can return early from the infra function, but with terraform, I would have to add a count = var.is_init ? 0 : 1 to every resource I didn’t want to create up front, which quickly becomes unwieldy.\nThere is also the downside of not being able to embed the Terraform inside a CLI tool like I can with Pulumi.\nOverall, I am happy with how this has turned out. The diff for enabling this optimisation is 3 files changed, 15 insertions, 7 deletions, which included some explanatory comments!\n","wordCount":"550","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2022/07/17/pulumi-faster-processes/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Pulumi Conditional Infrastructure for Speed</h1><div class=post-meta><span title='2022-07-17 00:00:00 +0000 UTC'>July 17, 2022</span>&nbsp;·&nbsp;3 min</div></header><div class=post-content><p>One of the reasons I prefer <a href=https://pulumi.com>Pulumi</a> over <a href=https://terraform.io>Terraform</a> is the additional control I have over my processes due to the fact that it&rsquo;s a programming language.</p><p>For example, I have a CLI, that creates a cluster of machines for a user; the machines use IAM Authentication with <a href=https://www.vaultproject.io>Vault</a> so that they can request certificates on boot. The trouble with this application is that it is slow; it takes 175 seconds on average to provision the machines, write the IAM information to Vault, and then re-run the cloud-init script on all the machines in the cluster (as when they first booted, the configuration hadn&rsquo;t been written to Vault yet.) so that they can request a certificate. The process is roughly this:</p><ul><li>Create infrastructure</li><li>Write configuration to Vault</li><li>Wait for the machines to be ready</li><li>Wait for SSH</li><li>Re-run cloud-init</li></ul><p>The CLI can&rsquo;t write the configuration to Vault before the machines boot, as the configuration values are from the same infrastructure stack as the machines themselves. You can see the process in the <a href=https://honeycomb.io>Honeycomb</a> trace UI (with more details about what infra is created thanks to my <a href=/2021/03/01/observability-with-infrastructure-as-code/>pulumi-honeycomb stream adaptor</a>):</p><p><img loading=lazy src=pulumi-infra-slow.png alt="pulumi trace showing execution time of 175 seconds"></p><p>I don&rsquo;t want to make two separate stacks for this, one containing IAM Roles and other configuration data, the other containing all the other infrastructure (load balancers, auto-scale groups, etc.) But what if I could dynamically change what the stack does?</p><p>By adding an <code>IsInit</code> property to the configuration of the stack, we can change the pulumi program to return early when the value of <code>IsInit</code> is <code>true</code>, meaning we only create the minimal amount of infrastructure for the configuration call to succeed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>DefineInfrastructure</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pulumi</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>cfg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ClusterConfiguration</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>role</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>iam</span>.<span style=color:#a6e22e>NewRole</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>Name</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;-iam-role&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>iam</span>.<span style=color:#a6e22e>RoleArgs</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NamePrefix</span>:       <span style=color:#a6e22e>pulumi</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>Name</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>AssumeRolePolicy</span>: <span style=color:#a6e22e>allowEc2Json</span>,
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>iam</span>.<span style=color:#a6e22e>NewRolePolicy</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>Name</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;-iam-policy-cluster&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>iam</span>.<span style=color:#a6e22e>RolePolicyArgs</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NamePrefix</span>: <span style=color:#a6e22e>pulumi</span>.<span style=color:#a6e22e>String</span>(<span style=color:#a6e22e>Name</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Role</span>:       <span style=color:#a6e22e>role</span>.<span style=color:#a6e22e>ID</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Policy</span>:     <span style=color:#a6e22e>findMachinesJson</span>,
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Export</span>(<span style=color:#e6db74>&#34;role-arn&#34;</span>, <span style=color:#a6e22e>role</span>.<span style=color:#a6e22e>Arn</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>IsInit</span> {
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>asg</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>autoscaling</span>.<span style=color:#a6e22e>NewGroup</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>Name</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;-asg&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>autoscaling</span>.<span style=color:#a6e22e>GroupArgs</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LaunchConfiguration</span>: <span style=color:#a6e22e>createLaunchConfiguration</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>role</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>VpcZoneIdentifiers</span>:  <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>ZoneIdentifiers</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DesiredCapacity</span>:     <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>ClusterSize</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MinSize</span>:             <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>ClusterSize</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxSize</span>:             <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>ClusterSize</span>,
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Export</span>(<span style=color:#e6db74>&#34;asg-name&#34;</span>, <span style=color:#a6e22e>asg</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now that the stack can be run to create only partial infrastructure, the process changes to this:</p><ul><li>Create minimal infrastructure</li><li>Write configuration to Vault</li><li>Create remaining infrastructure</li></ul><p>But is the new process faster? I had hoped it would be a little faster, as waiting for cloud-init and SSH can take a while, and thankfully, it is significantly faster. It takes on average 98 seconds, so around 77 seconds faster.</p><p><img loading=lazy src=pulumi-infra-fast.png alt="pulumi trace showing execution time of 98 seconds"></p><p>Comparing the before and after traces, I can see that the additional pulumi call adds 20 seconds to the processes, but the <code>consul_configure</code> span drops from 100 seconds to 3.5, which is quite the speed increase.</p><h2 id=what-about-terraform>What about Terraform?<a hidden class=anchor aria-hidden=true href=#what-about-terraform>#</a></h2><p>This is still possible to do with a terraform stack, but not in a pleasant way; in pulumi I can return early from the infra function, but with terraform, I would have to add a <code>count = var.is_init ? 0 : 1</code> to every resource I didn&rsquo;t want to create up front, which quickly becomes unwieldy.</p><p>There is also the downside of not being able to embed the Terraform inside a CLI tool like I can with Pulumi.</p><p>Overall, I am happy with how this has turned out. The diff for enabling this optimisation is 3 files changed, 15 insertions, 7 deletions, which included some explanatory comments!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/aws/>aws</a></li><li><a href=https://andydote.co.uk/tags/pulumi/>pulumi</a></li><li><a href=https://andydote.co.uk/tags/honeycomb/>honeycomb</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2022/09/11/uml-isnt-dead/><span class=title>« Prev Page</span><br><span>The reports of UML's death are greatly exaggerated</span></a>
<a class=next href=https://andydote.co.uk/2022/04/23/nginx-dns/><span class=title>Next Page »</span><br><span>An NGINX and DNS based outage</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>