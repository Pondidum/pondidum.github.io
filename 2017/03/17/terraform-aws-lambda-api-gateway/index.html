<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using Terraform to setup AWS API-Gateway and Lambda | Andy Dote</title><meta name=keywords content="c#,nodejs,aws,terraform,lambda,apigateway,rest"><meta name=description content="I have been writing simple webhook type applications using Claudiajs, which in behind the scenes is using Aws&rsquo;s Lambda and Api Gateway to make things happen, but I really wanted to understand what exactly it was doing for me, and how I could achieve the same results using Terraform.
The Lambda Function I started off with a simple NodeJS function, in a file called index.js
exports.handler = function(event, context, callback) { callback(null, { statusCode: '200', body: JSON."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2017/03/17/terraform-aws-lambda-api-gateway/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b4e19c453811e60acfec1f00c15ac2be1c53f6ab90187e684358ce7faaf48bab.css integrity="sha256-tOGcRTgR5grP7B8AwVrCvhxT9quQGH5oQ1jOf6r0i6s=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Using Terraform to setup AWS API-Gateway and Lambda"><meta property="og:description" content="I have been writing simple webhook type applications using Claudiajs, which in behind the scenes is using Aws&rsquo;s Lambda and Api Gateway to make things happen, but I really wanted to understand what exactly it was doing for me, and how I could achieve the same results using Terraform.
The Lambda Function I started off with a simple NodeJS function, in a file called index.js
exports.handler = function(event, context, callback) { callback(null, { statusCode: '200', body: JSON."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2017/03/17/terraform-aws-lambda-api-gateway/"><meta property="article:section" content="post"><meta property="article:published_time" content="2017-03-17T00:00:00+00:00"><meta property="article:modified_time" content="2017-03-17T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Terraform to setup AWS API-Gateway and Lambda"><meta name=twitter:description content="I have been writing simple webhook type applications using Claudiajs, which in behind the scenes is using Aws&rsquo;s Lambda and Api Gateway to make things happen, but I really wanted to understand what exactly it was doing for me, and how I could achieve the same results using Terraform.
The Lambda Function I started off with a simple NodeJS function, in a file called index.js
exports.handler = function(event, context, callback) { callback(null, { statusCode: '200', body: JSON."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Using Terraform to setup AWS API-Gateway and Lambda","item":"https://andydote.co.uk/2017/03/17/terraform-aws-lambda-api-gateway/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using Terraform to setup AWS API-Gateway and Lambda","name":"Using Terraform to setup AWS API-Gateway and Lambda","description":"I have been writing simple webhook type applications using Claudiajs, which in behind the scenes is using Aws\u0026rsquo;s Lambda and Api Gateway to make things happen, but I really wanted to understand what exactly it was doing for me, and how I could achieve the same results using Terraform.\nThe Lambda Function I started off with a simple NodeJS function, in a file called index.js\nexports.handler = function(event, context, callback) { callback(null, { statusCode: \u0026#39;200\u0026#39;, body: JSON.","keywords":["c#","nodejs","aws","terraform","lambda","apigateway","rest"],"articleBody":"I have been writing simple webhook type applications using Claudiajs, which in behind the scenes is using Aws’s Lambda and Api Gateway to make things happen, but I really wanted to understand what exactly it was doing for me, and how I could achieve the same results using Terraform.\nThe Lambda Function I started off with a simple NodeJS function, in a file called index.js\nexports.handler = function(event, context, callback) { callback(null, { statusCode: '200', body: JSON.stringify({ 'message': 'hello world' }), headers: { 'Content-Type': 'application/json', }, }); }; First thing to note about this function is the 2nd argument passed to callback: this maps to the whole response object not just the body. If you try and just run callback(null, { message: 'hello world' }), when called from the API Gateway, you will get the following error in your CloudWatch logs, and not a lot of help on Google:\nExecution failed due to configuration error: “Malformed Lambda proxy response”\nTerraform We want to upload a zip file containing all our lambda’s code, which in this case is just the index.js file. While this could be done by generating the zip file with a gulp script or manually, we can just get terraform to do this for us, by using the archive_file data source:\ndata \"archive_file\" \"lambda\" { type = \"zip\" source_file = \"index.js\" output_path = \"lambda.zip\" } resource \"aws_lambda_function\" \"example_test_function\" { filename = \"${data.archive_file.lambda.output_path}\" function_name = \"example_test_function\" role = \"${aws_iam_role.example_api_role.arn}\" handler = \"index.handler\" runtime = \"nodejs4.3\" source_code_hash = \"${base64sha256(file(\"${data.archive_file.lambda.output_path}\"))}\" publish = true } By using the source_code_hash property, Terraform can detect when the zip file has changed, and thus know whether to re-upload the function when you call terraform apply.\nWe also need an IAM role for the function to run under. While the policy could be written inline, but I have found it more expressive to have a separate file for the role policy:\nresource \"aws_iam_role\" \"example_api_role\" { name = \"example_api_role\" assume_role_policy = \"${file(\"policies/lambda-role.json\")}\" } { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Action\": \"sts:AssumeRole\", \"Principal\": { \"Service\": [ \"lambda.amazonaws.com\", \"apigateway.amazonaws.com\" ] }, \"Effect\": \"Allow\", \"Sid\": \"\" } ] } That’s the lambda done - you can login to the AWS Console, setup a test event and execute it if you want :)\nCreating the Api Gateway We are going to create a simple api, with one endpoint (or resource, in AWS terminology).\nFirst we need to define an api root:\nresource \"aws_api_gateway_rest_api\" \"example_api\" { name = \"ExampleAPI\" description = \"Example Rest Api\" } And then a resource to represent the /messages endpoint, and a method to handle POST:\nresource \"aws_api_gateway_resource\" \"example_api_resource\" { rest_api_id = \"${aws_api_gateway_rest_api.example_api.id}\" parent_id = \"${aws_api_gateway_rest_api.example_api.root_resource_id}\" path_part = \"messages\" } resource \"aws_api_gateway_method\" \"example_api_method\" { rest_api_id = \"${aws_api_gateway_rest_api.example_api.id}\" resource_id = \"${aws_api_gateway_resource.example_api_resource.id}\" http_method = \"POST\" authorization = \"NONE\" } The aws_api_gateway_resource can be attached to other aws_api_gateway_resources rather than to the api root too, allowing for multi level routes. You can do this by changing the parent_id property to point to another aws_api_gateway_resource.id.\nNow we need add an integration between the api and lambda:\nresource \"aws_api_gateway_integration\" \"example_api_method-integration\" { rest_api_id = \"${aws_api_gateway_rest_api.example_api.id}\" resource_id = \"${aws_api_gateway_resource.example_api_resource.id}\" http_method = \"${aws_api_gateway_method.example_api_method.http_method}\" type = \"AWS_PROXY\" uri = \"arn:aws:apigateway:${var.region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${var.region}:${var.account_id}:function:${aws_lambda_function.example_test_function.function_name}/invocations\" integration_http_method = \"POST\" } Finally a couple of deployment stages, and an output variable for each to let you know the api’s urls:\nresource \"aws_api_gateway_deployment\" \"example_deployment_dev\" { depends_on = [ \"aws_api_gateway_method.example_api_method\", \"aws_api_gateway_integration.example_api_method-integration\" ] rest_api_id = \"${aws_api_gateway_rest_api.example_api.id}\" stage_name = \"dev\" } resource \"aws_api_gateway_deployment\" \"example_deployment_prod\" { depends_on = [ \"aws_api_gateway_method.example_api_method\", \"aws_api_gateway_integration.example_api_method-integration\" ] rest_api_id = \"${aws_api_gateway_rest_api.example_api.id}\" stage_name = \"api\" } output \"dev_url\" { value = \"https://${aws_api_gateway_deployment.example_deployment_dev.rest_api_id}.execute-api.${var.region}.amazonaws.com/${aws_api_gateway_deployment.example_deployment_dev.stage_name}\" } output \"prod_url\" { value = \"https://${aws_api_gateway_deployment.example_deployment_prod.rest_api_id}.execute-api.${var.region}.amazonaws.com/${aws_api_gateway_deployment.example_deployment_prod.stage_name}\" } The two output variables will cause terraform to output the paths when you call terraform apply, or afterwards when you call terraform output dev_url. Great for scripts which need to know the urls!\nRun it! You can now call your url and see a friendly hello world message:\ncurl -X POST -H \"Content-Type: application/json\" \"YOUR_DEV_OR_PROD_URL\" Switching to C# Switching to a C#/dotnetcore lambda is very straight forward from here. We just need to change the aws_lambda_function’s runtime and handler properties, and change the archive_file to use source_dir rather than source_file:\ndata \"archive_file\" \"lambda\" { type = \"zip\" source_dir = \"./src/published\" output_path = \"lambda.zip\" } resource \"aws_lambda_function\" \"example_test_function\" { filename = \"${data.archive_file.lambda.output_path}\" function_name = \"example_test_function\" role = \"${aws_iam_role.example_api_role.arn}\" handler = \"ExampleLambdaApi::ExampleLambdaApi.Handler::Handle\" runtime = \"dotnetcore1.0\" source_code_hash = \"${base64sha256(file(\"${data.archive_file.lambda.output_path}\"))}\" publish = true } Note the handler property is in the form AssemblyName::FullyQualifiedTypeName::MethodName.\nFor our C# project, we need the following two nugets:\nAmazon.Lambda.APIGatewayEvents Amazon.Lambda.Serialization.Json And the only file in our project looks like so:\nnamespace ExampleLambdaApi { public class Handler { [LambdaSerializer(typeof(JsonSerializer))] public APIGatewayProxyResponse Handle(APIGatewayProxyRequest apigProxyEvent) { return new APIGatewayProxyResponse { Body = apigProxyEvent.Body, StatusCode = 200, }; } } } One thing worth noting is that the first time a C# function is called it takes a long time - in the region of 5-6 seconds. Subsequent invocations are in the 200ms region.\nAll the code for this demo can be found on my GitHub, in the terraform-demos repository.\n","wordCount":"831","inLanguage":"en","datePublished":"2017-03-17T00:00:00Z","dateModified":"2017-03-17T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2017/03/17/terraform-aws-lambda-api-gateway/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Using Terraform to setup AWS API-Gateway and Lambda</h1><div class=post-meta><span title='2017-03-17 00:00:00 +0000 UTC'>March 17, 2017</span>&nbsp;·&nbsp;4 min</div></header><div class=post-content><p>I have been writing simple webhook type applications using <a href=https://claudiajs.com/>Claudiajs</a>, which in behind the scenes is using Aws&rsquo;s Lambda and Api Gateway to make things happen, but I really wanted to understand what exactly it was doing for me, and how I could achieve the same results using <a href=https://terraform.io>Terraform</a>.</p><h3 id=the-lambda-function>The Lambda Function<a hidden class=anchor aria-hidden=true href=#the-lambda-function>#</a></h3><p>I started off with a simple NodeJS function, in a file called <code>index.js</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>context</span>, <span style=color:#a6e22e>callback</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>callback</span>(<span style=color:#66d9ef>null</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;200&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({ <span style=color:#e6db74>&#39;message&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;hello world&#39;</span> }),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>First thing to note about this function is the 2nd argument passed to <code>callback</code>: <strong>this maps to the whole response object not just the body</strong>. If you try and just run <code>callback(null, { message: 'hello world' })</code>, when called from the API Gateway, you will get the following error in your CloudWatch logs, and not a lot of help on Google:</p><blockquote><p>Execution failed due to configuration error: &ldquo;Malformed Lambda proxy response&rdquo;</p></blockquote><h2 id=terraform>Terraform<a hidden class=anchor aria-hidden=true href=#terraform>#</a></h2><p>We want to upload a zip file containing all our lambda&rsquo;s code, which in this case is just the <code>index.js</code> file. While this could be done by generating the zip file with a gulp script or manually, we can just get terraform to do this for us, by using the <a href=https://www.terraform.io/docs/providers/archive/d/archive_file.html>archive_file data source</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>data</span> <span style=color:#960050;background-color:#1e0010>&#34;archive_file&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;lambda&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>type</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;zip&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>source_file</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;index.js&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>output_path</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;lambda.zip&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>resource</span> <span style=color:#960050;background-color:#1e0010>&#34;aws_lambda_function&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;example_test_function&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>filename</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${data.archive_file.lambda.output_path}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>function_name</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;example_test_function&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>role</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_iam_role.example_api_role.arn}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>handler</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;index.handler&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>runtime</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;nodejs4.3&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>source_code_hash</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${</span>base64sha256(<span style=color:#e6db74>file(</span><span style=color:#e6db74>&#34;${data.archive_file.lambda.output_path}&#34;</span>)<span style=color:#960050;background-color:#1e0010>)}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>publish</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>true
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><p>By using the <code>source_code_hash</code> property, Terraform can detect when the zip file has changed, and thus know whether to re-upload the function when you call <code>terraform apply</code>.</p><p>We also need an IAM role for the function to run under. While the policy could be written inline, but I have found it more expressive to have a separate file for the role policy:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>resource</span> <span style=color:#960050;background-color:#1e0010>&#34;aws_iam_role&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;example_api_role&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>name</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;example_api_role&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>assume_role_policy</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${</span>file(<span style=color:#e6db74>&#34;policies/lambda-role.json&#34;</span>)<span style=color:#960050;background-color:#1e0010>}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Action&#34;</span>: <span style=color:#e6db74>&#34;sts:AssumeRole&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Principal&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;Service&#34;</span>: [
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;lambda.amazonaws.com&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;apigateway.amazonaws.com&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Sid&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That&rsquo;s the lambda done - you can login to the AWS Console, setup a test event and execute it if you want :)</p><h3 id=creating-the-api-gateway>Creating the Api Gateway<a hidden class=anchor aria-hidden=true href=#creating-the-api-gateway>#</a></h3><p>We are going to create a simple api, with one endpoint (or resource, in AWS terminology).</p><p>First we need to define an api root:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>resource</span> <span style=color:#960050;background-color:#1e0010>&#34;aws_api_gateway_rest_api&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;example_api&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>name</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;ExampleAPI&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>description</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;Example</span> <span style=color:#960050;background-color:#1e0010>Rest</span> <span style=color:#960050;background-color:#1e0010>Api&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><p>And then a resource to represent the <code>/messages</code> endpoint, and a method to handle <code>POST</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>resource</span> <span style=color:#960050;background-color:#1e0010>&#34;aws_api_gateway_resource&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;example_api_resource&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>rest_api_id</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_api_gateway_rest_api.example_api.id}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>parent_id</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_api_gateway_rest_api.example_api.root_resource_id}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>path_part</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;messages&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>resource</span> <span style=color:#960050;background-color:#1e0010>&#34;aws_api_gateway_method&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;example_api_method&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>rest_api_id</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_api_gateway_rest_api.example_api.id}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>resource_id</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_api_gateway_resource.example_api_resource.id}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>http_method</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;POST&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>authorization</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;NONE&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><p>The <code>aws_api_gateway_resource</code> can be attached to other <code>aws_api_gateway_resource</code>s rather than to the api root too, allowing for multi level routes. You can do this by changing the <code>parent_id</code> property to point to another <code>aws_api_gateway_resource.id</code>.</p><p>Now we need add an integration between the api and lambda:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>resource</span> <span style=color:#960050;background-color:#1e0010>&#34;aws_api_gateway_integration&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;example_api_method-integration&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>rest_api_id</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_api_gateway_rest_api.example_api.id}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>resource_id</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_api_gateway_resource.example_api_resource.id}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>http_method</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_api_gateway_method.example_api_method.http_method}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>type</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;AWS_PROXY&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>uri</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;arn:aws:apigateway:${var.region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${var.region}:${var.account_id}:function:${aws_lambda_function.example_test_function.function_name}/invocations&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>integration_http_method</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;POST&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><p>Finally a couple of deployment stages, and an output variable for each to let you know the api&rsquo;s urls:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>resource</span> <span style=color:#960050;background-color:#1e0010>&#34;aws_api_gateway_deployment&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;example_deployment_dev&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>depends_on</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>[
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>&#34;aws_api_gateway_method.example_api_method&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>&#34;aws_api_gateway_integration.example_api_method-integration&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>]
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>rest_api_id</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_api_gateway_rest_api.example_api.id}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>stage_name</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;dev&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>resource</span> <span style=color:#960050;background-color:#1e0010>&#34;aws_api_gateway_deployment&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;example_deployment_prod&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>depends_on</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>[
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>&#34;aws_api_gateway_method.example_api_method&#34;,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>&#34;aws_api_gateway_integration.example_api_method-integration&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>]
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>rest_api_id</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_api_gateway_rest_api.example_api.id}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>stage_name</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;api&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>output</span> <span style=color:#960050;background-color:#1e0010>&#34;dev_url&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>value</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;https://${aws_api_gateway_deployment.example_deployment_dev.rest_api_id}.execute-api.${var.region}.amazonaws.com/${aws_api_gateway_deployment.example_deployment_dev.stage_name}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>output</span> <span style=color:#960050;background-color:#1e0010>&#34;prod_url&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>value</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;https://${aws_api_gateway_deployment.example_deployment_prod.rest_api_id}.execute-api.${var.region}.amazonaws.com/${aws_api_gateway_deployment.example_deployment_prod.stage_name}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><p>The two output variables will cause terraform to output the paths when you call <code>terraform apply</code>, or afterwards when you call <code>terraform output dev_url</code>. Great for scripts which need to know the urls!</p><h3 id=run-it>Run it!<a hidden class=anchor aria-hidden=true href=#run-it>#</a></h3><p>You can now call your url and see a friendly hello world message:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -X POST -H <span style=color:#e6db74>&#34;Content-Type: application/json&#34;</span> <span style=color:#e6db74>&#34;YOUR_DEV_OR_PROD_URL&#34;</span>
</span></span></code></pre></div><h2 id=switching-to-c>Switching to C#<a hidden class=anchor aria-hidden=true href=#switching-to-c>#</a></h2><p>Switching to a C#/dotnetcore lambda is very straight forward from here. We just need to change the <code>aws_lambda_function</code>&rsquo;s runtime and handler properties, and change the <code>archive_file</code> to use <code>source_dir</code> rather than <code>source_file</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>data</span> <span style=color:#960050;background-color:#1e0010>&#34;archive_file&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;lambda&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>type</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;zip&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>source_dir</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;./src/published&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>output_path</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;lambda.zip&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>resource</span> <span style=color:#960050;background-color:#1e0010>&#34;aws_lambda_function&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;example_test_function&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>filename</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${data.archive_file.lambda.output_path}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>function_name</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;example_test_function&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>role</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_iam_role.example_api_role.arn}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>handler</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;ExampleLambdaApi::ExampleLambdaApi.Handler::Handle&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>runtime</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;dotnetcore1.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>source_code_hash</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${</span>base64sha256(<span style=color:#e6db74>file(</span><span style=color:#e6db74>&#34;${data.archive_file.lambda.output_path}&#34;</span>)<span style=color:#960050;background-color:#1e0010>)}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>publish</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>true
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><p>Note the <code>handler</code> property is in the form <code>AssemblyName::FullyQualifiedTypeName::MethodName</code>.</p><p>For our C# project, we need the following two nugets:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Amazon.Lambda.APIGatewayEvents
</span></span><span style=display:flex><span>Amazon.Lambda.Serialization.Json
</span></span></code></pre></div><p>And the only file in our project looks like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>namespace</span> ExampleLambdaApi
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Handler</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span><span style=color:#a6e22e>    [LambdaSerializer(typeof(JsonSerializer))]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> APIGatewayProxyResponse Handle(APIGatewayProxyRequest apigProxyEvent)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> APIGatewayProxyResponse
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        Body = apigProxyEvent.Body,
</span></span><span style=display:flex><span>        StatusCode = <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>One thing worth noting is that the first time a C# function is called it takes a long time - in the region of 5-6 seconds. Subsequent invocations are in the 200ms region.</p><p>All the code for this demo can be found on my <a href=https://github.com/pondidum/>GitHub</a>, in the <a href=https://github.com/Pondidum/Terraform-Demos/tree/master/api-lambda>terraform-demos repository</a>.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/c#/>c#</a></li><li><a href=https://andydote.co.uk/tags/nodejs/>nodejs</a></li><li><a href=https://andydote.co.uk/tags/aws/>aws</a></li><li><a href=https://andydote.co.uk/tags/terraform/>terraform</a></li><li><a href=https://andydote.co.uk/tags/lambda/>lambda</a></li><li><a href=https://andydote.co.uk/tags/apigateway/>apigateway</a></li><li><a href=https://andydote.co.uk/tags/rest/>rest</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2017/04/16/dont-write-frameworks-write-libraries/><span class=title>« Prev Page</span><br><span>Don't write Frameworks, write Libraries</span></a>
<a class=next href=https://andydote.co.uk/2017/01/21/unit-tests-and-scratchpads/><span class=title>Next Page »</span><br><span>Unit Tests & Scratchpads</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>