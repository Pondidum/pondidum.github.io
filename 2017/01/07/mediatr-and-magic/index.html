<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>MediatR and Magic | Andy Dote</title><meta name=keywords content="c#,cqs,cqrs,mediatr"><meta name=description content="Having recently watched Greg Young&rsquo;s excellent talk on 8 Lines of Code I was thinking about how this kind of thinking applies to the mediator pattern, and specifically the MediatR implementation.
I have written about the advantages of CQRS with MediatR before, but having used it for a long time now, there are some parts which cause friction on a regular basis.
The problems Discoverability The biggest issue first. You have a controller with the following constructor:"><meta name=author content><link rel=canonical href=https://andydote.co.uk/2017/01/07/mediatr-and-magic/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ea821116adbd94ff8c04bf7745204429750a1079f16951db0415b837fc273249.css integrity="sha256-6oIRFq29lP+MBL93RSBEKXUKEHnxaVHbBBW4N/wnMkk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="MediatR and Magic"><meta property="og:description" content="Having recently watched Greg Young&rsquo;s excellent talk on 8 Lines of Code I was thinking about how this kind of thinking applies to the mediator pattern, and specifically the MediatR implementation.
I have written about the advantages of CQRS with MediatR before, but having used it for a long time now, there are some parts which cause friction on a regular basis.
The problems Discoverability The biggest issue first. You have a controller with the following constructor:"><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2017/01/07/mediatr-and-magic/"><meta property="article:section" content="post"><meta property="article:published_time" content="2017-01-07T00:00:00+00:00"><meta property="article:modified_time" content="2017-01-07T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="MediatR and Magic"><meta name=twitter:description content="Having recently watched Greg Young&rsquo;s excellent talk on 8 Lines of Code I was thinking about how this kind of thinking applies to the mediator pattern, and specifically the MediatR implementation.
I have written about the advantages of CQRS with MediatR before, but having used it for a long time now, there are some parts which cause friction on a regular basis.
The problems Discoverability The biggest issue first. You have a controller with the following constructor:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"MediatR and Magic","item":"https://andydote.co.uk/2017/01/07/mediatr-and-magic/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"MediatR and Magic","name":"MediatR and Magic","description":"Having recently watched Greg Young\u0026rsquo;s excellent talk on 8 Lines of Code I was thinking about how this kind of thinking applies to the mediator pattern, and specifically the MediatR implementation.\nI have written about the advantages of CQRS with MediatR before, but having used it for a long time now, there are some parts which cause friction on a regular basis.\nThe problems Discoverability The biggest issue first. You have a controller with the following constructor:","keywords":["c#","cqs","cqrs","mediatr"],"articleBody":"Having recently watched Greg Young’s excellent talk on 8 Lines of Code I was thinking about how this kind of thinking applies to the mediator pattern, and specifically the MediatR implementation.\nI have written about the advantages of CQRS with MediatR before, but having used it for a long time now, there are some parts which cause friction on a regular basis.\nThe problems Discoverability The biggest issue first. You have a controller with the following constructor:\npublic AddressController(IMediator mediator) { _mediator = mediator; } What messages does it emit? What handlers are used by it? No idea without grepping for _mediator.\nWhere is the hander for X? So you have a controller with a method which sends a GetAllAddressesQuery:\npublic class AddressController : ApiController { public IEnumerable Get() { return _mediator.Send(new GetAllAddressesQuery(User)); } } The fastest way to get to the handler definition is to hit Ctrl+T and type in GetAllAddressesQueryHandler. This becomes more problematic on larger codebases when you can end up with many handlers with similar names.\nWhat calls {command|query}Handler? Given the following handler, what uses it?\npublic class GetAllAddressesQueryHandler : IRequestHandler","wordCount":"547","inLanguage":"en","datePublished":"2017-01-07T00:00:00Z","dateModified":"2017-01-07T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2017/01/07/mediatr-and-magic/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>MediatR and Magic</h1><div class=post-meta><span title='2017-01-07 00:00:00 +0000 UTC'>January 7, 2017</span>&nbsp;·&nbsp;3 min</div></header><div class=post-content><p>Having recently watched Greg Young&rsquo;s excellent talk on <a href=https://www.infoq.com/presentations/8-lines-code-refactoring>8 Lines of Code</a> I was thinking about how this kind of thinking applies to the mediator pattern, and specifically the <a href=https://github.com/jbogard/MediatR>MediatR</a> implementation.</p><p>I have written about the advantages of <a href=/2016/03/19/cqs-with-mediatr/>CQRS with MediatR</a> before, but having used it for a long time now, there are some parts which cause friction on a regular basis.</p><h2 id=the-problems>The problems<a hidden class=anchor aria-hidden=true href=#the-problems>#</a></h2><h3 id=discoverability>Discoverability<a hidden class=anchor aria-hidden=true href=#discoverability>#</a></h3><p>The biggest issue first. You have a controller with the following constructor:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> AddressController(IMediator mediator)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    _mediator = mediator;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>What messages does it emit? What handlers are used by it? No idea without grepping for <code>_mediator.</code></p><h3 id=where-is-the-hander-for-x>Where is the hander for X?<a hidden class=anchor aria-hidden=true href=#where-is-the-hander-for-x>#</a></h3><p>So you have a controller with a method which sends a <code>GetAllAddressesQuery</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AddressController</span> : ApiController
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IEnumerable&lt;Address&gt; Get()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _mediator.Send(<span style=color:#66d9ef>new</span> GetAllAddressesQuery(User));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The fastest way to get to the handler definition is to hit <code>Ctrl+T</code> and type in <code>GetAllAddressesQueryHandler</code>. This becomes more problematic on larger codebases when you can end up with many handlers with similar names.</p><h3 id=what-calls-commandqueryhandler>What calls {command|query}Handler?<a hidden class=anchor aria-hidden=true href=#what-calls-commandqueryhandler>#</a></h3><p>Given the following handler, what uses it?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GetAllAddressesQueryHandler</span> : IRequestHandler&lt;GetAllAddressesQuery, IEnumerable&lt;Address&gt;&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IEnumerable&lt;Address&gt; Handle(GetAllAddressesQuery message)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//...</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With this problem you can use <code>Find Usages</code> on the <code>GetAllAddressesQuery</code> type parameter to find what calls it, so this isn&rsquo;t so bad at all. The main problem is I am often doing <code>Find Usages</code> on the handler itself, not the message.</p><h2 id=solutions>Solutions<a hidden class=anchor aria-hidden=true href=#solutions>#</a></h2><h3 id=discoverability-1>Discoverability<a hidden class=anchor aria-hidden=true href=#discoverability-1>#</a></h3><p>The team I am on at work felt this problem a lot before I joined, and had decided to role their own mediation pipeline. It works much the same as MediatR, but rather than injecting an <code>IMediator</code> interface into the constructor, you inject interface(s) representing the handler(s) being used:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> AddressController(IGetAllAddressesQueryHandler getHandler, IAddAddressHandler addHandler)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    _getHandler = getHandler;
</span></span><span style=display:flex><span>    _addHandler = addHandler;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The trade-offs made by this method are:</p><ul><li>The controllers are now more tightly coupled to the handlers (Handlers are mostly used by 1 controller anyway)</li><li>We can&rsquo;t easily do multicast messages (We almost never need to do this)</li><li>More types are required (the interface) for your handler (so what?)</li></ul><p>On the whole, I think this is a pretty good trade-off to be made, we get all the discoverability we wanted, and our controllers and handlers are still testable.</p><h3 id=what-callswhere-is-commandqueryhandler>What calls/Where is {command|query}Handler?<a hidden class=anchor aria-hidden=true href=#what-callswhere-is-commandqueryhandler>#</a></h3><p>This is also solved by the switch to our internal library, but we also augment the change by grouping everything into functionality groups:</p><pre tabindex=0><code>Frontend
  Adddress
    AddressController.cs
    GetAllAddressesQuery.cs
    GetAllAddressesQueryHandler.cs
    IGetAllAddressesQueryHandler.cs
  Contact
    ContactController.cs
    ...
  Startup.cs
  project.json
</code></pre><p>I happen to prefer this structure to a folder for each role (e.g. <code>controllers</code>, <code>messages</code>, <code>handlers</code>), so this is not a hard change to make for me.</p><h2 id=magic>Magic<a hidden class=anchor aria-hidden=true href=#magic>#</a></h2><p>As Greg noted in his video, the second you take in a 3rd party library, it&rsquo;s code you own (or are responsible for). The changes we have made have really just traded some 3rd party magic for some internal magic. How the handler pipeline gets constructed can be a mystery still (unless you go digging through the library), but it&rsquo;s a mystery we control.</p><p>The important part of this to note is that we felt a pain/friction with how we are working, and decided to change what trade-offs we were making.</p><p>What trade-offs are you making? Is it worth changing the deal?</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/c#/>c#</a></li><li><a href=https://andydote.co.uk/tags/cqs/>cqs</a></li><li><a href=https://andydote.co.uk/tags/cqrs/>cqrs</a></li><li><a href=https://andydote.co.uk/tags/mediatr/>mediatr</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2017/01/16/update-all-docker-images/><span class=title>« Prev Page</span><br><span>Update all Docker images</span></a>
<a class=next href=https://andydote.co.uk/2017/01/06/git-aliases/><span class=title>Next Page »</span><br><span>Git Aliases</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>