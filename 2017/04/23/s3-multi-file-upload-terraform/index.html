<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>S3 Multi-File upload with Terraform | Andy Dote</title>
<meta name=keywords content="aws,terraform,s3"><meta name=description content="Hosting a static website with S3 is really easy, especially from terraform:
First off, we want a public readable S3 bucket policy, but we want to apply this only to one specific bucket. To achive that we can use Terraform&rsquo;s template_file data block to merge in a value:
{ &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Sid&#34;: &#34;PublicReadGetObject&#34;, &#34;Effect&#34;: &#34;Allow&#34;, &#34;Principal&#34;: &#34;*&#34;, &#34;Action&#34;: [ &#34;s3:GetObject&#34; ], &#34;Resource&#34;: [ &#34;arn:aws:s3:::${bucket_name}/*&#34; ] } ] } As you can see the interpolation syntax is pretty much the same as how you use variables in terraform itself."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2017/04/23/s3-multi-file-upload-terraform/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.c6a36963ab47314b3d95fe85a9385337e1ef8eb1c2194eecb86f178d492ab666.js integrity="sha256-xqNpY6tHMUs9lf6FqThTN+HvjrHCGU7suG8XjUkqtmY="></script><script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script><link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="S3 Multi-File upload with Terraform"><meta property="og:description" content="Hosting a static website with S3 is really easy, especially from terraform:
First off, we want a public readable S3 bucket policy, but we want to apply this only to one specific bucket. To achive that we can use Terraform&rsquo;s template_file data block to merge in a value:
{ &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Sid&#34;: &#34;PublicReadGetObject&#34;, &#34;Effect&#34;: &#34;Allow&#34;, &#34;Principal&#34;: &#34;*&#34;, &#34;Action&#34;: [ &#34;s3:GetObject&#34; ], &#34;Resource&#34;: [ &#34;arn:aws:s3:::${bucket_name}/*&#34; ] } ] } As you can see the interpolation syntax is pretty much the same as how you use variables in terraform itself."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2017/04/23/s3-multi-file-upload-terraform/"><meta property="article:section" content="post"><meta property="article:published_time" content="2017-04-23T00:00:00+00:00"><meta property="article:modified_time" content="2017-04-23T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="S3 Multi-File upload with Terraform"><meta name=twitter:description content="Hosting a static website with S3 is really easy, especially from terraform:
First off, we want a public readable S3 bucket policy, but we want to apply this only to one specific bucket. To achive that we can use Terraform&rsquo;s template_file data block to merge in a value:
{ &#34;Version&#34;: &#34;2012-10-17&#34;, &#34;Statement&#34;: [ { &#34;Sid&#34;: &#34;PublicReadGetObject&#34;, &#34;Effect&#34;: &#34;Allow&#34;, &#34;Principal&#34;: &#34;*&#34;, &#34;Action&#34;: [ &#34;s3:GetObject&#34; ], &#34;Resource&#34;: [ &#34;arn:aws:s3:::${bucket_name}/*&#34; ] } ] } As you can see the interpolation syntax is pretty much the same as how you use variables in terraform itself."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"S3 Multi-File upload with Terraform","item":"https://andydote.co.uk/2017/04/23/s3-multi-file-upload-terraform/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"S3 Multi-File upload with Terraform","name":"S3 Multi-File upload with Terraform","description":"Hosting a static website with S3 is really easy, especially from terraform:\nFirst off, we want a public readable S3 bucket policy, but we want to apply this only to one specific bucket. To achive that we can use Terraform\u0026rsquo;s template_file data block to merge in a value:\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Sid\u0026#34;: \u0026#34;PublicReadGetObject\u0026#34;, \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Principal\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;s3:GetObject\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;arn:aws:s3:::${bucket_name}/*\u0026#34; ] } ] } As you can see the interpolation syntax is pretty much the same as how you use variables in terraform itself.","keywords":["aws","terraform","s3"],"articleBody":"Hosting a static website with S3 is really easy, especially from terraform:\nFirst off, we want a public readable S3 bucket policy, but we want to apply this only to one specific bucket. To achive that we can use Terraform’s template_file data block to merge in a value:\n{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"PublicReadGetObject\", \"Effect\": \"Allow\", \"Principal\": \"*\", \"Action\": [ \"s3:GetObject\" ], \"Resource\": [ \"arn:aws:s3:::${bucket_name}/*\" ] } ] } As you can see the interpolation syntax is pretty much the same as how you use variables in terraform itself. Next we define a template_file to do the transformation. As the bucket name is going to be used many times, we extract that into a variable block also:\nvariable \"bucket\" { default = \"examplebucket\" } data \"template_file\" \"s3_public_policy\" { template = \"${file(\"policies/s3-public.json\")}\" vars { bucket_name = \"${var.bucket}\" } } Next we want to create the S3 bucket and set it to be a static website, which we can do using the website sub block. For added usefulness, we will also define an output to show the website url on the command line:\nresource \"aws_s3_bucket\" \"static_site\" { bucket = \"${var.bucket}\" acl = \"public-read\" policy = \"${data.template_file.s3_public_policy.rendered}\" website { index_document = \"index.html\" } } output \"url\" { value = \"${aws_s3_bucket.static_site.bucket}.s3-website-${var.region}.amazonaws.com\" } Single File Upload If you just want one file in the website (say the index.html file), then you can add the following block. Just make sure the key property matches the index_document name in the aws_s3_bucket block.\nresource \"aws_s3_bucket_object\" \"index\" { bucket = \"${aws_s3_bucket.static_site.bucket}\" key = \"index.html\" source = \"src/index.html\" content_type = \"text/html\" etag = \"${md5(file(\"src/index.html\"))}\" } Multi File Upload Most websites need more than one file to be useful, and while we could write out an aws_s3_bucket_object block for every file, that seems like a lot of effort. Other options include manually uploading the files to S3, or using the aws cli to do it. While both methods work, they’re error prone - you need to specify the content_type for each file for them to load properly, and you can’t change this property once a file is uploaded.\nTo get around this, I add one more variable to my main terraform file, and generate a second file with all the aws_s3_bucket_object blocks in I need.\nThe added variable is a lookup for mime types:\nvariable \"mime_types\" { default = { htm = \"text/html\" html = \"text/html\" css = \"text/css\" js = \"application/javascript\" map = \"application/javascript\" json = \"application/json\" } } I then create a shell script which will write a new file containing a aws_s3_bucket_object block for each file in the src directory:\n#! /bin/sh SRC=\"src/\" TF_FILE=\"files.tf\" COUNT=0 cat \u003e $TF_FILE '' find $SRC -iname '*.*' | while read path; do cat \u003e\u003e $TF_FILE \u003c\u003c EOM resource \"aws_s3_bucket_object\" \"file_$COUNT\" { bucket = \"\\${aws_s3_bucket.static_site.bucket}\" key = \"${path#$SRC}\" source = \"$path\" content_type = \"\\${lookup(var.mime_types, \"${path##*.}\")}\" etag = \"\\${md5(file(\"$path\"))}\" } EOM COUNT=$(expr $COUNT + 1) done Now when I want to publish a static site, I just have to make sure I run ./files.sh once before my terraform plan and terraform apply calls.\nCaveats This technique has one major drawback: it doesn’t work well with updating an existing S3 bucket. It won’t remove files which are no longer in the terraform files, and can’t detect file moves.\nHowever, if you’re happy with a call to terraform destroy before applying, this will work fine. I use it for a number of test sites which I don’t tend to leave online very long, and for scripted aws infrastructure that I give out to other people so they can run their own copy.\n","wordCount":"598","inLanguage":"en","datePublished":"2017-04-23T00:00:00Z","dateModified":"2017-04-23T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2017/04/23/s3-multi-file-upload-terraform/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>S3 Multi-File upload with Terraform</h1><div class=post-meta>&lt;span title='2017-04-23 00:00:00 +0000 UTC'>April 23, 2017&lt;/span>&amp;nbsp;·&amp;nbsp;3 min</div></header><div class=post-content><p>Hosting a static website with S3 is really easy, especially from terraform:</p><p>First off, we want a public readable S3 bucket policy, but we want to apply this only to one specific bucket. To achive that we can use Terraform&rsquo;s <code>template_file</code> data block to merge in a value:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Sid&#34;</span>: <span style=color:#e6db74>&#34;PublicReadGetObject&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Principal&#34;</span>: <span style=color:#e6db74>&#34;*&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;s3:GetObject&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Resource&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;arn:aws:s3:::${bucket_name}/*&#34;</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As you can see the interpolation syntax is pretty much the same as how you use variables in terraform itself. Next we define a <code>template_file</code> to do the transformation. As the bucket name is going to be used many times, we extract that into a <code>variable</code> block also:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>variable</span> <span style=color:#960050;background-color:#1e0010>&#34;bucket&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>default</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;examplebucket&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>data</span> <span style=color:#960050;background-color:#1e0010>&#34;template_file&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;s3_public_policy&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>template</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${</span>file(<span style=color:#e6db74>&#34;policies/s3-public.json&#34;</span>)<span style=color:#960050;background-color:#1e0010>}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>vars</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>bucket_name</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${var.bucket}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><p>Next we want to create the S3 bucket and set it to be a static website, which we can do using the <code>website</code> sub block. For added usefulness, we will also define an <code>output</code> to show the website url on the command line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>resource</span> <span style=color:#960050;background-color:#1e0010>&#34;aws_s3_bucket&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;static_site&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>bucket</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${var.bucket}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>acl</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;public-read&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>policy</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${data.template_file.s3_public_policy.rendered}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>website</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>index_document</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;index.html&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>output</span> <span style=color:#960050;background-color:#1e0010>&#34;url&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>value</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_s3_bucket.static_site.bucket}.s3-website-${var.region}.amazonaws.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><h2 id=single-file-upload>Single File Upload<a hidden class=anchor aria-hidden=true href=#single-file-upload>#</a></h2><p>If you just want one file in the website (say the <code>index.html</code> file), then you can add the following block. Just make sure the <code>key</code> property matches the <code>index_document</code> name in the <code>aws_s3_bucket</code> block.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>resource</span> <span style=color:#960050;background-color:#1e0010>&#34;aws_s3_bucket_object&#34;</span> <span style=color:#960050;background-color:#1e0010>&#34;index&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>bucket</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${aws_s3_bucket.static_site.bucket}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>key</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;index.html&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>source</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;src/index.html&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>content_type</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;text/html&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>etag</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;${</span>md5(<span style=color:#e6db74>file(</span><span style=color:#e6db74>&#34;src/index.html&#34;</span>)<span style=color:#960050;background-color:#1e0010>)}&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><h2 id=multi-file-upload>Multi File Upload<a hidden class=anchor aria-hidden=true href=#multi-file-upload>#</a></h2><p>Most websites need more than one file to be useful, and while we could write out an <code>aws_s3_bucket_object</code> block for every file, that seems like a lot of effort. Other options include manually uploading the files to S3, or using the aws cli to do it. While both methods work, they&rsquo;re error prone - you need to specify the <code>content_type</code> for each file for them to load properly, and you can&rsquo;t change this property once a file is uploaded.</p><p>To get around this, I add one more variable to my main terraform file, and generate a second file with all the <code>aws_s3_bucket_object</code> blocks in I need.</p><p>The added <code>variable</code> is a lookup for mime types:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmake data-lang=cmake><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>variable</span> <span style=color:#960050;background-color:#1e0010>&#34;mime_types&#34;</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>default</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>htm</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;text/html&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>html</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;text/html&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>css</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;text/css&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>js</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;application/javascript&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>map</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;application/javascript&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#960050;background-color:#1e0010>json</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>&#34;application/json&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#960050;background-color:#1e0010>}
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><p>I then create a shell script which will write a new file containing a <code>aws_s3_bucket_object</code> block for each file in the <code>src</code> directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#! /bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>SRC<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;src/&#34;</span>
</span></span><span style=display:flex><span>TF_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;files.tf&#34;</span>
</span></span><span style=display:flex><span>COUNT<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cat &gt; $TF_FILE <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>find $SRC -iname <span style=color:#e6db74>&#39;*.*&#39;</span> | <span style=color:#66d9ef>while</span> read path; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cat &gt;&gt; $TF_FILE <span style=color:#e6db74>&lt;&lt; EOM
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>resource &#34;aws_s3_bucket_object&#34; &#34;file_$COUNT&#34; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  bucket = &#34;\${aws_s3_bucket.static_site.bucket}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  key = &#34;${path#$SRC}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  source = &#34;$path&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  content_type = &#34;\${lookup(var.mime_types, &#34;${path##*.}&#34;)}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  etag = &#34;\${md5(file(&#34;$path&#34;))}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOM</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    COUNT<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>expr $COUNT + 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>Now when I want to publish a static site, I just have to make sure I run <code>./files.sh</code> once before my <code>terraform plan</code> and <code>terraform apply</code> calls.</p><h2 id=caveats>Caveats<a hidden class=anchor aria-hidden=true href=#caveats>#</a></h2><p>This technique has one major drawback: it doesn&rsquo;t work well with updating an existing S3 bucket. It won&rsquo;t remove files which are no longer in the terraform files, and can&rsquo;t detect file moves.</p><p>However, if you&rsquo;re happy with a call to <code>terraform destroy</code> before applying, this will work fine. I use it for a number of test sites which I don&rsquo;t tend to leave online very long, and for scripted aws infrastructure that I give out to other people so they can run their own copy.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/aws/>aws</a></li><li><a href=https://andydote.co.uk/tags/terraform/>terraform</a></li><li><a href=https://andydote.co.uk/tags/s3/>s3</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2017/07/12/terraform-kinesis-lambda-iam/><span class=title>« Prev Page</span><br><span>Terraform, Kinesis Streams, Lambda and IAM problems</span>
</a><a class=next href=https://andydote.co.uk/2017/04/16/dont-write-frameworks-write-libraries/><span class=title>Next Page »</span><br><span>Don't write Frameworks, write Libraries</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>