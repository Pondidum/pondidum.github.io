<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Strong Configuration Composition | Andy Dote</title>
<meta name=keywords content="configuration,design,architecture,c#,strongtyping,stronk"><meta name=description content="It&rsquo;s no secret I am a fan of strong typing - not only do I talk and blog about it a lot, but I also have a library called Stronk which provides strong typed configuration for non dotnet core projects.
The problem I come across often is large configurations. For example, given the following project structure (3 applications, all reference the Domain project):
DemoService `-- src |-- Domain | |-- Domain."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2017/11/09/configuration-composition/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.c6a36963ab47314b3d95fe85a9385337e1ef8eb1c2194eecb86f178d492ab666.js integrity="sha256-xqNpY6tHMUs9lf6FqThTN+HvjrHCGU7suG8XjUkqtmY="></script><script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script><link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Strong Configuration Composition"><meta property="og:description" content="It&rsquo;s no secret I am a fan of strong typing - not only do I talk and blog about it a lot, but I also have a library called Stronk which provides strong typed configuration for non dotnet core projects.
The problem I come across often is large configurations. For example, given the following project structure (3 applications, all reference the Domain project):
DemoService `-- src |-- Domain | |-- Domain."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2017/11/09/configuration-composition/"><meta property="article:section" content="post"><meta property="article:published_time" content="2017-11-09T00:00:00+00:00"><meta property="article:modified_time" content="2017-11-09T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Strong Configuration Composition"><meta name=twitter:description content="It&rsquo;s no secret I am a fan of strong typing - not only do I talk and blog about it a lot, but I also have a library called Stronk which provides strong typed configuration for non dotnet core projects.
The problem I come across often is large configurations. For example, given the following project structure (3 applications, all reference the Domain project):
DemoService `-- src |-- Domain | |-- Domain."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Strong Configuration Composition","item":"https://andydote.co.uk/2017/11/09/configuration-composition/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Strong Configuration Composition","name":"Strong Configuration Composition","description":"It\u0026rsquo;s no secret I am a fan of strong typing - not only do I talk and blog about it a lot, but I also have a library called Stronk which provides strong typed configuration for non dotnet core projects.\nThe problem I come across often is large configurations. For example, given the following project structure (3 applications, all reference the Domain project):\nDemoService `-- src |-- Domain | |-- Domain.","keywords":["configuration","design","architecture","c#","strongtyping","stronk"],"articleBody":"It’s no secret I am a fan of strong typing - not only do I talk and blog about it a lot, but I also have a library called Stronk which provides strong typed configuration for non dotnet core projects.\nThe problem I come across often is large configurations. For example, given the following project structure (3 applications, all reference the Domain project):\nDemoService `-- src |-- Domain | |-- Domain.csproj | `-- IConfiguration.cs |-- QueueConsumer | |-- app.config | |-- QueueConsumerConfiguration.cs | `-- QueueConsumer.csproj |-- RestApi | |-- RestConfiguration.cs | |-- RestApi.csproj | `-- web.config `-- Worker |-- app.config |-- WorkerConfiguration.cs `-- Worker.csproj The configuration defined in the domain will look something like this:\npublic interface IConfiguration { string ApplicationName { get; } string LogPath { get; } Uri MetricsEndpoint { get; } Uri DocumentsEndpoint { get; } Uri ArchivalEndpoint { get; } string RabbitMqUsername { get; } string RabbitMqPassword { get; } string RabbitMqVHost { get; } string BulkQueue { get; } string DirectQueue { get; } string NotificationsQueue { get; } Uri RabbitMqConnection { get; } string DatabaseConnection { get; } string CacheConnection { get; } } There are a number of problems with this configuration:\nFirst off, it lives in the Domain project, which kinda makes sense, as things in there need access to some of the properties - but none of them need to know the name of the Queue being listened to, or where the metrics are being written to.\nNext, and also somewhat related to the first point, is that all the entry projects (RestApi, QueueConsumer and Worker) need to supply all the configuration values, and you can’t tell at a glance which projects actually need which values.\nFinally, classes which use this configuration are less externally discoverable. For example, which properties does this need: new DocumentDeduplicator(new Configuration())? Probably the cache? Maybe the database? or possibly the DocumentsEndpoint? Who knows without opening the class.\nThe Solution The key to solving this is the Interface Segregation Principal - the I in SOLID. First we need to split the interface into logical parts, which will allow our consuming classes to only take in the configuration they require, rather than the whole thing:\npublic interface IRabbitConfiguration { Uri RabbitMqConnection { get; } string RabbitMqUsername { get; } string RabbitMqPassword { get; } string RabbitMqVHost { get; } string BulkQueue { get; } string DirectQueue { get; } string NotificationsQueue { get; } } public interface IDeduplicationConfiguration { Uri DocumentsEndpoint { get; } string CacheConnection { get; } } public interface IStorageConfiguration { Uri ArchivalEndpoint { get; } string DatabaseConnection { get; } } We can also move the IRabbitConfiguration and IDeduplicationConfiguration out of the domain project, and into the QueueConsumer and Worker projects respectively, as they are only used by types in these projects:\nDemoService `-- src |-- Domain | |-- Domain.csproj | `-- IStorageConfiguration.cs |-- QueueConsumer | |-- app.config | |-- IRabbitConfiguration.cs | |-- QueueConsumerConfiguration.cs | `-- QueueConsumer.csproj |-- RestApi | |-- RestConfiguration.cs | |-- RestApi.csproj | `-- web.config `-- Worker |-- app.config |-- IDeduplicationConfiguration.cs |-- WorkerConfiguration.cs `-- Worker.csproj Next we can create some top-level configuration interfaces, which compose the relevant configuration interfaces for a project (e.g. the RestApi doesn’t need IDeduplicationConfiguration or IRabbitConfiguration):\npublic interface IWorkerConfiguration : IStorageConfiguration, IDeduplicationConfiguration { string ApplicationName { get; } string LogPath { get; } Uri MetricsEndpoint { get; } } public interface IRestConfiguration : IStorageConfiguration { string ApplicationName { get; } string LogPath { get; } Uri MetricsEndpoint { get; } } public interface IQueueConsumerConfiguration : IStorageConfiguration, IRabbitConfiguration { string ApplicationName { get; } string LogPath { get; } Uri MetricsEndpoint { get; } } Note how we have also not created a central interface for the application configuration - this is because the application configuration is specific to each entry project, and has no need to be passed on to the domain.\nFinally, an actual configuration class can be implemented (in this case using Stronk, but if you are on dotnet core, the inbuilt configuration builder is fine):\npublic class QueueConsumerConfiguration : IQueueConsumerConfiguration { string ApplicationName { get; private set; } string LogPath { get; private set; } Uri MetricsEndpoint { get; private set; } Uri ArchivalEndpoint { get; private set; } string DatabaseConnection { get; private set; } Uri RabbitMqConnection { get; private set; } string RabbitMqUsername { get; private set; } string RabbitMqPassword { get; private set; } string RabbitMqVHost { get; private set; } string BulkQueue { get; private set; } string DirectQueue { get; private set; } string NotificationsQueue { get; private set; } public QueueConsumerConfiguration() { this.FromAppConfig(); } } And our startup class might look something like this (using StructureMap):\npublic class Startup : IDisposable { private readonly Container _container; private readonly IConsumer _consumer; public Startup(IQueueConsumerConfiguration config) { ConfigureLogging(config); ConfigureMetrics(config); _container = new Container(_ =\u003e { _.Scan(a =\u003e { a.TheCallingAssembly(); a.LookForRegistries(); }) _.For().Use(config); _.For().Use(config); _.For().Use(config); }); _consumer = _container.GetInstance(); } public async Task Start() =\u003e await _consumer.Start(); public async Task Stop() =\u003e await _consumer.Stop(); private void ConfigureLogging(IQueueConsumerConfiguration config) { /* ... */ } private void ConfigureMetrics(IQueueConsumerConfiguration config) { /* ... */ } public void Dispose() =\u003e _container.Dispose(); } As our Startup takes in the top-level configuration interface, if we want to write a test which tests our entire system, it can be done with a single mocked configuration object:\n[Fact] public async Task When_the_entire_system_is_run() { var config = Substitute.For(); config.RabbitMqConnection.Returns(new Uri(\"localhost:5672\")); // etc. var startup = new Startup(config); await startup.Start(); await startup.Stop(); } One Final Thing Even if you have a microservice type project with only the one csproj, I would still recommend splitting your configuration into small interfaces, just due to the discoverability it provides.\nHow do you do configuration?\n","wordCount":"949","inLanguage":"en","datePublished":"2017-11-09T00:00:00Z","dateModified":"2017-11-09T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2017/11/09/configuration-composition/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Strong Configuration Composition</h1><div class=post-meta>&lt;span title='2017-11-09 00:00:00 +0000 UTC'>November 9, 2017&lt;/span>&amp;nbsp;·&amp;nbsp;5 min</div></header><div class=post-content><p>It&rsquo;s no secret I am a fan of strong typing - not only do I talk and blog about it a lot, but I also have a library called <a href=https://github.com/pondidum/stronk>Stronk</a> which provides strong typed configuration for non dotnet core projects.</p><p>The problem I come across often is large configurations. For example, given the following project structure (3 applications, all reference the Domain project):</p><pre tabindex=0><code>DemoService
`-- src
    |-- Domain
    |   |-- Domain.csproj
    |   `-- IConfiguration.cs
    |-- QueueConsumer
    |   |-- app.config
    |   |-- QueueConsumerConfiguration.cs
    |   `-- QueueConsumer.csproj
    |-- RestApi
    |   |-- RestConfiguration.cs
    |   |-- RestApi.csproj
    |   `-- web.config
    `-- Worker
        |-- app.config
        |-- WorkerConfiguration.cs
        `-- Worker.csproj
</code></pre><p>The configuration defined in the domain will look something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IConfiguration</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> ApplicationName { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> LogPath { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    Uri MetricsEndpoint { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Uri DocumentsEndpoint { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    Uri ArchivalEndpoint { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> RabbitMqUsername { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> RabbitMqPassword { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> RabbitMqVHost { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> BulkQueue { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> DirectQueue { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> NotificationsQueue { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Uri RabbitMqConnection { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> DatabaseConnection { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> CacheConnection { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>There are a number of problems with this configuration:</p><p>First off, it lives in the <code>Domain</code> project, which kinda makes sense, as things in there need access to some of the properties - but none of them need to know the name of the Queue being listened to, or where the metrics are being written to.</p><p>Next, and also somewhat related to the first point, is that all the entry projects (<code>RestApi</code>, <code>QueueConsumer</code> and <code>Worker</code>) need to supply all the configuration values, and you can&rsquo;t tell at a glance which projects actually need which values.</p><p>Finally, classes which use this configuration are less externally discoverable. For example, which properties does this need: <code>new DocumentDeduplicator(new Configuration())</code>? Probably the cache? Maybe the database? or possibly the DocumentsEndpoint? Who knows without opening the class.</p><h2 id=the-solution>The Solution<a hidden class=anchor aria-hidden=true href=#the-solution>#</a></h2><p>The key to solving this is the Interface Segregation Principal - the I in SOLID. First we need to split the interface into logical parts, which will allow our consuming classes to only take in the configuration they require, rather than the whole thing:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IRabbitConfiguration</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Uri RabbitMqConnection { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> RabbitMqUsername { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> RabbitMqPassword { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> RabbitMqVHost { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> BulkQueue { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> DirectQueue { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> NotificationsQueue { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IDeduplicationConfiguration</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Uri DocumentsEndpoint { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> CacheConnection { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IStorageConfiguration</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Uri ArchivalEndpoint { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> DatabaseConnection { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can also move the <code>IRabbitConfiguration</code> and <code>IDeduplicationConfiguration</code> out of the domain project, and into the <code>QueueConsumer</code> and <code>Worker</code> projects respectively, as they are only used by types in these projects:</p><pre tabindex=0><code>DemoService
`-- src
    |-- Domain
    |   |-- Domain.csproj
    |   `-- IStorageConfiguration.cs
    |-- QueueConsumer
    |   |-- app.config
    |   |-- IRabbitConfiguration.cs
    |   |-- QueueConsumerConfiguration.cs
    |   `-- QueueConsumer.csproj
    |-- RestApi
    |   |-- RestConfiguration.cs
    |   |-- RestApi.csproj
    |   `-- web.config
    `-- Worker
        |-- app.config
        |-- IDeduplicationConfiguration.cs
        |-- WorkerConfiguration.cs
        `-- Worker.csproj
</code></pre><p>Next we can create some top-level configuration interfaces, which compose the relevant configuration interfaces for a project (e.g. the <code>RestApi</code> doesn&rsquo;t need <code>IDeduplicationConfiguration</code> or <code>IRabbitConfiguration</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IWorkerConfiguration</span> : IStorageConfiguration, IDeduplicationConfiguration
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> ApplicationName { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> LogPath { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    Uri MetricsEndpoint { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IRestConfiguration</span> : IStorageConfiguration
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> ApplicationName { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> LogPath { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    Uri MetricsEndpoint { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IQueueConsumerConfiguration</span> : IStorageConfiguration, IRabbitConfiguration
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> ApplicationName { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> LogPath { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    Uri MetricsEndpoint { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note how we have also not created a central interface for the application configuration - this is because the application configuration is specific to each entry project, and has no need to be passed on to the domain.</p><p>Finally, an actual configuration class can be implemented (in this case using <a href=https://github.com/pondidum/stronk>Stronk</a>, but if you are on dotnet core, the inbuilt configuration builder is fine):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>QueueConsumerConfiguration</span> : IQueueConsumerConfiguration
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> ApplicationName { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> LogPath { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    Uri MetricsEndpoint { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Uri ArchivalEndpoint { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> DatabaseConnection { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    Uri RabbitMqConnection { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> RabbitMqUsername { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> RabbitMqPassword { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> RabbitMqVHost { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> BulkQueue { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> DirectQueue { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> NotificationsQueue { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> QueueConsumerConfiguration()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.FromAppConfig();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And our startup class might look something like this (using <a href=http://structuremap.github.io/>StructureMap</a>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Startup</span> : IDisposable
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> Container _container;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IConsumer _consumer;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Startup(IQueueConsumerConfiguration config)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        ConfigureLogging(config);
</span></span><span style=display:flex><span>        ConfigureMetrics(config);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        _container = <span style=color:#66d9ef>new</span> Container(_ =&gt;
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            _.Scan(a =&gt; {
</span></span><span style=display:flex><span>                a.TheCallingAssembly();
</span></span><span style=display:flex><span>                a.LookForRegistries();
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            _.For&lt;IQueueConsumerConfiguration&gt;().Use(config);
</span></span><span style=display:flex><span>            _.For&lt;IStorageConfiguration&gt;().Use(config);
</span></span><span style=display:flex><span>            _.For&lt;IRabbitConfiguration&gt;().Use(config);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        _consumer = _container.GetInstance&lt;IConsumer&gt;();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task Start() =&gt; <span style=color:#66d9ef>await</span> _consumer.Start();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task Stop() =&gt; <span style=color:#66d9ef>await</span> _consumer.Stop();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> ConfigureLogging(IQueueConsumerConfiguration config) { <span style=color:#75715e>/* ... */</span> }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> ConfigureMetrics(IQueueConsumerConfiguration config) { <span style=color:#75715e>/* ... */</span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Dispose() =&gt; _container.Dispose();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As our <code>Startup</code> takes in the top-level configuration interface, if we want to write a test which tests our entire system, it can be done with a single mocked configuration object:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[Fact]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task When_the_entire_system_is_run()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> config = Substitute.For&lt;IQueueConsumerConfiguration&gt;();
</span></span><span style=display:flex><span>    config.RabbitMqConnection.Returns(<span style=color:#66d9ef>new</span> Uri(<span style=color:#e6db74>&#34;localhost:5672&#34;</span>));
</span></span><span style=display:flex><span>    <span style=color:#75715e>// etc.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> startup = <span style=color:#66d9ef>new</span> Startup(config);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> startup.Start();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> startup.Stop();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=one-final-thing>One Final Thing<a hidden class=anchor aria-hidden=true href=#one-final-thing>#</a></h2><p>Even if you have a microservice type project with only the one csproj, I would still recommend splitting your configuration into small interfaces, just due to the discoverability it provides.</p><p>How do you do configuration?</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/configuration/>configuration</a></li><li><a href=https://andydote.co.uk/tags/design/>design</a></li><li><a href=https://andydote.co.uk/tags/architecture/>architecture</a></li><li><a href=https://andydote.co.uk/tags/c#/>c#</a></li><li><a href=https://andydote.co.uk/tags/strongtyping/>strongtyping</a></li><li><a href=https://andydote.co.uk/tags/stronk/>stronk</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2017/11/17/evolutionary-development/><span class=title>« Prev Page</span><br><span>Evolutionary Development</span>
</a><a class=next href=https://andydote.co.uk/2017/10/30/alarm-fatigue/><span class=title>Next Page »</span><br><span>Alarm Fatigue</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>