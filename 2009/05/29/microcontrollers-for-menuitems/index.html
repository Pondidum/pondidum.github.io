<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Microcontrollers for MenuItems | Andy Dote</title><meta name=keywords content="design,generics,controls,c#"><meta name=description content="I have been working my way through Jeremy Miller&rsquo;s excellent Build Your Own CAB Series (which would be even better if he felt like finishing!) and was very interested by the article on controlling menus with Microcontrollers.
After reading it and writing a version of it myself, I came to the conclusion that some parts of it seem to be wrong. All of the permissioning is done based on the menu items which fire ICommands, and several menu items could use the same ICommand."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2009/05/29/microcontrollers-for-menuitems/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b4e19c453811e60acfec1f00c15ac2be1c53f6ab90187e684358ce7faaf48bab.css integrity="sha256-tOGcRTgR5grP7B8AwVrCvhxT9quQGH5oQ1jOf6r0i6s=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Microcontrollers for MenuItems"><meta property="og:description" content="I have been working my way through Jeremy Miller&rsquo;s excellent Build Your Own CAB Series (which would be even better if he felt like finishing!) and was very interested by the article on controlling menus with Microcontrollers.
After reading it and writing a version of it myself, I came to the conclusion that some parts of it seem to be wrong. All of the permissioning is done based on the menu items which fire ICommands, and several menu items could use the same ICommand."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2009/05/29/microcontrollers-for-menuitems/"><meta property="article:section" content="post"><meta property="article:published_time" content="2009-05-29T00:00:00+00:00"><meta property="article:modified_time" content="2009-05-29T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Microcontrollers for MenuItems"><meta name=twitter:description content="I have been working my way through Jeremy Miller&rsquo;s excellent Build Your Own CAB Series (which would be even better if he felt like finishing!) and was very interested by the article on controlling menus with Microcontrollers.
After reading it and writing a version of it myself, I came to the conclusion that some parts of it seem to be wrong. All of the permissioning is done based on the menu items which fire ICommands, and several menu items could use the same ICommand."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Microcontrollers for MenuItems","item":"https://andydote.co.uk/2009/05/29/microcontrollers-for-menuitems/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Microcontrollers for MenuItems","name":"Microcontrollers for MenuItems","description":"I have been working my way through Jeremy Miller\u0026rsquo;s excellent Build Your Own CAB Series (which would be even better if he felt like finishing!) and was very interested by the article on controlling menus with Microcontrollers.\nAfter reading it and writing a version of it myself, I came to the conclusion that some parts of it seem to be wrong. All of the permissioning is done based on the menu items which fire ICommands, and several menu items could use the same ICommand.","keywords":["design","generics","controls","c#"],"articleBody":"I have been working my way through Jeremy Miller’s excellent Build Your Own CAB Series (which would be even better if he felt like finishing!) and was very interested by the article on controlling menus with Microcontrollers.\nAfter reading it and writing a version of it myself, I came to the conclusion that some parts of it seem to be wrong. All of the permissioning is done based on the menu items which fire ICommands, and several menu items could use the same ICommand. This means that you need to use the interface something like this:\nMenuController.MenuItem(mnuFileNew).Executes(Commands.Open).IsAvailableToRoles(\"normal\", \"editor\", \"su\"); MenuController.MenuItem(tsbStandardNew).Executes(Commands.Open).IsAvailableToRoles(\"normal\", \"editor\", \"su\"); Now to me this seems somewhat wrong, I would rather have something like this:\nMenuController.Command(new MenuCommands.New).IsAttachedTo(mnuFileNew, tsbStandardNew).IsAvailableToRoles(\"normal\", \"editor\", \"su\"); So I decided to have a go at re-working it to my liking. To start with we have the mandatory ICommand interface:\nPublic Interface ICommand  Sub Execute() End Interface Then a class that manages the actual ICommand and its menuitem(s):\nPublic NotInheritable Class CommandItem(Of T)  Implements IDisposable 'used to remove handlers that we dont want to leave lying around   Private ReadOnly _command As ICommand  Private ReadOnly _id As T   Private _roles As New List(Of String)  Private _menuItems As New List(Of ToolStripItem)  Private _alwaysEnabled As Boolean = False  Private _disposed As Boolean = False   Public Property AlwaysEnabled() As Boolean  Get  Return _alwaysEnabled  End Get  Set(ByVal value As Boolean)  _alwaysEnabled = value  End Set  End Property   Public Property Roles() As List(Of String)  Get  Return _roles  End Get  Set(ByVal value As List(Of String))  _roles = value  End Set  End Property   Public ReadOnly Property MenuItems() As ToolStripItem()  Get  Return _menuItems.ToArray  End Get  End Property   Public ReadOnly Property IsDisposed() As Boolean  Get  Return _disposed  End Get  End Property   Public Sub New(ByVal cmd As ICommand, ByVal id As T)  _command = cmd  _id = id  End Sub   Public Sub AddMenuItem(ByVal menuItem As ToolStripItem)  _menuItems.Add(menuItem)  AddHandler menuItem.Click, AddressOf _item_Click  End Sub   Public Sub RemoveMenuItem(ByVal menuItem As ToolStripItem)  RemoveHandler menuItem.Click, AddressOf _item_Click  _menuItems.Remove(menuItem)  End Sub   Public Function IsEnabled(ByVal state As CommandState(Of T)) As Boolean   If _alwaysEnabled Then Return True   If Not state.IsEnabled(_id) Return False   For i As Integer = 0 To _roles.Count - 1  If Thread.CurrentPrincipal.IsInRole(_roles(i)) Then Return True  Next   Return False   End Function   Public Sub SetState(ByVal state As CommandState(Of T))   Dim enabled As Boolean = IsEnabled(state)   For Each ts As ToolStripItem In _menuItems  ts.Enabled = enabled  Next   End Sub   Public Sub Dispose(ByVal disposing As Boolean)   If Not _disposed AndAlso disposing Then   For Each menuItem As ToolStripItem In _menuItems  RemoveMenuItem(menuItem)  Next   End If   _disposed = True   End Sub   Public Sub Dispose() Implements IDisposable.Dispose  Dispose(True)  GC.SuppressFinalize(Me)  End Sub   Private Sub _item_Click(ByVal sender As Object, ByVal e As EventArgs)  _command.Execute()  End Sub  End Class As you can see, the Dispose Method is used to allow for handlers to be removed, otherwise the objects might be hanging around longer than they should be. We also have a list of menu items that this command controls, and a list of roles that the command is available to.\nNext we have the class that holds the state of each menu item, which is generic to allow the end user to use whatever they wish to identify each menu item:\nPublic NotInheritable Class CommandState(Of T)   Private _enabledCommands As New List(Of T)   Public Function Enable(ByVal id As T) As CommandState(Of T)  If Not _enabledCommands.Contains(id) Then  _enabledCommands.Add(id)  End If   Return Me  End Function   Public Function Disable(ByVal id As T) As CommandState(Of T)  If _enabledCommands.Contains(id) Then  _enabledCommands.Remove(id)  End If   Return Me  End Function   Public Function IsEnabled(ByVal id As T) As Boolean  Return _enabledCommands.Contains(id)  End Function  End Class Finally we have the Manager class which stitches the whole lot together with a health dollop of Fluent Interfaces. We have a unique list of Commands (as I wrote this in VS2005, I just had to make a unique List class, rather than use a dictionary of CommmandItem and Null) and a sub class which provides the Fluent Interface to the manager. (IDisposeable parts have been trimmed out for brevity, it’s just contains a loop that disposes all child objects).\nPublic NotInheritable Class Manager(Of T)   Private _commands As New UniqueList(Of CommandItem(Of T))   Public Function Command(ByVal cmd As ICommand, ByVal id As T) As CommandExpression  Return New CommandExpression(Me, cmd, id)  End Function   Public Sub SetState(ByVal state As CommandState(Of T))   For Each ci As CommandItem(Of T) In _commands  ci.SetState(state)  Next   End Sub   Public NotInheritable Class CommandExpression   Private ReadOnly _manager As Manager(Of T)  Private ReadOnly _commandItem As CommandItem(Of T)   Friend Sub New(ByVal mgr As Manager(Of T), ByVal cmd As ICommand, ByVal id As T)   _manager = mgr  _commandItem = New CommandItem(Of T)(cmd, id)  _manager._commands.Add(_commandItem)   End Sub   Public Function IsAttachedTo(ByVal menuItem As ToolStripItem) As CommandExpression  _commandItem.AddMenuItem(menuItem)  Return Me  End Function   Public Function IsInRole(ByVal ParamArray roles() As String) As CommandExpression  _commandItem.Roles.AddRange(roles)  Return Me  End Function   Public Function IsAlwaysEnabled() As CommandExpression  _commandItem.AlwaysEnabled = True  Return Me  End Function   End Class   Private Class UniqueList(Of TKey)  Inherits List(Of TKey)   Public Shadows Sub Add(ByVal item As TKey)  If Not MyBase.Contains(item) Then  MyBase.Add(item)  End If  End Sub   End Class  End Class In my test application I have a file containing my menuCommands and an Enum used for identification:\nNamespace MenuCommands  Public Enum Commands  [New]  Open  Save  Close  End Enum   Public Class Open  Implements ICommand   Public Sub Execute() Implements ICommand.Execute  MessageBox.Show(\"Open\")  End Sub   End Class End Namespace And in the main form I have this code. The Thread Principle is used for the roles, and the actual roles could (should) be loaded from a database or anywhere other than hard coded constants of course.\nPrivate _menuManager As New Manager(Of MenuCommands.Commands) Private _state As New CommandState(Of MenuCommands.Commands)  Private Sub Form1_Load(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles MyBase.Load    Thread.CurrentPrincipal = New GenericPrincipal(Thread.CurrentPrincipal.Identity, New String() {\"normal\"})   _menuManager.Command(New MenuCommands.[New], MenuCommands.Commands.[New]) _  .IsAttachedTo(mnuFileNew) _  .IsAttachedTo(tsbNew) _  .IsInRole(\"normal\")   _menuManager.Command(New MenuCommands.Open, MenuCommands.Commands.Open) _  .IsAttachedTo(mnuFileOpen) _  .IsAttachedTo(tsbOpen) _  .IsInRole(\"normal\", \"reviewer\", \"viewer\")   _menuManager.Command(New MenuCommands.Save, MenuCommands.Commands.Save) _  .IsAttachedTo(mnuFileSave) _  .IsAttachedTo(tsbSave) _  .IsInRole(\"normal\", \"reviewer\")   _menuManager.Command(New MenuCommands.Close, MenuCommands.Commands.Close) _  .IsAttachedTo(mnuFileExit) _  .IsAlwaysEnabled()   _state.Enable(MenuCommands.Commands.Open) _  .Enable(MenuCommands.Commands.Save) _  .Enable(MenuCommands.Commands.Close)   _menuManager.SetState(_state)  End Sub The state object is used to enable and disable menu items and could be wrapped in another object if it needed to be exposed further than the form.\n","wordCount":"1018","inLanguage":"en","datePublished":"2009-05-29T00:00:00Z","dateModified":"2009-05-29T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2009/05/29/microcontrollers-for-menuitems/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Microcontrollers for MenuItems</h1><div class=post-meta><span title="2009-05-29 00:00:00 +0000 UTC">May 29, 2009</span>&nbsp;·&nbsp;5 min</div></header><div class=post-content><p>I have been working my way through Jeremy Miller&rsquo;s excellent <a href=http://codebetter.com/blogs/jeremy.miller/archive/2007/07/25/the-build-your-own-cab-series-table-of-contents.aspx>Build Your Own CAB Series</a> (which would be even better if he felt like finishing!) and was very interested by the article on controlling menus with <a href=http://codebetter.com/blogs/jeremy.miller/pages/build-your-own-cab-14-managing-menu-state-with-microcontroller-s-command-s-a-layer-supertype-some-structuremap-pixie-dust-and-a-dollop-of-fluent-interface.aspx>Microcontrollers</a>.</p><p>After reading it and writing a version of it myself, I came to the conclusion that some parts of it seem to be wrong. All of the permissioning is done based on the menu items which fire <code>ICommands</code>, and several menu items could use the same <code>ICommand</code>. This means that you need to use the interface something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span>MenuController.MenuItem(mnuFileNew).Executes(Commands.Open).IsAvailableToRoles(<span style=color:#e6db74>&#34;normal&#34;</span>, <span style=color:#e6db74>&#34;editor&#34;</span>, <span style=color:#e6db74>&#34;su&#34;</span>)<span style=color:#960050;background-color:#1e0010>;</span>
</span></span><span style=display:flex><span>MenuController.MenuItem(tsbStandardNew).Executes(Commands.Open).IsAvailableToRoles(<span style=color:#e6db74>&#34;normal&#34;</span>, <span style=color:#e6db74>&#34;editor&#34;</span>, <span style=color:#e6db74>&#34;su&#34;</span>)<span style=color:#960050;background-color:#1e0010>;</span>
</span></span></code></pre></div><p>Now to me this seems somewhat wrong, I would rather have something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span>MenuController.Command(<span style=color:#66d9ef>new</span> MenuCommands.New).IsAttachedTo(mnuFileNew, tsbStandardNew).IsAvailableToRoles(<span style=color:#e6db74>&#34;normal&#34;</span>, <span style=color:#e6db74>&#34;editor&#34;</span>, <span style=color:#e6db74>&#34;su&#34;</span>)<span style=color:#960050;background-color:#1e0010>;</span>
</span></span></code></pre></div><p>So I decided to have a go at re-working it to my liking. To start with we have the mandatory <code>ICommand</code> interface:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span><span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Interface</span> ICommand
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>Execute</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Interface</span>
</span></span></code></pre></div><p>Then a class that manages the actual <code>ICommand</code> and its menuitem(s):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span><span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>NotInheritable</span> <span style=color:#66d9ef>Class</span> <span style=color:#a6e22e>CommandItem</span>(<span style=color:#66d9ef>Of</span> T)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Implements</span> IDisposable      <span style=color:#75715e>&#39;used to remove handlers that we dont want to leave lying around
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>ReadOnly</span> _command <span style=color:#f92672>As</span> ICommand
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>ReadOnly</span> _id <span style=color:#f92672>As</span> T
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Private</span> _roles <span style=color:#f92672>As</span> <span style=color:#66d9ef>New</span> List(<span style=color:#66d9ef>Of</span> <span style=color:#66d9ef>String</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Private</span> _menuItems <span style=color:#f92672>As</span> <span style=color:#66d9ef>New</span> List(<span style=color:#66d9ef>Of</span> ToolStripItem)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Private</span> _alwaysEnabled <span style=color:#f92672>As</span> <span style=color:#66d9ef>Boolean</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Private</span> _disposed <span style=color:#f92672>As</span> <span style=color:#66d9ef>Boolean</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Property</span> <span style=color:#a6e22e>AlwaysEnabled</span>() <span style=color:#f92672>As</span> <span style=color:#66d9ef>Boolean</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Get</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Return</span> _alwaysEnabled
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Get</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Set</span>(<span style=color:#66d9ef>ByVal</span> value <span style=color:#f92672>As</span> <span style=color:#66d9ef>Boolean</span>)
</span></span><span style=display:flex><span>            _alwaysEnabled <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Set</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Property</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Property</span> <span style=color:#a6e22e>Roles</span>() <span style=color:#f92672>As</span> List(<span style=color:#66d9ef>Of</span> <span style=color:#66d9ef>String</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Get</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Return</span> _roles
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Get</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Set</span>(<span style=color:#66d9ef>ByVal</span> value <span style=color:#f92672>As</span> List(<span style=color:#66d9ef>Of</span> <span style=color:#66d9ef>String</span>))
</span></span><span style=display:flex><span>            _roles <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Set</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Property</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>ReadOnly</span> <span style=color:#66d9ef>Property</span> <span style=color:#a6e22e>MenuItems</span>() <span style=color:#f92672>As</span> ToolStripItem()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Get</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Return</span> _menuItems.ToArray
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Get</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Property</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>ReadOnly</span> <span style=color:#66d9ef>Property</span> <span style=color:#a6e22e>IsDisposed</span>() <span style=color:#f92672>As</span> <span style=color:#66d9ef>Boolean</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Get</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Return</span> _disposed
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Get</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Property</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>New</span>(<span style=color:#66d9ef>ByVal</span> cmd <span style=color:#f92672>As</span> ICommand, <span style=color:#66d9ef>ByVal</span> id <span style=color:#f92672>As</span> T)
</span></span><span style=display:flex><span>        _command <span style=color:#f92672>=</span> cmd
</span></span><span style=display:flex><span>        _id <span style=color:#f92672>=</span> id
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>AddMenuItem</span>(<span style=color:#66d9ef>ByVal</span> menuItem <span style=color:#f92672>As</span> ToolStripItem)
</span></span><span style=display:flex><span>        _menuItems.Add(menuItem)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>AddHandler</span> menuItem.Click, <span style=color:#f92672>AddressOf</span> _item_Click
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>RemoveMenuItem</span>(<span style=color:#66d9ef>ByVal</span> menuItem <span style=color:#f92672>As</span> ToolStripItem)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>RemoveHandler</span> menuItem.Click, <span style=color:#f92672>AddressOf</span> _item_Click
</span></span><span style=display:flex><span>        _menuItems.Remove(menuItem)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>IsEnabled</span>(<span style=color:#66d9ef>ByVal</span> state <span style=color:#f92672>As</span> CommandState(<span style=color:#66d9ef>Of</span> T)) <span style=color:#f92672>As</span> <span style=color:#66d9ef>Boolean</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>If</span> _alwaysEnabled <span style=color:#66d9ef>Then</span> <span style=color:#66d9ef>Return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>If</span> <span style=color:#66d9ef>Not</span> state.IsEnabled(_id) <span style=color:#66d9ef>Return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>For</span> i <span style=color:#f92672>As</span> <span style=color:#66d9ef>Integer</span> <span style=color:#f92672>=</span> 0 <span style=color:#66d9ef>To</span> _roles.Count <span style=color:#f92672>-</span> 1
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>If</span> Thread.CurrentPrincipal.IsInRole(_roles(i)) <span style=color:#66d9ef>Then</span> <span style=color:#66d9ef>Return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Next</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Return</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Function</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>SetState</span>(<span style=color:#66d9ef>ByVal</span> state <span style=color:#f92672>As</span> CommandState(<span style=color:#66d9ef>Of</span> T))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Dim</span> enabled <span style=color:#f92672>As</span> <span style=color:#66d9ef>Boolean</span> <span style=color:#f92672>=</span> IsEnabled(state)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>For</span> <span style=color:#66d9ef>Each</span> ts <span style=color:#f92672>As</span> ToolStripItem <span style=color:#f92672>In</span> _menuItems
</span></span><span style=display:flex><span>            ts.Enabled <span style=color:#f92672>=</span> enabled
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Next</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>Dispose</span>(<span style=color:#66d9ef>ByVal</span> disposing <span style=color:#f92672>As</span> <span style=color:#66d9ef>Boolean</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>If</span> <span style=color:#66d9ef>Not</span> _disposed <span style=color:#f92672>AndAlso</span> disposing <span style=color:#66d9ef>Then</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>For</span> <span style=color:#66d9ef>Each</span> menuItem <span style=color:#f92672>As</span> ToolStripItem <span style=color:#f92672>In</span> _menuItems
</span></span><span style=display:flex><span>                RemoveMenuItem(menuItem)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Next</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>If</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        _disposed <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>Dispose</span>() <span style=color:#66d9ef>Implements</span> IDisposable.Dispose
</span></span><span style=display:flex><span>        Dispose(<span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>        GC.SuppressFinalize(<span style=color:#66d9ef>Me</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>_item_Click</span>(<span style=color:#66d9ef>ByVal</span> sender <span style=color:#f92672>As</span> <span style=color:#66d9ef>Object</span>, <span style=color:#66d9ef>ByVal</span> e <span style=color:#f92672>As</span> EventArgs)
</span></span><span style=display:flex><span>        _command.Execute()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Class</span>
</span></span></code></pre></div><p>As you can see, the <code>Dispose</code> Method is used to allow for handlers to be removed, otherwise the objects might be hanging around longer than they should be. We also have a list of menu items that this command controls, and a list of roles that the command is available to.</p><p>Next we have the class that holds the state of each menu item, which is generic to allow the end user to use whatever they wish to identify each menu item:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span><span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>NotInheritable</span> <span style=color:#66d9ef>Class</span> <span style=color:#a6e22e>CommandState</span>(<span style=color:#66d9ef>Of</span> T)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Private</span> _enabledCommands <span style=color:#f92672>As</span> <span style=color:#66d9ef>New</span> List(<span style=color:#66d9ef>Of</span> T)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>Enable</span>(<span style=color:#66d9ef>ByVal</span> id <span style=color:#f92672>As</span> T) <span style=color:#f92672>As</span> CommandState(<span style=color:#66d9ef>Of</span> T)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>If</span> <span style=color:#66d9ef>Not</span> _enabledCommands.Contains(id) <span style=color:#66d9ef>Then</span>
</span></span><span style=display:flex><span>            _enabledCommands.Add(id)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>If</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Return</span> <span style=color:#66d9ef>Me</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Function</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>Disable</span>(<span style=color:#66d9ef>ByVal</span> id <span style=color:#f92672>As</span> T) <span style=color:#f92672>As</span> CommandState(<span style=color:#66d9ef>Of</span> T)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>If</span> _enabledCommands.Contains(id) <span style=color:#66d9ef>Then</span>
</span></span><span style=display:flex><span>            _enabledCommands.Remove(id)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>If</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Return</span> <span style=color:#66d9ef>Me</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Function</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>IsEnabled</span>(<span style=color:#66d9ef>ByVal</span> id <span style=color:#f92672>As</span> T) <span style=color:#f92672>As</span> <span style=color:#66d9ef>Boolean</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Return</span> _enabledCommands.Contains(id)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Function</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Class</span>
</span></span></code></pre></div><p>Finally we have the Manager class which stitches the whole lot together with a health dollop of Fluent Interfaces. We have a unique list of Commands (as I wrote this in VS2005, I just had to make a unique List class, rather than use a dictionary of <code>CommmandItem</code> and <code>Null</code>) and a sub class which provides the Fluent Interface to the manager. (<code>IDisposeable</code> parts have been trimmed out for brevity, it&rsquo;s just contains a loop that disposes all child objects).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span><span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>NotInheritable</span> <span style=color:#66d9ef>Class</span> <span style=color:#a6e22e>Manager</span>(<span style=color:#66d9ef>Of</span> T)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Private</span> _commands <span style=color:#f92672>As</span> <span style=color:#66d9ef>New</span> UniqueList(<span style=color:#66d9ef>Of</span> CommandItem(<span style=color:#66d9ef>Of</span> T))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>Command</span>(<span style=color:#66d9ef>ByVal</span> cmd <span style=color:#f92672>As</span> ICommand, <span style=color:#66d9ef>ByVal</span> id <span style=color:#f92672>As</span> T) <span style=color:#f92672>As</span> CommandExpression
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Return</span> <span style=color:#66d9ef>New</span> CommandExpression(<span style=color:#66d9ef>Me</span>, cmd, id)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Function</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>SetState</span>(<span style=color:#66d9ef>ByVal</span> state <span style=color:#f92672>As</span> CommandState(<span style=color:#66d9ef>Of</span> T))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>For</span> <span style=color:#66d9ef>Each</span> ci <span style=color:#f92672>As</span> CommandItem(<span style=color:#66d9ef>Of</span> T) <span style=color:#f92672>In</span> _commands
</span></span><span style=display:flex><span>            ci.SetState(state)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Next</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>NotInheritable</span> <span style=color:#66d9ef>Class</span> <span style=color:#a6e22e>CommandExpression</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>ReadOnly</span> _manager <span style=color:#f92672>As</span> Manager(<span style=color:#66d9ef>Of</span> T)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>ReadOnly</span> _commandItem <span style=color:#f92672>As</span> CommandItem(<span style=color:#66d9ef>Of</span> T)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Friend</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>New</span>(<span style=color:#66d9ef>ByVal</span> mgr <span style=color:#f92672>As</span> Manager(<span style=color:#66d9ef>Of</span> T), <span style=color:#66d9ef>ByVal</span> cmd <span style=color:#f92672>As</span> ICommand, <span style=color:#66d9ef>ByVal</span> id <span style=color:#f92672>As</span> T)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            _manager <span style=color:#f92672>=</span> mgr
</span></span><span style=display:flex><span>            _commandItem <span style=color:#f92672>=</span> <span style=color:#66d9ef>New</span> CommandItem(<span style=color:#66d9ef>Of</span> T)(cmd, id)
</span></span><span style=display:flex><span>            _manager._commands.Add(_commandItem)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>IsAttachedTo</span>(<span style=color:#66d9ef>ByVal</span> menuItem <span style=color:#f92672>As</span> ToolStripItem) <span style=color:#f92672>As</span> CommandExpression
</span></span><span style=display:flex><span>            _commandItem.AddMenuItem(menuItem)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Return</span> <span style=color:#66d9ef>Me</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Function</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>IsInRole</span>(<span style=color:#66d9ef>ByVal</span> <span style=color:#66d9ef>ParamArray</span> roles() <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>) <span style=color:#f92672>As</span> CommandExpression
</span></span><span style=display:flex><span>            _commandItem.Roles.AddRange(roles)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Return</span> <span style=color:#66d9ef>Me</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Function</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>IsAlwaysEnabled</span>() <span style=color:#f92672>As</span> CommandExpression
</span></span><span style=display:flex><span>            _commandItem.AlwaysEnabled <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>Return</span> <span style=color:#66d9ef>Me</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Function</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Class</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Class</span> <span style=color:#a6e22e>UniqueList</span>(<span style=color:#66d9ef>Of</span> TKey)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Inherits</span> List(<span style=color:#66d9ef>Of</span> TKey)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Shadows</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>Add</span>(<span style=color:#66d9ef>ByVal</span> item <span style=color:#f92672>As</span> TKey)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>If</span> <span style=color:#66d9ef>Not</span> <span style=color:#66d9ef>MyBase</span>.Contains(item) <span style=color:#66d9ef>Then</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>MyBase</span>.Add(item)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>If</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Class</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Class</span>
</span></span></code></pre></div><p>In my test application I have a file containing my menuCommands and an Enum used for identification:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span><span style=color:#66d9ef>Namespace</span> MenuCommands
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Enum</span> <span style=color:#a6e22e>Commands</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span><span style=color:#66d9ef>New</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>        Open
</span></span><span style=display:flex><span>        Save
</span></span><span style=display:flex><span>        Close
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Enum</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Class</span> <span style=color:#a6e22e>Open</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Implements</span> ICommand
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>Execute</span>() <span style=color:#66d9ef>Implements</span> ICommand.Execute
</span></span><span style=display:flex><span>            MessageBox.Show(<span style=color:#e6db74>&#34;Open&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Class</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Namespace</span>
</span></span></code></pre></div><p>And in the main form I have this code. The Thread Principle is used for the roles, and the actual roles could (should) be loaded from a database or anywhere other than hard coded constants of course.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span><span style=color:#66d9ef>Private</span> _menuManager <span style=color:#f92672>As</span> <span style=color:#66d9ef>New</span> Manager(<span style=color:#66d9ef>Of</span> MenuCommands.Commands)
</span></span><span style=display:flex><span><span style=color:#66d9ef>Private</span> _state <span style=color:#f92672>As</span> <span style=color:#66d9ef>New</span> CommandState(<span style=color:#66d9ef>Of</span> MenuCommands.Commands)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>Form1_Load</span>(<span style=color:#66d9ef>ByVal</span> sender <span style=color:#f92672>As</span> System.Object, <span style=color:#66d9ef>ByVal</span> e <span style=color:#f92672>As</span> System.EventArgs) <span style=color:#66d9ef>Handles</span> <span style=color:#66d9ef>MyBase</span>.Load
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Thread.CurrentPrincipal <span style=color:#f92672>=</span> <span style=color:#66d9ef>New</span> GenericPrincipal(Thread.CurrentPrincipal.Identity, <span style=color:#66d9ef>New</span> <span style=color:#66d9ef>String</span>() {<span style=color:#e6db74>&#34;normal&#34;</span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    _menuManager.Command(<span style=color:#66d9ef>New</span> MenuCommands.<span style=color:#f92672>[</span><span style=color:#66d9ef>New</span><span style=color:#f92672>]</span>, MenuCommands.Commands.<span style=color:#f92672>[</span><span style=color:#66d9ef>New</span><span style=color:#f92672>]</span>) _
</span></span><span style=display:flex><span>                .IsAttachedTo(mnuFileNew) _
</span></span><span style=display:flex><span>                .IsAttachedTo(tsbNew) _
</span></span><span style=display:flex><span>                .IsInRole(<span style=color:#e6db74>&#34;normal&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    _menuManager.Command(<span style=color:#66d9ef>New</span> MenuCommands.Open, MenuCommands.Commands.Open) _
</span></span><span style=display:flex><span>                .IsAttachedTo(mnuFileOpen) _
</span></span><span style=display:flex><span>                .IsAttachedTo(tsbOpen) _
</span></span><span style=display:flex><span>                .IsInRole(<span style=color:#e6db74>&#34;normal&#34;</span>, <span style=color:#e6db74>&#34;reviewer&#34;</span>, <span style=color:#e6db74>&#34;viewer&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    _menuManager.Command(<span style=color:#66d9ef>New</span> MenuCommands.Save, MenuCommands.Commands.Save) _
</span></span><span style=display:flex><span>                .IsAttachedTo(mnuFileSave) _
</span></span><span style=display:flex><span>                .IsAttachedTo(tsbSave) _
</span></span><span style=display:flex><span>                .IsInRole(<span style=color:#e6db74>&#34;normal&#34;</span>, <span style=color:#e6db74>&#34;reviewer&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    _menuManager.Command(<span style=color:#66d9ef>New</span> MenuCommands.Close, MenuCommands.Commands.Close) _
</span></span><span style=display:flex><span>                .IsAttachedTo(mnuFileExit) _
</span></span><span style=display:flex><span>                .IsAlwaysEnabled()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    _state.Enable(MenuCommands.Commands.Open) _
</span></span><span style=display:flex><span>          .Enable(MenuCommands.Commands.Save) _
</span></span><span style=display:flex><span>          .Enable(MenuCommands.Commands.Close)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    _menuManager.SetState(_state)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span></code></pre></div><p>The state object is used to enable and disable menu items and could be wrapped in another object if it needed to be exposed further than the form.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/design/>design</a></li><li><a href=https://andydote.co.uk/tags/generics/>generics</a></li><li><a href=https://andydote.co.uk/tags/controls/>controls</a></li><li><a href=https://andydote.co.uk/tags/c#/>c#</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2009/06/01/converting-code/><span class=title>« Prev Page</span><br><span>Converting Code</span></a>
<a class=next href=https://andydote.co.uk/2009/05/22/generics-to-the-rescue-again/><span class=title>Next Page »</span><br><span>Generics to the rescue! Again!</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>