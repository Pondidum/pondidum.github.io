<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>aws | Andy Dote</title>
<meta name=keywords content><meta name=description content><meta name=author content><link rel=canonical href=https://andydote.co.uk/tags/aws/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.c6a36963ab47314b3d95fe85a9385337e1ef8eb1c2194eecb86f178d492ab666.js integrity="sha256-xqNpY6tHMUs9lf6FqThTN+HvjrHCGU7suG8XjUkqtmY="></script><script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script><link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://andydote.co.uk/tags/aws/rss.xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="aws"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://andydote.co.uk/tags/aws/"><meta name=twitter:card content="summary"><meta name=twitter:title content="aws"><meta name=twitter:description content></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>aws</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2>Pulumi Conditional Infrastructure for Speed</h2></header><div class=entry-content><p>One of the reasons I prefer Pulumi over Terraform is the additional control I have over my processes due to the fact that it’s a programming language.
For example, I have a CLI, that creates a cluster of machines for a user; the machines use IAM Authentication with Vault so that they can request certificates on boot. The trouble with this application is that it is slow; it takes 175 seconds on average to provision the machines, write the IAM information to Vault, and then re-run the cloud-init script on all the machines in the cluster (as when they first booted, the configuration hadn’t been written to Vault yet....</p></div><footer class=entry-footer>&lt;span title='2022-07-17 00:00:00 +0000 UTC'>July 17, 2022&lt;/span>&amp;nbsp;·&amp;nbsp;3 min</footer><a class=entry-link aria-label="post link to Pulumi Conditional Infrastructure for Speed" href=https://andydote.co.uk/2022/07/17/pulumi-faster-processes/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>An NGINX and DNS based outage</h2></header><div class=entry-content><p>I recently encountered a behaviour in Nginx that I didn’t expect and caused a production outage in the process. While I would love to blame DNS for this, as it’s usually the cause of most network-related issues, in this case, the fault lies with Nginx.
I was running a very simple Nginx proxy, relaying an internal service to the outside world. The internal service is behind an AWS ALB, and the Nginx configuration was proxying to the ALB’s FQDN:...</p></div><footer class=entry-footer>&lt;span title='2022-04-23 00:00:00 +0000 UTC'>April 23, 2022&lt;/span>&amp;nbsp;·&amp;nbsp;3 min</footer><a class=entry-link aria-label="post link to An NGINX and DNS based outage" href=https://andydote.co.uk/2022/04/23/nginx-dns/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Observability with Infrastructure as Code</h2></header><div class=entry-content><p>This article was originally published on the Pulumi blog.
When using the Pulumi Automation API to create applications which can provision infrastructure, it is very handy to be able to use observability techniques to ensure the application functions correctly and to help see where performance bottlenecks are.
One of the applications I work on creates a VPC and Bastion host and then stores the credentials into a Vault instance. The problem is that the “create infrastructure” part is an opaque blob, in that I can see it takes 129 seconds to create, but I can’t see what it’s doing, or why it takes this amount of time....</p></div><footer class=entry-footer>&lt;span title='2021-03-01 00:00:00 +0000 UTC'>March 1, 2021&lt;/span>&amp;nbsp;·&amp;nbsp;4 min</footer><a class=entry-link aria-label="post link to Observability with Infrastructure as Code" href=https://andydote.co.uk/2021/03/01/observability-with-infrastructure-as-code/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Testing Immutable Infrastructure</h2></header><div class=entry-content><p>In my previous post, I glossed over one of the most important and useful parts of Immutable Infrastructure: Testability. There are many kinds of tests we can write for our infrastructure, but they should all be focused on the machine/service and maybe it’s nearest dependencies, not the entire system.
While this post focuses on testing a full machine (both locally in a VM, and remotely as an Amazon EC2 instance), it is also possible to do most of the same kind of tests against a Docker container....</p></div><footer class=entry-footer>&lt;span title='2019-01-01 00:00:00 +0000 UTC'>January 1, 2019&lt;/span>&amp;nbsp;·&amp;nbsp;17 min</footer><a class=entry-link aria-label="post link to Testing Immutable Infrastructure" href=https://andydote.co.uk/2019/01/01/immutable-infra/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Terraform, Kinesis Streams, Lambda and IAM problems</h2></header><div class=entry-content><p>I hit an problem the recently with Terraform, when I was trying to hook up a Lambda Trigger to a Kinesis stream. Both the lambda itself, and the stream creation succeeded within Terraform, but the trigger would just stay stuck on “creating…” for at least 5 minutes, before I got bored of waiting and killed the process. Several attempts at doing this had the same issue.
The code looked something along the lines of this:...</p></div><footer class=entry-footer>&lt;span title='2017-07-12 00:00:00 +0000 UTC'>July 12, 2017&lt;/span>&amp;nbsp;·&amp;nbsp;2 min</footer><a class=entry-link aria-label="post link to Terraform, Kinesis Streams, Lambda and IAM problems" href=https://andydote.co.uk/2017/07/12/terraform-kinesis-lambda-iam/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>S3 Multi-File upload with Terraform</h2></header><div class=entry-content><p>Hosting a static website with S3 is really easy, especially from terraform:
First off, we want a public readable S3 bucket policy, but we want to apply this only to one specific bucket. To achive that we can use Terraform’s template_file data block to merge in a value:
{ "Version": "2012-10-17", "Statement": [ { "Sid": "PublicReadGetObject", "Effect": "Allow", "Principal": "*", "Action": [ "s3:GetObject" ], "Resource": [ "arn:aws:s3:::${bucket_name}/*" ] } ] } As you can see the interpolation syntax is pretty much the same as how you use variables in terraform itself....</p></div><footer class=entry-footer>&lt;span title='2017-04-23 00:00:00 +0000 UTC'>April 23, 2017&lt;/span>&amp;nbsp;·&amp;nbsp;3 min</footer><a class=entry-link aria-label="post link to S3 Multi-File upload with Terraform" href=https://andydote.co.uk/2017/04/23/s3-multi-file-upload-terraform/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Using Terraform to setup AWS API-Gateway and Lambda</h2></header><div class=entry-content><p>I have been writing simple webhook type applications using Claudiajs, which in behind the scenes is using Aws’s Lambda and Api Gateway to make things happen, but I really wanted to understand what exactly it was doing for me, and how I could achieve the same results using Terraform.
The Lambda Function I started off with a simple NodeJS function, in a file called index.js
exports.handler = function(event, context, callback) { callback(null, { statusCode: '200', body: JSON....</p></div><footer class=entry-footer>&lt;span title='2017-03-17 00:00:00 +0000 UTC'>March 17, 2017&lt;/span>&amp;nbsp;·&amp;nbsp;4 min</footer><a class=entry-link aria-label="post link to Using Terraform to setup AWS API-Gateway and Lambda" href=https://andydote.co.uk/2017/03/17/terraform-aws-lambda-api-gateway/></a></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>