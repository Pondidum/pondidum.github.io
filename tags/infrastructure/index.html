<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>infrastructure | Andy Dote</title><meta name=keywords content><meta name=description content><meta name=author content><link rel=canonical href=https://andydote.co.uk/tags/infrastructure/><link crossorigin=anonymous href=/assets/css/stylesheet.min.2b33c247bf6959372dd097f2cfdcd9f4d5019027cd9b1e28ae3d14c17c37ac00.css integrity="sha256-KzPCR79pWTct0Jfyz9zZ9NUBkCfNmx4orj0UwXw3rAA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://andydote.co.uk/tags/infrastructure/rss.xml><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="infrastructure"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://andydote.co.uk/tags/infrastructure/"><meta name=twitter:card content="summary"><meta name=twitter:title content="infrastructure"><meta name=twitter:description content></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><header class=page-header><h1>infrastructure</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2>The Operator Pattern in Nomad</h2></header><div class=entry-content><p>The Operator Pattern from Kubernetes is an excellent way of handling tasks in a cluster in an automated way, for example, provisioning applications, running backups, requesting certificates, and injecting chaos testing.
As a Nomad user, I wanted to do something similar for my clusters, so I set about seeing how it would be possible. It turns out; it is much easier than I expected! While Nomad doesn’t support the idea of Custom Resource Definitions, we can achieve an operator by utilising a regular Nomad job and the nomad HTTP API....</p></div><footer class=entry-footer><span title='2021-11-22 00:00:00 +0000 UTC'>November 22, 2021</span>&nbsp;·&nbsp;9 min</footer><a class=entry-link aria-label="post link to The Operator Pattern in Nomad" href=https://andydote.co.uk/2021/11/22/nomad-operator-pattern/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>The Problem with CPUs and Kubernetes</h2></header><div class=entry-content><p>Key Takeaway: os .cpus() returns the number of cores on a Kubernetes host, not the number of cores assigned to a pod.
Investigating excessive memory usage Recently, when I was looking through a cluster health dashboard for a Kubernetes cluster, I noticed that one of the applications deployed was using a considerable amount of RAM - way more than I thought could be reasonable. Each instance (pod) of the application used approximately 8 GB of RAM, which was definitely excessive for a reasonably simple NodeJS webserver....</p></div><footer class=entry-footer><span title='2021-06-02 00:00:00 +0000 UTC'>June 2, 2021</span>&nbsp;·&nbsp;2 min</footer><a class=entry-link aria-label="post link to The Problem with CPUs and Kubernetes" href=https://andydote.co.uk/2021/06/02/os-cpus-and-kubernetes/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Adding Observability to Vault</h2></header><div class=entry-content><p>One of the things I like to do when setting up a Vault cluster is to visualise all the operations Vault is performing, which helps see usage patterns changing, whether there are lots of failed requests coming in, and what endpoints are receiving the most traffic.
While Vault has a lot of data available in Prometheus telemetry, the kind of information I am after is best taken from the Audit backend....</p></div><footer class=entry-footer><span title='2021-05-27 00:00:00 +0000 UTC'>May 27, 2021</span>&nbsp;·&nbsp;7 min</footer><a class=entry-link aria-label="post link to Adding Observability to Vault" href=https://andydote.co.uk/2021/05/27/vault-observe/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Observability with Infrastructure as Code</h2></header><div class=entry-content><p>This article was originally published on the Pulumi blog.
When using the Pulumi Automation API to create applications which can provision infrastructure, it is very handy to be able to use observability techniques to ensure the application functions correctly and to help see where performance bottlenecks are.
One of the applications I work on creates a VPC and Bastion host and then stores the credentials into a Vault instance. The problem is that the “create infrastructure” part is an opaque blob, in that I can see it takes 129 seconds to create, but I can’t see what it’s doing, or why it takes this amount of time....</p></div><footer class=entry-footer><span title='2021-03-01 00:00:00 +0000 UTC'>March 1, 2021</span>&nbsp;·&nbsp;4 min</footer><a class=entry-link aria-label="post link to Observability with Infrastructure as Code" href=https://andydote.co.uk/2021/03/01/observability-with-infrastructure-as-code/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Nomad Isolated Exec</h2></header><div class=entry-content><p>One of the many features of Nomad that I like is the ability to run things other than Docker containers. It has built-in support for Java, QEMU, and Rkt, although the latter is deprecated. Besides these inbuilt “Task Drivers” there are community maintained ones too, covering Podman, LXC, Firecraker and BSD Jails, amongst others.
The one I want to talk about today, however, is called exec. This Task Driver runs any given executable, so if you have an application which you don’t want (or can’t) put into a container, you can still schedule it with Nomad....</p></div><footer class=entry-footer><span title='2020-02-29 00:00:00 +0000 UTC'>February 29, 2020</span>&nbsp;·&nbsp;4 min</footer><a class=entry-link aria-label="post link to Nomad Isolated Exec" href=https://andydote.co.uk/2020/02/29/nomad-isolated-exec/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Consul DNS Fowarding in Alpine, revisited</h2></header><div class=entry-content><p>I noticed when running an Alpine based virtual machine with Consul DNS forwarding set up, that sometimes the machine couldn’t resolve *.consul domains, but not in a consistent manner. Inspecting the logs looked like the request was being made and responded to successfully, but the result was being ignored.
After a lot of googling and frustration, I was able to track down that it’s down to a difference (or optimisation) in musl libc, which glibc doesn’t do....</p></div><footer class=entry-footer><span title='2019-12-30 00:00:00 +0000 UTC'>December 30, 2019</span>&nbsp;·&nbsp;4 min</footer><a class=entry-link aria-label="post link to Consul DNS Fowarding in Alpine, revisited" href=https://andydote.co.uk/2019/12/30/consul-alpine-dns-revisited/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Nomad Good, Kubernetes Bad</h2></header><div class=entry-content><p>I will update this post as I learn more (both positive and negative), and is here to be linked to when people ask me why I don’t like Kubernetes, and why I would pick Nomad in most situations if I chose to use an orchestrator at all.
TLDR: I don’t like complexity, and Kubernetes has more complexity than benefits.
Operational Complexity Operating Nomad is very straight forward. There are very few moving parts, so the number of things which can go wrong is significantly reduced....</p></div><footer class=entry-footer><span title='2019-11-21 00:00:00 +0000 UTC'>November 21, 2019</span>&nbsp;·&nbsp;6 min</footer><a class=entry-link aria-label="post link to Nomad Good, Kubernetes Bad" href=https://andydote.co.uk/2019/11/21/nomad-good-kubernetes-bad/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Creating a Vault instance with a TLS Consul Cluster</h2></header><div class=entry-content><p>So we want to set up a Vault instance, and have it’s storage be a TLS based Consul cluster. The problem is that the Consul cluster needs Vault to create the certificates for TLS, which is quite the catch-22. Luckily for us, quite easy to solve:
Start a temporary Vault instance as an intermediate ca Launch Consul cluster, using Vault to generate certificates Destroy temporary Vault instance Start a permanent Vault instance, with Consul as the store Reprovision the Consul cluster with certificates from the new Vault instance There is a repository on Github with all the scripts used, and a few more details on some options....</p></div><footer class=entry-footer><span title='2019-10-06 00:00:00 +0000 UTC'>October 6, 2019</span>&nbsp;·&nbsp;3 min</footer><a class=entry-link aria-label="post link to Creating a Vault instance with a TLS Consul Cluster" href=https://andydote.co.uk/2019/10/06/vault-consul-bootstrap/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Consul DNS Fowarding in Ubuntu, revisited</h2></header><div class=entry-content><p>I was recently using my Hashibox for a test, and I noticed the DNS resolution didn’t seem to work. This was a bit worrying, as I have written about how to do DNS resolution with Consul forwarding in Ubuntu, and apparently something is wrong with how I do it. Interestingly, the Alpine version works fine, so it appears there is something not quite working with how I am configuring Systemd-resolved....</p></div><footer class=entry-footer><span title='2019-09-24 00:00:00 +0000 UTC'>September 24, 2019</span>&nbsp;·&nbsp;7 min</footer><a class=entry-link aria-label="post link to Consul DNS Fowarding in Ubuntu, revisited" href=https://andydote.co.uk/2019/09/24/consul-ubuntu-dns-revisited/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2>Canary Routing with Traefik in Nomad</h2></header><div class=entry-content><p>I wanted to implement canary routing for some HTTP services deployed via Nomad the other day, but rather than having the traffic split by weighting to the containers, I wanted to direct the traffic based on a header.
My first choice of tech was to use Fabio, but it only supports routing by URL prefix, and additionally with a route weight. While I was at JustDevOps in Poland, I heard about another router/loadbalancer which worked in a similar way to Fabio: Traefik....</p></div><footer class=entry-footer><span title='2019-06-23 00:00:00 +0000 UTC'>June 23, 2019</span>&nbsp;·&nbsp;8 min</footer><a class=entry-link aria-label="post link to Canary Routing with Traefik in Nomad" href=https://andydote.co.uk/2019/06/23/nomad-traefik-canary/></a></article><footer class=page-footer><nav class=pagination><a class=next href=https://andydote.co.uk/tags/infrastructure/page/2/>Next Page »</a></nav></footer></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>