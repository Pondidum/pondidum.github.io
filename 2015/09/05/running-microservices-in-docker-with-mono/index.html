<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Running microservices in Docker with Mono | Andy Dote</title><meta name=keywords content="design,microservices,docker,mono"><meta name=description content="Getting a service running under Docker is fairly straight forward once you have all the working parts together. I have an app written (following my guide on service and console in one), which uses Owin to serve a web page as a demo:
install-package Microsoft.Owin.SelfHost public partial class Service : ServiceBase { //see the service console post for the rest of this protected override void OnStart(string[] args) { _app = WebApp."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2015/09/05/running-microservices-in-docker-with-mono/><link crossorigin=anonymous href=/assets/css/stylesheet.min.4ac25d88867f6882d86478d9b478a3d3efa1ed9e18f0bc5e432812301516cb28.css integrity="sha256-SsJdiIZ/aILYZHjZtHij0++h7Z4Y8LxeQygSMBUWyyg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Running microservices in Docker with Mono"><meta property="og:description" content="Getting a service running under Docker is fairly straight forward once you have all the working parts together. I have an app written (following my guide on service and console in one), which uses Owin to serve a web page as a demo:
install-package Microsoft.Owin.SelfHost public partial class Service : ServiceBase { //see the service console post for the rest of this protected override void OnStart(string[] args) { _app = WebApp."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2015/09/05/running-microservices-in-docker-with-mono/"><meta property="article:section" content="post"><meta property="article:published_time" content="2015-09-05T00:00:00+00:00"><meta property="article:modified_time" content="2015-09-05T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Running microservices in Docker with Mono"><meta name=twitter:description content="Getting a service running under Docker is fairly straight forward once you have all the working parts together. I have an app written (following my guide on service and console in one), which uses Owin to serve a web page as a demo:
install-package Microsoft.Owin.SelfHost public partial class Service : ServiceBase { //see the service console post for the rest of this protected override void OnStart(string[] args) { _app = WebApp."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Running microservices in Docker with Mono","item":"https://andydote.co.uk/2015/09/05/running-microservices-in-docker-with-mono/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Running microservices in Docker with Mono","name":"Running microservices in Docker with Mono","description":"Getting a service running under Docker is fairly straight forward once you have all the working parts together. I have an app written (following my guide on service and console in one), which uses Owin to serve a web page as a demo:\ninstall-package Microsoft.Owin.SelfHost public partial class Service : ServiceBase { //see the service console post for the rest of this protected override void OnStart(string[] args) { _app = WebApp.","keywords":["design","microservices","docker","mono"],"articleBody":"Getting a service running under Docker is fairly straight forward once you have all the working parts together. I have an app written (following my guide on service and console in one), which uses Owin to serve a web page as a demo:\ninstall-package Microsoft.Owin.SelfHost public partial class Service : ServiceBase { //see the service console post for the rest of this protected override void OnStart(string[] args) { _app = WebApp.Start(\"http://*:12345\", app =\u003e { app.UseWelcomePage(\"/\"); }); } protected override void OnStop() { _app.Dispose(); } } To run this under docker/mono we just need to add a Dockerfile to the root directory of the solution, which is based off the documentation here.\nUsing mono-service instead of mono to run the application caused me a number of headaches to start with, as the container was exiting instantly. This is because Docker detects the process has exited, and stops the container. As we will be running the container detached from the console, we just need to supply the --no-daemon argument to mono-service.\nFROM mono:3.10-onbuild RUN apt-get update \u0026\u0026 apt-get install mono-4.0-service -y CMD [ \"mono-service\", \"./MicroServiceDemo.exe\", \"--no-daemon\" ] EXPOSE 12345 You can then go to your solution directory, and run the following two commands to create your image, and start a container of it:\ndocker build -t servicedemo . docker run -d -p 12345:12345 --name demo servicedemo You can now open your browser and go to your Docker hostâ€™s IP:12345 and see the Owin welcome page.\nImprovements: Speed and lack of internet Quite often I have no internet access, so having to apt-get install mono-4.0-service each time I build the image can be a pain. This however is also very easily resolved: by making another image with the package already installed.\nCreate a new directory (outside of your project directory), and create a Dockerfile. This Dockerfile is identical to the mono:3.10-onbuild image, but with the added apt-get line.\nFROM mono:3.10.0 MAINTAINER Jo Shields RUN apt-get update \u0026\u0026 apt-get install mono-4.0-service -y RUN mkdir -p /usr/src/app/source /usr/src/app/build WORKDIR /usr/src/app/source ONBUILD COPY . /usr/src/app/source ONBUILD RUN nuget restore -NonInteractive ONBUILD RUN xbuild /property:Configuration=Release /property:OutDir=/usr/src/app/build/ ONBUILD WORKDIR /usr/src/app/build Now run the build command to make your new base image:\ndocker build -t mono-service-onbuild . Now you can go back to your project and update the Dockerfile to use this image base instead:\nFROM mono-service-onbuild CMD [ \"mono-service\", \"./MicroServiceDemo.exe\", \"--no-daemon\" ] EXPOSE 12345 Now when you run docker build -t . it will only need to do the compile steps.\nMuch faster :)\n","wordCount":"419","inLanguage":"en","datePublished":"2015-09-05T00:00:00Z","dateModified":"2015-09-05T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2015/09/05/running-microservices-in-docker-with-mono/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Running microservices in Docker with Mono</h1><div class=post-meta><span title='2015-09-05 00:00:00 +0000 UTC'>September 5, 2015</span>&nbsp;Â·&nbsp;2 min</div></header><div class=post-content><p>Getting a service running under <a href=https://www.docker.com>Docker</a> is fairly straight forward once you have all the working parts together. I have an app written (following <a href=/2015/08/30/single-project-service-and-console.html>my guide</a> on service and console in one), which uses Owin to serve a web page as a demo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>install-package Microsoft.Owin.SelfHost
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>partial</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Service</span> : ServiceBase
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>//see the service console post for the rest of this</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> OnStart(<span style=color:#66d9ef>string</span>[] args)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		_app = WebApp.Start(<span style=color:#e6db74>&#34;http://*:12345&#34;</span>, app =&gt;
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			app.UseWelcomePage(<span style=color:#e6db74>&#34;/&#34;</span>);
</span></span><span style=display:flex><span>		});
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> OnStop()
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		_app.Dispose();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To run this under docker/mono we just need to add a <code>Dockerfile</code> to the root directory of the solution, which is based off the <a href=https://hub.docker.com/_/mono>documentation here</a>.</p><p>Using <code>mono-service</code> instead of <code>mono</code> to run the application caused me a number of headaches to start with, as the container was exiting instantly. This is because Docker detects the process has exited, and stops the container. As we will be running the container detached from the console, we just need to supply the <code>--no-daemon</code> argument to <code>mono-service</code>.</p><pre tabindex=0><code>FROM mono:3.10-onbuild
RUN apt-get update &amp;&amp; apt-get install mono-4.0-service -y
CMD [ &#34;mono-service&#34;,  &#34;./MicroServiceDemo.exe&#34;, &#34;--no-daemon&#34; ]
EXPOSE 12345
</code></pre><p>You can then go to your solution directory, and run the following two commands to create your image, and start a container of it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t servicedemo .
</span></span><span style=display:flex><span>docker run -d -p 12345:12345 --name demo servicedemo
</span></span></code></pre></div><p>You can now open your browser and go to your Docker host&rsquo;s IP:12345 and see the Owin welcome page.</p><h2 id=improvements-speed-and-lack-of-internet>Improvements: Speed and lack of internet<a hidden class=anchor aria-hidden=true href=#improvements-speed-and-lack-of-internet>#</a></h2><p>Quite often I have no internet access, so having to <code>apt-get install mono-4.0-service</code> each time I build the image can be a pain. This however is also very easily resolved: by making another image with the package already installed.</p><p>Create a new directory (outside of your project directory), and create a <code>Dockerfile</code>. This Dockerfile is identical to the <a href=https://github.com/mono/docker/blob/adc7a3ec47f7d590f75a4dec0203a2103daf8db0/3.10.0/onbuild/Dockerfile>mono:3.10-onbuild</a> image, but with the added apt-get line.</p><pre tabindex=0><code>FROM mono:3.10.0

MAINTAINER Jo Shields &lt;jo.shields@xamarin.com&gt;

RUN apt-get update &amp;&amp; apt-get install mono-4.0-service -y

RUN mkdir -p /usr/src/app/source /usr/src/app/build
WORKDIR /usr/src/app/source

ONBUILD COPY . /usr/src/app/source
ONBUILD RUN nuget restore -NonInteractive
ONBUILD RUN xbuild /property:Configuration=Release /property:OutDir=/usr/src/app/build/
ONBUILD WORKDIR /usr/src/app/build
</code></pre><p>Now run the build command to make your new base image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t mono-service-onbuild .
</span></span></code></pre></div><p>Now you can go back to your project and update the <code>Dockerfile</code> to use this image base instead:</p><pre tabindex=0><code>FROM mono-service-onbuild
CMD [ &#34;mono-service&#34;,  &#34;./MicroServiceDemo.exe&#34;, &#34;--no-daemon&#34; ]
EXPOSE 12345
</code></pre><p>Now when you run <code>docker build -t &lt;project name> .</code> it will only need to do the compile steps.</p><p>Much faster :)</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/design/>design</a></li><li><a href=https://andydote.co.uk/tags/microservices/>microservices</a></li><li><a href=https://andydote.co.uk/tags/docker/>docker</a></li><li><a href=https://andydote.co.uk/tags/mono/>mono</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2015/09/15/pre-compiled-microservices/><span class=title>Â« Prev Page</span><br><span>Running pre-compiled microservices in Docker with Mono</span></a>
<a class=next href=https://andydote.co.uk/2015/08/30/single-project-service-and-console/><span class=title>Next Page Â»</span><br><span>A single project Windows Service and Console</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>