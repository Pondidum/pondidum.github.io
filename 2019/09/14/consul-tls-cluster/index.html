<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Creating a TLS enabled Consul cluster | Andy Dote</title><meta name=keywords content="vault,security,tls,consul"><meta name=description content="This post is going to go through how to set up a Consul cluster to communicate over TLS. I will be using Vagrant to create three machines locally, which will form my cluster, and in the provisioning step will use Vault to generate the certificates needed.
How to securely communicate with Vault to get the TLS certificates is out of scope for this post.
Host Configuration Unless you already have Vault running somewhere on your network, or have another mechanism to generate TLS certificates for each machine, you&rsquo;ll need to start and configure Vault on the Host machine."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2019/09/14/consul-tls-cluster/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b4e19c453811e60acfec1f00c15ac2be1c53f6ab90187e684358ce7faaf48bab.css integrity="sha256-tOGcRTgR5grP7B8AwVrCvhxT9quQGH5oQ1jOf6r0i6s=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.e85ad0406048e8176e1c7661b25d5c69297ddfe41dc4124cf75ecb99a4f7b3d1.js integrity="sha256-6FrQQGBI6BduHHZhsl1caSl93+QdxBJM917LmaT3s9E=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Creating a TLS enabled Consul cluster"><meta property="og:description" content="This post is going to go through how to set up a Consul cluster to communicate over TLS. I will be using Vagrant to create three machines locally, which will form my cluster, and in the provisioning step will use Vault to generate the certificates needed.
How to securely communicate with Vault to get the TLS certificates is out of scope for this post.
Host Configuration Unless you already have Vault running somewhere on your network, or have another mechanism to generate TLS certificates for each machine, you&rsquo;ll need to start and configure Vault on the Host machine."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2019/09/14/consul-tls-cluster/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-09-14T00:00:00+00:00"><meta property="article:modified_time" content="2019-09-14T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Creating a TLS enabled Consul cluster"><meta name=twitter:description content="This post is going to go through how to set up a Consul cluster to communicate over TLS. I will be using Vagrant to create three machines locally, which will form my cluster, and in the provisioning step will use Vault to generate the certificates needed.
How to securely communicate with Vault to get the TLS certificates is out of scope for this post.
Host Configuration Unless you already have Vault running somewhere on your network, or have another mechanism to generate TLS certificates for each machine, you&rsquo;ll need to start and configure Vault on the Host machine."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Creating a TLS enabled Consul cluster","item":"https://andydote.co.uk/2019/09/14/consul-tls-cluster/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Creating a TLS enabled Consul cluster","name":"Creating a TLS enabled Consul cluster","description":"This post is going to go through how to set up a Consul cluster to communicate over TLS. I will be using Vagrant to create three machines locally, which will form my cluster, and in the provisioning step will use Vault to generate the certificates needed.\nHow to securely communicate with Vault to get the TLS certificates is out of scope for this post.\nHost Configuration Unless you already have Vault running somewhere on your network, or have another mechanism to generate TLS certificates for each machine, you\u0026rsquo;ll need to start and configure Vault on the Host machine.","keywords":["vault","security","tls","consul"],"articleBody":"This post is going to go through how to set up a Consul cluster to communicate over TLS. I will be using Vagrant to create three machines locally, which will form my cluster, and in the provisioning step will use Vault to generate the certificates needed.\nHow to securely communicate with Vault to get the TLS certificates is out of scope for this post.\nHost Configuration Unless you already have Vault running somewhere on your network, or have another mechanism to generate TLS certificates for each machine, you’ll need to start and configure Vault on the Host machine. I am using my Vault Dev Intermediate CA script from my previous post.\nTo set this up, all I need to do is run this on the host machine, which starts Vault in a docker container, and configures it as an intermediate certificate authority:\n./run_int.sh I also have DNS on my network setup for the tecra.xyz domain so will be using that to test with.\nConsul Machine Configuration The Vagrantfile is very minimal - I am using my Hashibox (be aware the libvirt provider for this might not work, for some reason vagrant package with libvirt produces a non-bootable box).\nVagrant.configure(2) do |config| config.vm.box = \"pondidum/hashibox\" config.vm.provision \"consul\", type: \"shell\", path: \"./provision.sh\" config.vm.define \"c1\" do |c1| c1.vm.hostname = \"consul1\" end config.vm.define \"c2\" do |c2| c2.vm.hostname = \"consul2\" end config.vm.define \"c3\" do |c3| c3.vm.hostname = \"consul3\" end end The hashibox script already has all the tools we’ll need installed already: Consul, Vault, and jq.\nFirst up, we request a certificate from Vault to use for Consul - How you get this certificate in a secure manner in a production environment is up to you. There is a catch-22 here for me, in that in a production environment I use Vault with Consul as it’s backing store…but Consul needs Vault to start! I’ll go over how I get around this in a future post.\nexport VAULT_ADDR=\"http://vault.tecra.xyz:8200\" export VAULT_TOKEN=\"vault\" response=$(vault write pki/issue/cert -format=json common_name=$HOSTNAME.tecra.xyz alt_names=\"server.dc1.consul\") config_dir=\"/etc/consul.d\" The first thing to note is that we have specified an alt_names for the certificate - you must have a SAN of server.$DC.$DOMAIN so either server.dc1.consul or server.euwest1.tecra.xyz, and the server prefix is required!.\nNext, we need to take all the certificates from the response and write them to the filesystem.\nmkdir -p \"$config_dir/ca\" for (( i=0; i\u003c$(echo \"$response\" | jq '.data.ca_chain | length'); i++ )); do cert=$(echo \"$response\" | jq -r \".data.ca_chain[$i]\") name=$(echo \"$cert\" | openssl x509 -noout -subject -nameopt multiline | sed -n 's/ *commonName *= //p' | sed 's/\\s//g') echo \"$cert\" \u003e \"$config_dir/ca/$name.pem\" done echo \"$response\" | jq -r .data.private_key \u003e $config_dir/consul.key echo \"$response\" | jq -r .data.certificate \u003e $config_dir/consul.crt echo \"$response\" | jq -r .data.issuing_ca \u003e\u003e $config_dir/consul.crt The for loop iterates through all of the certificates returned in the ca_chain and writes them into a ca directory. We use openssl to get the name of the certificate, so the files are named nicely!\nFinally, it writes the private_key for the node’s certificate to consul.key, and both the certificate and issuing_ca to the consul.crt file.\nNow for the consul.json. To setup a secure cluster, first of all we need to add the certificate configuration, pointing to the files we wrote earlier:\n\"ca_path\": \"$config_dir/ca/\", \"cert_file\": \"$config_dir/consul.crt\", \"key_file\": \"$config_dir/consul.key\", We will also disable the HTTP port, and enable the HTTPS port:\n\"ports\": { \"http\": -1, \"https\": 8501 } Finally, we need to add some security settings. First is encrypt, which sets that the key that all Consul nodes will use to encrypt their communications. It must match on all nodes. The easiest way to generate this is just run consul keygen and use the value that produces.\n\"encrypt\": \"oNMJiPZRlaP8RnQiQo9p8MMK5RSJ+dXA2u+GjFm1qx8=\":\nThe key the cluster will use to encrypt all it’s traffic. It must be the same on all nodes, and the easiest way to generate the value is to use the output of consul keygen.\n\"verify_outgoing\": true:\nAll the traffic leaving this node will be encrypted with the TLS certificates. However, the node will still accept non-TLS traffic.\n\"verify_incoming_rpc\": true:\nAll the gossip traffic arriving at this node must be signed with an authority in the ca_path.\n\"verify_incoming_https\": false:\nWe are going to use the Consul Web UI, so we want to allow traffic to hit the API without a client certificate. If you are using the UI from a non-server node, you can set this to true.\n\"verify_server_hostname\": true:\nSet Consul to verify outgoing connections have a hostname in the format of server... From the docs: “This setting is critical to prevent a compromised client from being restarted as a server and having all cluster state including all ACL tokens and Connect CA root keys replicated to it”\nThe complete config we will use is listed here:\n( cat \u003c\u003c-EOF { \"bootstrap_expect\": 3, \"client_addr\": \"0.0.0.0\", \"data_dir\": \"/var/consul\", \"leave_on_terminate\": true, \"rejoin_after_leave\": true, \"retry_join\": [\"consul1\", \"consul2\", \"consul3\"], \"server\": true, \"ui\": true, \"encrypt\": \"oNMJiPZRlaP8RnQiQo9p8MMK5RSJ+dXA2u+GjFm1qx8=\", \"verify_incoming_rpc\": true, \"verify_incoming_https\": false, \"verify_outgoing\": true, \"verify_server_hostname\": true, \"ca_path\": \"$config_dir/ca/\", \"cert_file\": \"$config_dir/consul.crt\", \"key_file\": \"$config_dir/consul.key\", \"ports\": { \"http\": -1, \"https\": 8501 } } EOF ) | sudo tee $config_dir/consul.json Lastly, we’ll make a systemd service unit to start consul:\n( cat \u003c\u003c-EOF [Unit] Description=consul agent Requires=network-online.target After=network-online.target [Service] Restart=on-failure ExecStart=/usr/bin/consul agent -config-file=$config_dir/consul.json -bind '{{ GetInterfaceIP \"eth0\" }}' ExecReload=/bin/kill -HUP $MAINPID [Install] WantedBy=multi-user.target EOF ) | sudo tee /etc/systemd/system/consul.service sudo systemctl daemon-reload sudo systemctl enable consul.service sudo systemctl start consul As the machines we are starting also have docker networks (and potentially others), our startup line specifies to bind to the eth0 network, using a Consul Template.\nRunning First, we need to run our intermediate CA, then provision our three machines:\n./run_int.sh vagrant up After a few moments, you should be able to curl the consul ui (curl https://consul1.tecra.xyz:8501) or open https://consul1.tecra.xyz:8501 in your browser.\nNote, however, the if your root CA is self-signed, like mine is, some browsers (such as FireFox) won’t trust it, as they won’t use your machine’s Trusted Certificate Store, but their own in built store. You can either accept the warning or add your root certificate to the browser’s store.\nTesting Now that we have our cluster seemingly running with TLS, what happens if we try to connect a Consul client without TLS to it? On the host machine, I just run a single node, and tell it to connect to one of the cluster nodes:\nconsul agent \\ -join consul1.tecra.xyz \\ -bind '{{ GetInterfaceIP \"eth0\" }}' \\ -data-dir /tmp/consul The result of this is a refusal to connect, as the cluster has TLS configured, but this instance does not:\n==\u003e Starting Consul agent... ==\u003e Log data will now stream in as it occurs: ==\u003e Joining cluster... ==\u003e 1 error occurred: * Failed to join 192.168.121.231: Remote state is encrypted and encryption is not configured Success!\nIn the next post, I’ll go through how we can set up a Vault cluster which stores its data in Consul, but also provision that same Consul cluster with certificates from the Vault instance!\n","wordCount":"1156","inLanguage":"en","datePublished":"2019-09-14T00:00:00Z","dateModified":"2019-09-14T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2019/09/14/consul-tls-cluster/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Creating a TLS enabled Consul cluster</h1><div class=post-meta><span title='2019-09-14 00:00:00 +0000 UTC'>September 14, 2019</span>&nbsp;·&nbsp;6 min</div></header><div class=post-content><p>This post is going to go through how to set up a <a href=https://www.consul.io/>Consul</a> cluster to communicate over TLS. I will be using <a href=https://www.vagrantup.com/>Vagrant</a> to create three machines locally, which will form my cluster, and in the provisioning step will use Vault to generate the certificates needed.</p><p>How to securely communicate with Vault to get the TLS certificates is out of scope for this post.</p><h2 id=host-configuration>Host Configuration<a hidden class=anchor aria-hidden=true href=#host-configuration>#</a></h2><p>Unless you already have Vault running somewhere on your network, or have another mechanism to generate TLS certificates for each machine, you&rsquo;ll need to start and configure Vault on the Host machine. I am using my <a href=https://andydote.co.uk/2019/08/25/vault-development-ca/#creating-a-vault-intermediate-ca>Vault Dev Intermediate CA script from my previous post</a>.</p><p>To set this up, all I need to do is run this on the host machine, which starts Vault in a docker container, and configures it as an intermediate certificate authority:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./run_int.sh
</span></span></code></pre></div><p>I also have DNS on my network setup for the <code>tecra.xyz</code> domain so will be using that to test with.</p><h2 id=consul-machine-configuration>Consul Machine Configuration<a hidden class=anchor aria-hidden=true href=#consul-machine-configuration>#</a></h2><p>The <code>Vagrantfile</code> is very minimal - I am using my <a href=https://app.vagrantup.com/pondidum/boxes/hashibox>Hashibox</a> (be aware the <code>libvirt</code> provider for this might not work, for some reason <code>vagrant package</code> with libvirt produces a non-bootable box).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Vagrant</span><span style=color:#f92672>.</span>configure(<span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>config<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>box <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pondidum/hashibox&#34;</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>provision <span style=color:#e6db74>&#34;consul&#34;</span>, <span style=color:#e6db74>type</span>: <span style=color:#e6db74>&#34;shell&#34;</span>, <span style=color:#e6db74>path</span>: <span style=color:#e6db74>&#34;./provision.sh&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>define <span style=color:#e6db74>&#34;c1&#34;</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>c1<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>    c1<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>hostname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;consul1&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>define <span style=color:#e6db74>&#34;c2&#34;</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>c2<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>    c2<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>hostname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;consul2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>define <span style=color:#e6db74>&#34;c3&#34;</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>c3<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>    c3<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>hostname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;consul3&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>The hashibox script already has all the tools we&rsquo;ll need installed already: Consul, Vault, and jq.</p><p>First up, we request a certificate from Vault to use for Consul - How you get this certificate in a secure manner in a production environment is up to you. There is a catch-22 here for me, in that in a production environment I use Vault with Consul as it&rsquo;s backing store&mldr;but Consul needs Vault to start! I&rsquo;ll go over how I get around this in a future post.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export VAULT_ADDR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://vault.tecra.xyz:8200&#34;</span>
</span></span><span style=display:flex><span>export VAULT_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;vault&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>response<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>vault write pki/issue/cert -format<span style=color:#f92672>=</span>json common_name<span style=color:#f92672>=</span>$HOSTNAME.tecra.xyz alt_names<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;server.dc1.consul&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>config_dir<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/etc/consul.d&#34;</span>
</span></span></code></pre></div><p>The first thing to note is that we have specified an <code>alt_names</code> for the certificate - you <em>must</em> have a SAN of <code>server.$DC.$DOMAIN</code> so either <code>server.dc1.consul</code> or <code>server.euwest1.tecra.xyz</code>, and the <code>server</code> prefix is required!.</p><p>Next, we need to take all the certificates from the response and write them to the filesystem.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p <span style=color:#e6db74>&#34;</span>$config_dir<span style=color:#e6db74>/ca&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#f92672>((</span> i<span style=color:#f92672>=</span>0; i&lt;<span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$response<span style=color:#e6db74>&#34;</span> | jq <span style=color:#e6db74>&#39;.data.ca_chain | length&#39;</span><span style=color:#66d9ef>)</span>; i++ <span style=color:#f92672>))</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  cert<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$response<span style=color:#e6db74>&#34;</span> | jq -r <span style=color:#e6db74>&#34;.data.ca_chain[</span>$i<span style=color:#e6db74>]&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>  name<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$cert<span style=color:#e6db74>&#34;</span> | openssl x509 -noout -subject -nameopt multiline | sed -n <span style=color:#e6db74>&#39;s/ *commonName *= //p&#39;</span> | sed <span style=color:#e6db74>&#39;s/\s//g&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;</span>$cert<span style=color:#e6db74>&#34;</span> &gt; <span style=color:#e6db74>&#34;</span>$config_dir<span style=color:#e6db74>/ca/</span>$name<span style=color:#e6db74>.pem&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;</span>$response<span style=color:#e6db74>&#34;</span> | jq -r .data.private_key &gt; $config_dir/consul.key
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;</span>$response<span style=color:#e6db74>&#34;</span> | jq -r .data.certificate &gt; $config_dir/consul.crt
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;</span>$response<span style=color:#e6db74>&#34;</span> | jq -r .data.issuing_ca &gt;&gt; $config_dir/consul.crt
</span></span></code></pre></div><p>The <code>for</code> loop iterates through all of the certificates returned in the <code>ca_chain</code> and writes them into a <code>ca</code> directory. We use <code>openssl</code> to get the name of the certificate, so the files are named nicely!</p><p>Finally, it writes the <code>private_key</code> for the node&rsquo;s certificate to <code>consul.key</code>, and both the <code>certificate</code> and <code>issuing_ca</code> to the <code>consul.crt</code> file.</p><p>Now for the <code>consul.json</code>. To setup a secure cluster, first of all we need to add the certificate configuration, pointing to the files we wrote earlier:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;ca_path&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;$config_dir/ca/&#34;</span><span style=color:#960050;background-color:#1e0010>,</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;cert_file&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;$config_dir/consul.crt&#34;</span><span style=color:#960050;background-color:#1e0010>,</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;key_file&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;$config_dir/consul.key&#34;</span><span style=color:#960050;background-color:#1e0010>,</span>
</span></span></code></pre></div><p>We will also disable the HTTP port, and enable the HTTPS port:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;ports&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;http&#34;</span>: <span style=color:#ae81ff>-1</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;https&#34;</span>: <span style=color:#ae81ff>8501</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally, we need to add some security settings. First is <code>encrypt</code>, which sets that the key that all Consul nodes will use to encrypt their communications. It must match on all nodes. The easiest way to generate this is just run <code>consul keygen</code> and use the value that produces.</p><ul><li><p><code>"encrypt": "oNMJiPZRlaP8RnQiQo9p8MMK5RSJ+dXA2u+GjFm1qx8="</code>:</p><p>The key the cluster will use to encrypt all it&rsquo;s traffic. It must be the same on all nodes, and the easiest way to generate the value is to use the output of <code>consul keygen</code>.</p></li><li><p><code>"verify_outgoing": true</code>:</p><p>All the traffic leaving this node will be encrypted with the TLS certificates. However, the node will still accept non-TLS traffic.</p></li><li><p><code>"verify_incoming_rpc": true</code>:</p><p>All the gossip traffic arriving at this node must be signed with an authority in the <code>ca_path</code>.</p></li><li><p><code>"verify_incoming_https": false</code>:</p><p>We are going to use the Consul Web UI, so we want to allow traffic to hit the API without a client certificate. If you are using the UI from a non-server node, you can set this to <code>true</code>.</p></li><li><p><code>"verify_server_hostname": true</code>:</p><p>Set Consul to verify <strong>outgoing</strong> connections have a hostname in the format of <code>server.&lt;datacenter>.&lt;domain></code>. From the <a href=https://www.consul.io/docs/agent/options.html#verify_server_hostname>docs</a>: &ldquo;This setting is critical to prevent a compromised client from being restarted as a server and having all cluster state including all ACL tokens and Connect CA root keys replicated to it&rdquo;</p></li></ul><p>The complete config we will use is listed here:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;-EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;bootstrap_expect&#34;: 3,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;client_addr&#34;: &#34;0.0.0.0&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;data_dir&#34;: &#34;/var/consul&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;leave_on_terminate&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;rejoin_after_leave&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;retry_join&#34;: [&#34;consul1&#34;, &#34;consul2&#34;, &#34;consul3&#34;],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;server&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;ui&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;encrypt&#34;: &#34;oNMJiPZRlaP8RnQiQo9p8MMK5RSJ+dXA2u+GjFm1qx8=&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;verify_incoming_rpc&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;verify_incoming_https&#34;: false,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;verify_outgoing&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;verify_server_hostname&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;ca_path&#34;: &#34;$config_dir/ca/&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;cert_file&#34;: &#34;$config_dir/consul.crt&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;key_file&#34;: &#34;$config_dir/consul.key&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;ports&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;http&#34;: -1,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;https&#34;: 8501
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span> | sudo tee $config_dir/consul.json
</span></span></code></pre></div><p>Lastly, we&rsquo;ll make a systemd service unit to start consul:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;-EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Description=consul agent
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Requires=network-online.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>After=network-online.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Restart=on-failure
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStart=/usr/bin/consul agent -config-file=$config_dir/consul.json -bind &#39;{{ GetInterfaceIP &#34;eth0&#34; }}&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecReload=/bin/kill -HUP $MAINPID
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WantedBy=multi-user.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span> | sudo tee /etc/systemd/system/consul.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl daemon-reload
</span></span><span style=display:flex><span>sudo systemctl enable consul.service
</span></span><span style=display:flex><span>sudo systemctl start consul
</span></span></code></pre></div><p>As the machines we are starting also have docker networks (and potentially others), our startup line specifies to bind to the <code>eth0</code> network, using a Consul Template.</p><h2 id=running>Running<a hidden class=anchor aria-hidden=true href=#running>#</a></h2><p>First, we need to run our intermediate CA, then provision our three machines:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./run_int.sh
</span></span><span style=display:flex><span>vagrant up
</span></span></code></pre></div><p>After a few moments, you should be able to <code>curl</code> the consul ui (<code>curl https://consul1.tecra.xyz:8501</code>) or open <code>https://consul1.tecra.xyz:8501</code> in your browser.</p><p>Note, however, the if your root CA is self-signed, like mine is, some browsers (such as FireFox) won&rsquo;t trust it, as they won&rsquo;t use your machine&rsquo;s Trusted Certificate Store, but their own in built store. You can either accept the warning or add your root certificate to the browser&rsquo;s store.</p><h2 id=testing>Testing<a hidden class=anchor aria-hidden=true href=#testing>#</a></h2><p>Now that we have our cluster seemingly running with TLS, what happens if we try to connect a Consul client <em>without</em> TLS to it? On the host machine, I just run a single node, and tell it to connect to one of the cluster nodes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>consul agent <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -join consul1.tecra.xyz <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -bind <span style=color:#e6db74>&#39;{{ GetInterfaceIP &#34;eth0&#34; }}&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -data-dir /tmp/consul
</span></span></code></pre></div><p>The result of this is a refusal to connect, as the cluster has TLS configured, but this instance does not:</p><pre tabindex=0><code>==&gt; Starting Consul agent...
==&gt; Log data will now stream in as it occurs:
==&gt; Joining cluster...
==&gt; 1 error occurred:
  * Failed to join 192.168.121.231: Remote state is encrypted and encryption is not configured
</code></pre><p>Success!</p><p>In the next post, I&rsquo;ll go through how we can set up a Vault cluster which stores its data in Consul, but also provision that same Consul cluster with certificates from the Vault instance!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/vault/>vault</a></li><li><a href=https://andydote.co.uk/tags/security/>security</a></li><li><a href=https://andydote.co.uk/tags/tls/>tls</a></li><li><a href=https://andydote.co.uk/tags/consul/>consul</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2019/09/24/consul-ubuntu-dns-revisited/><span class=title>« Prev Page</span><br><span>Consul DNS Fowarding in Ubuntu, revisited</span></a>
<a class=next href=https://andydote.co.uk/2019/08/25/vault-development-ca/><span class=title>Next Page »</span><br><span>Using Vault as a Development CA</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>