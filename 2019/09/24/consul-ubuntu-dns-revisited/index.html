<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Consul DNS Fowarding in Ubuntu, revisited | Andy Dote</title><meta name=keywords content="consul,dns,infrastructure"><meta name=description content="I was recently using my Hashibox for a test, and I noticed the DNS resolution didn&rsquo;t seem to work. This was a bit worrying, as I have written about how to do DNS resolution with Consul forwarding in Ubuntu, and apparently something is wrong with how I do it. Interestingly, the Alpine version works fine, so it appears there is something not quite working with how I am configuring Systemd-resolved."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2019/09/24/consul-ubuntu-dns-revisited/><link crossorigin=anonymous href=/assets/css/stylesheet.min.4ac25d88867f6882d86478d9b478a3d3efa1ed9e18f0bc5e432812301516cb28.css integrity="sha256-SsJdiIZ/aILYZHjZtHij0++h7Z4Y8LxeQygSMBUWyyg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Consul DNS Fowarding in Ubuntu, revisited"><meta property="og:description" content="I was recently using my Hashibox for a test, and I noticed the DNS resolution didn&rsquo;t seem to work. This was a bit worrying, as I have written about how to do DNS resolution with Consul forwarding in Ubuntu, and apparently something is wrong with how I do it. Interestingly, the Alpine version works fine, so it appears there is something not quite working with how I am configuring Systemd-resolved."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2019/09/24/consul-ubuntu-dns-revisited/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-09-24T00:00:00+00:00"><meta property="article:modified_time" content="2019-09-24T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Consul DNS Fowarding in Ubuntu, revisited"><meta name=twitter:description content="I was recently using my Hashibox for a test, and I noticed the DNS resolution didn&rsquo;t seem to work. This was a bit worrying, as I have written about how to do DNS resolution with Consul forwarding in Ubuntu, and apparently something is wrong with how I do it. Interestingly, the Alpine version works fine, so it appears there is something not quite working with how I am configuring Systemd-resolved."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Consul DNS Fowarding in Ubuntu, revisited","item":"https://andydote.co.uk/2019/09/24/consul-ubuntu-dns-revisited/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Consul DNS Fowarding in Ubuntu, revisited","name":"Consul DNS Fowarding in Ubuntu, revisited","description":"I was recently using my Hashibox for a test, and I noticed the DNS resolution didn\u0026rsquo;t seem to work. This was a bit worrying, as I have written about how to do DNS resolution with Consul forwarding in Ubuntu, and apparently something is wrong with how I do it. Interestingly, the Alpine version works fine, so it appears there is something not quite working with how I am configuring Systemd-resolved.","keywords":["consul","dns","infrastructure"],"articleBody":"I was recently using my Hashibox for a test, and I noticed the DNS resolution didn’t seem to work. This was a bit worrying, as I have written about how to do DNS resolution with Consul forwarding in Ubuntu, and apparently something is wrong with how I do it. Interestingly, the Alpine version works fine, so it appears there is something not quite working with how I am configuring Systemd-resolved.\nSo this post is how I figured out what was wrong, and how to do DNS resolution with Consul forwarding on Ubuntu properly!\nThe Problem If Consul is running on the host, I can only resolve .consul domains, and if Consul is not running, I can resolve anything else. Clearly I have configured something wrong!\nTo summarise, I want to be able to resolve 3 kinds of address:\n*.consul addresses should be handled by the local Consul instance $HOSTNAME.mshome.net should be handled by the Hyper-V DNS server (running on the Host machine) reddit.com public DNS should be resolved properly Discovery To make sure that hostname resolution even works by default, I create a blank Ubuntu box in Hyper-V, using Vagrant.\nVagrant.configure(2) do |config| config.vm.box = \"bento/ubuntu-16.04\" config.vm.hostname = \"test\" end I set the hostname so that I can test that dns resolution works from the host machine to the guest machines too. I next bring up the machine, SSH into it, and try to dig my hostmachine’s DNS name (spectre.mshome.net):\n\u003e vagrant up \u003e vagrant ssh \u003e dig spectre.mshome.net ; \u003c\u003c\u003e\u003e DiG 9.10.3-P4-Ubuntu \u003c\u003c\u003e\u003e spectre.mshome.net ;; global options: +cmd ;; Got answer: ;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 12333 ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0 ;; QUESTION SECTION: ;spectre.mshome.net. IN A ;; ANSWER SECTION: Spectre.mshome.net. 0 IN A 192.168.181.161 ;; Query time: 0 msec ;; SERVER: 192.168.181.161#53(192.168.181.161) ;; WHEN: Mon Sep 23 21:57:26 UTC 2019 ;; MSG SIZE rcvd: 70 \u003e exit \u003e vagrant destroy -f As you can see, the host machine’s DNS server responds with the right address. Now that I know that this should work, we can tweak the Vagrantfile to start an instance of my Hashibox:\nVagrant.configure(2) do |config| config.vm.box = \"pondidum/hashibox\" config.vm.hostname = \"test\" end When I run the same command sin this box, I get a slighty different response:\n; \u003c\u003c\u003e\u003e DiG 9.10.3-P4-Ubuntu \u003c\u003c\u003e\u003e spectre.mshome.net ;; global options: +cmd ;; Got answer: ;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NXDOMAIN, id: 57216 ;; flags: qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ;; QUESTION SECTION: ;spectre.mshome.net. IN A ;; AUTHORITY SECTION: consul. 0 IN SOA ns.consul. hostmaster.consul. 1569276784 3600 600 86400 0 ;; Query time: 1 msec ;; SERVER: 127.0.0.1#53(127.0.0.1) ;; WHEN: Mon Sep 23 22:13:04 UTC 2019 ;; MSG SIZE rcvd: 103 As intended, the DNS server on localhost responded…but it looks like Consul answered, not the inbuilt dns server (systemd-resolved), as I intended.\nThe reason for this is that I am running Consul’s DNS endpoint on 8600, and Systemd-Resolved cannot send requests to anything other than port 53, so I use iptables to redirect the traffic from port 53 to 8600, which means any local use of DNS will always be sent to Consul.\nThe reason it works when Consul is not running is that we have both 127.0.0.1 specified as a nameserver, and a fallback set to be the eth0’s Gateway, so when Consul doesn’t respond, the request hits the default DNS instead.\nThe Solution: Dnsmasq. Basically, stop using systemd-resolved and use something that has a more flexible configuration. Enter Dnsmasq.\nStarting from the blank Ubuntu box, I install dnsmasq, and disable systemd-resolved. Doing this might prevent any DNS resolutio working for a while…\nsudo apt-get install -yq dnsmasq sudo systemctl disable systemd-resolved.service If you would rather not disable systemd-resolved entirely, you can use these two lines instead to just switch off the local DNS stub:\necho \"DNSStubListener=no\" | sudo tee --append /etc/systemd/resolved.conf sudo systemctl restart systemd-resolved Next I update /etc/resolv.conf to not be managed by Systemd, and point to where dnsmasq will be running:\nsudo rm /etc/resolv.conf echo \"nameserver 127.0.0.1\" | sudo tee /etc/resolv.conf The reason for deleting the file is that it was symlinked to the Systemd-Resolved managed file, so that link needed to be broken first to prevent Systemd interfering.\nLastly a minimal configuration for dnsmasq:\necho ' port=53 resolv-file=/var/run/dnsmasq/resolv.conf bind-interfaces listen-address=127.0.0.1 server=/consul/127.0.0.1#8600 ' | sudo tee /etc/dnsmasq.d/default sudo systemctl restart dnsmasq This config does a few things, the two most important lines are:\nresolv-file=/var/run/dnsmasq/resolv.conf which is pointing to the default resolv.conf written by dnsmasq. This file contains the default nameserver supplied by the default network connection, and I want to use this as a fallback for anything dnsmasq cannot resolve directly (which will be everything, except .consul). In my case, the content of this file is just nameserver 192.168.181.161.\nserver=/consul/127.0.0.1#8600 specifies that any address ending in .consul should be forwarded to Consul, running at 127.0.0.1 on port 8600. No more iptables rules!\nTesting Now that I have a (probably) working DNS system, let’s look at testing it properly this time. There are 3 kinds of address I want to test:\nConsul resolution, e.g. consul.service.consul should return the current Consul instance address. Hostname resolution, e.g. spectre.mshome.net should resolve to the machine hosting the VM. Public resolution, e.g. reddit.com should resolve to…reddit. I also want to test that the latter two cases work when Consul is not running too.\nSo let’s write a simple script to make sure these all work. This way I can reuse the same script on other machines, and also with other VM providers to check DNS works as it should. The entire script is here:\nlocal_domain=${1:-mshome.net} host_machine=${2:-spectre} consul agent -dev -client 0.0.0.0 -bind '{{ GetInterfaceIP \"eth0\" }}' \u003e /dev/null \u0026 sleep 1 consul_ip=$(dig consul.service.consul +short) self_ip=$(dig $HOSTNAME.$local_domain +short | tail -n 1) host_ip=$(dig $host_machine.$local_domain +short | tail -n 1) reddit_ip=$(dig reddit.com +short | tail -n 1) kill %1 [ \"$consul_ip\" == \"\" ] \u0026\u0026 echo \"Didn't get consul ip\" \u003e\u00262 \u0026\u0026 exit 1 [ \"$self_ip\" == \"\" ] \u0026\u0026 echo \"Didn't get self ip\" \u003e\u00262 \u0026\u0026 exit 1 [ \"$host_ip\" == \"\" ] \u0026\u0026 echo \"Didn't get host ip\" \u003e\u00262 \u0026\u0026 exit 1 [ \"$reddit_ip\" == \"\" ] \u0026\u0026 echo \"Didn't get reddit ip\" \u003e\u00262 \u0026\u0026 exit 1 echo \"==\u003e Consul Running: Success!\" consul_ip=$(dig consul.service.consul +short | tail -n 1) self_ip=$(dig $HOSTNAME.$local_domain +short | tail -n 1) host_ip=$(dig $host_machine.$local_domain +short | tail -n 1) reddit_ip=$(dig reddit.com +short | tail -n 1) [[ \"$consul_ip\" != *\";; connection timed out;\"* ]] \u0026\u0026 echo \"Got a consul ip ($consul_ip)\" \u003e\u00262 \u0026\u0026 exit 1 [ \"$self_ip\" == \"\" ] \u0026\u0026 echo \"Didn't get self ip\" \u003e\u00262 \u0026\u0026 exit 1 [ \"$host_ip\" == \"\" ] \u0026\u0026 echo \"Didn't get host ip\" \u003e\u00262 \u0026\u0026 exit 1 [ \"$reddit_ip\" == \"\" ] \u0026\u0026 echo \"Didn't get reddit ip\" \u003e\u00262 \u0026\u0026 exit 1 echo \"==\u003e Consul Stopped: Success!\" exit 0 What this does is:\nRead two command line arguments, or use defaults if not specified Start Consul as a background job Query 4 domains, storing the results Stop Consul (kill %1) Check an IP address came back for each domain Query the same 4 domains, storing the results Check that a timeout was received for consul.service.consul Check an IP address came back for the other domains To further prove that dnsmasq is forwarding requests correctly, I can include two more lines to /etc/dnsmasq.d/default to enable logging, and restart dnsmasq\necho \"log-queries\" | sudo tee /etc/dnsmasq.d/default echo \"log-facility=/var/log/dnsmasq.log\" | sudo tee /etc/dnsmasq.d/default sudo systemctl restart dnsmasq dig consul.service.consul Now I can view the log file and check that it received the DNS query and did the right thing. In this case, it recieved the consul.service.consul query, and forwarded it to the local Consul instance:\nSep 24 06:30:50 dnsmasq[13635]: query[A] consul.service.consul from 127.0.0.1 Sep 24 06:30:50 dnsmasq[13635]: forwarded consul.service.consul to 127.0.0.1 Sep 24 06:30:50 dnsmasq[13635]: reply consul.service.consul is 192.168.181.172 I don’t tend to keep DNS logging on in my Hashibox as the log files can grow very quickly.\nWrapping Up Now that I have proven my DNS resolution works (I think), I have rolled it back into my Hashibox, and can now use machine names for setting up clusters, rather than having to specify IP addresses initially.\n","wordCount":"1389","inLanguage":"en","datePublished":"2019-09-24T00:00:00Z","dateModified":"2019-09-24T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2019/09/24/consul-ubuntu-dns-revisited/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Consul DNS Fowarding in Ubuntu, revisited</h1><div class=post-meta><span title='2019-09-24 00:00:00 +0000 UTC'>September 24, 2019</span>&nbsp;·&nbsp;7 min</div></header><div class=post-content><p>I was recently using my <a href=https://github.com/pondidum/hashibox>Hashibox</a> for a test, and I noticed the DNS resolution didn&rsquo;t seem to work. This was a bit worrying, as I have written about how to do <a href=/2019/05/29/consul-dns-forwarding/>DNS resolution with Consul forwarding in Ubuntu</a>, and apparently something is wrong with how I do it. Interestingly, the <a href=/2019/05/31/consul-dns-forwarding-alpine/>Alpine version</a> works fine, so it appears there is something not quite working with how I am configuring Systemd-resolved.</p><p>So this post is how I figured out what was wrong, and how to do DNS resolution with Consul forwarding on Ubuntu properly!</p><h2 id=the-problem>The Problem<a hidden class=anchor aria-hidden=true href=#the-problem>#</a></h2><p>If Consul is running on the host, I can only resolve <code>.consul</code> domains, and if Consul is not running, I can resolve anything else. Clearly I have configured something wrong!</p><p>To summarise, I want to be able to resolve 3 kinds of address:</p><ul><li><code>*.consul</code> addresses should be handled by the local Consul instance</li><li><code>$HOSTNAME.mshome.net</code> should be handled by the Hyper-V DNS server (running on the Host machine)</li><li><code>reddit.com</code> public DNS should be resolved properly</li></ul><h2 id=discovery>Discovery<a hidden class=anchor aria-hidden=true href=#discovery>#</a></h2><p>To make sure that hostname resolution even works by default, I create a blank Ubuntu box in Hyper-V, using <a href=https://www.vagrantup.com/>Vagrant</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Vagrant</span><span style=color:#f92672>.</span>configure(<span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>config<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>box <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bento/ubuntu-16.04&#34;</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>hostname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>I set the hostname so that I can test that dns resolution works from the host machine to the guest machines too. I next bring up the machine, SSH into it, and try to <code>dig</code> my hostmachine&rsquo;s DNS name (<code>spectre.mshome.net</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; vagrant up
</span></span><span style=display:flex><span>&gt; vagrant ssh
</span></span><span style=display:flex><span>&gt; dig spectre.mshome.net
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; spectre.mshome.net
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#e6db74>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#ae81ff>12333</span>
</span></span><span style=display:flex><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;spectre.mshome.net.            IN      A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>Spectre.mshome.net.     <span style=color:#ae81ff>0</span>       IN      A       192.168.181.161
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: <span style=color:#ae81ff>0</span> msec
</span></span><span style=display:flex><span>;; SERVER: 192.168.181.161#53<span style=color:#f92672>(</span>192.168.181.161<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; WHEN: Mon Sep <span style=color:#ae81ff>23</span> 21:57:26 UTC <span style=color:#ae81ff>2019</span>
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: <span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; exit
</span></span><span style=display:flex><span>&gt; vagrant destroy -f
</span></span></code></pre></div><p>As you can see, the host machine&rsquo;s DNS server responds with the right address. Now that I know that this should work, we can tweak the <code>Vagrantfile</code> to start an instance of my Hashibox:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Vagrant</span><span style=color:#f92672>.</span>configure(<span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>config<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>box <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pondidum/hashibox&#34;</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>hostname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>When I run the same command sin this box, I get a slighty different response:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; spectre.mshome.net
</span></span><span style=display:flex><span>;; global options: +cmd
</span></span><span style=display:flex><span>;; Got answer:
</span></span><span style=display:flex><span>;; -&gt;&gt;HEADER<span style=color:#e6db74>&lt;&lt;- opco</span>de: QUERY, status: NXDOMAIN, id: <span style=color:#ae81ff>57216</span>
</span></span><span style=display:flex><span>;; flags: qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>;; WARNING: recursion requested but not available
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; OPT PSEUDOSECTION:
</span></span><span style=display:flex><span>; EDNS: version: 0, flags:; udp: <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span>;; QUESTION SECTION:
</span></span><span style=display:flex><span>;spectre.mshome.net.            IN      A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; AUTHORITY SECTION:
</span></span><span style=display:flex><span>consul.                 <span style=color:#ae81ff>0</span>       IN      SOA     ns.consul. hostmaster.consul. <span style=color:#ae81ff>1569276784</span> <span style=color:#ae81ff>3600</span> <span style=color:#ae81ff>600</span> <span style=color:#ae81ff>86400</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>;; Query time: <span style=color:#ae81ff>1</span> msec
</span></span><span style=display:flex><span>;; SERVER: 127.0.0.1#53<span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>;; WHEN: Mon Sep <span style=color:#ae81ff>23</span> 22:13:04 UTC <span style=color:#ae81ff>2019</span>
</span></span><span style=display:flex><span>;; MSG SIZE  rcvd: <span style=color:#ae81ff>103</span>
</span></span></code></pre></div><p>As intended, the DNS server on localhost responded&mldr;but it looks like Consul answered, not the inbuilt dns server (<code>systemd-resolved</code>), as I intended.</p><p>The reason for this is that I am running Consul&rsquo;s DNS endpoint on <code>8600</code>, and Systemd-Resolved cannot send requests to anything other than port <code>53</code>, so I use <code>iptables</code> to redirect the traffic from port <code>53</code> to <code>8600</code>, which means any local use of DNS will always be sent to Consul.</p><p>The reason it works when Consul is not running is that we have both <code>127.0.0.1</code> specified as a nameserver, and a fallback set to be the <code>eth0</code>&rsquo;s Gateway, so when Consul doesn&rsquo;t respond, the request hits the default DNS instead.</p><h2 id=the-solution-dnsmasq>The Solution: Dnsmasq.<a hidden class=anchor aria-hidden=true href=#the-solution-dnsmasq>#</a></h2><p>Basically, stop using <code>systemd-resolved</code> and use something that has a more flexible configuration. Enter Dnsmasq.</p><p>Starting from the blank Ubuntu box, I install dnsmasq, and disable systemd-resolved. Doing this might prevent any DNS resolutio working for a while&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get install -yq dnsmasq
</span></span><span style=display:flex><span>sudo systemctl disable systemd-resolved.service
</span></span></code></pre></div><p>If you would rather not disable <code>systemd-resolved</code> entirely, you can use these two lines instead to just switch off the local DNS stub:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;DNSStubListener=no&#34;</span> | sudo tee --append /etc/systemd/resolved.conf
</span></span><span style=display:flex><span>sudo systemctl restart systemd-resolved
</span></span></code></pre></div><p>Next I update <code>/etc/resolv.conf</code> to not be managed by Systemd, and point to where dnsmasq will be running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo rm /etc/resolv.conf
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;nameserver 127.0.0.1&#34;</span> | sudo tee /etc/resolv.conf
</span></span></code></pre></div><p>The reason for deleting the file is that it was symlinked to the Systemd-Resolved managed file, so that link needed to be broken first to prevent Systemd interfering.</p><p>Lastly a minimal configuration for dnsmasq:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>port=53
</span></span></span><span style=display:flex><span><span style=color:#e6db74>resolv-file=/var/run/dnsmasq/resolv.conf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>bind-interfaces
</span></span></span><span style=display:flex><span><span style=color:#e6db74>listen-address=127.0.0.1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>server=/consul/127.0.0.1#8600
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;</span> | sudo tee /etc/dnsmasq.d/default
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl restart dnsmasq
</span></span></code></pre></div><p>This config does a few things, the two most important lines are:</p><ul><li><p><code>resolv-file=/var/run/dnsmasq/resolv.conf</code> which is pointing to the default <code>resolv.conf</code> written by dnsmasq. This file contains the default nameserver supplied by the default network connection, and I want to use this as a fallback for anything dnsmasq cannot resolve directly (which will be everything, except <code>.consul</code>). In my case, the content of this file is just <code>nameserver 192.168.181.161</code>.</p></li><li><p><code>server=/consul/127.0.0.1#8600</code> specifies that any address ending in <code>.consul</code> should be forwarded to Consul, running at <code>127.0.0.1</code> on port <code>8600</code>. No more <code>iptables</code> rules!</p></li></ul><h2 id=testing>Testing<a hidden class=anchor aria-hidden=true href=#testing>#</a></h2><p>Now that I have a (probably) working DNS system, let&rsquo;s look at testing it properly this time. There are 3 kinds of address I want to test:</p><ul><li>Consul resolution, e.g. <code>consul.service.consul</code> should return the current Consul instance address.</li><li>Hostname resolution, e.g. <code>spectre.mshome.net</code> should resolve to the machine hosting the VM.</li><li>Public resolution, e.g. <code>reddit.com</code> should resolve to&mldr;reddit.</li></ul><p>I also want to test that the latter two cases work when Consul is <strong>not</strong> running too.</p><p>So let&rsquo;s write a simple script to make sure these all work. This way I can reuse the same script on other machines, and also with other VM providers to check DNS works as it should. The entire script is here:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>local_domain<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>1<span style=color:#66d9ef>:-</span>mshome.net<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>host_machine<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>2<span style=color:#66d9ef>:-</span>spectre<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>consul agent -dev -client 0.0.0.0 -bind <span style=color:#e6db74>&#39;{{ GetInterfaceIP &#34;eth0&#34; }}&#39;</span> &gt; /dev/null &amp;
</span></span><span style=display:flex><span>sleep <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>consul_ip<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>dig consul.service.consul +short<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>self_ip<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>dig $HOSTNAME.$local_domain +short | tail -n 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>host_ip<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>dig $host_machine.$local_domain +short | tail -n 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>reddit_ip<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>dig reddit.com +short | tail -n 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kill %1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$consul_ip<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;Didn&#39;t get consul ip&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$self_ip<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;Didn&#39;t get self ip&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$host_ip<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;Didn&#39;t get host ip&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$reddit_ip<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;Didn&#39;t get reddit ip&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;==&gt; Consul Running: Success!&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>consul_ip<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>dig consul.service.consul +short | tail -n 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>self_ip<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>dig $HOSTNAME.$local_domain +short | tail -n 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>host_ip<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>dig $host_machine.$local_domain +short | tail -n 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>reddit_ip<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>dig reddit.com +short | tail -n 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[[</span> <span style=color:#e6db74>&#34;</span>$consul_ip<span style=color:#e6db74>&#34;</span> !<span style=color:#f92672>=</span> *<span style=color:#e6db74>&#34;;; connection timed out;&#34;</span>* <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;Got a consul ip (</span>$consul_ip<span style=color:#e6db74>)&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$self_ip<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;Didn&#39;t get self ip&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$host_ip<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;Didn&#39;t get host ip&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$reddit_ip<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;Didn&#39;t get reddit ip&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;==&gt; Consul Stopped: Success!&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exit <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>What this does is:</p><ol><li>Read two command line arguments, or use defaults if not specified</li><li>Start Consul as a background job</li><li>Query 4 domains, storing the results</li><li>Stop Consul (<code>kill %1</code>)</li><li>Check an IP address came back for each domain</li><li>Query the same 4 domains, storing the results</li><li>Check that a timeout was received for <code>consul.service.consul</code></li><li>Check an IP address came back for the other domains</li></ol><p>To further prove that dnsmasq is forwarding requests correctly, I can include two more lines to <code>/etc/dnsmasq.d/default</code> to enable logging, and restart dnsmasq</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;log-queries&#34;</span> | sudo tee /etc/dnsmasq.d/default
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;log-facility=/var/log/dnsmasq.log&#34;</span> | sudo tee /etc/dnsmasq.d/default
</span></span><span style=display:flex><span>sudo systemctl restart dnsmasq
</span></span><span style=display:flex><span>dig consul.service.consul
</span></span></code></pre></div><p>Now I can view the log file and check that it received the DNS query and did the right thing. In this case, it recieved the <code>consul.service.consul</code> query, and forwarded it to the local Consul instance:</p><pre tabindex=0><code>Sep 24 06:30:50 dnsmasq[13635]: query[A] consul.service.consul from 127.0.0.1
Sep 24 06:30:50 dnsmasq[13635]: forwarded consul.service.consul to 127.0.0.1
Sep 24 06:30:50 dnsmasq[13635]: reply consul.service.consul is 192.168.181.172
</code></pre><p>I don&rsquo;t tend to keep DNS logging on in my Hashibox as the log files can grow very quickly.</p><h2 id=wrapping-up>Wrapping Up<a hidden class=anchor aria-hidden=true href=#wrapping-up>#</a></h2><p>Now that I have proven my DNS resolution works (I think), I have rolled it back into my Hashibox, and can now use machine names for setting up clusters, rather than having to specify IP addresses initially.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/consul/>consul</a></li><li><a href=https://andydote.co.uk/tags/dns/>dns</a></li><li><a href=https://andydote.co.uk/tags/infrastructure/>infrastructure</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2019/10/06/vault-consul-bootstrap/><span class=title>« Prev Page</span><br><span>Creating a Vault instance with a TLS Consul Cluster</span></a>
<a class=next href=https://andydote.co.uk/2019/09/14/consul-tls-cluster/><span class=title>Next Page »</span><br><span>Creating a TLS enabled Consul cluster</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>