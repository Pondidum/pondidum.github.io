<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Configuring Consul DNS Forwarding in Alpine Linux | Andy Dote</title><meta name=keywords content="infrastructure,consul,alpine,dns"><meta name=description content="DEPRECATED - This has a race condition! Please see this post for an updated version which works!
Following on from the post the other day on setting up DNS forwarding to Consul with SystemD, I wanted also to show how to get Consul up and running under Alpine Linux, as it&rsquo;s a little more awkward in some respects.
To start with, I am going to setup Consul as a service - I didn&rsquo;t do this in the Ubuntu version, as there are plenty of useful articles about that already, but that is not the case with Alpine."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2019/05/31/consul-dns-forwarding-alpine/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Configuring Consul DNS Forwarding in Alpine Linux"><meta property="og:description" content="DEPRECATED - This has a race condition! Please see this post for an updated version which works!
Following on from the post the other day on setting up DNS forwarding to Consul with SystemD, I wanted also to show how to get Consul up and running under Alpine Linux, as it&rsquo;s a little more awkward in some respects.
To start with, I am going to setup Consul as a service - I didn&rsquo;t do this in the Ubuntu version, as there are plenty of useful articles about that already, but that is not the case with Alpine."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2019/05/31/consul-dns-forwarding-alpine/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-05-31T00:00:00+00:00"><meta property="article:modified_time" content="2019-05-31T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Configuring Consul DNS Forwarding in Alpine Linux"><meta name=twitter:description content="DEPRECATED - This has a race condition! Please see this post for an updated version which works!
Following on from the post the other day on setting up DNS forwarding to Consul with SystemD, I wanted also to show how to get Consul up and running under Alpine Linux, as it&rsquo;s a little more awkward in some respects.
To start with, I am going to setup Consul as a service - I didn&rsquo;t do this in the Ubuntu version, as there are plenty of useful articles about that already, but that is not the case with Alpine."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Configuring Consul DNS Forwarding in Alpine Linux","item":"https://andydote.co.uk/2019/05/31/consul-dns-forwarding-alpine/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Configuring Consul DNS Forwarding in Alpine Linux","name":"Configuring Consul DNS Forwarding in Alpine Linux","description":"DEPRECATED - This has a race condition! Please see this post for an updated version which works!\nFollowing on from the post the other day on setting up DNS forwarding to Consul with SystemD, I wanted also to show how to get Consul up and running under Alpine Linux, as it\u0026rsquo;s a little more awkward in some respects.\nTo start with, I am going to setup Consul as a service - I didn\u0026rsquo;t do this in the Ubuntu version, as there are plenty of useful articles about that already, but that is not the case with Alpine.","keywords":["infrastructure","consul","alpine","dns"],"articleBody":"DEPRECATED - This has a race condition! Please see this post for an updated version which works!\nFollowing on from the post the other day on setting up DNS forwarding to Consul with SystemD, I wanted also to show how to get Consul up and running under Alpine Linux, as it’s a little more awkward in some respects.\nTo start with, I am going to setup Consul as a service - I didn’t do this in the Ubuntu version, as there are plenty of useful articles about that already, but that is not the case with Alpine.\nRun Consul First, we need to get a version of Consul and install it into our system. This script downloads 1.5.1 from Hashicorp’s releases site, installs it to /usr/bin/consul, and creates a consul user and group to run the daemon with:\nCONSUL_VERSION=1.5.1 curl -sSL https://releases.hashicorp.com/consul/${CONSUL_VERSION}/consul_${CONSUL_VERSION}_linux_amd64.zip -o /tmp/consul.zip unzip /tmp/consul.zip sudo install consul /usr/bin/consul sudo addgroup -S consul sudo adduser -S -D -h /var/consul -s /sbin/nologin -G consul -g consul consul Next, we need to create the directories for the configuration and data to live in, and copy the init script and configuration file to those directories:\nconsul_dir=/etc/consul data_dir=/srv/consul sudo mkdir $consul_dir sudo mkdir $data_dir sudo chown consul:consul $data_dir sudo mv /tmp/consul.sh /etc/init.d/consul sudo chmod +x /etc/init.d/consul sudo mv /tmp/consul.json $consul_dir/consul.json The init script is pretty straight forward, but note that I am running the agent in this example in dev mode; don’t do this in production:\n#!/sbin/openrc-run CONSUL_LOG_FILE=\"/var/log/${SVCNAME}.log\" name=consul description=\"A tool for service discovery, monitoring and configuration\" description_checkconfig=\"Verify configuration file\" daemon=/usr/bin/$name daemon_user=$name daemon_group=$name consul_dir=/etc/consul extra_commands=\"checkconfig\" start_pre() { checkpath -f -m 0644 -o ${SVCNAME}:${SVCNAME} \"$CONSUL_LOG_FILE\" } depend() { need net after firewall } checkconfig() { consul validate $consul_dir } start() { checkconfig || return 1 ebegin \"Starting ${name}\" start-stop-daemon --start --quiet \\ -m --pidfile /var/run/${name}.pid \\ --user ${daemon_user} --group ${daemon_group} \\ -b --stdout $CONSUL_LOG_FILE --stderr $CONSUL_LOG_FILE \\ -k 027 --exec ${daemon} -- agent -dev -config-dir=$consul_dir eend $? } stop() { ebegin \"Stopping ${name}\" start-stop-daemon --stop --quiet \\ --pidfile /var/run/${name}.pid \\ --exec ${daemon} eend $? } Finally, a basic config file to launch consul is as follows:\n{ \"data_dir\": \"/srv/consul/data\", \"client_addr\": \"0.0.0.0\" } Now that all our scripts are in place, we can register Consul into the service manager, and start it:\nsudo rc-update add consul sudo rc-service consul start You can check consul is up and running by using dig to get the address of the consul service itself:\ndig @localhost -p 8600 consul.service.consul Setup Local DNS with Unbound Now that Consul is running, we need to configure a local DNS resolver to forward requests for the .consul domain to Consul. We will use Unbound as it works nicely on Alpine. It also has the wonderful feature of being able to send queries to a specific port, so no iptables rules needed this time!\nThe config file (/etc/unbound/unbound.conf) is all default values, with the exception of the last 5 lines, which let us forward DNS requests to a custom, and insecure, location:\n#! /bin/bash sudo apk add unbound ( cat \u003c\u003c-EOF server: verbosity: 1 root-hints: /etc/unbound/root.hints trust-anchor-file: \"/usr/share/dnssec-root/trusted-key.key\" do-not-query-localhost: no domain-insecure: \"consul\" stub-zone: name: \"consul\" stub-addr: 127.0.0.1@8600 EOF ) | sudo tee /etc/unbound/unbound.conf sudo rc-update add unbound sudo rc-service unbound start We can validate this works again by using dig, but this time removing the port specification to hit 53 instead:\ndig @localhost consul.service.consul Configure DNS Resolution Finally, we need to update /etc/resolv.conf so that other system tools such as ping and curl can resolve .consul addresses. This is a little more hassle on Alpine, as there are no head files we can push our nameserver entry into. Instead, we use dhclient which will let us prepend a custom nameserver (or multiple) when the interface is brought up, even when using DHCP:\n#! /bin/bash sudo apk add dhclient ( cat \u003c\u003c-EOF option rfc3442-classless-static-routes code 121 = array of unsigned integer 8; send host-name = gethostname(); request subnet-mask, broadcast-address, time-offset, routers, domain-name, domain-name-servers, domain-search, host-name, dhcp6.name-servers, dhcp6.domain-search, dhcp6.fqdn, dhcp6.sntp-servers, netbios-name-servers, netbios-scope, interface-mtu, rfc3442-classless-static-routes, ntp-servers; prepend domain-name-servers 127.0.0.1; EOF ) | sudo tee /etc/dhcp/dhclient.conf sudo rm /etc/resolv.conf # hack due to it dhclient making an invalid `chown` call. sudo rc-service networking restart The only thing of interest here is the little hack: we delete the /etc/resolv.conf before restarting the networking service, as if you don’t do this, you get errors about “chmod invalid option resource=…”.\nWe can varify everything works in the same way we did on Ubuntu; curl to both a .consul and a public address:\n$ curl -s -o /dev/null -w \"%{http_code}\\n\" http://consul.service.consul:8500/ui/ 200 $ curl -s -o /dev/null -w \"%{http_code}\\n\" http://google.com 301 End This was a bit easier to get started with than the Ubuntu version as I knew what I was trying to accomplish this time - however making a good init.d script was a bit more hassle, and the error from chmod took some time to track down.\n","wordCount":"817","inLanguage":"en","datePublished":"2019-05-31T00:00:00Z","dateModified":"2019-05-31T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2019/05/31/consul-dns-forwarding-alpine/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Configuring Consul DNS Forwarding in Alpine Linux</h1><div class=post-meta><span title='2019-05-31 00:00:00 +0000 UTC'>May 31, 2019</span>&nbsp;·&nbsp;4 min</div></header><div class=post-content><h1 id=deprecated---this-has-a-race-condition>DEPRECATED - This has a race condition!<a hidden class=anchor aria-hidden=true href=#deprecated---this-has-a-race-condition>#</a></h1><p><a href=/2019/12/30/consul-alpine-dns-revisited/>Please see this post for an updated version which works!</a></p><p>Following on from the post the other day on setting up <a href=/2019/05/29/consul-dns-forwarding/>DNS forwarding to Consul with SystemD</a>, I wanted also to show how to get Consul up and running under <a href=https://www.alpinelinux.org/>Alpine Linux</a>, as it&rsquo;s a little more awkward in some respects.</p><p>To start with, I am going to setup Consul as a service - I didn&rsquo;t do this in the Ubuntu version, as there are plenty of useful articles about that already, but that is not the case with Alpine.</p><h2 id=run-consul>Run Consul<a hidden class=anchor aria-hidden=true href=#run-consul>#</a></h2><p>First, we need to get a version of Consul and install it into our system. This script downloads <code>1.5.1</code> from Hashicorp&rsquo;s releases site, installs it to <code>/usr/bin/consul</code>, and creates a <code>consul</code> user and group to run the daemon with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>CONSUL_VERSION<span style=color:#f92672>=</span>1.5.1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -sSL https://releases.hashicorp.com/consul/<span style=color:#e6db74>${</span>CONSUL_VERSION<span style=color:#e6db74>}</span>/consul_<span style=color:#e6db74>${</span>CONSUL_VERSION<span style=color:#e6db74>}</span>_linux_amd64.zip -o /tmp/consul.zip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>unzip /tmp/consul.zip
</span></span><span style=display:flex><span>sudo install consul /usr/bin/consul
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo addgroup -S consul
</span></span><span style=display:flex><span>sudo adduser -S -D -h /var/consul -s /sbin/nologin -G consul -g consul consul
</span></span></code></pre></div><p>Next, we need to create the directories for the configuration and data to live in, and copy the init script and configuration file to those directories:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>consul_dir<span style=color:#f92672>=</span>/etc/consul
</span></span><span style=display:flex><span>data_dir<span style=color:#f92672>=</span>/srv/consul
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo mkdir $consul_dir
</span></span><span style=display:flex><span>sudo mkdir $data_dir
</span></span><span style=display:flex><span>sudo chown consul:consul $data_dir
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo mv /tmp/consul.sh /etc/init.d/consul
</span></span><span style=display:flex><span>sudo chmod +x /etc/init.d/consul
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo mv /tmp/consul.json $consul_dir/consul.json
</span></span></code></pre></div><p>The init script is pretty straight forward, but note that I am running the agent in this example in <code>dev</code> mode; <strong>don&rsquo;t do this in production</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/sbin/openrc-run
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>CONSUL_LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/var/log/</span><span style=color:#e6db74>${</span>SVCNAME<span style=color:#e6db74>}</span><span style=color:#e6db74>.log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>name<span style=color:#f92672>=</span>consul
</span></span><span style=display:flex><span>description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;A tool for service discovery, monitoring and configuration&#34;</span>
</span></span><span style=display:flex><span>description_checkconfig<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Verify configuration file&#34;</span>
</span></span><span style=display:flex><span>daemon<span style=color:#f92672>=</span>/usr/bin/$name
</span></span><span style=display:flex><span>daemon_user<span style=color:#f92672>=</span>$name
</span></span><span style=display:flex><span>daemon_group<span style=color:#f92672>=</span>$name
</span></span><span style=display:flex><span>consul_dir<span style=color:#f92672>=</span>/etc/consul
</span></span><span style=display:flex><span>extra_commands<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;checkconfig&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>start_pre<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    checkpath -f -m <span style=color:#ae81ff>0644</span> -o <span style=color:#e6db74>${</span>SVCNAME<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>SVCNAME<span style=color:#e6db74>}</span> <span style=color:#e6db74>&#34;</span>$CONSUL_LOG_FILE<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>depend<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    need net
</span></span><span style=display:flex><span>    after firewall
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>checkconfig<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    consul validate $consul_dir
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>start<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    checkconfig <span style=color:#f92672>||</span> <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ebegin <span style=color:#e6db74>&#34;Starting </span><span style=color:#e6db74>${</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        start-stop-daemon --start --quiet <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -m --pidfile /var/run/<span style=color:#e6db74>${</span>name<span style=color:#e6db74>}</span>.pid <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --user <span style=color:#e6db74>${</span>daemon_user<span style=color:#e6db74>}</span> --group <span style=color:#e6db74>${</span>daemon_group<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -b --stdout $CONSUL_LOG_FILE --stderr $CONSUL_LOG_FILE <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            -k <span style=color:#ae81ff>027</span> --exec <span style=color:#e6db74>${</span>daemon<span style=color:#e6db74>}</span> -- agent -dev -config-dir<span style=color:#f92672>=</span>$consul_dir
</span></span><span style=display:flex><span>    eend $?
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>stop<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ebegin <span style=color:#e6db74>&#34;Stopping </span><span style=color:#e6db74>${</span>name<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        start-stop-daemon --stop --quiet <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --pidfile /var/run/<span style=color:#e6db74>${</span>name<span style=color:#e6db74>}</span>.pid <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>            --exec <span style=color:#e6db74>${</span>daemon<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>    eend $?
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Finally, a basic config file to launch consul is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;data_dir&#34;</span>: <span style=color:#e6db74>&#34;/srv/consul/data&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;client_addr&#34;</span>: <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now that all our scripts are in place, we can register Consul into the service manager, and start it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo rc-update add consul
</span></span><span style=display:flex><span>sudo rc-service consul start
</span></span></code></pre></div><p>You can check consul is up and running by using <code>dig</code> to get the address of the consul service itself:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dig @localhost -p <span style=color:#ae81ff>8600</span> consul.service.consul
</span></span></code></pre></div><h2 id=setup-local-dns-with-unbound>Setup Local DNS with Unbound<a hidden class=anchor aria-hidden=true href=#setup-local-dns-with-unbound>#</a></h2><p>Now that Consul is running, we need to configure a local DNS resolver to forward requests for the <code>.consul</code> domain to Consul. We will use <a href=https://nlnetlabs.nl/projects/unbound/about/>Unbound</a> as it works nicely on Alpine. It also has the wonderful feature of being able to send queries to a specific port, so no <code>iptables</code> rules needed this time!</p><p>The config file (<code>/etc/unbound/unbound.conf</code>) is all default values, with the exception of the last 5 lines, which let us forward DNS requests to a custom, and insecure, location:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#! /bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>sudo apk add unbound
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;-EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>server:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    verbosity: 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    root-hints: /etc/unbound/root.hints
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    trust-anchor-file: &#34;/usr/share/dnssec-root/trusted-key.key&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    do-not-query-localhost: no
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    domain-insecure: &#34;consul&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>stub-zone:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    name: &#34;consul&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    stub-addr: 127.0.0.1@8600
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span> | sudo tee /etc/unbound/unbound.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo rc-update add unbound
</span></span><span style=display:flex><span>sudo rc-service unbound start
</span></span></code></pre></div><p>We can validate this works again by using <code>dig</code>, but this time removing the port specification to hit <code>53</code> instead:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dig @localhost consul.service.consul
</span></span></code></pre></div><h2 id=configure-dns-resolution>Configure DNS Resolution<a hidden class=anchor aria-hidden=true href=#configure-dns-resolution>#</a></h2><p>Finally, we need to update <code>/etc/resolv.conf</code> so that other system tools such as <code>ping</code> and <code>curl</code> can resolve <code>.consul</code> addresses. This is a little more hassle on Alpine, as there are no <code>head</code> files we can push our nameserver entry into. Instead, we use <code>dhclient</code> which will let us prepend a custom nameserver (or multiple) when the interface is brought up, even when using DHCP:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#! /bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>sudo apk add dhclient
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;-EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>option rfc3442-classless-static-routes code 121 = array of unsigned integer 8;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>send host-name = gethostname();
</span></span></span><span style=display:flex><span><span style=color:#e6db74>request subnet-mask, broadcast-address, time-offset, routers,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        domain-name, domain-name-servers, domain-search, host-name,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        dhcp6.name-servers, dhcp6.domain-search, dhcp6.fqdn, dhcp6.sntp-servers,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        netbios-name-servers, netbios-scope, interface-mtu,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        rfc3442-classless-static-routes, ntp-servers;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>prepend domain-name-servers 127.0.0.1;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span> | sudo tee /etc/dhcp/dhclient.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo rm /etc/resolv.conf <span style=color:#75715e># hack due to it dhclient making an invalid `chown` call.</span>
</span></span><span style=display:flex><span>sudo rc-service networking restart
</span></span></code></pre></div><p>The only thing of interest here is the little hack: we delete the <code>/etc/resolv.conf</code> before restarting the networking service, as if you don&rsquo;t do this, you get errors about &ldquo;chmod invalid option resource=&mldr;&rdquo;.</p><p>We can varify everything works in the same way we did on Ubuntu; <code>curl</code> to both a <code>.consul</code> and a public address:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s -o /dev/null -w <span style=color:#e6db74>&#34;%{http_code}\n&#34;</span> http://consul.service.consul:8500/ui/
</span></span><span style=display:flex><span><span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ curl -s -o /dev/null -w <span style=color:#e6db74>&#34;%{http_code}\n&#34;</span> http://google.com
</span></span><span style=display:flex><span><span style=color:#ae81ff>301</span>
</span></span></code></pre></div><h2 id=end>End<a hidden class=anchor aria-hidden=true href=#end>#</a></h2><p>This was a bit easier to get started with than the Ubuntu version as I knew what I was trying to accomplish this time - however making a good <code>init.d</code> script was a bit more hassle, and the error from <code>chmod</code> took some time to track down.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/infrastructure/>infrastructure</a></li><li><a href=https://andydote.co.uk/tags/consul/>consul</a></li><li><a href=https://andydote.co.uk/tags/alpine/>alpine</a></li><li><a href=https://andydote.co.uk/tags/dns/>dns</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2019/06/03/feature-toggles-branch-by-abstraction/><span class=title>« Prev Page</span><br><span>Feature Toggles: Branch by Abstraction</span></a>
<a class=next href=https://andydote.co.uk/2019/05/29/consul-dns-forwarding/><span class=title>Next Page »</span><br><span>Configuring Consul DNS Forwarding in Ubuntu 16.04</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>