<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Configuring Consul DNS Forwarding in Ubuntu 16.04 | Andy Dote</title><meta name=keywords content="infrastructure,dns,consul"><meta name=description content="DEPRECATED - This doesn&rsquo;t work properly Please see this post for an updated version which works!
One of the advantages of using Consul for service discovery is that besides an HTTP API, you can also query it by DNS.
The DNS server is listening on port 8600 by default, and you can query both A records or SRV records from it. SRV records are useful as they contain additional properties (priority, weight and port), and you can get multiple records back from a single query, letting you do load balancing client side:"><meta name=author content><link rel=canonical href=https://andydote.co.uk/2019/05/29/consul-dns-forwarding/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d3aaf8cdcec9a6487824ab95cadf08232ec362e7ba510c6b742973d16ef5b72e.css integrity="sha256-06r4zc7Jpkh4JKuVyt8IIy7DYue6UQxrdClz0W71ty4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/js/tabs.min.2d019e9ee3574770ad4ecfd4f5f794739892195cb82a4e6383252b9074ab520c.js integrity="sha256-LQGenuNXR3CtTs/U9feUc5iSGVy4Kk5jgyUrkHSrUgw="></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Configuring Consul DNS Forwarding in Ubuntu 16.04"><meta property="og:description" content="DEPRECATED - This doesn&rsquo;t work properly Please see this post for an updated version which works!
One of the advantages of using Consul for service discovery is that besides an HTTP API, you can also query it by DNS.
The DNS server is listening on port 8600 by default, and you can query both A records or SRV records from it. SRV records are useful as they contain additional properties (priority, weight and port), and you can get multiple records back from a single query, letting you do load balancing client side:"><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2019/05/29/consul-dns-forwarding/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-05-29T00:00:00+00:00"><meta property="article:modified_time" content="2019-05-29T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Configuring Consul DNS Forwarding in Ubuntu 16.04"><meta name=twitter:description content="DEPRECATED - This doesn&rsquo;t work properly Please see this post for an updated version which works!
One of the advantages of using Consul for service discovery is that besides an HTTP API, you can also query it by DNS.
The DNS server is listening on port 8600 by default, and you can query both A records or SRV records from it. SRV records are useful as they contain additional properties (priority, weight and port), and you can get multiple records back from a single query, letting you do load balancing client side:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Configuring Consul DNS Forwarding in Ubuntu 16.04","item":"https://andydote.co.uk/2019/05/29/consul-dns-forwarding/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Configuring Consul DNS Forwarding in Ubuntu 16.04","name":"Configuring Consul DNS Forwarding in Ubuntu 16.04","description":"DEPRECATED - This doesn\u0026rsquo;t work properly Please see this post for an updated version which works!\nOne of the advantages of using Consul for service discovery is that besides an HTTP API, you can also query it by DNS.\nThe DNS server is listening on port 8600 by default, and you can query both A records or SRV records from it. SRV records are useful as they contain additional properties (priority, weight and port), and you can get multiple records back from a single query, letting you do load balancing client side:","keywords":["infrastructure","dns","consul"],"articleBody":"DEPRECATED - This doesn’t work properly Please see this post for an updated version which works!\nOne of the advantages of using Consul for service discovery is that besides an HTTP API, you can also query it by DNS.\nThe DNS server is listening on port 8600 by default, and you can query both A records or SRV records from it. SRV records are useful as they contain additional properties (priority, weight and port), and you can get multiple records back from a single query, letting you do load balancing client side:\n$ dig @localhost -p 8600 consul.service.consul SRV +short 1 10 8300 vagrant1.node.dc1.consul. 1 14 8300 vagrant2.node.dc1.consul. 2 100 8300 vagrant3.node.dc1.consul. A Records are also useful, as it means we should be able to treat services registered to Consul like any other domain - but it doesn’t work:\n$ curl http://consul.service.consul:8500 curl: (6) Could not resolve host: consul.service.consul The reason for this is that the system’s built-in DNS resolver doesn’t know how to query Consul. We can, however, configure it to forward any *.consul requests to Consul.\nSolution - Forward DNS queries to Consul As I usually target Ubuntu based machines, this means configuring systemd-resolved to forward to Consul. However, we want to keep Consul listening on it’s default port (8600), and systemd-resolved can only forward requests to port 53, so we need also to configure iptables to redirect the requests.\nThe steps are as follows:\nConfigure systemd-resolved to forward .consul TLD queries to the local consul agent Configure iptables to redirect 53 to 8600 So let’s get to it!\n1. Make iptables persistent IPTables configuration changes don’t persist through reboots, so the easiest way to solve this is with the iptables-persistent package.\nTypically I am scripting machines (using [Packer] or [Vagrant]), so I configure the install to be non-interactive:\necho iptables-persistent iptables-persistent/autosave_v4 boolean false | sudo debconf-set-selections echo iptables-persistent iptables-persistent/autosave_v6 boolean false | sudo debconf-set-selections sudo DEBIAN_FRONTEND=noninteractive apt install -yq iptables-persistent 2. Update Systemd-Resolved The file to change is /etc/systemd/resolved.conf. By default it looks like this:\n[Resolve] #DNS= #FallbackDNS=8.8.8.8 8.8.4.4 2001:4860:4860::8888 2001:4860:4860::8844 #Domains= #LLMNR=yes #DNSSEC=no We need to change the DNS and Domains lines - either editing the file by hand, or scripting a replacement with sed:\nsudo sed -i 's/#DNS=/DNS=127.0.0.1/g; s/#Domains=/Domains=~consul/g' /etc/systemd/resolved.conf The result of which is the file now reading like this:\n[Resolve] DNS=127.0.0.1 #FallbackDNS=8.8.8.8 8.8.4.4 2001:4860:4860::8888 2001:4860:4860::8844 Domains=~consul #LLMNR=yes #DNSSEC=no By specifying the Domains as ~consul, we are telling resolvd to forward requests for the consul TLD to the server specified in the DNS line.\n3. Configure Resolvconf too For compatibility with some applications (e.g. curl and ping), we also need to update /etc/resolv.conf to specify our local nameserver. You do this not by editing the file directly!\nInstead, we need to add nameserver 127.0.0.1 to /etc/resolvconf/resolv.conf.d/head. Again, I will script this, and as we need sudo to write to the file, the easiest way is to use tee to append the line and then run resolvconf -u to apply the change:\necho \"nameserver 127.0.0.1\" | sudo tee --append /etc/resolvconf/resolv.conf.d/head sudo resolvconf -u Configure iptables Finally, we need to configure iptables so that when systemd-resolved sends a DNS query to localhost on port 53, it gets redirected to port 8600. We’ll do this for both TCP and UDP requests, and then use netfilter-persistent to make the rules persistent:\nsudo iptables -t nat -A OUTPUT -d localhost -p udp -m udp --dport 53 -j REDIRECT --to-ports 8600 sudo iptables -t nat -A OUTPUT -d localhost -p tcp -m tcp --dport 53 -j REDIRECT --to-ports 8600 sudo netfilter-persistent save Verification First, we can test that both Consul and Systemd-Resolved return an address for a consul service:\n$ dig @localhost -p 8600 consul.service.consul +short 10.0.2.15 $ dig @localhost consul.service.consul +short 10.0.2.15 And now we can try using curl to verify that we can resolve consul domains and normal domains still:\n$ curl -s -o /dev/null -w \"%{http_code}\\n\" http://consul.service.consul:8500/ui/ 200 $ curl -s -o /dev/null -w \"%{http_code}\\n\" http://google.com 301 End There are also guides available on how to do this on Hashicorp’s website, covering other DNS resolvers too (such as BIND, Dnsmasq, Unbound).\n","wordCount":"684","inLanguage":"en","datePublished":"2019-05-29T00:00:00Z","dateModified":"2019-05-29T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2019/05/29/consul-dns-forwarding/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Configuring Consul DNS Forwarding in Ubuntu 16.04</h1><div class=post-meta><span title='2019-05-29 00:00:00 +0000 UTC'>May 29, 2019</span>&nbsp;·&nbsp;4 min</div></header><div class=post-content><h1 id=deprecated---this-doesnt-work-properly>DEPRECATED - This doesn&rsquo;t work properly<a hidden class=anchor aria-hidden=true href=#deprecated---this-doesnt-work-properly>#</a></h1><p><a href=/2019/09/24/consul-ubuntu-dns-revisited/>Please see this post for an updated version which works!</a></p><hr><p>One of the advantages of using <a href=https://www.consul.io/>Consul</a> for service discovery is that besides an HTTP API, you can also query it by DNS.</p><p>The DNS server is listening on port <code>8600</code> by default, and you can query both A records or SRV records from it. <a href=https://en.wikipedia.org/wiki/SRV_record>SRV</a> records are useful as they contain additional properties (<code>priority</code>, <code>weight</code> and <code>port</code>), and you can get multiple records back from a single query, letting you do load balancing client side:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ dig @localhost -p <span style=color:#ae81ff>8600</span> consul.service.consul SRV +short
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> <span style=color:#ae81ff>10</span> <span style=color:#ae81ff>8300</span> vagrant1.node.dc1.consul.
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> <span style=color:#ae81ff>14</span> <span style=color:#ae81ff>8300</span> vagrant2.node.dc1.consul.
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span> <span style=color:#ae81ff>100</span> <span style=color:#ae81ff>8300</span> vagrant3.node.dc1.consul.
</span></span></code></pre></div><p>A Records are also useful, as it means we should be able to treat services registered to Consul like any other domain - but it doesn&rsquo;t work:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl http://consul.service.consul:8500
</span></span><span style=display:flex><span>curl: <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span> Could not resolve host: consul.service.consul
</span></span></code></pre></div><p>The reason for this is that the system&rsquo;s built-in DNS resolver doesn&rsquo;t know how to query Consul. We can, however, configure it to forward any <code>*.consul</code> requests to Consul.</p><h2 id=solution---forward-dns-queries-to-consul>Solution - Forward DNS queries to Consul<a hidden class=anchor aria-hidden=true href=#solution---forward-dns-queries-to-consul>#</a></h2><p>As I usually target Ubuntu based machines, this means configuring <code>systemd-resolved</code> to forward to Consul. However, we want to keep Consul listening on it&rsquo;s default port (<code>8600</code>), and <code>systemd-resolved</code> can only forward requests to port <code>53</code>, so we need also to configure <code>iptables</code> to redirect the requests.</p><p>The steps are as follows:</p><ol><li>Configure <code>systemd-resolved</code> to forward <code>.consul</code> TLD queries to the local consul agent</li><li>Configure <code>iptables</code> to redirect <code>53</code> to <code>8600</code></li></ol><p>So let&rsquo;s get to it!</p><h3 id=1-make-iptables-persistent>1. Make iptables persistent<a hidden class=anchor aria-hidden=true href=#1-make-iptables-persistent>#</a></h3><p>IPTables configuration changes don&rsquo;t persist through reboots, so the easiest way to solve this is with the <code>iptables-persistent</code> package.</p><p>Typically I am scripting machines (using [Packer] or [Vagrant]), so I configure the install to be non-interactive:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo iptables-persistent iptables-persistent/autosave_v4 boolean false | sudo debconf-set-selections
</span></span><span style=display:flex><span>echo iptables-persistent iptables-persistent/autosave_v6 boolean false | sudo debconf-set-selections
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo DEBIAN_FRONTEND<span style=color:#f92672>=</span>noninteractive apt install -yq iptables-persistent
</span></span></code></pre></div><h3 id=2-update-systemd-resolved>2. Update Systemd-Resolved<a hidden class=anchor aria-hidden=true href=#2-update-systemd-resolved>#</a></h3><p>The file to change is <code>/etc/systemd/resolved.conf</code>. By default it looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-conf data-lang=conf><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>[</span>Resolve<span style=color:#960050;background-color:#1e0010>]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#DNS=
</span></span></span><span style=display:flex><span><span style=color:#75715e>#FallbackDNS=8.8.8.8 8.8.4.4 2001:4860:4860::8888 2001:4860:4860::8844
</span></span></span><span style=display:flex><span><span style=color:#75715e>#Domains=
</span></span></span><span style=display:flex><span><span style=color:#75715e>#LLMNR=yes
</span></span></span><span style=display:flex><span><span style=color:#75715e>#DNSSEC=no
</span></span></span></code></pre></div><p>We need to change the <code>DNS</code> and <code>Domains</code> lines - either editing the file by hand, or scripting a replacement with <code>sed</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo sed -i <span style=color:#e6db74>&#39;s/#DNS=/DNS=127.0.0.1/g; s/#Domains=/Domains=~consul/g&#39;</span> /etc/systemd/resolved.conf
</span></span></code></pre></div><p>The result of which is the file now reading like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-conf data-lang=conf><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>[</span>Resolve<span style=color:#960050;background-color:#1e0010>]</span>
</span></span><span style=display:flex><span>DNS<span style=color:#f92672>=</span><span style=color:#ae81ff>127.0.0.1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#FallbackDNS=8.8.8.8 8.8.4.4 2001:4860:4860::8888 2001:4860:4860::8844
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Domains<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>~</span>consul
</span></span><span style=display:flex><span><span style=color:#75715e>#LLMNR=yes
</span></span></span><span style=display:flex><span><span style=color:#75715e>#DNSSEC=no
</span></span></span></code></pre></div><p>By specifying the <code>Domains</code> as <code>~consul</code>, we are telling resolvd to forward requests for the <code>consul</code> TLD to the server specified in the <code>DNS</code> line.</p><h3 id=3-configure-resolvconf-too>3. Configure Resolvconf too<a hidden class=anchor aria-hidden=true href=#3-configure-resolvconf-too>#</a></h3><p>For compatibility with some applications (e.g. <code>curl</code> and <code>ping</code>), we also need to update <code>/etc/resolv.conf</code> to specify our local nameserver. You do this <strong>not</strong> by editing the file directly!</p><p>Instead, we need to add <code>nameserver 127.0.0.1</code> to <code>/etc/resolvconf/resolv.conf.d/head</code>. Again, I will script this, and as we need <code>sudo</code> to write to the file, the easiest way is to use <code>tee</code> to append the line and then run <code>resolvconf -u</code> to apply the change:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;nameserver 127.0.0.1&#34;</span> | sudo tee --append /etc/resolvconf/resolv.conf.d/head
</span></span><span style=display:flex><span>sudo resolvconf -u
</span></span></code></pre></div><h3 id=configure-iptables>Configure iptables<a hidden class=anchor aria-hidden=true href=#configure-iptables>#</a></h3><p>Finally, we need to configure iptables so that when <code>systemd-resolved</code> sends a DNS query to localhost on port <code>53</code>, it gets redirected to port <code>8600</code>. We&rsquo;ll do this for both TCP and UDP requests, and then use <code>netfilter-persistent</code> to make the rules persistent:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo iptables -t nat -A OUTPUT -d localhost -p udp -m udp --dport <span style=color:#ae81ff>53</span> -j REDIRECT --to-ports <span style=color:#ae81ff>8600</span>
</span></span><span style=display:flex><span>sudo iptables -t nat -A OUTPUT -d localhost -p tcp -m tcp --dport <span style=color:#ae81ff>53</span> -j REDIRECT --to-ports <span style=color:#ae81ff>8600</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo netfilter-persistent save
</span></span></code></pre></div><h2 id=verification>Verification<a hidden class=anchor aria-hidden=true href=#verification>#</a></h2><p>First, we can test that both Consul and Systemd-Resolved return an address for a consul service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ dig @localhost -p <span style=color:#ae81ff>8600</span> consul.service.consul +short
</span></span><span style=display:flex><span>10.0.2.15
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ dig @localhost consul.service.consul +short
</span></span><span style=display:flex><span>10.0.2.15
</span></span></code></pre></div><p>And now we can try using <code>curl</code> to verify that we can resolve consul domains and normal domains still:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -s -o /dev/null -w <span style=color:#e6db74>&#34;%{http_code}\n&#34;</span> http://consul.service.consul:8500/ui/
</span></span><span style=display:flex><span><span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ curl -s -o /dev/null -w <span style=color:#e6db74>&#34;%{http_code}\n&#34;</span> http://google.com
</span></span><span style=display:flex><span><span style=color:#ae81ff>301</span>
</span></span></code></pre></div><h2 id=end>End<a hidden class=anchor aria-hidden=true href=#end>#</a></h2><p>There are also guides available on how to do this on <a href=https://learn.hashicorp.com/consul/security-networking/forwarding>Hashicorp&rsquo;s website</a>, covering other DNS resolvers too (such as BIND, Dnsmasq, Unbound).</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/infrastructure/>infrastructure</a></li><li><a href=https://andydote.co.uk/tags/dns/>dns</a></li><li><a href=https://andydote.co.uk/tags/consul/>consul</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2019/05/31/consul-dns-forwarding-alpine/><span class=title>« Prev Page</span><br><span>Configuring Consul DNS Forwarding in Alpine Linux</span></a>
<a class=next href=https://andydote.co.uk/2019/04/06/nomad-rabbitmq-secure/><span class=title>Next Page »</span><br><span>Running a Secure RabbitMQ Cluster in Nomad</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>