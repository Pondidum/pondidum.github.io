<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using Vault as a Development CA | Andy Dote</title><meta name=keywords content="vault,security,tls"><meta name=description content="Often when developing or testing some code, I need (or want) to use SSL, and one of the easiest ways to do that is to use Vault. However, it gets pretty annoying having to generate a new CA for each project, and import the CA cert into windows (less painful in Linux, but still annoying), especially as I forget which cert is in use, and accidentally clean up the wrong ones."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2019/08/25/vault-development-ca/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ea821116adbd94ff8c04bf7745204429750a1079f16951db0415b837fc273249.css integrity="sha256-6oIRFq29lP+MBL93RSBEKXUKEHnxaVHbBBW4N/wnMkk=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Using Vault as a Development CA"><meta property="og:description" content="Often when developing or testing some code, I need (or want) to use SSL, and one of the easiest ways to do that is to use Vault. However, it gets pretty annoying having to generate a new CA for each project, and import the CA cert into windows (less painful in Linux, but still annoying), especially as I forget which cert is in use, and accidentally clean up the wrong ones."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2019/08/25/vault-development-ca/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-08-25T00:00:00+00:00"><meta property="article:modified_time" content="2019-08-25T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Vault as a Development CA"><meta name=twitter:description content="Often when developing or testing some code, I need (or want) to use SSL, and one of the easiest ways to do that is to use Vault. However, it gets pretty annoying having to generate a new CA for each project, and import the CA cert into windows (less painful in Linux, but still annoying), especially as I forget which cert is in use, and accidentally clean up the wrong ones."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Using Vault as a Development CA","item":"https://andydote.co.uk/2019/08/25/vault-development-ca/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using Vault as a Development CA","name":"Using Vault as a Development CA","description":"Often when developing or testing some code, I need (or want) to use SSL, and one of the easiest ways to do that is to use Vault. However, it gets pretty annoying having to generate a new CA for each project, and import the CA cert into windows (less painful in Linux, but still annoying), especially as I forget which cert is in use, and accidentally clean up the wrong ones.","keywords":["vault","security","tls"],"articleBody":"Often when developing or testing some code, I need (or want) to use SSL, and one of the easiest ways to do that is to use Vault. However, it gets pretty annoying having to generate a new CA for each project, and import the CA cert into windows (less painful in Linux, but still annoying), especially as I forget which cert is in use, and accidentally clean up the wrong ones.\nMy solution has been to generate a single CA certificate and PrivateKey, import this into my Trusted Root Certificate Store, and then whenever I need a Vault instance, I just setup Vault to use the existing certificate and private key. The documentation for how to do this seems somewhat lacking, so here’s how I do it.\nThings you’ll need:\nDocker Vault cli JQ Generating the Root Certificate First we need to create a Certificate, which we will do using the Vault docker container, and our local Vault CLI. We start the docker container in the background, and mark it for deletion when it stops (--rm):\ncontainer=$(docker run -d --rm --cap-add=IPC_LOCK -p 8200:8200 -e \"VAULT_DEV_ROOT_TOKEN_ID=vault\" vault:latest) export VAULT_ADDR=\"http://localhost:8200\" export VAULT_TOKEN=\"vault\" certs_dir=\"./ca\" max_ttl=\"87600h\" # 10 years why not mkdir -p $certs_dir rm -rf $certs_dir/*.* vault secrets enable pki vault secrets tune -max-lease-ttl=$max_ttl pki Finally, we generate a certificate by writing to the pki/root/generate/exported path. If the path ends with exported the Private Key is returned too. If you specify /internal then the Private Key is stored internally to Vault, and never accessible.\nresult=$(vault write -format \"json\" \\ pki/root/generate/exported \\ common_name=\"Local Dev CA\" \\ alt_names=\"localhost,mshome.net\" \\ ttl=$max_ttl) echo \"$result\" \u003e $certs_dir/response.json echo \"$result\" | jq -r .data.certificate \u003e $certs_dir/ca.crt echo \"$result\" | jq -r .data.private_key \u003e $certs_dir/private.key docker stop $container We put the entire response into a json file just incase there is something interesting we want out of it later, and store the certificate and private key into the same directory too. Note for the certificate’s alt_names I have specified both localhost and mshome.net, which is the domain that Hyper-V machines use.\nLastly, we can now import the root CA into our machine/user’s Trusted Root Certification Authorities store, meaning our later uses of this certificate will be trusted by our local machine.\nCreating a Vault CA As before, we use a Docker container to run the Vault instance, except this time we import the existing CA certificate into the PKI backend. The first half of the script (run_ca.sh) is pretty much the same as before, except we don’t delete the contents of the ./ca directory, and our certificate max_ttl is much lower:\ndocker run -d --rm --cap-add=IPC_LOCK -p 8200:8200 -e \"VAULT_DEV_ROOT_TOKEN_ID=vault\" vault:latest export VAULT_ADDR=\"http://localhost:8200\" export VAULT_TOKEN=\"vault\" certs_dir=\"./ca\" max_ttl=\"72h\" vault secrets enable pki vault secrets tune -max-lease-ttl=$max_ttl pki The last part is to read in the certificate and private key, bundle them together, and configure the pki backend to use them, and add a single role to use for issuing certificates:\npem=$(cat $certs_dir/ca.crt $certs_dir/private.key) vault write pki/config/ca pem_bundle=\"$pem\" vault write pki/roles/cert \\ allowed_domains=localhost,mshome.net \\ allow_subdomains=true \\ max_ttl=$max_ttl Also note how we don’t stop the docker container either. Wouldn’t be much of a CA if it stopped the second it was configured…\nCreating a Vault Intermediate CA Sometimes, I want to test that a piece of software works when I have issued certificates from an Intermediate CA, rather than directly from the root. We can configure Vault to do this too, with a modified script which this time we start two PKI secret backends, one to act as the root, and onc as the intermediate:\n#!/bin/bash set -e docker run -d --rm --cap-add=IPC_LOCK -p 8200:8200 -e \"VAULT_DEV_ROOT_TOKEN_ID=vault\" vault:latest export VAULT_ADDR=\"http://localhost:8200\" export VAULT_TOKEN=\"vault\" # create root ca certs_dir=\"./ca\" pem=$(cat $certs_dir/ca.crt $certs_dir/private.key) vault secrets enable -path=pki_root pki vault secrets tune -max-lease-ttl=87600h pki_root vault write pki_root/config/ca pem_bundle=\"$pem\" # create the intermediate vault secrets enable pki vault secrets tune -max-lease-ttl=43800h pki csr=$(vault write pki/intermediate/generate/internal \\ -format=json common_name=\"Spectre Dev Intermdiate CA\" \\ | jq -r .data.csr) intermediate=$(vault write pki_root/root/sign-intermediate \\ -format=json csr=\"$csr\" format=pem_bundle ttl=43800h \\ | jq -r .data.certificate) chained=$(echo -e \"$intermediate\\n$(cat $certs_dir/ca.crt)\") vault write pki/intermediate/set-signed certificate=\"$chained\" echo \"$intermediate\" \u003e intermediate.crt vault write pki/roles/cert \\ allowed_domains=localhost,mshome.net \\ allow_subdomains=true \\ max_ttl=43800h # destroy the temp root vault secrets disable pki_root We use the pki_root backend to sign a CSR from the pki (intermediate) backend, and once the signed response is stored in pki, we delete the pki_root backend, as it is no longer needed for our Development Intermediate CA.\nIssuing Certificates We can now use the cert role to issue certificates for our applications, which I have in a script called issue.sh:\n#!/bin/bash export VAULT_ADDR=\"http://localhost:8200\" export VAULT_TOKEN=\"vault\" vault write \\ -format=json \\ pki/issue/cert \\ common_name=$1.mshome.net This script I usually use with jq to do something useful with:\nresponse=$(./issue.sh consul) cert=$(echo \"$response\" | jq -r .data.certificate) key=$(echo \"$response\" | jq -r .data.private_key) Cleaning Up When I have finished with an application or demo, I can just stop the Vault container, and run the run_ca.sh script again if I need Vault for another project.\n","wordCount":"833","inLanguage":"en","datePublished":"2019-08-25T00:00:00Z","dateModified":"2019-08-25T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2019/08/25/vault-development-ca/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Using Vault as a Development CA</h1><div class=post-meta><span title='2019-08-25 00:00:00 +0000 UTC'>August 25, 2019</span>&nbsp;·&nbsp;4 min</div></header><div class=post-content><p>Often when developing or testing some code, I need (or want) to use SSL, and one of the easiest ways to do that is to use <a href=https://www.vaultproject.io/>Vault</a>. However, it gets pretty annoying having to generate a new CA for each project, and import the CA cert into windows (less painful in Linux, but still annoying), especially as I forget which cert is in use, and accidentally clean up the wrong ones.</p><p>My solution has been to generate a single CA certificate and PrivateKey, import this into my Trusted Root Certificate Store, and then whenever I need a Vault instance, I just setup Vault to use the existing certificate and private key. The documentation for how to do this seems somewhat lacking, so here&rsquo;s how I do it.</p><p>Things you&rsquo;ll need:</p><ul><li>Docker</li><li>Vault cli</li><li>JQ</li></ul><h2 id=generating-the-root-certificate>Generating the Root Certificate<a hidden class=anchor aria-hidden=true href=#generating-the-root-certificate>#</a></h2><p>First we need to create a Certificate, which we will do using the Vault docker container, and our local Vault CLI. We start the docker container in the background, and mark it for deletion when it stops (<code>--rm</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>container<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>docker run -d --rm  --cap-add<span style=color:#f92672>=</span>IPC_LOCK -p 8200:8200 -e <span style=color:#e6db74>&#34;VAULT_DEV_ROOT_TOKEN_ID=vault&#34;</span> vault:latest<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export VAULT_ADDR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://localhost:8200&#34;</span>
</span></span><span style=display:flex><span>export VAULT_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;vault&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>certs_dir<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;./ca&#34;</span>
</span></span><span style=display:flex><span>max_ttl<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;87600h&#34;</span> <span style=color:#75715e># 10 years why not</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir -p $certs_dir
</span></span><span style=display:flex><span>rm -rf $certs_dir/*.*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vault secrets enable pki
</span></span><span style=display:flex><span>vault secrets tune -max-lease-ttl<span style=color:#f92672>=</span>$max_ttl pki
</span></span></code></pre></div><p>Finally, we generate a certificate by writing to the <code>pki/root/generate/exported</code> path. If the path ends with <code>exported</code> the Private Key is returned too. If you specify <code>/internal</code> then the Private Key is stored internally to Vault, and never accessible.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>result<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>vault write -format <span style=color:#e6db74>&#34;json&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  pki/root/generate/exported <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  common_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Local Dev CA&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  alt_names<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost,mshome.net&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  ttl<span style=color:#f92672>=</span>$max_ttl<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;</span>$result<span style=color:#e6db74>&#34;</span> &gt; $certs_dir/response.json
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;</span>$result<span style=color:#e6db74>&#34;</span> | jq -r .data.certificate &gt; $certs_dir/ca.crt
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;</span>$result<span style=color:#e6db74>&#34;</span> | jq -r .data.private_key &gt; $certs_dir/private.key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker stop $container
</span></span></code></pre></div><p>We put the entire response into a <code>json</code> file just incase there is something interesting we want out of it later, and store the certificate and private key into the same directory too. Note for the certificate&rsquo;s <code>alt_names</code> I have specified both <code>localhost</code> and <code>mshome.net</code>, which is the domain that Hyper-V machines use.</p><p>Lastly, we can now import the root CA into our machine/user&rsquo;s Trusted Root Certification Authorities store, meaning our later uses of this certificate will be trusted by our local machine.</p><h2 id=creating-a-vault-ca>Creating a Vault CA<a hidden class=anchor aria-hidden=true href=#creating-a-vault-ca>#</a></h2><p>As before, we use a Docker container to run the Vault instance, except this time we import the existing CA certificate into the PKI backend. The first half of the script (<code>run_ca.sh</code>) is pretty much the same as before, except we don&rsquo;t delete the contents of the <code>./ca</code> directory, and our certificate <code>max_ttl</code> is much lower:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d --rm  --cap-add<span style=color:#f92672>=</span>IPC_LOCK -p 8200:8200 -e <span style=color:#e6db74>&#34;VAULT_DEV_ROOT_TOKEN_ID=vault&#34;</span> vault:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export VAULT_ADDR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://localhost:8200&#34;</span>
</span></span><span style=display:flex><span>export VAULT_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;vault&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>certs_dir<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;./ca&#34;</span>
</span></span><span style=display:flex><span>max_ttl<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;72h&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vault secrets enable pki
</span></span><span style=display:flex><span>vault secrets tune -max-lease-ttl<span style=color:#f92672>=</span>$max_ttl pki
</span></span></code></pre></div><p>The last part is to read in the certificate and private key, bundle them together, and configure the <code>pki</code> backend to use them, and add a single role to use for issuing certificates:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pem<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cat $certs_dir/ca.crt $certs_dir/private.key<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vault write pki/config/ca pem_bundle<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$pem<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vault write pki/roles/cert <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  allowed_domains<span style=color:#f92672>=</span>localhost,mshome.net <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  allow_subdomains<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  max_ttl<span style=color:#f92672>=</span>$max_ttl
</span></span></code></pre></div><p>Also note how we don&rsquo;t stop the docker container either. Wouldn&rsquo;t be much of a CA if it stopped the second it was configured&mldr;</p><h2 id=creating-a-vault-intermediate-ca>Creating a Vault Intermediate CA<a hidden class=anchor aria-hidden=true href=#creating-a-vault-intermediate-ca>#</a></h2><p>Sometimes, I want to test that a piece of software works when I have issued certificates from an Intermediate CA, rather than directly from the root. We can configure Vault to do this too, with a modified script which this time we start two PKI secret backends, one to act as the root, and onc as the intermediate:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>set -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run -d --rm  --cap-add<span style=color:#f92672>=</span>IPC_LOCK -p 8200:8200 -e <span style=color:#e6db74>&#34;VAULT_DEV_ROOT_TOKEN_ID=vault&#34;</span> vault:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export VAULT_ADDR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://localhost:8200&#34;</span>
</span></span><span style=display:flex><span>export VAULT_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;vault&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># create root ca</span>
</span></span><span style=display:flex><span>certs_dir<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;./ca&#34;</span>
</span></span><span style=display:flex><span>pem<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cat $certs_dir/ca.crt $certs_dir/private.key<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vault secrets enable -path<span style=color:#f92672>=</span>pki_root pki
</span></span><span style=display:flex><span>vault secrets tune -max-lease-ttl<span style=color:#f92672>=</span>87600h pki_root
</span></span><span style=display:flex><span>vault write pki_root/config/ca pem_bundle<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$pem<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># create the intermediate</span>
</span></span><span style=display:flex><span>vault secrets enable pki
</span></span><span style=display:flex><span>vault secrets tune -max-lease-ttl<span style=color:#f92672>=</span>43800h pki
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>csr<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>vault write pki/intermediate/generate/internal <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -format<span style=color:#f92672>=</span>json common_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Spectre Dev Intermdiate CA&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  | jq -r .data.csr<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>intermediate<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>vault write pki_root/root/sign-intermediate <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -format<span style=color:#f92672>=</span>json csr<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$csr<span style=color:#e6db74>&#34;</span> format<span style=color:#f92672>=</span>pem_bundle ttl<span style=color:#f92672>=</span>43800h <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  | jq -r .data.certificate<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chained<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo -e <span style=color:#e6db74>&#34;</span>$intermediate<span style=color:#e6db74>\n</span><span style=color:#66d9ef>$(</span>cat $certs_dir/ca.crt<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vault write pki/intermediate/set-signed certificate<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$chained<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;</span>$intermediate<span style=color:#e6db74>&#34;</span> &gt; intermediate.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vault write pki/roles/cert <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  allowed_domains<span style=color:#f92672>=</span>localhost,mshome.net <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  allow_subdomains<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  max_ttl<span style=color:#f92672>=</span>43800h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># destroy the temp root</span>
</span></span><span style=display:flex><span>vault secrets disable pki_root
</span></span></code></pre></div><p>We use the <code>pki_root</code> backend to sign a CSR from the <code>pki</code> (intermediate) backend, and once the signed response is stored in <code>pki</code>, we delete the <code>pki_root</code> backend, as it is no longer needed for our Development Intermediate CA.</p><h2 id=issuing-certificates>Issuing Certificates<a hidden class=anchor aria-hidden=true href=#issuing-certificates>#</a></h2><p>We can now use the <code>cert</code> role to issue certificates for our applications, which I have in a script called <code>issue.sh</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>export VAULT_ADDR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://localhost:8200&#34;</span>
</span></span><span style=display:flex><span>export VAULT_TOKEN<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;vault&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vault write <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -format<span style=color:#f92672>=</span>json <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  pki/issue/cert <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  common_name<span style=color:#f92672>=</span>$1.mshome.net
</span></span></code></pre></div><p>This script I usually use with <code>jq</code> to do something useful with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>response<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>./issue.sh consul<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cert<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$response<span style=color:#e6db74>&#34;</span> | jq -r .data.certificate<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>key<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$response<span style=color:#e6db74>&#34;</span> | jq -r .data.private_key<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><h2 id=cleaning-up>Cleaning Up<a hidden class=anchor aria-hidden=true href=#cleaning-up>#</a></h2><p>When I have finished with an application or demo, I can just stop the Vault container, and run the <code>run_ca.sh</code> script again if I need Vault for another project.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/vault/>vault</a></li><li><a href=https://andydote.co.uk/tags/security/>security</a></li><li><a href=https://andydote.co.uk/tags/tls/>tls</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2019/09/14/consul-tls-cluster/><span class=title>« Prev Page</span><br><span>Creating a TLS enabled Consul cluster</span></a>
<a class=next href=https://andydote.co.uk/2019/06/29/architecture-decision-records/><span class=title>Next Page »</span><br><span>Architecture Decision Records</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>