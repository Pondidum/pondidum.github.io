<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Canary Routing with Traefik in Nomad | Andy Dote</title><meta name=keywords content="infrastructure,vagrant,nomad,consul,traefik"><meta name=description content="I wanted to implement canary routing for some HTTP services deployed via Nomad the other day, but rather than having the traffic split by weighting to the containers, I wanted to direct the traffic based on a header.
My first choice of tech was to use Fabio, but it only supports routing by URL prefix, and additionally with a route weight. While I was at JustDevOps in Poland, I heard about another router/loadbalancer which worked in a similar way to Fabio: Traefik."><meta name=author content><link rel=canonical href=https://andydote.co.uk/2019/06/23/nomad-traefik-canary/><link crossorigin=anonymous href=/assets/css/stylesheet.min.b4e19c453811e60acfec1f00c15ac2be1c53f6ab90187e684358ce7faaf48bab.css integrity="sha256-tOGcRTgR5grP7B8AwVrCvhxT9quQGH5oQ1jOf6r0i6s=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/mermaid.min.725f44bd345b0a2a4043ca952b0863edd789e913cf0813a12bbdfe986fe87079.js integrity="sha256-cl9EvTRbCipAQ8qVKwhj7deJ6RPPCBOhK73+mG/ocHk="></script>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://andydote.co.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andydote.co.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andydote.co.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://andydote.co.uk/apple-touch-icon.png><link rel=mask-icon href=https://andydote.co.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Canary Routing with Traefik in Nomad"><meta property="og:description" content="I wanted to implement canary routing for some HTTP services deployed via Nomad the other day, but rather than having the traffic split by weighting to the containers, I wanted to direct the traffic based on a header.
My first choice of tech was to use Fabio, but it only supports routing by URL prefix, and additionally with a route weight. While I was at JustDevOps in Poland, I heard about another router/loadbalancer which worked in a similar way to Fabio: Traefik."><meta property="og:type" content="article"><meta property="og:url" content="https://andydote.co.uk/2019/06/23/nomad-traefik-canary/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-06-23T00:00:00+00:00"><meta property="article:modified_time" content="2019-06-23T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Canary Routing with Traefik in Nomad"><meta name=twitter:description content="I wanted to implement canary routing for some HTTP services deployed via Nomad the other day, but rather than having the traffic split by weighting to the containers, I wanted to direct the traffic based on a header.
My first choice of tech was to use Fabio, but it only supports routing by URL prefix, and additionally with a route weight. While I was at JustDevOps in Poland, I heard about another router/loadbalancer which worked in a similar way to Fabio: Traefik."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://andydote.co.uk/post/"},{"@type":"ListItem","position":3,"name":"Canary Routing with Traefik in Nomad","item":"https://andydote.co.uk/2019/06/23/nomad-traefik-canary/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Canary Routing with Traefik in Nomad","name":"Canary Routing with Traefik in Nomad","description":"I wanted to implement canary routing for some HTTP services deployed via Nomad the other day, but rather than having the traffic split by weighting to the containers, I wanted to direct the traffic based on a header.\nMy first choice of tech was to use Fabio, but it only supports routing by URL prefix, and additionally with a route weight. While I was at JustDevOps in Poland, I heard about another router/loadbalancer which worked in a similar way to Fabio: Traefik.","keywords":["infrastructure","vagrant","nomad","consul","traefik"],"articleBody":"I wanted to implement canary routing for some HTTP services deployed via Nomad the other day, but rather than having the traffic split by weighting to the containers, I wanted to direct the traffic based on a header.\nMy first choice of tech was to use Fabio, but it only supports routing by URL prefix, and additionally with a route weight. While I was at JustDevOps in Poland, I heard about another router/loadbalancer which worked in a similar way to Fabio: Traefik.\nWhile Traefik also doesn’t directly support canary routing, it is much more flexible than Fabio, also allowing request filtering based on HTTP headers. Traefik integrates with a number of container schedulers directly, but Nomad is not one of them. It does however also support using the Consul Service Catalog so that you can use it as an almost drop-in replacement for Fabio.\nSo let’s get to the setup. As usual, there is a complete repository on GitHub: Nomad Traefik Canary Routing.\nNomad As usual, I am using my Hashibox Vagrant base image, and provisioning it as a single Nomad server and client node, using this script. I won’t dig into all the setup in that, as I’ve written it a few times now.\nConsul Consul is already running on the Hashibox base, so we have no further configuration to do.\nTraefik Traefik can be deployed as a Docker container, and either configured through a TOML file (yay, not yaml!) or with command line switches. As we only need a minimal configuration, I opted to use the command line.\nThe container exposes two ports we need to care about: 80 for incoming traffic to be routed, and 8080 for the UI, which are statically allocated to the host as 8000 and 8080 for this demo.\nThe command line configuration used is as follows:\n--api - enable the UI. --consulcatalog - Traefik has two ways to use Consul - --consul uses the KV store for service definitions, and --consulcatalog makes use Consul’s service catalogue. --consulcatalog.endpoint=consul.service.consul:8500 as Consul is not running in the same container as Traefik, we need to tell it where Consul is listening, and as we have DNS Forwarding for *.consul domains, we use the address consul.service.consul. If DNS forwarding was not available, you could use the Nomad variable ${attr.unique.network.ip-address} to get the current task’s host’s IP. --consulcatalog.frontEndRule disable the default rule - each service needs to specify traefik.frontend.rule. --consulcatalog.exposedByDefault=false - lastly, we stop Traefik showing all services registered into consul, the will need to have the traefik.enable=true tag to be processed. The entire job file is listed below:\njob \"traefik\" { datacenters = [\"dc1\"] type = \"service\" group \"loadbalancers\" { count = 1 task \"traefik\" { driver = \"docker\" config { image = \"traefik:1.7.12\" args = [ \"--api\", \"--consulcatalog\", \"--consulcatalog.endpoint=consul.service.consul:8500\", \"--consulcatalog.frontEndRule=''\", \"--consulcatalog.exposedByDefault=false\" ] port_map { http = 80 ui = 8080 } } resources { network { port \"http\" { static = 8000 } port \"ui\" { static = 8080 } } memory = 50 } } } } We register the job into Nomad, and then start on the backend services we will route to:\nnomad job run jobs/traefik.nomad The Backend Services To demonstrate the services can be routed to correctly, we can use the containersol/k8s-deployment-strategies docker container. This image exposes an HTTP service which responds with the container’s hostname and the content of the VERSION environment variable, something like this:\n$ curl http://echo.service.consul:8080 # Host: 23351e48dc98, Version: 1.0.0 We’ll start by making a standard nomad job for this container, and then update it to support canarying. The entire job is listed below:\njob \"echo\" { datacenters = [\"dc1\"] type = \"service\" group \"apis\" { count = 3 task \"echo\" { driver = \"docker\" config { image = \"containersol/k8s-deployment-strategies\" port_map { http = 8080 } } env { VERSION = \"1.0.0\" } resources { network { port \"http\" { } } } service { name = \"echo\" port = \"http\" tags = [ \"traefik.enable=true\", \"traefik.frontend.rule=Host:api.localhost\" ] check { type = \"http\" path = \"/\" interval = \"5s\" timeout = \"1s\" } } } } } The only part of interest in this version of the job is the service stanza, which is registering our echo service into consul, with a few tags to control how it is routed by Traefik:\nservice { name = \"echo\" port = \"http\" tags = [ \"traefik.enable=true\", \"traefik.frontend.rule=Host:api.localhost\" ] check { type = \"http\" path = \"/\" interval = \"5s\" timeout = \"1s\" } } The traefik.enabled=true tag allows this service to be handled by Traefik (as we set exposedByDefault=false in Traefik), and traefik.frontend.rule=Host:api.localhost the rule means that any traffic with the Host header set to api.localhost will be routed to the service.\nWhich we can now run the job in Nomad:\nnomad job run jobs/echo.nomad Once it is up and running, we’ll get 3 instances of echo running which will be round-robin routed by Traefik:\n$ curl http://traefik.service.consul:8080 -H 'Host: api.localhost' #Host: 1ac8a49cbaee, Version: 1.0.0 $ curl http://traefik.service.consul:8080 -H 'Host: api.localhost' #Host: 23351e48dc98, Version: 1.0.0 $ curl http://traefik.service.consul:8080 -H 'Host: api.localhost' #Host: c2f8a9dcab95, Version: 1.0.0 Now that we have working routing for the Echo service let’s make it canaryable.\nCanaries To show canary routing, we will create a second version of the service to respond to HTTP traffic with a Canary header.\nThe first change to make is to add in the update stanza, which controls how the containers get updated when Nomad pushes a new version. The canary parameter controls how many instances of the task will be created for canary purposes (and must be less than the total number of containers). Likewise, the max_parallel parameter controls how many containers will be replaced at a time when a deployment happens.\ngroup \"apis\" { count = 3 + update { + max_parallel = 1 + canary = 1 + } task \"echo\" { Next, we need to modify the service stanza to write different tags to Consul when a task is a canary instance so that it does not get included in the “normal” backend routing group.\nIf we don’t specify at least 1 value in canary_tags, Nomad will use the tags even in the canary version - an empty canary_tags = [] declaration is not enough!\nservice { name = \"echo\" port = \"http\" tags = [ \"traefik.enable=true\", \"traefik.frontend.rule=Host:api.localhost\" ] + canary_tags = [ + \"traefik.enable=false\" + ] check { Finally, we need to add a separate service stanza to create a second backend group which will contain the canary versions. Note how this group has a different name, and has no tags, but does have a set of canary_tags.\nservice { name = \"echo-canary\" port = \"http\" tags = [] canary_tags = [ \"traefik.enable=true\", \"traefik.frontend.rule=Host:api.localhost;Headers: Canary,true\" ] check { type = \"http\" path = \"/\" interval = \"5s\" timeout = \"1s\" } } The reason we need two service stanzas is that Traefik can only create backends based on the name of the service registered to Consul and not from a tag in that registration. If we just used one service stanza, then the canary version of the container would be added to both the canary backend and standard backend. I was hoping for traefik.backend=echo-canary to work, but alas no.\nThe entire updated jobfile is as follows:\njob \"echo\" { datacenters = [\"dc1\"] type = \"service\" group \"apis\" { count = 3 update { max_parallel = 1 canary = 1 } task \"echo\" { driver = \"docker\" config { image = \"containersol/k8s-deployment-strategies\" port_map { http = 8080 } } env { VERSION = \"1.0.0\" } resources { network { port \"http\" { } } memory = 50 } service { name = \"echo-canary\" port = \"http\" tags = [] canary_tags = [ \"traefik.enable=true\", \"traefik.frontend.rule=Host:api.localhost;Headers: Canary,true\" ] check { type = \"http\" path = \"/\" interval = \"5s\" timeout = \"1s\" } } service { name = \"echo\" port = \"http\" tags = [ \"traefik.enable=true\", \"traefik.frontend.rule=Host:api.localhost\" ] canary_tags = [ \"traefik.enable=false\" ] check { type = \"http\" path = \"/\" interval = \"5s\" timeout = \"1s\" } } } } } Testing First, we will change the VERSION environment variable so that Nomad sees the job as changed, and we get a different response from HTTP calls to the canary:\nenv { - VERSION = \"1.0.0\" + VERSION = \"2.0.0\" } Now we will update the job in Nomad:\nnomad job run jobs/echo.nomad If we run the status command, we can see that the deployment has started, and there is one canary instance running. Nothing further will happen until we promote it:\n$ nomad status echo ID = echo Status = running Latest Deployment ID = 330216b9 Status = running Description = Deployment is running but requires promotion Deployed Task Group Promoted Desired Canaries Placed Healthy Unhealthy Progress Deadline apis false 3 1 1 1 0 2019-06-19T11:19:31Z Allocations ID Node ID Task Group Version Desired Status Created Modified dcff2555 82f6ea8b apis 1 run running 18s ago 2s ago 5b2710ed 82f6ea8b apis 0 run running 6m52s ago 6m26s ago 698bd8a7 82f6ea8b apis 0 run running 6m52s ago 6m27s ago b315bcd3 82f6ea8b apis 0 run running 6m52s ago 6m25s ago We can now test that the original containers still work, and that the canary version works:\n$ curl http://traefik.service.consul:8080 -H 'Host: api.localhost' #Host: 1ac8a49cbaee, Version: 1.0.0 $ curl http://traefik.service.consul:8080 -H 'Host: api.localhost' #Host: 23351e48dc98, Version: 1.0.0 $ curl http://traefik.service.consul:8080 -H 'Host: api.localhost' #Host: c2f8a9dcab95, Version: 1.0.0 $ curl http://traefik.service.consul:8080 -H 'Host: api.localhost' -H 'Canary: true' #Host: 496840b438f2, Version: 2.0.0 Assuming we are happy with our new version, we can tell Nomad to promote the deployment, which will remove the canary and start a rolling update of the three tasks, one at a time:\nnomad deployment promote 330216b9 End My hope is that the next version of Traefik will have better support for canary by header, meaning I could simplify the Nomad jobs a little, but as it stands, this doesn’t add much complexity to the jobs, and can be easily put into an Architecture Decision Record (or documented in a wiki page, never to be seen or read from again!)\n","wordCount":"1679","inLanguage":"en","datePublished":"2019-06-23T00:00:00Z","dateModified":"2019-06-23T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://andydote.co.uk/2019/06/23/nomad-traefik-canary/"},"publisher":{"@type":"Organization","name":"Andy Dote","logo":{"@type":"ImageObject","url":"https://andydote.co.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://andydote.co.uk accesskey=h title="Andy Dote (Alt + H)">Andy Dote</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://andydote.co.uk/archive title=Archive><span>Archive</span></a></li><li><a href=https://andydote.co.uk/talks title=Talks><span>Talks</span></a></li><li><a href=https://andydote.co.uk/notes title=Notes><span>Notes</span></a></li><li><a href=https://andydote.co.uk/tags title=Tags><span>Tags</span></a></li><li><a href=https://andydote.co.uk/contact title=Contact><span>Contact</span></a></li><li><a href=https://andydote.co.uk/rss.xml title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Canary Routing with Traefik in Nomad</h1><div class=post-meta><span title='2019-06-23 00:00:00 +0000 UTC'>June 23, 2019</span>&nbsp;·&nbsp;8 min</div></header><div class=post-content><p>I wanted to implement canary routing for some HTTP services deployed via <a href=https://www.nomadproject.io/>Nomad</a> the other day, but rather than having the traffic split by weighting to the containers, I wanted to direct the traffic based on a header.</p><p>My first choice of tech was to use <a href=https://fabiolb.net/>Fabio</a>, but it only supports routing by URL prefix, and additionally with a route weight. While I was at <a href=https://justdevops.org/>JustDevOps</a> in Poland, I heard about another router/loadbalancer which worked in a similar way to Fabio: <a href=https://traefik.io/>Traefik</a>.</p><p>While Traefik also doesn&rsquo;t directly support canary routing, it is much more flexible than Fabio, also allowing request filtering based on HTTP headers. Traefik integrates with a number of container schedulers directly, but Nomad is not one of them. It does however also support using the Consul Service Catalog so that you can use it as an almost drop-in replacement for Fabio.</p><p>So let&rsquo;s get to the setup. As usual, there is a complete repository on GitHub: <a href=https://github.com/Pondidum/nomad-traefik-canary-demo>Nomad Traefik Canary Routing</a>.</p><h2 id=nomad>Nomad<a hidden class=anchor aria-hidden=true href=#nomad>#</a></h2><p>As usual, I am using my <a href=https://github.com/Pondidum/hashibox>Hashibox</a> <a href=https://vagrantup.com/>Vagrant</a> base image, and provisioning it as a single Nomad server and client node, using <a href=https://github.com/Pondidum/nomad-traefik-canary-demo/blob/master/scripts/server.sh>this script</a>. I won&rsquo;t dig into all the setup in that, as I&rsquo;ve written it a few times now.</p><h2 id=consul>Consul<a hidden class=anchor aria-hidden=true href=#consul>#</a></h2><p>Consul is already running on the Hashibox base, so we have no further configuration to do.</p><h2 id=traefik>Traefik<a hidden class=anchor aria-hidden=true href=#traefik>#</a></h2><p>Traefik can be deployed as a Docker container, and either configured through a TOML file (yay, <a href=https://noyaml.com/>not yaml!</a>) or with command line switches. As we only need a minimal configuration, I opted to use the command line.</p><p>The container exposes two ports we need to care about: <code>80</code> for incoming traffic to be routed, and <code>8080</code> for the UI, which are statically allocated to the host as <code>8000</code> and <code>8080</code> for this demo.</p><p>The command line configuration used is as follows:</p><ul><li><code>--api</code> - enable the UI.</li><li><code>--consulcatalog</code> - Traefik has two ways to use Consul - <code>--consul</code> uses the KV store for service definitions, and <code>--consulcatalog</code> makes use Consul&rsquo;s service catalogue.</li><li><code>--consulcatalog.endpoint=consul.service.consul:8500</code> as Consul is not running in the same container as Traefik, we need to tell it where Consul is listening, and as we have <a href>DNS Forwarding for <code>*.consul</code> domains</a>, we use the address <code>consul.service.consul</code>. If DNS forwarding was not available, you could use the Nomad variable <code>${attr.unique.network.ip-address}</code> to get the current task&rsquo;s host&rsquo;s IP.</li><li><code>--consulcatalog.frontEndRule</code> disable the default rule - each service needs to specify <code>traefik.frontend.rule</code>.</li><li><code>--consulcatalog.exposedByDefault=false</code> - lastly, we stop Traefik showing all services registered into consul, the will need to have the <code>traefik.enable=true</code> tag to be processed.</li></ul><p>The entire job file is listed below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>job <span style=color:#e6db74>&#34;traefik&#34;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  datacenters <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;dc1&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;service&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  group <span style=color:#e6db74>&#34;loadbalancers&#34;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    count <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    task <span style=color:#e6db74>&#34;traefik&#34;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      driver <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;docker&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      config <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;traefik:1.7.12&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        args <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;--api&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;--consulcatalog&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;--consulcatalog.endpoint=consul.service.consul:8500&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;--consulcatalog.frontEndRule=&#39;&#39;&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;--consulcatalog.exposedByDefault=false&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        port_map <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          http <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>          ui <span style=color:#f92672>=</span> <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      resources <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        network <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          port <span style=color:#e6db74>&#34;http&#34;</span> <span style=color:#f92672>{</span> static <span style=color:#f92672>=</span> <span style=color:#ae81ff>8000</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>          port <span style=color:#e6db74>&#34;ui&#34;</span> <span style=color:#f92672>{</span> static <span style=color:#f92672>=</span> <span style=color:#ae81ff>8080</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        memory <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>We register the job into Nomad, and then start on the backend services we will route to:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nomad job run jobs/traefik.nomad
</span></span></code></pre></div><h2 id=the-backend-services>The Backend Services<a hidden class=anchor aria-hidden=true href=#the-backend-services>#</a></h2><p>To demonstrate the services can be routed to correctly, we can use the <code>containersol/k8s-deployment-strategies</code> docker container. This image exposes an HTTP service which responds with the container&rsquo;s hostname and the content of the <code>VERSION</code> environment variable, something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl http://echo.service.consul:8080
</span></span><span style=display:flex><span><span style=color:#75715e># Host: 23351e48dc98, Version: 1.0.0</span>
</span></span></code></pre></div><p>We&rsquo;ll start by making a standard nomad job for this container, and then update it to support canarying. The entire job is listed below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>job <span style=color:#e6db74>&#34;echo&#34;</span> {
</span></span><span style=display:flex><span>  datacenters <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;dc1&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;service&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  group <span style=color:#e6db74>&#34;apis&#34;</span> {
</span></span><span style=display:flex><span>    count <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    task <span style=color:#e6db74>&#34;echo&#34;</span> {
</span></span><span style=display:flex><span>      driver <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;docker&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      config {
</span></span><span style=display:flex><span>        image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;containersol/k8s-deployment-strategies&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        port_map {
</span></span><span style=display:flex><span>          http <span style=color:#f92672>=</span> <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      env {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>VERSION</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1.0.0&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      resources {
</span></span><span style=display:flex><span>        network {
</span></span><span style=display:flex><span>          port <span style=color:#e6db74>&#34;http&#34;</span> { }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      service {
</span></span><span style=display:flex><span>        name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;echo&#34;</span>
</span></span><span style=display:flex><span>        port <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        tags <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;traefik.frontend.rule=Host:api.localhost&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        check {
</span></span><span style=display:flex><span>          type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>          path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>          interval <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;5s&#34;</span>
</span></span><span style=display:flex><span>          timeout <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1s&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The only part of interest in this version of the job is the <code>service</code> stanza, which is registering our echo service into consul, with a few tags to control how it is routed by Traefik:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>service {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;echo&#34;</span>
</span></span><span style=display:flex><span>  port <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;traefik.frontend.rule=Host:api.localhost&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  check {
</span></span><span style=display:flex><span>    type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>    path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>    interval <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;5s&#34;</span>
</span></span><span style=display:flex><span>    timeout <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1s&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>traefik.enabled=true</code> tag allows this service to be handled by Traefik (as we set <code>exposedByDefault=false</code> in Traefik), and <code>traefik.frontend.rule=Host:api.localhost</code> the rule means that any traffic with the <code>Host</code> header set to <code>api.localhost</code> will be routed to the service.</p><p>Which we can now run the job in Nomad:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nomad job run jobs/echo.nomad
</span></span></code></pre></div><p>Once it is up and running, we&rsquo;ll get 3 instances of <code>echo</code> running which will be round-robin routed by Traefik:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl http://traefik.service.consul:8080 -H <span style=color:#e6db74>&#39;Host: api.localhost&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Host: 1ac8a49cbaee, Version: 1.0.0</span>
</span></span><span style=display:flex><span>$ curl http://traefik.service.consul:8080 -H <span style=color:#e6db74>&#39;Host: api.localhost&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Host: 23351e48dc98, Version: 1.0.0</span>
</span></span><span style=display:flex><span>$ curl http://traefik.service.consul:8080 -H <span style=color:#e6db74>&#39;Host: api.localhost&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Host: c2f8a9dcab95, Version: 1.0.0</span>
</span></span></code></pre></div><p>Now that we have working routing for the Echo service let&rsquo;s make it canaryable.</p><h2 id=canaries>Canaries<a hidden class=anchor aria-hidden=true href=#canaries>#</a></h2><p>To show canary routing, we will create a second version of the service to respond to HTTP traffic with a <code>Canary</code> header.</p><p>The first change to make is to add in the <code>update</code> stanza, which controls how the containers get updated when Nomad pushes a new version. The <code>canary</code> parameter controls how many instances of the task will be created for canary purposes (and must be less than the total number of containers). Likewise, the <code>max_parallel</code> parameter controls how many containers will be replaced at a time when a deployment happens.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>group &#34;apis&#34; {
</span></span><span style=display:flex><span>  count = 3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+  update {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    max_parallel = 1
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    canary = 1
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+  }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span>  task &#34;echo&#34; {
</span></span></code></pre></div><p>Next, we need to modify the <code>service</code> stanza to write different tags to Consul when a task is a canary instance so that it does not get included in the &ldquo;normal&rdquo; backend routing group.</p><p>If we don&rsquo;t specify at least 1 value in <code>canary_tags</code>, Nomad will use the <code>tags</code> even in the canary version - an empty <code>canary_tags = []</code> declaration is not enough!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>service {
</span></span><span style=display:flex><span>  name = &#34;echo&#34;
</span></span><span style=display:flex><span>  port = &#34;http&#34;
</span></span><span style=display:flex><span>  tags = [
</span></span><span style=display:flex><span>    &#34;traefik.enable=true&#34;,
</span></span><span style=display:flex><span>    &#34;traefik.frontend.rule=Host:api.localhost&#34;
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span><span style=color:#a6e22e>+  canary_tags = [
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    &#34;traefik.enable=false&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+  ]
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>  check {
</span></span></code></pre></div><p>Finally, we need to add a separate <code>service</code> stanza to create a second backend group which will contain the canary versions. Note how this group has a different name, and has no <code>tags</code>, but does have a set of <code>canary_tags</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>service {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;echo-canary&#34;</span>
</span></span><span style=display:flex><span>  port <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  tags <span style=color:#f92672>=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>  canary_tags <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;traefik.frontend.rule=Host:api.localhost;Headers: Canary,true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  check {
</span></span><span style=display:flex><span>    type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>    path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>    interval <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;5s&#34;</span>
</span></span><span style=display:flex><span>    timeout <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1s&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The reason we need two <code>service</code> stanzas is that Traefik can only create backends based on the name of the service registered to Consul and not from a tag in that registration. If we just used one <code>service</code> stanza, then the canary version of the container would be added to both the canary backend and standard backend. I was hoping for <code>traefik.backend=echo-canary</code> to work, but alas no.</p><p>The entire updated jobfile is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>job <span style=color:#e6db74>&#34;echo&#34;</span> {
</span></span><span style=display:flex><span>  datacenters <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;dc1&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;service&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  group <span style=color:#e6db74>&#34;apis&#34;</span> {
</span></span><span style=display:flex><span>    count <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    update {
</span></span><span style=display:flex><span>      max_parallel <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      canary <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    task <span style=color:#e6db74>&#34;echo&#34;</span> {
</span></span><span style=display:flex><span>      driver <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;docker&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      config {
</span></span><span style=display:flex><span>        image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;containersol/k8s-deployment-strategies&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        port_map {
</span></span><span style=display:flex><span>          http <span style=color:#f92672>=</span> <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      env {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>VERSION</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1.0.0&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      resources {
</span></span><span style=display:flex><span>        network {
</span></span><span style=display:flex><span>          port <span style=color:#e6db74>&#34;http&#34;</span> { }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        memory <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      service {
</span></span><span style=display:flex><span>        name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;echo-canary&#34;</span>
</span></span><span style=display:flex><span>        port <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        tags <span style=color:#f92672>=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>        canary_tags <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;traefik.frontend.rule=Host:api.localhost;Headers: Canary,true&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        check {
</span></span><span style=display:flex><span>          type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>          path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>          interval <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;5s&#34;</span>
</span></span><span style=display:flex><span>          timeout <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1s&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      service {
</span></span><span style=display:flex><span>        name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;echo&#34;</span>
</span></span><span style=display:flex><span>        port <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        tags <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;traefik.frontend.rule=Host:api.localhost&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>        canary_tags <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;traefik.enable=false&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        check {
</span></span><span style=display:flex><span>          type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http&#34;</span>
</span></span><span style=display:flex><span>          path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>          interval <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;5s&#34;</span>
</span></span><span style=display:flex><span>          timeout <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1s&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=testing>Testing<a hidden class=anchor aria-hidden=true href=#testing>#</a></h2><p>First, we will change the <code>VERSION</code> environment variable so that Nomad sees the job as changed, and we get a different response from HTTP calls to the canary:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>env {
</span></span><span style=display:flex><span><span style=color:#f92672>-  VERSION = &#34;1.0.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+  VERSION = &#34;2.0.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>}
</span></span></code></pre></div><p>Now we will update the job in Nomad:</p><pre tabindex=0><code>nomad job run jobs/echo.nomad
</code></pre><p>If we run the status command, we can see that the deployment has started, and there is one canary instance running. Nothing further will happen until we promote it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ nomad status echo
</span></span><span style=display:flex><span>ID            <span style=color:#f92672>=</span> echo
</span></span><span style=display:flex><span>Status        <span style=color:#f92672>=</span> running
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Latest Deployment
</span></span><span style=display:flex><span>ID          <span style=color:#f92672>=</span> 330216b9
</span></span><span style=display:flex><span>Status      <span style=color:#f92672>=</span> running
</span></span><span style=display:flex><span>Description <span style=color:#f92672>=</span> Deployment is running but requires promotion
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Deployed
</span></span><span style=display:flex><span>Task Group  Promoted  Desired  Canaries  Placed  Healthy  Unhealthy  Progress Deadline
</span></span><span style=display:flex><span>apis        false     <span style=color:#ae81ff>3</span>        <span style=color:#ae81ff>1</span>         <span style=color:#ae81ff>1</span>       <span style=color:#ae81ff>1</span>        <span style=color:#ae81ff>0</span>          2019-06-19T11:19:31Z
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Allocations
</span></span><span style=display:flex><span>ID        Node ID   Task Group  Version  Desired  Status   Created    Modified
</span></span><span style=display:flex><span>dcff2555  82f6ea8b  apis        <span style=color:#ae81ff>1</span>        run      running  18s ago    2s ago
</span></span><span style=display:flex><span>5b2710ed  82f6ea8b  apis        <span style=color:#ae81ff>0</span>        run      running  6m52s ago  6m26s ago
</span></span><span style=display:flex><span>698bd8a7  82f6ea8b  apis        <span style=color:#ae81ff>0</span>        run      running  6m52s ago  6m27s ago
</span></span><span style=display:flex><span>b315bcd3  82f6ea8b  apis        <span style=color:#ae81ff>0</span>        run      running  6m52s ago  6m25s ago
</span></span></code></pre></div><p>We can now test that the original containers still work, and that the canary version works:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl http://traefik.service.consul:8080 -H <span style=color:#e6db74>&#39;Host: api.localhost&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Host: 1ac8a49cbaee, Version: 1.0.0</span>
</span></span><span style=display:flex><span>$ curl http://traefik.service.consul:8080 -H <span style=color:#e6db74>&#39;Host: api.localhost&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Host: 23351e48dc98, Version: 1.0.0</span>
</span></span><span style=display:flex><span>$ curl http://traefik.service.consul:8080 -H <span style=color:#e6db74>&#39;Host: api.localhost&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Host: c2f8a9dcab95, Version: 1.0.0</span>
</span></span><span style=display:flex><span>$ curl http://traefik.service.consul:8080 -H <span style=color:#e6db74>&#39;Host: api.localhost&#39;</span> -H <span style=color:#e6db74>&#39;Canary: true&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Host: 496840b438f2, Version: 2.0.0</span>
</span></span></code></pre></div><p>Assuming we are happy with our new version, we can tell Nomad to promote the deployment, which will remove the canary and start a rolling update of the three tasks, one at a time:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nomad deployment promote 330216b9
</span></span></code></pre></div><h2 id=end>End<a hidden class=anchor aria-hidden=true href=#end>#</a></h2><p>My hope is that the next version of Traefik will have better support for canary by header, meaning I could simplify the Nomad jobs a little, but as it stands, this doesn&rsquo;t add much complexity to the jobs, and can be easily put into an Architecture Decision Record (or documented in a wiki page, never to be seen or read from again!)</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andydote.co.uk/tags/infrastructure/>infrastructure</a></li><li><a href=https://andydote.co.uk/tags/vagrant/>vagrant</a></li><li><a href=https://andydote.co.uk/tags/nomad/>nomad</a></li><li><a href=https://andydote.co.uk/tags/consul/>consul</a></li><li><a href=https://andydote.co.uk/tags/traefik/>traefik</a></li></ul><nav class=paginav><a class=prev href=https://andydote.co.uk/2019/06/29/architecture-decision-records/><span class=title>« Prev Page</span><br><span>Architecture Decision Records</span></a>
<a class=next href=https://andydote.co.uk/2019/06/11/feature-toggles-reducing-coupling/><span class=title>Next Page »</span><br><span>Feature Toggles: Reducing Coupling</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>